{
  "version": 3,
  "sources": ["../../@arcgis/core/renderers/support/DictionaryLoader.js"],
  "sourcesContent": ["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.27/esri/copyright.txt for details.\n*/\nimport e from\"../../Color.js\";import t from\"../../request.js\";import s from\"../../core/Error.js\";import\"../../core/has.js\";import i from\"../../core/Logger.js\";import{LRUCache as o}from\"../../core/LRUCache.js\";import{isAbortError as r}from\"../../core/promiseUtils.js\";import{numericHash as n}from\"../../core/string.js\";import{Version as l}from\"../../core/Version.js\";import a from\"../../layers/support/FieldsIndex.js\";import{loadArcade as c,createDictionaryExpression as m}from\"../../support/arcadeOnDemand.js\";import f from\"../../symbols/CIMSymbol.js\";const h=\"esri.renderers.support.DictionaryLoader\",u={type:\"CIMSimpleLineCallout\",lineSymbol:{type:\"CIMLineSymbol\",symbolLayers:[{type:\"CIMSolidStroke\",width:.5,color:[0,0,0,255]}]}};class y{constructor(e,t,s){this.config=null,this.fieldMap=null,this.url=null,this._ongoingRequests=new Map,this._symbolCache=new o(100),this._dictionaryVersion=null,this._fieldIndex=null,this._dictionaryPromise=null,this.url=e,this.config=t,this.fieldMap=s}getSymbolFields(){return this._symbolFields}async getSymbolAsync(t,s){let i;this._dictionaryPromise||(this._dictionaryPromise=this.fetchResources(s));try{i=await this._dictionaryPromise}catch(d){if(r(d))return this._dictionaryPromise=null,null}const o=this._dictionaryVersion&&this._dictionaryVersion.since(4,0),l={};if(this.fieldMap)for(const e of this._symbolFields){const s=this._getFieldName(this.fieldMap[e]);l[e]=s?o?t.attributes[s]:\"\"+t.attributes[s]:\"\"}let a=null;try{a=i?.(l,s)}catch(g){return null}if(!a||\"string\"!=typeof a)return null;const c=n(a).toString(),m=this._symbolCache.get(c);if(m)return m.catch((()=>{this._symbolCache.pop(c)})),m;const f=a.split(\";\"),h=[],u=[];for(const r of f)if(r)if(r.includes(\"po:\")){const t=r.substr(3).split(\"|\");if(3===t.length){const s=t[0],i=t[1];let o=t[2];if(\"DashTemplate\"===i)o=o.split(\" \").map((e=>Number(e)));else if(\"Color\"===i){const t=new e(o).toRgba();o=[t[0],t[1],t[2],255*t[3]]}else o=Number(o);u.push({primitiveName:s,propertyName:i,value:o})}}else if(r.includes(\"|\")){for(const e of r.split(\"|\"))if(this._itemNames.has(e)){h.push(e);break}}else this._itemNames.has(r)&&h.push(r);const y=null==t.geometry||!t.geometry.hasZ&&\"point\"===t.geometry.type,p=this._cimPartsToCIMSymbol(h,u,y,s);return this._symbolCache.put(c,p,1),p}async fetchResources(e){if(this._dictionaryPromise)return this._dictionaryPromise;if(!this.url)return void i.getLogger(h).error(\"no valid URL!\");const o=t(this.url+\"/resources/styles/dictionary-info.json\",{responseType:\"json\",query:{f:\"json\"},signal:null!=e?e.signal:null}),[{data:r}]=await Promise.all([o,c()]);if(!r)throw this._dictionaryPromise=null,new s(\"esri.renderers.DictionaryRenderer\",\"Bad dictionary data!\");const{authoringInfo:n,dictionary_version:f,expression:u,itemsNames:y}=r,p=u;let d=!1;f&&(this._dictionaryVersion=l.parse(f),d=this._dictionaryVersion.since(4,0)),this._refSymbolUrlTemplate=this.url+\"/\"+r.cimRefTemplateUrl,this._itemNames=new Set(y),this._symbolFields=n.symbol;const g={};if(this.config){const e=this.config;for(const t in e)g[t]=e[t]}if(n.configuration)for(const t of n.configuration)g.hasOwnProperty(t.name)||(g[t.name]=t.value);const b=[];if(null!=e&&e.fields&&this.fieldMap)for(const t of this._symbolFields){const s=this.fieldMap[t],i=e.fields.filter((e=>e.name.toLowerCase()===s?.toLowerCase()));i.length>0&&b.push({...i[0],type:d?i[0].type:\"esriFieldTypeString\"})}b.length>0&&(this._fieldIndex=new a(b));const _=m(p,null!=e?e.spatialReference:null,b,g).then((e=>{const t={scale:0};return(s,i)=>{if(null==e)return null;const o=e.repurposeFeature({geometry:null,attributes:s});return t.scale=null!=i?i.scale??void 0:void 0,e.evaluate({$feature:o,$view:t},e.services)}})).catch((e=>(i.getLogger(h).error(\"Creating dictinoary expression failed:\",e),null)));return this._dictionaryPromise=_,_}async _cimPartsToCIMSymbol(e,t,s,i){const o=new Array(e.length);for(let l=0;l<e.length;l++)o[l]=this._getSymbolPart(e[l],i);const r=await Promise.all(o),n=this.fieldMap;if(n)for(const l of r)p(l,n);return new f({data:this._combineSymbolParts(r,t,s)})}async _getSymbolPart(e,s){if(this._ongoingRequests.has(e))return this._ongoingRequests.get(e).then((e=>e.data));const i=this._refSymbolUrlTemplate.replaceAll(/\\{itemName\\}/gi,e),o=t(i,{responseType:\"json\",query:{f:\"json\"},...s});this._ongoingRequests.set(e,o);try{return(await o).data}catch(r){throw this._ongoingRequests.delete(e),r}}_combineSymbolParts(e,t,s){if(!e||0===e.length)return null;const i={...e[0]};if(e.length>1){i.symbolLayers=[];for(const t of e){const e=t;i.symbolLayers.unshift(...e.symbolLayers)}}return s&&(i.callout=u),{type:\"CIMSymbolReference\",symbol:i,primitiveOverrides:t}}_getFieldName(e){if(null!==this._fieldIndex){const t=this._fieldIndex.get(e);return t?t.name:e}return e}}function p(e,t){if(!e)return;const s=e.symbolLayers;if(!s)return;let i=s.length;for(;i--;){const e=s[i];if(e&&!1!==e.enable&&\"CIMVectorMarker\"===e.type)d(e,t)}}function d(e,t){const s=e.markerGraphics;if(s)for(const i of s){if(!i)continue;const e=i.symbol;if(e)switch(e.type){case\"CIMPointSymbol\":case\"CIMLineSymbol\":case\"CIMPolygonSymbol\":p(e,t);break;case\"CIMTextSymbol\":e.fieldMap=t}}}export{y as DictionaryLoader};\n"],
  "mappings": "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",
  "names": ["h", "e", "s", "i", "d", "l", "c", "u", "r", "t", "o", "y", "p"]
}
