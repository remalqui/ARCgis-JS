{
  "version": 3,
  "sources": ["../../@arcgis/core/layers/save/featureLayerUtils.js"],
  "sourcesContent": ["/*\nAll material copyright ESRI, All Rights Reserved, unless otherwise specified.\nSee https://js.arcgis.com/4.27/esri/copyright.txt for details.\n*/\nimport{difference as e}from\"../../core/arrayUtils.js\";import t from\"../../core/Error.js\";import r from\"../../core/Logger.js\";import{debounce as a,eachAlways as o}from\"../../core/promiseUtils.js\";import{updateOrigins as l}from\"../../core/accessorSupport/originUtils.js\";import s from\"../FeatureLayer.js\";import{parse as n}from\"../support/arcgisLayerUrl.js\";import{fetchFeatureService as i}from\"../support/fetchService.js\";import{isFeatureCollectionLayer as u,isFeatureServiceLayer as p}from\"../support/layerUtils.js\";import c from\"../../portal/Portal.js\";import d from\"../../portal/PortalItem.js\";import{createForItemWrite as y}from\"../../portal/support/jsonContext.js\";import{addTypeKeyword as m,TypeKeyword as f,getWGS84ExtentForItem as w,removeTypeKeyword as h}from\"../../portal/support/portalItemUtils.js\";const v=r.getLogger(\"esri.layers.FeatureLayer\"),b=\"Feature Service\";function I(e,t){return`Layer (title: ${e.title}, id: ${e.id}) of type '${e.declaredClass}' ${t}`}function S(e,r){if(r.type!==b)throw new t(\"feature-layer:portal-item-wrong-type\",I(e,`should have portal item of type \"${b}\"`))}async function g(e){if(await e.load(),u(e))throw new t(\"feature-layer:save\",I(e,\"using an in-memory source cannot be saved to a portal item\"))}function j(e,r){let a=(e.messages??[]).filter((({type:e})=>\"error\"===e)).map((({name:e,message:r,details:a})=>new t(e,r,a)));if(r?.ignoreUnsupported&&(a=a.filter((({name:e})=>\"layer:unsupported\"!==e&&\"symbol:unsupported\"!==e&&\"symbol-layer:unsupported\"!==e&&\"property:unsupported\"!==e&&\"url:unsupported\"!==e))),a.length>0)throw new t(\"feature-layer:save\",\"Failed to save feature layer due to unsupported or invalid content. See 'details.errors' for more detailed information\",{errors:a})}async function L(e,t,r){\"beforeSave\"in e&&\"function\"==typeof e.beforeSave&&await e.beforeSave();const a=e.write({},t);return j(t,r),a}function P(e){const{layer:t,layerJSON:r}=e;return t.isTable?{layers:[],tables:[r]}:{layers:[r],tables:[]}}function J(e){m(e,f.JSAPI),e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter(((e,t,r)=>r.indexOf(e)===t)))}function N(e){const r=e.portalItem;if(!r)throw v.error(\"save: requires the portalItem property to be set\"),new t(\"feature-layer:portal-item-not-set\",I(e,\"requires the portalItem property to be set\"));if(!r.loaded)throw new t(\"feature-layer:portal-item-not-loaded\",I(e,\"cannot be saved to a portal item that does not exist or is inaccessible\"));S(e,r)}async function O(e,t){return/\\/\\d+\\/?$/.test(e.url??\"\")?P(t[0]):E(e,t)}async function E(e,t){const{layer:{url:r,customParameters:a,apiKey:o}}=t[0];let l=await e.fetchData(\"json\");l&&null!=l.layers&&null!=l.tables||(l=await T(l,{url:r??\"\",customParameters:a,apiKey:o},t.map((e=>e.layer.layerId))));for(const s of t)A(s.layer,s.layerJSON,l);return l}async function T(e,t,r){e||={},e.layers||=[],e.tables||=[];const{url:a,customParameters:o,apiKey:l}=t,{serviceJSON:s,layersJSON:n}=await i(a,{customParameters:o,apiKey:l}),u=$(e.layers,s.layers,r),p=$(e.tables,s.tables,r);e.layers=u.itemResources,e.tables=p.itemResources;const c=[...u.added,...p.added],d=n?[...n.layers,...n.tables]:[];return await x(e,c,a,d),e}function $(t,r,a){const o=e(t,r,((e,t)=>e.id===t.id));t=t.filter((e=>!o.removed.some((t=>t.id===e.id))));const l=o.added.map((({id:e})=>({id:e})));return l.forEach((({id:e})=>{t.push({id:e})})),{itemResources:t,added:l.filter((({id:e})=>!a.includes(e)))}}async function x(e,t,r,a){const l=t.map((({id:e})=>new s({url:r,layerId:e,sourceJSON:a.find((({id:t})=>t===e))})));await o(l.map((e=>e.load()))),l.forEach((t=>{const{layerId:r,loaded:a,defaultPopupTemplate:o}=t;if(!a||null==o)return;A(t,{id:r,popupInfo:o.toJSON()},e)}))}function A(e,t,r){e.isTable?U(r.tables,t):U(r.layers,t)}function U(e,t){if(!e)return;const r=e.findIndex((({id:e})=>e===t.id));-1===r?e.push(t):e[r]=t}function K(e){const{portalItem:t}=e;return p(e)&&!e.dynamicDataSource&&!!t?.loaded&&t.type===b}async function F(e){if(!e?.length)throw new t(\"feature-layer-utils-saveall:missing-parameters\",\"'layers' array should contain at least one feature layer\");await Promise.all(e.map((e=>e.load())));for(const o of e)if(!K(o))throw new t(\"feature-layer-utils-saveall:invalid-parameters\",`'layers' array should only contain layers or tables in a feature service loaded from 'Feature Service' item. ${I(o,\"does not conform\")}`,{layer:o});const r=e.map((e=>e.portalItem.id));if(new Set(r).size>1)throw new t(\"feature-layer-utils-saveall:invalid-parameters\",\"All layers in the 'layers' array should be loaded from the same portal item\");const a=e.map((e=>e.layerId));if(new Set(a).size!==a.length)throw new t(\"feature-layer-utils-saveall:invalid-parameters\",\"'layers' array should contain only one instance each of layer or table in a feature service\")}function R(e,t){let r=d.from(t);return r.id&&(r=r.clone(),r.id=null),r.type??=b,r.portal??=c.getDefault(),S(e,r),r}async function D(e,t){const{url:r,layerId:a,title:o,fullExtent:l,isTable:s}=e,i=n(r),u=null!=i&&\"FeatureServer\"===i.serverType;t.url=u?r:`${r}/${a}`,t.title||=o,t.extent=null,s||null==l||(t.extent=await w(l)),h(t,f.METADATA),h(t,f.MULTI_LAYER),m(t,f.SINGLE_LAYER),s&&m(t,f.TABLE),J(t)}async function q(e,t,r){const a=e.portal;await(a?.signIn()),await(a?.user?.addItem({item:e,data:t,folder:r?.folder}))}const z=a(C);async function C(e,t){await g(e),N(e);const r=e.portalItem,a=y(r),o=await L(e,a,t),s=await O(r,[{layer:e,layerJSON:o}]);return J(r),await r.update({data:s}),l(a),r}const M=a((async(e,t)=>{await F(e);const r=e[0].portalItem,a=y(r),o=await Promise.all(e.map((e=>L(e,a,t)))),s=await O(r,e.map(((e,t)=>({layer:e,layerJSON:o[t]}))));return J(r),await r.update({data:s}),await Promise.all(e.slice(1).map((e=>e.portalItem.reload()))),l(a),r.clone()})),Y=a(_);async function _(e,t,r){await g(e);const a=R(e,t),o=y(a),s=P({layer:e,layerJSON:await L(e,o,r)});return await D(e,a),await q(a,s,r),e.portalItem=a,l(o),a}export{z as save,M as saveAll,Y as saveAs};\n"],
  "mappings": "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",
  "names": ["r", "s", "j", "a", "e", "o", "l", "u", "p", "d", "x", "t", "i"]
}
