/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import r from"../Error.js";import has from"../has.js";import{throwIfAborted as t}from"../promiseUtils.js";import o from"./Connection.js";import e from"./RemoteClient.js";import n from"./WorkerOwner.js";const i=has("host-browser")?Math.min(navigator.hardwareConcurrency-1,has("workers-pool-size")):0;let s=has("esri-mobile")?Math.min(i,3):i;s||(s=has("safari")&&has("mac")?7:2);let a=0;const l=[];function c(){d()}function m(r,t){return u(r,{client:t})}async function u(r,t){const e=new o;return await e.open(r,t),e}async function f(o,n={}){if("string"!=typeof o)throw new r("workers:undefined-module","modulePath is missing");let i=n.strategy||"distributed";if(has("host-webworker")&&!has("esri-workers")&&(i="local"),"local"===i){let r=await e.loadWorker(o);r||(r=await import(/* @vite-ignore */ /* webpackIgnore: true */o)),t(n.signal);const i=n.client||r;return u([e.connect(r)],{...n,client:i})}if(await d(),t(n.signal),"dedicated"===i){const r=a++%s;return u([await l[r].open(o,n)],n)}if(n.maxNumWorkers&&n.maxNumWorkers>0){const r=Math.min(n.maxNumWorkers,s);if(r<s){const t=new Array(r);for(let e=0;e<r;++e){const r=a++%s;t[e]=l[r].open(o,n)}return u(t,n)}}return u(l.map((r=>r.open(o,n))),n)}function w(){h&&(p.abort(),h=null);for(let r=0;r<l.length;r++)l[r]&&l[r].terminate();l.length=0}let p,h=null;async function d(){if(h)return h;p=new AbortController;const r=[];for(let t=0;t<s;t++){const o=n.create(t).then((r=>(l[t]=r,r)));r.push(o)}return h=Promise.all(r),h}export{o as Connection,e as RemoteClient,c as initialize,f as open,m as openWithPorts,w as terminate};
