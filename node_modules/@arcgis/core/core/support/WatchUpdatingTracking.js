/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{_ as s}from"../../chunks/tslib.es6.js";import e from"../Accessor.js";import t from"../Handles.js";import{makeHandle as i}from"../handleUtils.js";import{watch as n,when as d,on as a,sync as r}from"../reactiveUtils.js";import{schedule as h}from"../scheduling.js";import{property as o}from"../accessorSupport/decorators/property.js";import{subclass as l}from"../accessorSupport/decorators/subclass.js";let c=class extends e{constructor(){super(...arguments),this.updating=!1,this._handleId=0,this._handles=new t,this._scheduleHandleId=0,this._pendingPromises=new Set}destroy(){this.removeAll(),this._handles.destroy()}add(s,e,t={}){return this._installWatch(s,e,t,n)}addWhen(s,e,t={}){return this._installWatch(s,e,t,d)}addOnCollectionChange(s,e,{initial:t=!1,final:n=!1}={}){const d=++this._handleId;return this._handles.add([a(s,"after-changes",this._createSyncUpdatingCallback(),r),a(s,"change",e,{onListenerAdd:t?s=>e({added:s.toArray(),removed:[]}):void 0,onListenerRemove:n?s=>e({added:[],removed:s.toArray()}):void 0})],d),i((()=>this._handles.remove(d)))}addPromise(s){if(null==s)return s;const e=++this._handleId;this._handles.add({remove:()=>{this._pendingPromises.delete(s)&&(0!==this._pendingPromises.size||this._handles.has(_)||this._set("updating",!1))}},e),this._pendingPromises.add(s),this._set("updating",!0);const t=()=>this._handles.remove(e);return s.then(t,t),s}removeAll(){this._pendingPromises.clear(),this._handles.removeAll(),this._set("updating",!1)}_installWatch(s,e,t={},n){const d=++this._handleId;t.sync||this._installSyncUpdatingWatch(s,d);const a=n(s,e,t);return this._handles.add(a,d),i((()=>this._handles.remove(d)))}_installSyncUpdatingWatch(s,e){const t=this._createSyncUpdatingCallback(),i=n(s,t,{sync:!0,equals:()=>!1});return this._handles.add(i,e),i}_createSyncUpdatingCallback(){return()=>{this._handles.remove(_),++this._scheduleHandleId;const s=this._scheduleHandleId;this._get("updating")||this._set("updating",!0),this._handles.add(h((()=>{s===this._scheduleHandleId&&(this._set("updating",this._pendingPromises.size>0),this._handles.remove(_))})),_)}}};s([o({readOnly:!0})],c.prototype,"updating",void 0),c=s([l("esri.core.support.WatchUpdatingTracking")],c);const _=-42;export{c as WatchUpdatingTracking};
