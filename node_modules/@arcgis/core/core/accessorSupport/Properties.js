/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import"../has.js";import{equals as t}from"../lang.js";import e from"../Logger.js";import r from"../ObjectPool.js";import{Lifecycle as s}from"./interfaces.js";import{Property as i}from"./Property.js";import{OriginId as o,idToName as n,nameToId as a}from"./PropertyOrigin.js";import{Store as c}from"./Store.js";import{trackAccess as l,runTracked as h,initializeDependencyTracking as f}from"./tracking.js";import{Flags as p}from"./tracking/Flags.js";function g(t,e,r){return void 0!==t}function u(t,e,r,i){return void 0!==t&&(!(null==r&&t.observerObject.flags&p.NonNullable)||(i.lifecycle,s.INITIALIZING,!1))}function d(t){return t&&"function"==typeof t.destroy}e.getLogger("esri.core.accessorSupport.Properties");class m{constructor(t){this.host=t,this.propertiesByName=new Map,this.ctorArgs=null,this.destroyed=!1,this.lifecycle=s.INITIALIZING,this.store=new c,this._origin=o.USER;const e=this.host.constructor.__accessorMetadata__;for(const r in e){const t=new i(r,e[r]);this.propertiesByName.set(r,t)}this.metadatas=e}initialize(){this.lifecycle=s.CONSTRUCTING}constructed(){this.lifecycle=s.CONSTRUCTED}destroy(){this.destroyed=!0;for(const[t,e]of this.propertiesByName){if(e.metadata.autoDestroy){const r=this.internalGet(t);r&&d(r)&&(r.destroy(),~e.observerObject.flags&p.NonNullable&&this._internalSet(e,null))}e.destroy()}}get initialized(){return this.lifecycle!==s.INITIALIZING}get(t){const e=this.propertiesByName.get(t);if(e.metadata.get)return e.getComputed(this);l(e.observerObject);const r=this.store;return r.has(t)?r.get(t):e.metadata.value}originOf(t){const e=this.store.originOf(t);if(void 0===e){const e=this.propertiesByName.get(t);if(void 0!==e&&e.observerObject.flags&p.HasDefaultValue)return"defaults"}return n(e)}has(t){return!!this.propertiesByName.has(t)&&this.store.has(t)}keys(){return[...this.propertiesByName.keys()]}internalGet(t){const e=this.propertiesByName.get(t);if(g(e))return this.store.has(t)?this.store.get(t):e.metadata.value}internalSet(t,e){const r=this.propertiesByName.get(t);g(r)&&this._internalSet(r,e)}getDependsInfo(t,e,r){const s=this.propertiesByName.get(e);if(!g(s))return"";const o=new Set,n=h({onObservableAccessed:t=>o.add(t),onTrackingEnd:()=>{}},(()=>s.metadata.get?.call(t)));let a=`${r}${t.declaredClass.split(".").pop()}.${e}: ${n}\n`;if(0===o.size)return a;r+="  ";for(const c of o){if(!(c instanceof i))continue;a+=`${r}${c.propertyName}: undefined\n`}return a}setAtOrigin(t,e,r){const s=this.propertiesByName.get(t);if(g(s))return this._setAtOrigin(s,e,r)}isOverridden(t){const e=this.propertiesByName.get(t);return void 0!==e&&!!(e.observerObject.flags&p.Overriden)}clearOverride(t){const e=this.propertiesByName.get(t),r=e?.observerObject;r&&r.flags&p.Overriden&&(r.flags&=~p.Overriden,e.notifyChange())}override(t,e){const r=this.propertiesByName.get(t);if(!u(r,t,e,this))return;const s=r.metadata.cast;if(s){const t=this._cast(s,e),{valid:r,value:i}=t;if(y.release(t),!r)return;e=i}r.observerObject.flags|=p.Overriden,this._internalSet(r,e)}set(t,e){const r=this.propertiesByName.get(t);if(!u(r,t,e,this))return;const s=r.metadata.cast;if(s){const t=this._cast(s,e),{valid:r,value:i}=t;if(y.release(t),!r)return;e=i}const i=r.metadata.set;i?i.call(this.host,e):this._internalSet(r,e)}setDefaultOrigin(t){this._origin=a(t)}getDefaultOrigin(){return n(this._origin)}notifyChange(t){const e=this.propertiesByName.get(t);void 0!==e&&e.notifyChange()}invalidate(t){const e=this.propertiesByName.get(t);void 0!==e&&e.invalidate()}commit(t){const e=this.propertiesByName.get(t);void 0!==e&&e.commit()}_internalSet(t,e){const r=this.lifecycle!==s.INITIALIZING?this._origin:o.DEFAULTS;this._setAtOrigin(t,e,r)}_setAtOrigin(e,r,s){const i=this.store,o=e.propertyName;i.has(o,s)&&t(r,i.get(o))&&~e.observerObject.flags&p.Overriden&&s===i.originOf(o)||(e.invalidate(),i.set(o,r,s),e.commit(),f(this.host,e))}_cast(t,e){const r=y.acquire();return r.valid=!0,r.value=e,t&&(r.value=t.call(this.host,e,r)),r}}class v{constructor(){this.value=null,this.valid=!0}acquire(){this.valid=!0}release(){this.value=null}}const y=new r(v);export{m as default};
