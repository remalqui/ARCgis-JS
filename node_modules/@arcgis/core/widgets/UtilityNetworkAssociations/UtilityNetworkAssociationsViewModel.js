/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{_ as t}from"../../chunks/tslib.es6.js";import e from"../../Graphic.js";import"../../intl.js";import i from"../../core/Accessor.js";import s from"../../core/Handles.js";import{watch as r}from"../../core/reactiveUtils.js";import{property as o}from"../../core/accessorSupport/decorators/property.js";import"../../core/accessorSupport/ensureType.js";import"../../core/arrayUtils.js";import"../../core/has.js";import{subclass as n}from"../../core/accessorSupport/decorators/subclass.js";import a from"../../geometry/Extent.js";import c from"../../geometry/Point.js";import l from"../../geometry/Polyline.js";import{isLoaded as h,load as y,project as m}from"../../geometry/projection.js";import p from"../../layers/GraphicsLayer.js";import{synthesizeAssociationGeometries as u}from"../../rest/networks/synthesizeAssociationGeometries.js";import A from"../../rest/networks/support/SynthesizeAssociationGeometriesParameters.js";import w from"../../symbols/CIMSymbol.js";import v from"../../symbols/SimpleLineSymbol.js";import{addUniqueLayer as d}from"../../views/draw/support/layerUtils.js";import{fetchMessageBundle as _}from"../../intl/messages.js";import{onLocaleChange as S}from"../../intl/locale.js";let g=class extends i{constructor(t){super(t),this._handles=new s,this._internalArrowsLayerConnectivity=this._createInternalGraphicsLayer("Connectivity Associations - Arrows (Internal)"),this._internalArrowsLayerStructuralAttachment=this._createInternalGraphicsLayer("Structural Attachment Associations - Arrows (Internal)"),this._internalGraphicsLayerConnectivity=this._createInternalGraphicsLayer("Connectivity Associations (Internal)"),this._internalGraphicsLayerStructuralAttachment=this._createInternalGraphicsLayer("Structural Attachment Associations (Internal)"),this.connectivityAssociationsLineSymbol=new v({style:"short-dash",width:2,color:[190,159,159,1]}),this.errorMessage="",this.maxAllowableAssociations=250,this.showArrowsConnectivity=!1,this.showArrowsStructuralAttachment=!1,this.structuralAttachmentAssociationsLineSymbol=new v({style:"short-dash",width:2,color:[159,190,159,1]}),this.utilityNetwork=null}initialize(){_("esri/widgets/UtilityNetworkAssociations/t9n/UtilityNetworkAssociations").then((t=>{this.messages=t})),this._handles.add([S((async()=>{this.messages=await _("esri/widgets/UtilityNetworkAssociations/t9n/UtilityNetworkAssociations")})),r((()=>this.view),(t=>{t&&(d(t,this._internalGraphicsLayerConnectivity),d(t,this._internalArrowsLayerConnectivity),d(t,this._internalGraphicsLayerStructuralAttachment),d(t,this._internalArrowsLayerStructuralAttachment)),this._internalGraphicsLayerConnectivity.visible=this.includeConnectivityAssociations,this._internalGraphicsLayerStructuralAttachment.visible=this.includeStructuralAttachmentAssociations}))])}destroy(){this.view=null,this._removeInternalGraphicsLayers()}set includeConnectivityAssociations(t){this._set("includeConnectivityAssociations",t),this._internalGraphicsLayerConnectivity.visible=t,this._internalArrowsLayerConnectivity.visible=t&&this.showArrowsConnectivity}set includeStructuralAttachmentAssociations(t){this._set("includeStructuralAttachmentAssociations",t),this._internalGraphicsLayerStructuralAttachment.visible=t,this._internalArrowsLayerStructuralAttachment.visible=t&&this.showArrowsStructuralAttachment}get state(){const{view:t}=this;return t?.ready&&this._utilityNetworkExists()?"ready":"disabled"}get view(){return this._get("view")}set view(t){this._set("view",t)}removeAssociations(){this._internalGraphicsLayerConnectivity.removeAll(),this._internalGraphicsLayerStructuralAttachment.removeAll(),this._internalArrowsLayerConnectivity.removeAll(),this._internalArrowsLayerStructuralAttachment.removeAll()}async showAssociations(){const{messages:t}=this;try{if(this._set("state","executing"),!this.includeConnectivityAssociations&&!this.includeStructuralAttachmentAssociations)return void this.removeAssociations();this._internalGraphicsLayerConnectivity.visible=this.includeConnectivityAssociations,this._internalGraphicsLayerStructuralAttachment.visible=this.includeStructuralAttachmentAssociations,this._internalArrowsLayerConnectivity.visible=this.showArrowsConnectivity&&this.includeConnectivityAssociations,this._internalArrowsLayerStructuralAttachment.visible=this.showArrowsStructuralAttachment&&this.includeStructuralAttachmentAssociations,this.removeAssociations(),h()||await y(),this.utilityNetwork.loaded||await this.utilityNetwork.load();const i=this.utilityNetwork.spatialReference,s=m(new c({x:this.view?.extent.xmin,y:this.view?.extent.ymin,spatialReference:this.view?.spatialReference}),i),r=m(new c({x:this.view?.extent.xmax,y:this.view?.extent.ymax,spatialReference:this.view?.spatialReference}),i),o=new a({xmin:s.x,ymin:s.y,xmax:r.x,ymax:r.y,spatialReference:i}),n=new A({returnConnectivityAssociations:this.includeConnectivityAssociations,returnAttachmentAssociations:this.includeStructuralAttachmentAssociations,extent:o,outSpatialReference:this.utilityNetwork.spatialReference,maxGeometryCount:this.maxAllowableAssociations,gdbVersion:(this.view?.map.allLayers?.items.find((t=>"feature"===t.type))).gdbVersion,moment:this.moment}),p=await u(null!==this.utilityNetwork.networkServiceUrl?this.utilityNetwork.networkServiceUrl:"",n);let w=[],v=[],d=[],_=[];if(p){if(!0===p.maxGeometryCountExceeded)return this._set("state","warning"),void this._set("errorMessage",t.infoStrings.maxAllowableAssociationsExceeded);if(0===p.associations.length)return this._set("state","warning"),void this._set("errorMessage",t.infoStrings.noAssociationsFound);w=p.associations.filter((t=>"connectivity"===t.associationType)).map((t=>{const i=new l({paths:t.geometry.paths,spatialReference:t.geometry.spatialReference});return new e({geometry:i,symbol:this.connectivityAssociationsLineSymbol})})),v=p.associations.filter((t=>"connectivity"===t.associationType)).map((t=>{const i=new l({paths:t.geometry.paths,spatialReference:t.geometry.spatialReference});return new e({geometry:i,symbol:this._getCIMSymbolArrows(this.connectivityAssociationsLineSymbol.color)})})),d=p.associations.filter((t=>"attachment"===t.associationType)).map((t=>{const i=new l({paths:t.geometry.paths,spatialReference:t.geometry.spatialReference});return new e({geometry:i,symbol:this.structuralAttachmentAssociationsLineSymbol})})),_=p.associations.filter((t=>"attachment"===t.associationType)).map((t=>{const i=new l({paths:t.geometry.paths,spatialReference:t.geometry.spatialReference});return new e({geometry:i,symbol:this._getCIMSymbolArrows(this.structuralAttachmentAssociationsLineSymbol.color)})}))}w.length>0&&(this._internalGraphicsLayerConnectivity.addMany(w),this._internalArrowsLayerConnectivity.addMany(v)),d.length>0&&(this._internalGraphicsLayerStructuralAttachment.addMany(d),this._internalArrowsLayerStructuralAttachment.addMany(_)),this._set("state","ready")}catch(i){this._set("state","failed"),this._set("errorMessage",i.message)}}_createInternalGraphicsLayer(t){return new p({listMode:"hide",internal:!0,title:t})}_getCIMSymbolArrows(t){return new w({data:{type:"CIMSymbolReference",symbol:{type:"CIMLineSymbol",symbolLayers:[{type:"CIMVectorMarker",enable:!0,size:6,markerPlacement:{type:"CIMMarkerPlacementAtExtremities",extremityPlacement:"JustEnd",angleToLine:!0},frame:{xmin:-5,ymin:-5,xmax:5,ymax:5},markerGraphics:[{type:"CIMMarkerGraphic",geometry:{rings:[[[-18,-5.47],[-18,5.6],[1.96,-.03],[-18,-5.47]]]},symbol:{type:"CIMPolygonSymbol",symbolLayers:[{type:"CIMSolidFill",enable:!0,color:[t.r,t.g,t.b,255*t.a]}]}}]}]}}})}_removeInternalGraphicsLayers(){this._internalGraphicsLayerConnectivity&&this._internalGraphicsLayerStructuralAttachment&&this.view&&this.view.map&&(this.view.map.remove(this._internalGraphicsLayerConnectivity),this.view.map.remove(this._internalGraphicsLayerStructuralAttachment),this.view.map.remove(this._internalArrowsLayerConnectivity),this.view.map.remove(this._internalArrowsLayerStructuralAttachment))}_utilityNetworkExists(){const{messages:t}=this;return!!this.utilityNetwork||(this._set("errorMessage",t.infoStrings.noUtilityNetwork),!1)}};t([o()],g.prototype,"connectivityAssociationsLineSymbol",void 0),t([o({readOnly:!0})],g.prototype,"errorMessage",void 0),t([o({type:Boolean,value:!0})],g.prototype,"includeConnectivityAssociations",null),t([o({type:Boolean,value:!0})],g.prototype,"includeStructuralAttachmentAssociations",null),t([o()],g.prototype,"maxAllowableAssociations",void 0),t([o()],g.prototype,"messages",void 0),t([o()],g.prototype,"moment",void 0),t([o()],g.prototype,"showArrowsConnectivity",void 0),t([o()],g.prototype,"showArrowsStructuralAttachment",void 0),t([o({readOnly:!0})],g.prototype,"state",null),t([o()],g.prototype,"structuralAttachmentAssociationsLineSymbol",void 0),t([o()],g.prototype,"utilityNetwork",void 0),t([o({value:null})],g.prototype,"view",null),g=t([n("esri.widgets.UtilityNetworkAssociations.UtilityNetworkAssociationsViewModel")],g);const L=g;export{L as default};
