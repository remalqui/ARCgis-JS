/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import"../intl.js";import{closest as t}from"../core/domUtils.js";import{on as i,eventKey as l}from"../core/events.js";import{HandleOwnerMixin as a}from"../core/HandleOwner.js";import{destroyMaybe as s}from"../core/maybe.js";import{watch as n,when as c,initial as o}from"../core/reactiveUtils.js";import{property as r}from"../core/accessorSupport/decorators/property.js";import{cast as u}from"../core/accessorSupport/decorators/cast.js";import"../core/arrayUtils.js";import"../core/has.js";import{subclass as d}from"../core/accessorSupport/decorators/subclass.js";import{formatNumber as m,getFormatter as h}from"../intl/number.js";import p from"./Slider.js";import v from"./Widget.js";import{CSS as S}from"./ScaleRangeSlider/css.js";import{getScalePreviewSource as M,getScalePreviewSpriteBackgroundPosition as _}from"./ScaleRangeSlider/scalePreviewUtils.js";import g from"./ScaleRangeSlider/ScaleRanges.js";import f from"./ScaleRangeSlider/ScaleRangeSliderViewModel.js";import{loadCalciteComponents as b}from"./support/componentsUtils.js";import w from"./support/Popover.js";import{accessibleHandler as y}from"./support/decorators/accessibleHandler.js";import{messageBundle as x}from"./support/decorators/messageBundle.js";import{tsx as I}from"./support/jsxFactory.js";import{isRTL as T,storeNode as C}from"./support/widgetUtils.js";import{substitute as L}from"../intl/substitute.js";const R={preview:!0,scaleMenus:{maxScaleMenu:!0,minScaleMenu:!0}},j={maximumFractionDigits:0};let N=class extends(a(v)){constructor(e,a){super(e,a),this._activeMenu=null,this._activeMenuNode=null,this._activeMenuToggleNode=null,this._activeThumb=null,this._customMaxScale=-1,this._customMinScale=-1,this._focusedMenuItemIndex=-1,this._maxScaleMenuPopover=new w({owner:this,placement:"bottom-end",anchorElement:()=>this._activeMenuToggleNode,renderContentFunction:()=>this._maxScaleMenuEnabled?this.renderMaxScaleMenu():null}),this._minScaleMenuPopover=new w({owner:this,placement:"bottom-start",anchorElement:()=>this._activeMenuToggleNode,renderContentFunction:()=>this._minScaleMenuEnabled?this.renderMinScaleMenu():null}),this._maxThumbNode=null,this._minThumbNode=null,this._previewAutoCloseTimeoutId=void 0,this._previewPopover=new w({owner:this,placement:"top",anchorElement:()=>0===this._activeThumb?this._minThumbNode:this._maxThumbNode,offset:[0,16],renderContentFunction:this.renderScalePreview}),this._scaleMenuNode=null,this._slider=new p({thumbCreatedFunction:(e,t,l)=>{0===e&&(this._minThumbNode=l),1===e&&(this._maxThumbNode=l),this.addHandles([i(l,"mouseenter",(()=>{const{visibleElements:{preview:t}}=this;this._activeThumb=e,this._previewPopover.open=t,this.scheduleRender()})),i(l,"mouseleave",(()=>{this._previewAutoCloseTimeoutId||(this._activeThumb=null,this._previewPopover.open=!1,this.scheduleRender())}))])}}),this.disabled=!1,this.messages=null,this.region="US",this.viewModel=new f,this.visibleElements=R,this._handleScaleMenuToggleClick=e=>{const l=e.currentTarget,a=l.getAttribute("data-type"),s="menu-closing-click-handle";if(this.handles.remove(s),a===this._activeMenu)return this._setActiveMenu(null),void(this._activeMenuToggleNode=null);this._setActiveMenu(a),this._activeMenuToggleNode=l,this.handles.add(i(document,"mousedown",(e=>{const i=e.target,l=t(i,`.${S.scaleMenuToggle}`),a=l&&l.getAttribute("data-type");if(l&&a===this._activeMenu)return;!a&&this._scaleMenuNode&&!this._scaleMenuNode.contains(i)&&(this._setActiveMenu(null),this.handles.remove(s),this.scheduleRender())})),s)},this._afterMenuListCreate=e=>{this._activeMenuNode=e,e.children[0].focus({preventScroll:!0})},this._handleCustomScaleEntry=e=>{this._setScaleFromMenuSelection(e),this._customMaxScale=-1,this._customMinScale=-1},this._handleCustomScaleInputBlur=()=>{"max"===this._activeMenu?this._customMaxScale=-1:this._customMinScale=-1},this._handleCustomScaleInputKeyDown=e=>{const t=e.currentTarget,{handleCustomScaleSelect:i}=t["data-render-props"],{key:l,ctrlKey:a,metaKey:s}=e,{viewModel:{scaleRanges:n}}=this;if("Enter"===l){const l=this.parseScale(t.value);return i?.(isNaN(l)?-1:n.clampScale(l)),e.preventDefault(),void e.stopPropagation()}if(l.length>1||a||s)return;/[:,.\d]/.test(l)||(e.preventDefault(),e.stopPropagation())},this._handleScaleMenuKeyDown=e=>{const t=l(e);if("Escape"===t||"Tab"===t)return this._setActiveMenu(null),void this._activeMenuToggleNode?.focus();if("ArrowUp"!==t&&"ArrowDown"!==t)return;const i=Array.from(this._activeMenuNode?.children??[]),a=this._focusedMenuItemIndex,s="ArrowUp"===t?(0===a?i.length:a)-1:(a+1)%i.length;e.preventDefault(),e.stopPropagation(),i[s].focus(),this._focusedMenuItemIndex=s}}loadDependencies(){return b({icon:()=>import("@esri/calcite-components/dist/components/calcite-icon.js")})}initialize(){this.addHandles([n((()=>this.viewModel),(e=>this._slider.viewModel=e?.sliderViewModel??null),o),n((()=>this._interactive),(e=>{this._slider.disabled=!e,e||this._setActiveMenu(null)}),o),this._slider.on("thumb-drag",(({index:e})=>{const{visibleElements:{preview:t}}=this;this._activeThumb=e,this._previewPopover.open=t,clearTimeout(this._previewAutoCloseTimeoutId);const i=250;this._previewAutoCloseTimeoutId=setTimeout((()=>{this._previewAutoCloseTimeoutId=void 0,this._activeThumb=null,this._previewPopover.open=!1,this.scheduleRender()}),i)})),c((()=>!0===this.view?.stationary),(()=>this.scheduleRender()))])}destroy(){this._previewPopover=s(this._previewPopover),this._maxScaleMenuPopover=s(this._maxScaleMenuPopover),this._minScaleMenuPopover=s(this._minScaleMenuPopover),this._slider=s(this._slider)}get _maxScaleMenuEnabled(){const{scaleMenus:e}=this.visibleElements;return!0===e||"boolean"!=typeof e&&e.maxScaleMenu}get _minScaleMenuEnabled(){const{scaleMenus:e}=this.visibleElements;return!0===e||"boolean"!=typeof e&&e.minScaleMenu}get _interactive(){return"disabled"!==this.get("viewModel.state")&&!this.disabled}get effectiveMaxScale(){return this.viewModel.effectiveMaxScale}get effectiveMinScale(){return this.viewModel.effectiveMinScale}get effectiveMaxScaleLimit(){return this.viewModel.effectiveMaxScaleLimit}get effectiveMinScaleLimit(){return this.viewModel.effectiveMinScaleLimit}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}get layer(){return this.viewModel.layer}set layer(e){this.viewModel.layer=e}get maxScale(){return this.viewModel.maxScale}set maxScale(e){this.viewModel.maxScale=e}get maxScaleLimit(){return this.viewModel.maxScaleLimit}set maxScaleLimit(e){this.viewModel.maxScaleLimit=e}get minScale(){return this.viewModel.minScale}set minScale(e){this.viewModel.minScale=e}get minScaleLimit(){return this.viewModel.minScaleLimit}set minScaleLimit(e){this.viewModel.minScaleLimit=e}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}castVisibleElements(e){return{...R,...e,scaleMenus:"boolean"==typeof e?.scaleMenus?e.scaleMenus:{...R.scaleMenus,...e?.scaleMenus}}}formatScale(e){return`1:${m(e,j)}`}parseScale(e){const t=h().formatToParts(100000.1),i=t.find((e=>"decimal"===e.type))?.value??"",l=t.find((e=>"group"===e.type))?.value??"",a=/[^\d.\s]/g,s=e.replace(/.*\(/,"").replace(/\).*$/,"").replace(/.*:/,"").replaceAll(l,"").replaceAll(i,".").replaceAll(a,"");return parseFloat(s)}render(){const{_interactive:e,_slider:t,label:i,messages:l,view:a,viewModel:{scaleRanges:s,state:n}}=this,c=l.scaleRangeLabels,o=c[s.findScaleRangeByIndex(t.values[0]).id],r=c[s.findScaleRangeByIndex(t.values[1]).id];return t.layout=T(this.container)?"horizontal-reversed":"horizontal",I("div",{"aria-label":i,class:this.classes(S.base,S.widget,e?null:S.disabled)},"ready"===n&&a?this.renderCurrentScaleIndicator():null,t.render(),I("div",{class:S.scaleMenuContainer,key:"scale-menu-toggles"},this._minScaleMenuEnabled?this.renderScaleMenuToggle("min",o):null,this._maxScaleMenuEnabled?this.renderScaleMenuToggle("max",r):null))}renderMinScaleMenu(){const{effectiveMaxScale:e,effectiveMinScaleLimit:t,view:i,viewModel:{scaleRanges:l}}=this,a=i?i.scale:void 0;return this.renderScaleMenu({type:"min",min:t,max:l.findScaleRange(e).minScale,map:a})}renderMaxScaleMenu(){const{effectiveMinScale:e,effectiveMaxScaleLimit:t,view:i,viewModel:{scaleRanges:l}}=this,a=i?i.scale:void 0;return this.renderScaleMenu({type:"max",min:l.findScaleRange(e).maxScale,max:t,map:a})}renderScalePreview(){const{_activeThumb:e,_slider:t,region:i,viewModel:{scaleRanges:l}}=this,a=0===e?t.values[0]:t.values[1],s=Object.keys(g.RecommendedScales).indexOf(l.findScaleRangeByIndex(a).id),n={backgroundImage:M(i),backgroundPosition:_(s)};return I("div",{class:S.scalePreview},I("div",{class:S.scalePreviewThumbnail,styles:n}))}renderScaleMenu({map:e,min:t,max:i,type:l}){const a=g.fromScaleRange({minScale:t,maxScale:i}),s=this.messages.featuredScaleLabels,n=g.RecommendedScales,c=Object.keys(n).filter((e=>a.contains(n[e]))).map((e=>this.renderScaleMenuItem({scaleLabel:s[e],scaleValue:n[e],valueVisible:"world"!==e,handleNamedScaleSelect:this._handleRecommendedScaleClick}))),{_customMaxScale:o,_customMinScale:r,messages:u}=this,d="max"===l?o:r;return I("div",{bind:this,class:S.scaleMenu,"data-type":l,id:`${this.id}__scale-menu--${l}`,key:`${l}-scale-menu`,afterCreate:C,"data-node-ref":"_scaleMenuNode",onkeydown:this._handleScaleMenuKeyDown},I("div",{class:S.scaleMenuScroller},I("ul",{class:S.scaleMenuList,afterCreate:this._afterMenuListCreate},this.renderScaleMenuItem({scaleValue:d,scaleLabel:u.featuredScaleLabels.custom,valueVisible:!1,handleNamedScaleSelect:this._handleScaleSelection,handleCustomScaleSelect:this._handleCustomScaleEntry}),null!=e?this.renderScaleMenuItem({scaleValue:e,scaleLabel:u.featuredScaleLabels.current,valueVisible:!0,handleNamedScaleSelect:this._handleRecommendedScaleClick}):null,c)))}_handleScaleSelection(){"max"===this._activeMenu?this._customMaxScale=this.effectiveMaxScale:this._customMinScale=this.effectiveMinScale}renderScaleMenuToggle(e,t){const{_activeMenu:i,_interactive:l}=this,a=i===e;return I("button",{"aria-controls":a?`${this.id}__scale-menu--${e}`:"","aria-pressed":a?"true":"false",class:this.classes(S.scaleMenuToggle,a?S.scaleMenuToggleActive:null),"data-type":e,key:`${e}-scale-menu-toggle`,onclick:this._handleScaleMenuToggleClick,disabled:!l,type:"button"},I("div",{class:S.scaleMenuToggleText,"aria-label":t,title:t},t),I("span",{class:this.classes(S.scaleMenuToggleIcon,S.expandIcon),"aria-hidden":"true"}))}renderScaleMenuItem(e){const{scaleValue:t,scaleLabel:i,valueVisible:l,handleNamedScaleSelect:a,handleCustomScaleSelect:s=null}=e,{id:n}=this,c=`${n}__custom-scale-input`;return I("li",{bind:this,class:S.scaleMenuListItem,"data-scale":t,key:i,onclick:a,onkeydown:a,tabIndex:-1},I("calcite-icon",{icon:"bullet-point",key:"bullet-icon",scale:"m",class:S.scaleMenuListItemIcon}),I("div",{class:S.scaleMenuListItemContent},I("label",{class:S.scaleItemLabel,for:c},i),l?I("div",{class:S.scaleItemValue,key:"value"},this.formatScale(t)):null,t>-1&&s?I("input",{afterCreate:this._focusAndSelectInputOnCreate,class:this.classes(S.scaleItemValue,S.scaleItemValueEditable),"data-render-props":e,id:c,key:"value",value:this.formatScale(t),onkeydown:this._handleCustomScaleInputKeyDown,onblur:this._handleCustomScaleInputBlur}):null))}_focusAndSelectInputOnCreate(e){e.focus(),e.select()}renderCurrentScaleIndicator(){const{_slider:e,messages:t,view:i,viewModel:{scaleRanges:l}}=this,a=l.clampScale(i.scale),s=this.viewModel.mapScaleToSlider(a),n=s/e.max,c=t.scaleRangeLabels[l.findScaleRangeByIndex(s).id],o=L(t.currentScaleTooltip,{scaleLabel:c});return I("div",{class:S.scaleIndicatorContainer,key:"scale-indicator"},I("div",{"aria-label":o,class:S.scaleIndicator,styles:{left:(T(this.container)?-1:1)*n*100+"%"},title:o},this.renderCurrentScaleIndicatorIcon()))}renderCurrentScaleIndicatorIcon(){return I("svg",{class:S.scaleIndicatorIcon,height:"8",width:"8",viewBox:"0 0 8 8",version:"1.1",xmlns:"http://www.w3.org/2000/svg"},I("polygon",{points:"4 0 8 8 0 8"}))}_handleRecommendedScaleClick(e){const t=Number(e.currentTarget["data-scale"]);this._setScaleFromMenuSelection(t)}_setScaleFromMenuSelection(e){"max"===this._activeMenu?this.maxScale=Math.min(e,this.effectiveMinScale-1):this.minScale=Math.max(e,this.effectiveMaxScale+1),this._setActiveMenu(null),this._activeMenuToggleNode?.focus()}_setActiveMenu(e){this._activeMenu=e,this._maxScaleMenuPopover.open="max"===e,this._minScaleMenuPopover.open="min"===e,this._focusedMenuItemIndex=e?0:-1}};e([r()],N.prototype,"_maxScaleMenuEnabled",null),e([r()],N.prototype,"_minScaleMenuEnabled",null),e([r()],N.prototype,"_slider",void 0),e([r({readOnly:!0})],N.prototype,"_interactive",null),e([r()],N.prototype,"disabled",void 0),e([r()],N.prototype,"effectiveMaxScale",null),e([r()],N.prototype,"effectiveMinScale",null),e([r()],N.prototype,"effectiveMaxScaleLimit",null),e([r()],N.prototype,"effectiveMinScaleLimit",null),e([r()],N.prototype,"label",null),e([r()],N.prototype,"layer",null),e([r()],N.prototype,"maxScale",null),e([r()],N.prototype,"maxScaleLimit",null),e([r(),x("esri/widgets/ScaleRangeSlider/t9n/ScaleRangeSlider")],N.prototype,"messages",void 0),e([r()],N.prototype,"minScale",null),e([r()],N.prototype,"minScaleLimit",null),e([r()],N.prototype,"region",void 0),e([r()],N.prototype,"view",null),e([r()],N.prototype,"viewModel",void 0),e([r()],N.prototype,"visibleElements",void 0),e([u("visibleElements")],N.prototype,"castVisibleElements",null),e([y()],N.prototype,"_handleScaleSelection",null),e([y()],N.prototype,"_handleRecommendedScaleClick",null),N=e([d("esri.widgets.ScaleRangeSlider")],N);const k=N;export{k as default};
