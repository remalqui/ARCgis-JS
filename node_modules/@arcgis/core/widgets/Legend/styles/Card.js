/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{_ as e}from"../../../chunks/tslib.es6.js";import"../../../intl.js";import{watch as t}from"../../../core/reactiveUtils.js";import{pt2px as s}from"../../../core/screenUtils.js";import{property as i}from"../../../core/accessorSupport/decorators/property.js";import"../../../core/accessorSupport/ensureType.js";import"../../../core/arrayUtils.js";import"../../../core/has.js";import{subclass as a}from"../../../core/accessorSupport/decorators/subclass.js";import{renderSVG as o}from"../../../symbols/support/svgUtils.js";import{getCSSFilterFromEffectList as r}from"../../../symbols/support/utils.js";import l from"../../Widget.js";import{CSS as n}from"./CardCSS.js";import{renderRelationshipRamp as c}from"./support/relationshipUtils.js";import{getUnivariateAboveAndBelowRampElements as p,getUnivariateSizeRampSize as d,getUnivariateColorRampSize as m,getUnivariateColorRampPreview as h,getUnivariateColorRampMargin as y,getUnivariateColorSizeRampElements as v}from"./support/univariateUtils.js";import{getTitle as f,attachToNode as g,isImageryStretchedLegend as u}from"../support/styleUtils.js";import{Heading as b,incrementHeadingLevel as w}from"../../support/Heading.js";import{accessibleHandler as _}from"../../support/decorators/accessibleHandler.js";import{messageBundle as L}from"../../support/decorators/messageBundle.js";import{tsx as x}from"../../support/jsxFactory.js";import{isRTL as C}from"../../support/widgetUtils.js";import{substitute as S}from"../../../intl/substitute.js";const R=25,$=25,k=768,z=100;var I;!function(e){e.Auto="auto",e.Stack="stack",e.SideBySide="side-by-side"}(I||(I={}));const N="#ddd",A=window.devicePixelRatio;function j(e){if(e){if(e.type.includes("3d")){const t=e.symbolLayers&&e.symbolLayers.length;if(!t)return;const s=e.symbolLayers.at(t-1),i=s.resource&&s.resource.primitive;return"circle"===i||"cross"===i||"kite"===i||"sphere"===i||"cube"===i||"diamond"===i}{const t=e.style;return"circle"===t||"diamond"===t||"cross"===t}}}function E(e){if(e){if(e.type.includes("3d")){const t=e.symbolLayers&&e.symbolLayers.length;if(!t)return;const s=e.symbolLayers.at(t-1).get("resource.primitive");return"triangle"===s||"cone"===s||"tetrahedron"===s}return"triangle"===e.style}}let F=class extends l{constructor(e,t){super(e,t),this._hasIndicators=!1,this._selectedSectionName=null,this._sectionNames=[],this._sectionMap=new Map,this.activeLayerInfos=null,this.headingLevel=3,this.layout=I.Stack,this.messages=null,this.messagesCommon=null,this.type="card",this.view=null}initialize(){this.addHandles(t((()=>this.activeLayerInfos),(e=>{this.removeAllHandles(),this._watchForSectionChanges(e)})))}render(){const{view:e}=this;this._hasIndicators=this.layout===I.Auto&&e&&e.container.clientWidth<=k||this.layout===I.Stack;const t=this.activeLayerInfos,s=t&&t.toArray().map((e=>this._renderLegendForLayer(e))).filter((e=>!!e));this._hasIndicators?this._selectedSectionName&&this._sectionNames.includes(this._selectedSectionName)||(this._selectedSectionName=this._sectionNames&&this._sectionNames[0]):this._selectedSectionName=null;const i=this._sectionNames.length,a=this._sectionNames.map(((e,t)=>{const s=S(this.messagesCommon.pagination.pageText,{index:t+1,total:i});return x("div",{key:e,role:"tab",id:e,"aria-label":s,"aria-controls":`${e}-panel`,"aria-selected":(this._selectedSectionName===e).toString(),tabIndex:this._selectedSectionName===e?0:-1,title:s,onclick:this._selectSection,onkeydown:this._focusSection,bind:this,class:this.classes(n.indicator,{[n.activated]:this._selectedSectionName===e}),"data-section-name":e})})),o=this._hasIndicators&&i>1?x("div",{class:n.indicatorContainer,key:"carousel-navigation",role:"tablist"},a):null,r=this._hasIndicators?this._sectionMap.get(this._selectedSectionName):s&&s.length?s:null,l={[n.stacked]:this._hasIndicators};return x("div",{class:this.classes(n.base,l)},r||x("div",{class:n.message},this.messages.noLegend),o)}_selectSection(e){const t=e.target.getAttribute("data-section-name");t&&(this._selectedSectionName=t)}_focusSection(e){switch(e.key){case"ArrowLeft":case"ArrowRight":this._switchSectionOnArrowPress(e);break;case"Enter":case" ":this._selectSection(e)}}_switchSectionOnArrowPress(e){const t=e.key,s="ArrowLeft"===t?-1:1,i=e.target.getAttribute("data-section-name"),a=this._sectionNames.indexOf(i),o=this._sectionNames;let r=null;-1!==a&&(o[a+s]?r=document.getElementById(o[a+s]):"ArrowLeft"===t?r=document.getElementById(o[o.length-1]):"ArrowRight"===t&&(r=document.getElementById(o[0])),r?.focus())}_watchForSectionChanges(e){if(this._generateSectionNames(),e){e.forEach((e=>{const s=`activeLayerInfo-${e.layer.uid}-version-change`;this.removeHandles(s),this._watchForSectionChanges(e.children),this.addHandles(t((()=>e.version),(()=>this._generateSectionNames())),s)}));const s="activeLayerInfos-collection-change";this.removeHandles(s),this.addHandles(e.on("change",(()=>this._watchForSectionChanges(e))),s)}}_generateSectionNames(){this._sectionNames.length=0,this._selectedSectionName=null,this.activeLayerInfos&&this.activeLayerInfos.forEach(this._generateSectionNamesForActiveLayerInfo,this)}_getSectionName(e,t,s){return`${this.id}${e.uid}-type-${t.type}-${s}`}_generateSectionNamesForActiveLayerInfo(e){e.children.forEach(this._generateSectionNamesForActiveLayerInfo,this),e.legendElements&&e.legendElements.forEach(((t,s)=>{this._sectionNames.push(this._getSectionName(e.layer,t,s))}))}_renderLegendForLayer(e){if(!e.ready)return null;if(e.children.length){const t=e.children.map((e=>this._renderLegendForLayer(e))).toArray();return x("div",{key:e.layer.uid,class:this.classes(n.service,n.groupLayer)},x("div",{class:n.serviceCaptionContainer},e.title),t)}{const t=e.legendElements;if(t&&!t.length)return null;const s=t.some((e=>"relationship-ramp"===e.type)),i=t.map(((t,i)=>this._renderLegendForElement(t,e,i,s))).filter((e=>!!e));if(!i.length)return null;const a={[n.groupLayerChild]:!!e.parent};return x("div",{key:e.layer.uid,class:this.classes(n.service,a)},x("div",{class:n.serviceCaptionContainer},x("div",{class:n.serviceCaptionText},e.title)),x("div",{class:n.serviceContent},i))}}_renderLegendForElement(e,t,s,i=!1,a=!1){const o="color-ramp"===e.type,r="opacity-ramp"===e.type,l="size-ramp"===e.type,p=t.layer;let d=null;if("string"==typeof e.title)d=e.title;else if(e.title){const t=e.title,s=f(this.messages,t,o||r);d=t.title?`${t.title} (${s})`:s}const m=this._getSectionName(p,e,s),h=this._hasIndicators&&!a?x("div",null,x(b,{level:this.headingLevel,class:n.carouselTitle},t.title),x(b,{level:w(this.headingLevel),class:n.layerCaption},d)):d?x(b,{level:this.headingLevel,class:n.layerCaption},d):null,y=t.effectList;let v=null;if("symbol-table"===e.type){const s=e.infos.map(((s,i)=>this._renderLegendForElementInfo(s,t,e.legendType,i))).filter((e=>!!e));if(s.length){const e=s[0].properties.classes&&s[0].properties.classes[n.symbolRow],t={[n.labelContainer]:!e&&!i,[n.relationshipLabelContainer]:i};v=x("div",{class:this.classes(t)},s)}}else"color-ramp"===e.type||"opacity-ramp"===e.type||"heatmap-ramp"===e.type?v=this._renderLegendForRamp(e,p.opacity,y):l?v=this._renderSizeRamp(e,p.opacity):"pie-chart-ramp"===e.type?v=this._renderPieChartRamp(e):"relationship-ramp"===e.type?v=c(e,this.id,{opacity:p.opacity,effectList:y,ariaLabel:this.messages.previewRelationshipRampAriaLabel}):"univariate-above-and-below-ramp"===e.type?v=this._renderUnivariateAboveAndBelowRamp(e,p.opacity,y):"univariate-color-size-ramp"===e.type&&(v=this._renderUnivariateColorSizeRamp(e,p.opacity,y));if(!v)return null;const g=x("div",{key:m,class:n.section,id:`${m}-panel`,role:"tabpanel","aria-labelledby":m,tabIndex:0},[h,v]);return a||this._sectionMap.set(m,g),g}_renderPieChartRamp(e){return x("div",{class:n.pieChartRampPreview,bind:e.preview,afterCreate:g})}_renderUnivariateAboveAndBelowRamp(e,t,s){const{sizeRampElement:i,colorRampElement:a}=p(e,t,"horizontal");if(!i)return null;const o=d(i,"full",!0,"horizontal"),r=m(i,"above",!0,"horizontal"),l=m(i,"below",!0,"horizontal"),c=12,v=this.messages?.previewColorRampAriaLabel,f=h(a,{width:r,height:c,rampAlignment:"horizontal",opacity:t,type:"above",effectList:s,ariaLabel:v}),u=h(a,{width:l,height:c,rampAlignment:"horizontal",opacity:t,type:"below",effectList:s,ariaLabel:v}),b=y(i,"card"),w=i.infos.map((e=>e.label)),_=w.length-1,L=w.map(((e,t)=>0===t||t===_?x("div",{key:t},e):null)),S={display:"flex",flexDirection:"column"},R={display:"flex",flexDirection:"row"},$={marginTop:"3px",display:"flex"};C(this.container)?$.marginRight=`${b}px`:$.marginLeft=`${b}px`;const k={width:`${o}px`,display:"flex",flexDirection:"row",justifyContent:"space-between"};return x("div",{class:n.layerRow,key:"size-ramp-preview",styles:S},x("div",{class:this.classes(n.symbolContainer,n.sizeRampHorizontal),styles:R},i.infos.map(((e,t)=>x("div",{key:t,class:n.symbol,bind:e.preview,afterCreate:g})))),f?x("div",{class:n.univariateAboveAndBelowColorRamp,styles:$,key:"color-ramp-preview"},x("div",{bind:f,afterCreate:g}),x("div",{bind:u,afterCreate:g})):null,x("div",{class:n.layerInfo},x("div",{class:n.rampLabelsContainer,styles:k},L)))}_renderUnivariateColorSizeRamp(e,t,s){const{sizeRampElement:i,colorRampElement:a}=v(e,"horizontal");if(!i)return null;const o=d(i,"full",!1,"horizontal"),r=m(i,"full",!1,"horizontal"),l=h(a,{width:r,height:12,rampAlignment:"horizontal",opacity:t,type:"full",effectList:s,ariaLabel:this.messages?.previewColorRampAriaLabel}),c=y(i,"card"),p=i.infos.length-1,f=i.infos.map(((e,t)=>0===t||t===p?x("div",{key:t},e.label):null)),u={display:"flex",flexDirection:"column"},b={display:"flex",flexDirection:"row"},w={marginTop:"3px",display:"flex"};C(this.container)?w.marginRight=`${c}px`:w.marginLeft=`${c}px`;const _={width:`${o}px`,display:"flex",flexDirection:"row",justifyContent:"space-between"};return x("div",{class:n.layerRow,key:"size-ramp-preview",styles:u},x("div",{class:this.classes(n.symbolContainer,n.sizeRampHorizontal),styles:b},i.infos.map(((e,t)=>x("div",{key:t,class:n.symbol,bind:e.preview,afterCreate:g})))),x("div",{class:n.univariateAboveAndBelowColorRamp,styles:w,key:"color-ramp-preview"},x("div",{bind:l,afterCreate:g})),x("div",{class:n.layerInfo},x("div",{class:n.rampLabelsContainer,styles:_},f)))}_renderLegendForElementInfo(e,t,s,i){const a=t.layer;if(e.type)return this._renderLegendForElement(e,t,i,!1,!0);const o=u(a,s);if(e.preview){if(!e.symbol||!e.symbol.type.includes("simple-fill")){if(!e.label)return x("div",{key:i,bind:e.preview,afterCreate:g});const t={[n.symbolCell]:this._hasIndicators};return x("div",{key:i,class:this.classes(n.layerRow,{[n.symbolRow]:this._hasIndicators})},x("div",{class:this.classes(t),bind:e.preview,afterCreate:g}),x("div",{class:this.classes(n.imageLabel,{[n.labelCell]:this._hasIndicators})},f(this.messages,e.label,!1)||""))}let s=255,o=255,l=255,c=0,p=255,d=255,m=255,h=0;const y=e.symbol.color&&e.symbol.color.a,v=e.symbol.outline&&e.symbol.outline.color&&e.symbol.outline.color.a;y&&(s=e.symbol.color.r,o=e.symbol.color.g,l=e.symbol.color.b,c=e.symbol.color.a*a.opacity),v&&(p=e.symbol.outline.color.r,d=e.symbol.outline.color.g,m=e.symbol.outline.color.b,h=e.symbol.outline.color.a*a.opacity);const u=e.symbol.color?.isBright??!0,b=u?"rgba(255, 255, 255, .6)":"rgba(0, 0, 0, .6)",w={background:y?`rgba(${s}, ${o}, ${l}, ${c})`:"none",color:u?"black":"white",textShadow:`-1px -1px 0 ${b},\n                                              1px -1px 0 ${b},\n                                              -1px 1px 0 ${b},\n                                              1px 1px 0 ${b}`,border:v?`1px solid rgba(${p}, ${d}, ${m}, ${h})`:"none",filter:r(t.effectList)??void 0};return x("div",{key:i,class:n.layerRow},x("div",{class:n.labelElement,styles:w}," ",e.label," "))}if(e.src){const t=this._renderImage(e,a,o);return x("div",{key:i,class:n.layerRow},t,x("div",{class:n.imageLabel},e.label||""))}}_renderImage(e,t,s){const{label:i,src:a,opacity:o}=e,r={[n.imageryLayerStretchedImage]:s,[n.symbol]:!s},l={opacity:`${null!=o?o:t.opacity}`};return x("img",{alt:f(this.messages,i,!1),"aria-label":f(this.messages,i,!1),src:a,border:0,width:e.width,height:e.height,class:this.classes(r),styles:l})}_renderSizeRampLines(e){const t=e.infos,i=t[0],a=t[t.length-1],o=i.symbol,r=this._hasIndicators,l=s(i.size+i.outlineSize)*A,n=s(a.size+a.outlineSize)*A,c=r?l:l+50*A,p=r?l/2+50*A:l,d=E(o),m=j(o),h=document.createElement("canvas");h.width=c,h.height=p,h.style.width=h.width/A+"px",h.style.height=h.height/A+"px";const y=h.getContext("2d");if(r){y.beginPath();const e=0,t=0,s=c/2-n/2,i=p;y.moveTo(e,t),y.lineTo(s,i);const a=c,o=0,r=c/2+n/2,l=p;y.moveTo(a,o),y.lineTo(r,l)}else{y.beginPath();const e=0,t=p/2-n/2,s=c,i=0;y.moveTo(e,t),y.lineTo(s,i);const a=0,o=p/2+n/2,r=c,l=p;y.moveTo(a,o),y.lineTo(r,l)}return y.strokeStyle=N,y.stroke(),x("div",{bind:h,afterCreate:g,styles:r?{display:"flex",marginTop:`-${d?0:m?l/2:0}px`,marginBottom:`-${d?n:m?n/2:0}px`}:{display:"flex",marginRight:`-${d?0:m?l/2:0}px`,marginLeft:`-${d?0:m?n/2:0}px`}})}_renderSizeRamp(e,t){const s=e.infos,i=s[0].label,a=s[s.length-1].label;let o=s[0].preview,r=s[s.length-1].preview;const l=this._hasIndicators,c={"flex-direction":l?"column":"row-reverse"};o&&(o=o.cloneNode(!0),o.style.display="flex"),r&&(r=r.cloneNode(!0),r.style.display="flex");const p={opacity:null!=t?`${t}`:""};return x("div",{class:this.classes(n.layerRow,{[n.sizeRampRow]:l})},x("div",{class:n.rampLabel},l?i:a),x("div",{class:n.sizeRampContainer,styles:c},x("div",{bind:o,afterCreate:g,class:n.sizeRampPreview,styles:p}),this._renderSizeRampLines(e),x("div",{bind:r,afterCreate:g,class:n.sizeRampContainer,styles:p})),x("div",{class:n.rampLabel},l?a:i))}_renderLegendForRamp(e,t,s){const i=e.infos,a="heatmap-ramp"===e.type,l=i.length-1,c=$,p=l>2&&!a?R*l:z,d=p+20,m=10,h=i.slice(0).reverse();h.forEach(((e,t)=>{e.offset=a?e.ratio:t/l}));const y=h.length-1,v=h.length%2!=0&&h[h.length/2|0],f=v&&x("div",{class:n.intervalSeparatorsContainer},x("div",{class:n.intervalSeparator},"|"),x("div",{class:n.rampLabel},v.label)),g=i[i.length-1].label,u=i[0].label,b=[[{shape:{type:"path",path:`M0 ${c/2} L${m} 0 L${m} ${c} Z`},fill:h[0].color,stroke:{width:0}},{shape:{type:"rect",x:m,y:0,width:p,height:c},fill:{type:"linear",x1:m,y1:0,x2:p+m,y2:0,colors:h},stroke:{width:0}},{shape:{type:"path",path:`M${p+m} 0 L${d} ${c/2} L${p+m} ${c} Z`},fill:h[y].color,stroke:{width:0}}]],w=o(b,d,c),{messages:_}=this,L={filter:r(s)??void 0,opacity:null==t?void 0:`${t}`},C={justifyContent:"center"};return x("div",{class:n.layerRow,styles:C},x("div",{class:n.rampLabel},a?_[g]:g),x("div",{class:n.symbolContainer},x("div",{styles:L},w),f),x("div",{class:n.rampLabel},a?_[u]:u))}};e([i()],F.prototype,"activeLayerInfos",void 0),e([i()],F.prototype,"headingLevel",void 0),e([i()],F.prototype,"layout",void 0),e([i(),L("esri/widgets/Legend/t9n/Legend")],F.prototype,"messages",void 0),e([i(),L("esri/t9n/common")],F.prototype,"messagesCommon",void 0),e([i({readOnly:!0})],F.prototype,"type",void 0),e([i()],F.prototype,"view",void 0),e([_()],F.prototype,"_selectSection",null),F=e([a("esri.widgets.Legend.styles.Card")],F);const T=F;export{T as default};
