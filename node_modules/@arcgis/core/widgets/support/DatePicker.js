/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import"../../intl.js";import{eventKey as t}from"../../core/events.js";import a from"../../core/Logger.js";import{watch as i,sync as s}from"../../core/reactiveUtils.js";import{property as o}from"../../core/accessorSupport/decorators/property.js";import"../../core/accessorSupport/ensureType.js";import"../../core/arrayUtils.js";import"../../core/has.js";import{subclass as n}from"../../core/accessorSupport/decorators/subclass.js";import r from"../Widget.js";import{parseDateIntoParts as d,getFirstDayOfWeek as l,getLocaleDayOfWeek as c}from"./datePickerUtils.js";import h from"./DatePickerViewModel.js";import u from"./Popover.js";import{accessibleHandler as p}from"./decorators/accessibleHandler.js";import{messageBundle as _}from"./decorators/messageBundle.js";import{tsx as v}from"./jsxFactory.js";import{storeNode as y,isActivationKey as m,isRTL as g}from"./widgetUtils.js";import{DateTime as D,Info as k,Interval as w}from"luxon";import{formatDate as f}from"../../intl/date.js";import{getLocale as b}from"../../intl/locale.js";const P="esri-date-picker",M={base:P,datePicker:`${P}__calendar`,monthPicker:`${P}__month-picker`,dayPicker:`${P}__day-picker`,week:`${P}__week-item`,nearbyMonth:`${P}__day-item--nearby-month`,activeDay:`${P}__day-item--active`,today:`${P}__day-item--today`,selectedDay:`${P}__day-item--selected`,day:`${P}__day-item`,dayHeader:`${P}__day-item--header`,yearPicker:`${P}__year-picker`,selectedYear:`${P}__year-picker-item--selected`,year:`${P}__year-picker-item`,monthDropdown:`${P}__month-dropdown`,date:`${P}__date`,datePickerToggle:`${P}__calendar-toggle`,dateInput:`${P}__input`,dateTextInput:`${P}__text-input`,leadingIcon:`${P}__icon--leading`,previousIcon:"esri-icon-left",nextIcon:"esri-icon-right",calendarIcon:"esri-icon-calendar",widget:"esri-widget",button:"esri-widget--button",input:"esri-input",select:"esri-select"},O={year:"numeric",month:"2-digit",day:"2-digit"},I=[" ","ArrowDown","ArrowLeft","ArrowRight","ArrowUp","End","Enter","Home","PageDown","PageUp"];let x=class extends r{constructor(e,t){super(e,t),this._calendarNode=null,this._inputOrButtonNode=null,this._rootNode=null,this._requestDayPickerFocusOnCreate=!1,this._activeDate=null,this._calendarPopover=new u({owner:this,placement:"bottom-start",anchorElement:()=>this._rootNode,renderContentFunction:this._renderCalendar}),this._isOpen=!1,this.dateInputEnabled=!1,this.messages=null,this.commitOnMonthChange=!1,this.viewModel=new h,this.disabled=!1,this.toggle=this.toggle.bind(this)}initialize(){this.addHandles(i((()=>({viewModel:this.viewModel,value:this.viewModel?.value})),(({viewModel:e,value:t})=>{!this.destroyed&&e&&null!=this.onChange&&this.onChange(t)}),s))}destroy(){this._calendarPopover.destroy()}get value(){return this.viewModel.value}set value(e){this.viewModel.value=e}get isOpen(){return this._isOpen}render(){return v("div",{afterCreate:y,bind:this,class:this.classes(M.base,M.widget),"data-node-ref":"_rootNode"},this.dateInputEnabled?this._renderInputAndButtonMode():this._renderButtonOnlyMode())}toggle(){this._isOpen?this.close():this.open()}open(e=!0){this._activeDate=D.fromJSDate(this.viewModel.value),this._isOpen=!0,this._calendarPopover.open=!0,this._requestDayPickerFocusOnCreate=e}close(e=!0){this._activeDate=null,this._isOpen=!1,this._calendarPopover.open=!1,e&&this._inputOrButtonNode?.focus()}_renderButtonOnlyMode(){const e=f(this.viewModel.value,O),{disabled:t,_isOpen:a,messages:i}=this;return v("div",{key:`date-button-${t}`,afterCreate:y,"aria-controls":a?this._getCalendarId():null,"aria-expanded":a.toString(),"aria-haspopup":"true","aria-label":i.setDate,"aria-pressed":a.toString(),bind:this,class:this.classes(M.button,M.select,M.datePickerToggle),"data-node-ref":"_inputOrButtonNode",onclick:this.toggle,onkeydown:this._handleDateButtonKeyDown,role:"button",tabIndex:t?void 0:0},v("span",{class:M.date},e))}_renderInputAndButtonMode(){const e=f(this.viewModel.value,O),{_isOpen:t,messages:a}=this;return v("div",{class:this.classes(M.dateInput)},v("input",{afterCreate:y,"data-node-ref":"_inputOrButtonNode","aria-controls":t?this._getCalendarId():null,"aria-haspopup":"true","aria-label":a.setDate,bind:this,class:this.classes(M.dateTextInput,M.input),key:"date-input",onblur:this._handleDateInputBlur,onclick:this._handleDateInputClick,onkeydown:this._handleDateInputKeyDown,type:"text",value:e}),v("span",{"aria-hidden":"true",class:this.classes(M.leadingIcon,M.calendarIcon)}))}_handleDateInputClick(){this.open(!1)}_handleDateInputKeyDown(e){const{key:t}=e;this._isOpen?"Enter"===t?this._handleDateText(e):"Escape"===t&&this.close():"ArrowDown"===t&&(this.open(),e.preventDefault())}_handleDateButtonKeyDown(e){const{key:t,shiftKey:a}=e;this._isOpen&&"Tab"===t&&a?this.close():m(t)&&this.toggle()}_handleDateInputBlur(e){this._isOpen||this._handleDateText(e)}_handleDateText(e){const t=e.currentTarget;let i;try{i=d(t.value,O)}catch(o){return a.getLogger(this).warn(o),void(t.value=f(this.viewModel.value,O))}const s=D.fromObject(i);s.isValid?(this.viewModel.value=s.toJSDate(),this._activeDate=s):t.value=f(this.viewModel.value,O)}_handleDatePickerKeydown(e){"Escape"===t(e)&&(this.close(),e.preventDefault(),e.stopPropagation())}_renderCalendar(){const e=this._activeDate;if(!e)return null;const t=D.fromJSDate(this.viewModel.value);return v("div",{afterCreate:y,bind:this,class:this.classes(M.datePicker,M.widget),"data-node-ref":"_calendarNode",id:this._getCalendarId(),key:"esri-date-picker__calendar",tabIndex:-1,onfocusout:this._onCalendarFocusOut,onkeydown:this._handleDatePickerKeydown},this._renderMonthPicker(e),this._renderDayPicker(e,t),this._renderYearPicker(e))}_getCalendarId(){return`date-picker__calendar--${this.id}`}_onCalendarFocusOut(e){const t=e.relatedTarget;t&&t instanceof Node&&(this._calendarNode?.contains(t)||this._rootNode?.contains(t))||this.close(!1)}_renderMonthPicker(e){const t=g(this.container),a=t?M.nextIcon:M.previousIcon,i=t?M.previousIcon:M.nextIcon,s=k.months("long",{locale:b()}).map(((t,a)=>{const i=e.month-1===a;return v("option",{selected:i,value:a.toString()},t)})),{disabled:o,messages:n}=this;return v("div",{class:M.monthPicker},v("div",{key:`previous-month-${o}`,"aria-label":n.goToPreviousMonth,bind:this,class:M.button,onclick:this._setPreviousMonth,onkeydown:this._handlePreviousMonthKeyDown,role:"button",tabIndex:o?void 0:0,title:n.goToPreviousMonth},v("span",{"aria-hidden":"true",class:a})),v("select",{"aria-live":"assertive","aria-label":n.selectMonth,bind:this,class:this.classes(M.monthDropdown,M.select),disabled:o,id:`${this.id}__month-picker`,onchange:this._setMonth,onkeydown:this._setMonth,title:n.selectMonth},s),v("div",{key:`next-month-${o}`,"aria-label":n.goToNextMonth,bind:this,class:M.button,onclick:this._setNextMonth,onkeydown:this._setNextMonth,role:"button",tabIndex:o?void 0:0,title:n.goToNextMonth},v("span",{"aria-hidden":"true",class:i})))}_renderDayPicker(e,t){const a=this._getWeekLabels(),i=this._getDayId(e),s=this._renderMonth(e,t),{id:o,disabled:n}=this;return v("div",{key:`day-picker-${n}`,afterCreate:this._handleDayPickerCreate,"aria-activedescendant":i,"aria-labelledby":`${o}__month-picker ${o}__selected-year`,bind:this,class:M.dayPicker,id:`${o}__day-picker`,onkeydown:this._handleDayPickerKeydown,role:"grid",tabIndex:n?void 0:0},v("div",{class:M.week,role:"row"},a.map((e=>v("div",{"aria-label":e.name,class:this.classes(M.day,M.dayHeader),role:"columnheader",title:e.name},e.abbr)))),s)}_getDayId(e){return`${this.id}__${f(e.valueOf(),O)}`}_handleDayPickerCreate(e){this._requestDayPickerFocusOnCreate&&(this._requestDayPickerFocusOnCreate=!1,e.focus())}_getWeekLabels(){const e=[],t={weekday:"long"},a={weekday:"narrow"};let i=D.now().set({weekday:l(b())});for(let s=0;s<7;s++)e.push({name:f(i.valueOf(),t),abbr:f(i.valueOf(),a)}),i=i.plus({day:1});return e}_handleDayPickerKeydown(e){const{ctrlKey:a,shiftKey:i}=e,s=t(e);if(!I.includes(s))return;let o=this._activeDate;if(o){if("ArrowLeft"===s)o=o.minus({day:1});else if("ArrowRight"===s)o=o.plus({day:1});else if("ArrowUp"===s)o=o.minus({week:1});else if("ArrowDown"===s)o=o.plus({week:1});else if("PageUp"===s){const e=i?"year":"month";o=o.minus({[e]:1})}else if("PageDown"===s){const e=i?"year":"month";o=o.plus({[e]:1})}else if("Home"===s){const e=a?"year":"month";o=o.startOf(e)}else if("End"===s){const e=a?"year":"month";o=o.endOf(e)}else m(s)&&(this.viewModel.value=o.toJSDate(),this.close());this._activeDate=o,e.preventDefault(),e.stopPropagation()}}_renderMonth(e,t){const a=D.now(),i=e.startOf("month"),s=e.endOf("month"),o=6,n=7;let r=i.minus({day:c(b(),i.weekday)});const d=[];for(let l=0;l<o;l++){const o=[];for(let d=0;d<n;d++){const n=r.day,d=r.hasSame(e,"day"),l=r.hasSame(t,"day"),c=this._getDayId(r),h=w.fromDateTimes(i,s),u={[M.nearbyMonth]:!h.contains(r),[M.today]:r.hasSame(a,"day"),[M.activeDay]:d,[M.selectedDay]:l};o.push(v("div",{"aria-label":n.toString(),"aria-selected":d.toString(),bind:this,class:this.classes(M.day,u),"data-iso-date":r.toISO(),id:c,onclick:this._handleSelectedDate,onkeydown:this._handleSelectedDate,role:"gridcell"},n)),r=r.plus({day:1})}d.push(v("div",{class:M.week,role:"row"},o))}return d}_renderYearPicker(e){const t={year:"numeric"},a=e,i=f(a.valueOf(),t),s=f(a.plus({year:1}).valueOf(),t),o=f(a.minus({year:1}).valueOf(),t),{disabled:n,messages:r}=this;return v("div",{class:M.yearPicker},v("div",{key:`previous-year-${n}`,"aria-label":r.goToPreviousYear,bind:this,class:M.year,onclick:this._setPreviousYear,onkeydown:this._setPreviousYear,tabIndex:n?void 0:0,title:r.goToPreviousYear},o),v("div",{class:this.classes(M.year,M.selectedYear),id:`${this.id}__selected-year`},i),v("div",{key:`next-year-${n}`,"aria-label":r.goToNextYear,bind:this,class:M.year,onclick:this._setNextYear,onkeydown:this._handleNextYearKeyDown,tabIndex:n?void 0:0,title:r.goToNextYear},s))}_setMonth(e){const t=e.target,a=Number(t.value)+1;this._activeDate&&(this._activeDate=this._activeDate.set({month:a}),this.commitOnMonthChange&&(this.viewModel.value=this._activeDate.toJSDate()))}_setPreviousMonth(){this._activeDate&&(this._activeDate=this._activeDate.minus({month:1}),this.commitOnMonthChange&&(this.viewModel.value=this._activeDate.toJSDate()))}_handlePreviousMonthKeyDown(e){if("Tab"===e.key&&e.shiftKey)return e.preventDefault(),void this.close();m(e.key)&&this._setPreviousMonth()}_setNextMonth(){this._activeDate&&(this._activeDate=this._activeDate.plus({month:1}),this.commitOnMonthChange&&(this.viewModel.value=this._activeDate.toJSDate()))}_setPreviousYear(){this._activeDate=this._activeDate?.minus({year:1})??null}_setNextYear(){this._activeDate=this._activeDate?.plus({year:1})??null}_handleNextYearKeyDown(e){if("Tab"===e.key&&!e.shiftKey)return e.preventDefault(),void this.close();m(e.key)&&this._setNextYear()}_handleSelectedDate(e){const t=e.target;this.viewModel.value=D.fromISO(t.getAttribute("data-iso-date")).toJSDate(),this.close()}};e([o()],x.prototype,"_activeDate",void 0),e([o()],x.prototype,"_calendarPopover",void 0),e([o()],x.prototype,"_isOpen",void 0),e([o()],x.prototype,"dateInputEnabled",void 0),e([o(),_("esri/widgets/support/t9n/DatePicker")],x.prototype,"messages",void 0),e([o()],x.prototype,"value",null),e([o()],x.prototype,"commitOnMonthChange",void 0),e([o({type:h})],x.prototype,"viewModel",void 0),e([o()],x.prototype,"onChange",void 0),e([o()],x.prototype,"disabled",void 0),e([o()],x.prototype,"isOpen",null),e([p()],x.prototype,"_setNextMonth",null),e([p()],x.prototype,"_setPreviousYear",null),e([p()],x.prototype,"_handleSelectedDate",null),x=e([n("esri.widgets.support.DatePicker")],x);const $=x;export{$ as default};
