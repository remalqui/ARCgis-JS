/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import t from"../../Color.js";import i from"../../core/Accessor.js";import{isSome as r}from"../../core/arrayUtils.js";import{createTask as s}from"../../core/asyncUtils.js";import"../../core/has.js";import o from"../../core/Handles.js";import{abortMaybe as n,destroyMaybe as a,applySome as l}from"../../core/maybe.js";import{after as u,throwIfAborted as p}from"../../core/promiseUtils.js";import{watch as d,syncAndInitial as c}from"../../core/reactiveUtils.js";import{createScreenPointArray as h,createRenderScreenPointArray as m}from"../../core/screenUtils.js";import{convertTime as f,offsetDateUTC as _}from"../../core/timeUtils.js";import{property as v}from"../../core/accessorSupport/decorators/property.js";import"../../core/accessorSupport/ensureType.js";import{subclass as y}from"../../core/accessorSupport/decorators/subclass.js";import{c as w}from"../../chunks/vec3f64.js";import{longitudeToTimezone as g}from"../../views/3d/support/earthUtils.js";import{computeDirectionsOverTime as T}from"../../views/3d/support/sunUtils.js";import{ShadowCastVisualization as D}from"../../views/3d/webgl-engine/shaders/ShadowCastVisualizeTechniqueConfiguration.js";import P from"./DiscreteOptions.js";import{DurationMode as b}from"./DurationMode.js";import O from"./DurationOptions.js";import{ShadowCastState as j}from"./ShadowCastState.js";import{ShadowTooltipViewModel as z}from"./ShadowTooltipViewModel.js";import{ShadowVisualizationType as U}from"./ShadowVisualizationType.js";import C from"./ThresholdOptions.js";import{breadthFirstBinaryPartitioning as V}from"../support/traversalUtils.js";const E=[],S=w(),A=[],R=255,N=f(1,"hours","milliseconds"),x=500;let M=class extends i{constructor(e){super(e),this.view=null,this.tooltip=new z({getDuration:(e,t)=>this.getDuration(e,t)}),this.startTimeOfDay=f(10,"hours","milliseconds"),this.endTimeOfDay=f(16,"hours","milliseconds"),this.visualizationType=U.Threshold,this.thresholdOptions=new C,this.durationOptions=new O,this.discreteOptions=new P,this._running=!0,this._handles=new o,this._stopPreviewingTask=null,this._forcePreview=!1,this._autoRestoreForcePreviewEnabled=!0,this._utcOffset=null,this.date=new Date}initialize(){this._handles.add([d((()=>({view:this.view,tooltipEnabled:this._tooltipEnabled})),(({view:e,tooltipEnabled:t})=>{this.tooltip.view=e,this.tooltip.enabled=t}),c),d((()=>this._forcePreviewDependencies),(()=>{n(this._stopPreviewingTask),this._forcePreview=!0,this._autoRestoreForcePreviewEnabled&&(this._stopPreviewingTask=s((async e=>{await u(x,e),p(e),this._forcePreview=!1})))}),c),d((()=>({renderer:this.renderer,parameters:this._visualizationParameters})),(e=>k(e.renderer,e.parameters)),c),d((()=>({renderer:this.renderer,parameters:{lightDirections:this._lightDirections}})),(e=>k(e.renderer,e.parameters)),c),d((()=>({renderer:this.renderer,parameters:{enabled:this._running}})),(e=>k(e.renderer,e.parameters)),c),d((()=>({renderer:this.renderer,parameters:{previewing:this._previewing}})),(e=>k(e.renderer,e.parameters)),c)])}destroy(){this.stop(),this._handles=a(this._handles),a(this.tooltip)}get state(){return null!=this.view&&this.view.ready&&null!=this._referencePosition?j.Ready:j.Disabled}set date(e){const t=new Date(e);t.setHours(0,0,0,0),this._set("date",t)}get utcOffset(){return this._utcOffset??this._utcOffsetAuto}set utcOffset(e){this._utcOffset=e}get testData(){return{setAutoRestoreForcedPreviewEnabled:e=>{this._autoRestoreForcePreviewEnabled=e},setForcedPreview:e=>{this._forcePreview=e},isPreviewing:()=>this._previewing}}get _previewing(){const{view:e}=this;return null==e||null==e.allLayerViews||(this._forcePreview||!e.stationary||e.allLayerViews.some((e=>F(e)&&e.updating)))}get _utcOffsetAuto(){const e=this._referencePosition;return null!=e?g(e[0],!1):0}get _dateUTCOffset(){let e=this.date;return e=_(e,-e.getTimezoneOffset(),"minutes"),e=_(e,-this.utcOffset,"hours"),e}get _startDateTimeUTC(){return _(this._dateUTCOffset,this.startTimeOfDay)}get _endDateTimeUTC(){return _(this._dateUTCOffset,this.endTimeOfDay)}get _referencePosition(){return l(this.view,(e=>l(e.environmentManager,(e=>e.referencePositionWGS84Comparable))))}get _interval(){const e=this._duration>0?Math.floor(this._duration/R):R,t=this.discreteOptions.interval;switch(this.visualizationType){case U.Threshold:case U.Duration:return e;case U.Discrete:return t>0?t:e}}get _sampleCount(){return this._lightDirections.length}get _duration(){return this.endTimeOfDay-this.startTimeOfDay}get _lightDirections(){const{view:e}=this;if(null==e)return E;const t="global"===e.viewingMode?S:this._referencePosition;if(null==t)return E;const i=this._interval,r=T(this._startDateTimeUTC,this._endDateTimeUTC,i,t,e.state.viewingMode),s=r.length;A.length=0;const o=V(0,s,A),n=new Array(s);for(let a=0;a<s;++a)n[a]=r[o[a]];return n}get _tooltipEnabled(){return this.state===j.Ready&&this.visualizationType!==U.Discrete&&this._running&&!this._previewing}get _visualizationParameters(){if(!this._running)return null;switch(this.visualizationType){case U.Threshold:return this._thresholdVisualizationParameters;case U.Duration:return this._durationVisualizationParameters;case U.Discrete:return this._discreteVisualizationParameters}}get _thresholdVisualizationParameters(){const{value:e,color:i}=this.thresholdOptions,r=this._duration;return{visualization:D.Threshold,color:t.toUnitRGBA(i),threshold:r>0?e/this._duration:0}}get _durationVisualizationParameters(){const{color:e,mode:i}=this.durationOptions,r=this._duration,s=r>0&&i===b.Hourly?N/r:0;return{color:t.toUnitRGBA(e),visualization:D.Gradient,bandsEnabled:s>0,bandSize:s}}get _discreteVisualizationParameters(){return{color:t.toUnitRGBA(this.discreteOptions.color),visualization:D.Gradient,bandsEnabled:!1,bandSize:0}}get _forcePreviewDependencies(){const{view:e}=this;if(null==e)return null;const t=e.slicePlane,i=e.allLayerViews.toArray().filter(F),s=i.map((e=>e.layer)).filter(r),o=i.map((e=>e.visible)),n=s.map((e=>e.visible)),a=s.map((e=>e.opacity)),l=s.filter((e=>"definitionExpression"in e)).map((e=>e.definitionExpression)),u=i.filter((e=>"filter"in e)).map((e=>e.filter));return{slicePlane:t,startDateUTC:this._startDateTimeUTC,endDateUTC:this._endDateTimeUTC,layerViewVisibilities:o,layerVisibilities:n,layerOpacities:a,filters:u,definitionExpressions:l}}get renderer(){const{view:e}=this;if(null==e)return null;const t=e._stage;return null==t?null:t.renderer}start(){this._running=!0}stop(){this._running=!1}setRunning(e){this._running=e}async getDuration(e,t){const{view:i,renderer:r}=this;if(null==i||null==r)return 0;const s=i.state.camera.screenToRender(h(e.x,e.y),m()),o=r.readAccumulatedShadow(s),n=this._sampleCount;if(0===n)return 0;return o*n*(this._duration/n)}};function k(e,t){null!=e&&null!=t&&e.setParameters({shadowCastOptions:t})}function F(e){if(e.suspended)return!1;switch(e.type){case"building-scene-3d":case"csv-3d":case"elevation-3d":case"feature-3d":case"geojson-3d":case"graphics-3d":case"integrated-mesh-3d":case"ogc-feature-3d":case"route-3d":case"scene-layer-3d":case"scene-layer-graphics-3d":case"stream-3d":case"wms-3d":return!0;case"base-dynamic-3d":case"dimension-3d":case"imagery-3d":case"imagery-tile-3d":case"line-of-sight-3d":case"map-image-3d":case"point-cloud-3d":case"tile-3d":case"vector-tile-3d":case"voxel-3d":case"wfs-3d":case"wmts-3d":case"media-3d":default:return!1;case"group":return e.layerViews.toArray().some((e=>F(e)))}}e([v()],M.prototype,"state",null),e([v()],M.prototype,"view",void 0),e([v()],M.prototype,"tooltip",void 0),e([v({nonNullable:!0})],M.prototype,"date",null),e([v({nonNullable:!0})],M.prototype,"utcOffset",null),e([v({nonNullable:!0})],M.prototype,"startTimeOfDay",void 0),e([v({nonNullable:!0})],M.prototype,"endTimeOfDay",void 0),e([v({nonNullable:!0})],M.prototype,"visualizationType",void 0),e([v({type:C,nonNullable:!0})],M.prototype,"thresholdOptions",void 0),e([v({type:O,nonNullable:!0})],M.prototype,"durationOptions",void 0),e([v({type:P,nonNullable:!0})],M.prototype,"discreteOptions",void 0),e([v()],M.prototype,"_running",void 0),e([v()],M.prototype,"_handles",void 0),e([v()],M.prototype,"_stopPreviewingTask",void 0),e([v()],M.prototype,"_forcePreview",void 0),e([v()],M.prototype,"_autoRestoreForcePreviewEnabled",void 0),e([v()],M.prototype,"_previewing",null),e([v()],M.prototype,"_utcOffset",void 0),e([v()],M.prototype,"_utcOffsetAuto",null),e([v()],M.prototype,"_dateUTCOffset",null),e([v()],M.prototype,"_startDateTimeUTC",null),e([v()],M.prototype,"_endDateTimeUTC",null),e([v()],M.prototype,"_referencePosition",null),e([v()],M.prototype,"_interval",null),e([v()],M.prototype,"_sampleCount",null),e([v()],M.prototype,"_duration",null),e([v()],M.prototype,"_lightDirections",null),e([v()],M.prototype,"_tooltipEnabled",null),e([v()],M.prototype,"_visualizationParameters",null),e([v()],M.prototype,"_thresholdVisualizationParameters",null),e([v()],M.prototype,"_durationVisualizationParameters",null),e([v()],M.prototype,"_discreteVisualizationParameters",null),e([v()],M.prototype,"_forcePreviewDependencies",null),e([v()],M.prototype,"renderer",null),M=e([y("esri.widgets.ShadowCast.ShadowCastViewModel")],M);const G=M;export{G as default};
