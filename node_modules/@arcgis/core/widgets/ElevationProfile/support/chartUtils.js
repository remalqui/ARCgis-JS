/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import"../../../intl.js";import{binaryFindClosest as i}from"../../../core/arrayUtils.js";import t from"../../../core/Error.js";import{handlesGroup as e,makeHandle as o}from"../../../core/handleUtils.js";import{applySome as n}from"../../../core/maybe.js";import{throwIfAborted as a}from"../../../core/promiseUtils.js";import{formatDecimal as s,unitName as l}from"../../../core/unitFormatUtils.js";import{convertUnit as r}from"../../../core/unitUtils.js";import{CHART_CSS as d}from"../css.js";import{getConfig as c,NOT_AVAILABLE as u}from"./constants.js";import{getTranslatedLineTitle as m}from"./intlUtils.js";import{niceScale as x}from"./niceScale.js";import{loadChartsModule as p}from"../../support/chartUtils.js";import{isRTL as f}from"../../support/widgetUtils.js";import{isDarkTheme as g}from"../../../support/themeUtils.js";import{substitute as h}from"../../../intl/substitute.js";import{formatNumber as b}from"../../../intl/number.js";const v="#f8f8f8",T="#a9a9a9",A="#323232",C="line",y="fill",L=15,z=12,k=30,P=.001,S=.5,w=.5,F=30,M=.02,Y=.02,X={sideSpacing:L,paddingBottom:0,paddingLeft:0,paddingRight:0,paddingTop:0,axisFontSize:9,axisFontWeight:"400",axisGridStroke:"#f4f4f4",axisLabelsFontSize:9,axisLabelsFontWeight:"400",axisLabelsColor:T,axisTooltipFontSize:12,axisTooltipBackgroundColor:A,axisTooltipLabelColor:v,axisTooltipPaddingTop:Math.round(z/4),axisTooltipPaddingBottom:Math.round(z/4),axisTooltipPaddingHorizontal:Math.round(L/4),xAxisMinGridDistance:50,xAxisLabelsSpacing:Math.round(z/2),xAxisMinLabelPosition:.05,xAxisMaxLabelPosition:.9,yAxisMinGridDistance:30,yAxisLabelSpacing:Math.round(L/4),yAxisMinLabelPosition:0,yAxisMaxLabelPosition:.8,seriesTooltipFontSize:12,seriesTooltipBackgroundColor:v,seriesTooltipLabelColor:A,seriesFillLighten:.9,seriesTooltipSpacing:z/2,seriesTooltipPaddingVertical:Math.round(L/4),seriesTooltipPaddingHorizontal:Math.round(L/4),tooltipBorderRadius:0},I={...X,axisGridStroke:A,axisLabelsColor:T,axisTooltipBackgroundColor:A,axisTooltipLabelColor:v,seriesTooltipBackgroundColor:A,seriesTooltipLabelColor:v,seriesFillLighten:-.75},W={minX:void 0,maxX:void 0,minY:void 0,maxY:void 0};async function j(i){const o=await p();if(!o)throw new t("elevation-profile:load-failed","Could not load amCharts");const{am4core:n,am4charts:s}=o;a(i.abortOptions);const{options:l}=n;l.minPolylineStep=S,l.autoSetClassName=!0,l.animationsEnabled=!1;const r=g(),d=r?I:X;r&&n.useTheme(o.am4themes_dark);const c=n.create(i.container,s.XYChart);c.arrangeTooltips=!1,c.preloader.disabled=!0,c.zoomOutButton.disabled=!0;const u=f(i.container);c.rtl=u,c.padding(d.paddingTop,u?d.paddingLeft:d.paddingRight,d.paddingBottom,u?d.paddingRight:d.paddingLeft);const m=c.plotContainer.background;m.strokeWidth=0,m.strokeOpacity=0,m.stroke=null;const x=c.xAxes.push(new s.ValueAxis),h=c.yAxes.push(new s.ValueAxis),b={params:i,amCharts4Index:o,amChart:c,xAxis:x,yAxis:h,series:new Map,data:null,messages:null,theme:d,zooming:!1,pointerIsOver:!1};c.cursor=H(b),D(b),E(b),O(b);const v=[J(b,i.onRangeChange),Q(b,i.onCursorPositionChange),K(b)];let T=null,A=!1;const C=()=>{null!=T&&("undefined"!=typeof window&&"cancelIdleCallback"in window?window.cancelIdleCallback(T):clearTimeout(T),T=null)};return{...b,destroy(){A=!0,C(),e(v).remove(),c.dispose()},update(i){if(i.data===b.data&&i.messages===b.messages)return;if(C(),A)return;const t=()=>{A||(T=null,U(b,i))};T="undefined"!=typeof window&&"requestIdleCallback"in window?window.requestIdleCallback(t,{timeout:F}):setTimeout(t,F)},zoomOut(){A||(b.yAxis.zoom({start:0,end:1},!1,!0),b.xAxis.zoom({start:0,end:1},!1,!0))}}}function H(i){const t=new i.amCharts4Index.am4charts.XYCursor;return t.trackable=!0,t.lineY.disabled=!0,t.behavior="zoomXY",t}function D(i){const t=i.theme,e=i.amChart.tooltip,{am4core:o}=i.amCharts4Index;e.id="series-tooltip",e.fitPointerToBounds=!0,e.pointerOrientation="vertical",e.zIndex=-1,e.getFillFromObject=!1,e.label.fontSize=t.seriesTooltipFontSize,e.label.fill=o.color(t.seriesTooltipLabelColor),e.label.padding(t.seriesTooltipPaddingVertical,t.seriesTooltipPaddingHorizontal,t.seriesTooltipPaddingVertical,t.seriesTooltipPaddingHorizontal),e.background.cornerRadius=t.tooltipBorderRadius,e.background.stroke=null,e.background.fill=o.color(t.seriesTooltipBackgroundColor),e.background.padding(0,0,0,0),e.adapter.add("dy",(()=>t.seriesTooltipSpacing*(e.background.pointerY<=0?1:-1))),f(i.params.container)&&(e.label.textAlign="middle")}function E(i){const{xAxis:t,theme:e}=i,{am4core:o}=i.amCharts4Index;t.numberFormatter=si(i,"distance"),t.strictMinMax=!0,t.cursorTooltipEnabled=!1,t.title.visible=!1;const n=t.renderer;n.line.visible=!1,n.minGridDistance=e.xAxisMinGridDistance,n.minLabelPosition=e.xAxisMinLabelPosition,n.maxLabelPosition=e.xAxisMaxLabelPosition,n.fontWeight=e.axisFontWeight,n.fontSize=e.axisFontSize,n.baseGrid.disabled=!0;const a=n.labels.template;a.fontSize=e.axisLabelsFontSize,a.fontWeight=e.axisLabelsFontWeight,a.fill=o.color(e.axisLabelsColor),a.paddingTop=e.xAxisLabelsSpacing,a.horizontalCenter="left",a.paddingLeft=0;const s=t.tooltip;s.id="axis-tooltip",s.background.fill=o.color(e.axisTooltipBackgroundColor),s.background.stroke=null,s.background.padding(0,0,0,0),s.label.fontSize=e.axisTooltipFontSize,s.label.fill=o.color(e.axisTooltipLabelColor),s.label.padding(e.axisTooltipPaddingTop,e.axisTooltipPaddingHorizontal,e.axisTooltipPaddingBottom,e.axisTooltipPaddingHorizontal);const l=n.grid.template;l.strokeOpacity=1,l.stroke=o.color(e.axisGridStroke)}function O(i){const{yAxis:t,theme:e}=i,{am4core:o}=i.amCharts4Index;t.numberFormatter=si(i,"elevation"),t.title.visible=!1,t.cursorTooltipEnabled=!1,t.strictMinMax=!0,t.baseValue=c().noDataValue;const n=t.renderer;n.inside=!0,n.line.opacity=0,n.line.visible=!1,n.minGridDistance=e.yAxisMinGridDistance,n.minLabelPosition=e.yAxisMinLabelPosition,n.maxLabelPosition=e.yAxisMaxLabelPosition,n.fontWeight=e.axisFontWeight,n.fontSize=e.axisFontSize,n.baseGrid.disabled=!0;const a=n.labels.template;a.fontSize=e.axisLabelsFontSize,a.fontWeight=e.axisLabelsFontWeight,a.fill=o.color(e.axisLabelsColor),a.verticalCenter="bottom",a.paddingLeft=e.yAxisLabelSpacing,a.paddingBottom=0;const s=n.grid.template;s.strokeOpacity=1,s.stroke=o.color(e.axisGridStroke),f(i.params.container)&&(n.opposite=!0,a.textAlign="middle",a.paddingLeft=0,a.paddingRight=e.yAxisLabelSpacing)}function U(i,{data:t,messages:e}){const{htmlContainer:o}=i.amChart;if(!o)return;const a=null!=t&&t.refined;i.amChart.cursor.disabled=!a,o.classList.toggle(d.cursorEnabled,a);const s=i.data!==t,l=n(i.data,(i=>i.effectiveUnits))!==n(t,(i=>i.effectiveUnits));i.data=t,i.messages=e,s&&(B(i),Z(i)),l&&(i.yAxis.invalidateLabels(),i.xAxis.invalidateLabels()),ti(i)}function B(i){const{xAxis:t,yAxis:e}=i,{minX:o,maxX:n,minY:a,maxY:s}=G({data:i.data,pixelWidth:t.pixelWidth,pixelHeight:e.pixelHeight});t.min=o,t.max=n,e.min=a,e.max=s}function G({data:i,pixelWidth:t,pixelHeight:e}){if(null==i)return W;const o=i.statistics,a=0,s=n(o,(i=>i.maxDistance));let l=n(o,(i=>i.minElevation)),d=n(o,(i=>i.maxElevation));if(null==s||null==l||null==d)return W;const u=Math.max(s-a,P);let m=Math.max(d-l,P);const p=i.effectiveUnits;if(i.dynamicElevationRange){const i=r(u,p.distance,p.elevation);m=Math.max(m,i/c().maxChartRatio)}return l-=Y*m,d=l+m+M*m,[l,d]=x(l,d,10),m=d-l,i.uniformScaling?R({data:i,bounds:{minX:a,maxX:s,minY:l,maxY:d},pixelWidth:t,pixelHeight:e,centered:!0}):{minX:a,maxX:a+u,minY:l,maxY:l+m}}function R({data:i,bounds:t,pixelWidth:e,pixelHeight:o,centered:n}){if(null==i)return t;let{minX:a,maxX:s,minY:l,maxY:d}=t;if(null==a||null==s||null==l||null==d)return W;const c=s-a,u=d-l,m=i.effectiveUnits,x=r(u,m.elevation,m.distance)/o/(c/e);return x>=1?[a,s]=V([a,s],x,n):[l,d]=V([l,d],1/x,n),{minX:a,maxX:s,minY:l,maxY:d}}function V([i,t],e,o){const n=(t-i)*e;if(o){const e=(i+t)/2-n/2;return[e,e+n]}return[i,i+n]}function Z(i){const{amChart:t,data:e}=i;if(null==e||0===e.lines.length)return void t.series.clear();const o=new Map,a=new Set(t.series.values),s=e.lines.length;for(let l=0;l<s;l++){const r=e.lines[l];let d=i.series.get(r.id);d?(n(d.fill,(i=>a.delete(i))),a.delete(d.line)):(d=N(i,r),n(d.fill,(i=>t.series.push(i))),t.series.push(d.line)),o.set(d.id,d);const c=s-l-1;n(d.fill,(i=>i.zIndex=c)),d.line.zIndex=s+c,$(i,d,r)}i.series=o;for(const n of a)t.series.removeValue(n)}function $(i,{line:t,fill:e},o){const{theme:a}=i,{am4core:s}=i.amCharts4Index,{r:l,g:r,b:d,a:c}=o.color,u=s.color({r:l,g:r,b:d,a:c}),m=o.samples??new Array,x=m.length>0;t.stroke=u,t.visible=x,n(e,(i=>{i.visible=x,i.fill=u.lighten(a.seriesFillLighten)}));const p=m.length,f=t.data;if(f.length===p){let i=!1;for(let t=0;t<p;++t){const e=f[t],o=m[t];i=i||null!=e.elevation!=(null!=o.elevation),q(e,o)}i?(t.invalidateData(),n(e,(i=>i.invalidateData()))):(t.invalidateRawData(),n(e,(i=>i.invalidateRawData())))}else t.data=m,n(e,(i=>i.data=m))}function q(i,t){i.x=t.x,i.y=t.y,i.z=t.z,i.distance=t.distance,i.elevation=t.elevation}function N(i,t){const{id:e}=t,o=_(i,`${C}-${e}`);o.strokeWidth=t.chartStrokeWidth,o.dy=t.chartStrokeOffsetY;let n=null;return t.chartFillEnabled&&(n=_(i,`${y}-${e}`),n.fillOpacity=1),{id:e,line:o,fill:n}}function _(i,t){const e=new i.amCharts4Index.am4charts.LineSeries;e.id=t,e.showOnInit=!1,e.simplifiedProcessing=!0,e.minDistance=w,e.excludeFromTotal=!0,e.clickable=!1,e.contextMenuDisabled=!0,e.cursorHoverEnabled=!1,e.cursorTooltipEnabled=!1,e.connect=!1,e.fill=null,e.stroke=null;const o="distance";e.dataFields.valueX=o;const n="elevation";return e.dataFields.valueY=n,e}function J(i,t){const{amChart:e,xAxis:n,yAxis:a}=i;let s=!1;const l=()=>{const{data:t}=i;if(!s||null==t||!t.uniformScaling)return;s=!1;const{minX:o,maxX:l,minY:r,maxY:d}=R({data:i.data,bounds:{minX:n.minZoomed,maxX:n.maxZoomed,minY:a.minZoomed,maxY:a.maxZoomed},pixelWidth:n.pixelWidth,pixelHeight:a.pixelHeight,centered:!0});null!=o&&null!=l&&n.zoomToValues(o,l,!0),null!=r&&null!=d&&a.zoomToValues(r,d,!0),e.validate(),ti(i)},r=()=>{t(i.xAxis.zoomFactor,i.yAxis.zoomFactor)},d=t=>{i.zooming=t,ti(i)},c=[e.events.on("down",(()=>d(!0))),e.events.on("up",(()=>d(!1))),e.cursor.events.on("zoomended",(()=>{s=!0})),n.events.on("startendchanged",l),a.events.on("startendchanged",l),n.events.on("rangechangeended",r),a.events.on("rangechangeended",r)];return o((()=>{c.forEach((i=>i.dispose()))}))}function K({xAxis:i,yAxis:t}){const e=i=>()=>{i.renderer.grid.each((i=>{i.visible="none"!==i.dataItem.label.dom.getAttribute("display")}))},n=[i.events.on("rangechangeended",e(i)),i.events.on("validated",e(i)),t.events.on("rangechangeended",e(t)),t.events.on("validated",e(t))];return o((()=>{n.forEach((i=>i.dispose()))}))}function Q(i,t){const{amChart:e,xAxis:n,yAxis:a}=i,{cursor:s,events:l}=e,r=t=>{i.pointerIsOver=t,ti(i)},d=()=>{r(!1),t(null,null)},c=[s.events.on("cursorpositionchanged",(()=>{if(!i.pointerIsOver)return;ti(i);let e=n.toAxisPosition(s.xPosition),o=a.toAxisPosition(s.yPosition);const l=i.data;if(null!=l&&null!=l.statistics){const{maxDistance:i,minElevation:t,maxElevation:s}=l.statistics;null!=i&&(e=ii(e,n.minZoomed,n.maxZoomed,0,i)),null!=t&&null!=s&&(o=ii(o,a.minZoomed,a.maxZoomed,t,s))}t(e,o)})),l.on("over",(()=>r(!0))),l.on("out",d),l.on("blur",d)];return o((()=>{c.forEach((i=>i.dispose()))}))}function ii(i,t,e,o,n){return(t+i*(e-t)-o)/(n-o)}function ti(i){const{amChart:t,xAxis:e,data:o,theme:n,zooming:a,pointerIsOver:s}=i;if(i.amChart.tooltip.hide(),i.xAxis.hideTooltip(),!s)return;if(a)return;if(null==o||!o.refined)return;const l=ei(i);if(null!=l){const{cursor:o}=t,a=t.tooltip;o.show(0),o.validate(),a.text=l.text,a.show(0),a.validate();const s=l.y-a.contentHeight-n.seriesTooltipSpacing;a.pointerOrientation=s<k?"up":"down",a.pointTo(l,!0),a.validate();const r=e.tooltip;r.text=ai(i),r.show(0),r.validate()}}function ei(i){const{amChart:t,yAxis:e,data:o}=i;if(null==o)return null;const a=o.lines.map((t=>({line:t,y:n(li(i,t),(i=>i.elevation))}))).sort(oi),s=a.length?a[0].y:null;if(null==s)return null;const l=t.cursor,r=e.measuredHeight,d=r+t.pixelPaddingTop;return{text:a.map((({y:t,line:e})=>ni(i,e,t))).join("\n"),x:l.point.x+l.parent.pixelX+t.pixelPaddingLeft,y:d-e.valueToPosition(s)*r}}function oi({y:i},{y:t}){return null==i?1:null==t?-1:t-i}function ni(i,t,e){const{data:o,messages:n}=i;if(null==o||null==n)return"";const a=c().formatPrecision,l=h(n.chartTooltip,{name:m(t,n),elevation:null!=e?s(n,e,o.effectiveUnits.elevation,a):u});return`[${t.color.toHex()}]●[/] ${l}`}function ai(i){const{data:t,messages:e}=i;if(null==t||null==e)return"";const o=t.lines[0],n=o?li(i,o):null,a=c().formatPrecision;return null!=n?s(e,n.distance,t.effectiveUnits.distance,a):"-"}function si(i,t){const e=i.xAxis.numberFormatter.clone();return e.format=(e,o,n)=>{const{messages:a,data:s}=i;if(null==a||null==s||"string"==typeof e)return"";return`${b(e,{maximumFractionDigits:n})} ${l(a,s.effectiveUnits[t],"abbr")}`},e}function li({amChart:t,xAxis:e},o){const n=o.samples??[];if(0===n.length)return null;const a=e.toAxisPosition(t.cursor.xPosition),s=e.positionToValue(a);return i(n,s,(i=>i.distance))}export{j as createChart,G as getAdjustedBounds};
