/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import{remove as t}from"../../core/arrayUtils.js";import{makeHandle as a,handlesGroup as i}from"../../core/handleUtils.js";import{removeMaybe as r,destroyMaybe as n}from"../../core/maybe.js";import{throwIfAborted as o}from"../../core/promiseUtils.js";import{whenOnce as s,watch as l,syncAndInitial as c}from"../../core/reactiveUtils.js";import{generateBracedUUID as d}from"../../core/uuid.js";import{property as u}from"../../core/accessorSupport/decorators/property.js";import"../../core/accessorSupport/ensureType.js";import"../../core/has.js";import{subclass as h}from"../../core/accessorSupport/decorators/subclass.js";import{getEffectiveLayerCapabilities as p,getEffectiveEditingEnabled as f,isTable as m}from"../../layers/support/layerUtils.js";import{getDrawHelpMessage as g}from"../../views/draw/support/helpMessageUtils.js";import w from"../../views/interactive/snapping/FeatureSnappingLayerSource.js";import{CreateFeaturesWorkflowData as v}from"./CreateFeaturesWorkflowData.js";import{isModelUpload as y,waitForModelUpload as _}from"./modelUploadUtils.js";import b from"./Workflow.js";import{shouldShowAttachmentsForCreateWorkflow as F,startCreatingNewFeature as I,findLayerInfo as M,updateGraphicSymbolWhenRequired as A,isTerminalUpdateEventType as k,getVisualVariableAttributes as C,startUpdatingFeature as V,createWorkflowSteps as S,avoidFeatureTemplateSelectionWithOnlyOneItem as j,showProgressCursor as E,visualVariableInteractiveUpdate as U,prepareAttachmentsForCreateWorkflow as H}from"./workflowUtils.js";var G;const O=Symbol(),D=Symbol();let P=G=class extends b{constructor(e){super(e),this.type="create-features",this.createFeatureState="create-new",this._featureFormHandle=null,this._visualVariableAttributes={rotation:null,size:null},this._attachmentFileInfos=new Map,this._highlightHandles=new Map,this._preventDefaultActionOnCancel=!1,this._lastActiveGraphics=[]}get hasPendingEdits(){if(this.numPendingFeatures)return!0;const{data:e}=this,{upload:t}=e;return!(!t||t.error)||!!e.creationInfo?.geometryToPlace}get helpMessage(){const{creationInfo:e,viewModel:t}=this.data;if("creating-features"!==this.stepId||!e)return;const a=e.layer.geometryType,i=t.sketchViewModel.createGraphic?.geometry;return g(a,i,t.view)}get numPendingFeatures(){return this.pendingFeatures.length}get pendingFeatures(){return this.data.pendingFeatures}get keyboardCancellationEnabled(){return 0===this.numPendingFeatures}get reliesOnOwnerAdminPrivileges(){const{creationInfo:e}=this.data;if(!e)return!1;const{layer:t}=e,a=t.capabilities?.operations.supportsAdd,i=p(t)?.operations.supportsAdd;return f(t)&&!t.editingEnabled||!!i&&!a}get shouldShowAttachments(){return!!(this.data&&this.data.creationInfo&&this.data.viewModel)&&F(this.data)}get shouldAllowAttachmentEditing(){return this.shouldShowAttachments}get updating(){return this.updatingHandles.updating}get test(){return{addAttachment:(e,t)=>{this._attachmentFileInfos.set(e,t)}}}async enter(){const{featureFormViewModel:e}=this.data.viewModel,t=e.relatedRecordCallbacks;e.relatedRecordCallbacks=null,this.addHandles(a((()=>{e.relatedRecordCallbacks=t})),D)}exit(){this.removeHandles(D)}async updatePendingFeature(e,a){return this._preventDefaultActionOnCancel=!0,this.data.viewModel.sketchViewModel.cancel(),t(this._lastActiveGraphics,e),this._startUpdating(e,a)}static create(e){const{addAttachmentsCallback:t,applyEditsCallback:a,creationInfo:i,startAt:r,viewModel:n}=e,o=new G({data:new v({creationInfo:i,viewModel:n}),onCommit:async e=>{const{creationInfo:i}=e;if(!i)return;i.geometryToPlace&&(e.creationInfo=null);const r=e.pendingFeatures.toArray(),{layer:n}=i,s=n.capabilities?.editing.supportsGlobalId&&"globalIdField"in n,l=o._attachmentFileInfos;if(s){const e=W(r,n,l);return void await a(n,e,{globalIdUsed:!0})}const c=await a(n,{addFeatures:r});if(l.size>0){const e=c?.addFeatureResults??[];await t(n,x(r,e,n,l))}}});return o._set("steps",this._createWorkflowSteps(o,r)),o}_fadeExistingFeatures(e){if("effect"in e){const t=e.effect;return e.effect="saturate(0.6) opacity(0.8)",a((()=>e.effect=t))}const t=e.opacity;return e.opacity=.7,a((()=>e.opacity=t))}_highlight(e){const t=this.data.viewModel.view;"3d"===t?.type&&this._highlightHandles.set(e,t.highlight(e))}_removeHighlight(e){r(this._highlightHandles.get(e)),this._highlightHandles.delete(e)}async _startCreating(e){const{data:t}=this,{creationInfo:a}=t;if(a)return this.createFeatureState="create-new",I(t.viewModel.sketchViewModel,a,e)}async _startUpdating(e,t){const{pendingFeatures:a}=this;a.includes(e)||a.add(e);const{creationInfo:n,viewModel:o}=this.data,{featureFormViewModel:s,layerInfos:l,sketchViewModel:c,view:d}=o;if(!d||!n)return;const u=n.layer,h=M(l,u),p=h?.formTemplate,f=d.spatialReference;return s.set({arcadeEditType:"INSERT",feature:e,formTemplate:p,spatialReference:f,map:d.map}),this._removeHighlight(e),await A(e,t),r(this._featureFormHandle),this._featureFormHandle=i([s.on("value-change",(async()=>{e.attributes=s.getValues(),await A(e,t)})),c.on(["update","undo","redo"],(e=>{("undo"===e.type||"redo"===e.type||"update"===e.type&&null!=e.toolEventInfo&&k(e.toolEventInfo.type))&&s.notifyFeatureGeometryChanged()}))]),this.createFeatureState="update-pending",this._visualVariableAttributes=C(e),m(u)?void 0:V({graphic:e,sketchViewModel:c,sourceLayer:u,visualVariables:this._visualVariableAttributes,webStyleCache:t})}static _createWorkflowSteps(e,t="awaiting-feature-creation-info"){const{data:a,handles:i}=e,n=S(["awaiting-feature-creation-info","creating-features","adding-attachment","editing-attachment"],t,{"awaiting-feature-creation-info":()=>({id:"awaiting-feature-creation-info",async setUp(t){const{creationInfo:r,viewModel:n}=a,{view:s}=n;if(s)if(y(r)){const r=await _({view:s,data:a,signal:t,next:()=>e.next(),cancel:()=>n.cancelWorkflow()});o(t),i.add(r,this.id)}else a.creationInfo=null,i.add(n.featureTemplatesViewModel.on("select",(({item:e})=>{e&&(a.creationInfo=e,n.activeWorkflow?.next())})),this.id)},async tearDown(){i.remove(this.id)}}),"creating-features":()=>({id:"creating-features",async setUp(){if(i.has(this.id))return;const{viewModel:t}=a,{view:n}=t;if(!n)return;const o=new Map,s=[],c=[];e._lastActiveGraphics=[],e._featureFormHandle=r(e._featureFormHandle),e._visualVariableAttributes={rotation:null,size:null},H(t.attachmentsViewModel),s.push(l((()=>t.attachmentsViewModel.mode),(t=>{switch(t){case"add":e.go("adding-attachment");break;case"edit":e.go("editing-attachment")}})));const d=E(n);s.push(d);const u=m(e.data.creationInfo?.layer);try{if(!u){const t=G._configureSketchViewModel(e,o);s.push(t.beforeCommit),c.push(t.afterCommit)}const i=a.creationInfo?.initialFeature;i?(u||t.sketchViewModel.layer.add(i),await e._startUpdating(i,o)):await e._startCreating(o)}finally{d.remove()}s.push(e._featureFormHandle),i.add(s,e._handleKeys.beforeCommit),i.add([...s,...c],this.id)},async tearDown(t){const{viewModel:r}=a;if(t.canceled){const{pendingFeatures:t}=e;t.drain((e=>r.sketchViewModel.layer.remove(e))),i.remove([this.id,O]),r.attachmentsViewModel.fileInfos.removeAll(),e._attachmentFileInfos.clear()}}}),"adding-attachment":()=>({id:"adding-attachment",parent:"creating-features",async setUp(){},async tearDown(){const{attachmentsViewModel:t}=a.viewModel,{graphic:i,fileInfos:r}=t;e._attachmentFileInfos.set(i,r.toArray()),t.mode="view"}}),"editing-attachment":()=>({id:"editing-attachment",parent:"creating-features",async setUp(){},async tearDown(){const{attachmentsViewModel:t}=a.viewModel,{graphic:i,fileInfos:r}=t;e._attachmentFileInfos.set(i,r.toArray()),t.mode="view"}})});return j(a,n)}static _configureSketchViewModel(e,r){const{data:n,handles:o}=e,{viewModel:l}=n,{view:c}=l,d=l.sketchViewModel;let u=null;const h=[];if(!c)return{beforeCommit:a(),afterCommit:a()};const p=d.updateOnGraphicClick;return d.updateOnGraphicClick=!1,"2d"===c.type&&n.creationInfo&&h.push(e._fadeExistingFeatures(n.creationInfo.layer)),h.push(d.on("create",(async t=>{if("cancel"===t.state){if(e._preventDefaultActionOnCancel)return void(e._preventDefaultActionOnCancel=!1);if(e._lastActiveGraphics.length<1)return e._startCreating(r);const t=e._lastActiveGraphics.pop();return e._startUpdating(t,r)}if("complete"===t.state&&t.graphic)return e._startUpdating(t.graphic,r)})),d.on("update",(async t=>{const{viewModel:a}=n,{attachmentsViewModel:i,featureFormViewModel:l}=a,d=t.graphics[0];if("complete"===t.state){if(d!==u&&(e._lastActiveGraphics.push(d),e._highlight(d)),u=null,e.numPendingFeatures===n.creationInfo?.maxFeatures){const t=e._lastActiveGraphics.pop();return e._startUpdating(t,r)}if("add"!==i.mode&&"edit"!==i.mode||a.activeWorkflow?.previous(),t.aborted&&e._preventDefaultActionOnCancel)return void(e._preventDefaultActionOnCancel=!1);o.add([E(c),c.on("click",(e=>e.preventDefault()))],O),await s((()=>!l.updating)),o.remove(O),e._startCreating(r)}if("start"===t.state){e._removeHighlight(d),"add"!==i.mode&&"edit"!==i.mode||a.activeWorkflow?.previous(),i.fileInfos.removeAll(),i.graphic=d,i.mode="view";(e._attachmentFileInfos.get(d)||[]).forEach((({file:e,form:t})=>i.addFile(e,t)))}const h=e._visualVariableAttributes;await U(c,d,t,h,r);const p=d.attributes,{rotation:f,size:m}=h;if(null!=f){const{field:e}=f;l.setValue(e,p[e])}if(null!=m){const{field:e}=m;l.setValue(e,p[e])}})),d.on("delete",(async a=>{const i=a.graphics[0];e.pendingFeatures.remove(i),t(e._lastActiveGraphics,i),u=i})),c.on("immediate-click",(async t=>{if(y(n.creationInfo))return;const{results:a}=await c.hitTest(t,{include:d.layer}),i=a.find((e=>"graphic"===e.type));if(!i)return;const o=i.graphic;if("transform"===d.activeTool||"reshape"===d.activeTool){if(d.updateGraphics.at(0)===o)return;await e.updatePendingFeature(o,r)}})),a((()=>d.cancel())),T(d,n)),{beforeCommit:i(h),afterCommit:a((()=>{d.updateOnGraphicClick=p}))}}};function T(e,t){let r=null;const o=()=>e.snappingOptions.featureSources,s=()=>(r=new w({layer:e.layer}),o().add(r),r),d=()=>{null!=r&&(o().remove(r),r=n(r))};return i([l((()=>{const e=t.creationInfo?.layer,a=o().find((t=>t.layer===e));return{hasFeatureLayerSource:!!a,enabled:a?.enabled??!1}}),(({hasFeatureLayerSource:e,enabled:t})=>{if(!e)return d();r??=s(),r.enabled=t}),c),a(d)])}function x(e,t,a,i){const r=[];return t.forEach(((t,n)=>{if(!t.error){const o=e[n],s=i.get(o)||[];o.attributes[a.objectIdField]=t.objectId,s.forEach((({form:e})=>r.push({feature:o,attachment:e})))}})),r}function W(e,t,a){const i=[],r=t.globalIdField;return e.forEach(((t,n)=>{e[n].attributes[r]??=d(),(a?.get(t)||[]).forEach((({file:e})=>i.push({feature:t,attachment:{globalId:d(),data:e}})))})),i.length?{addFeatures:e,addAttachments:i}:{addFeatures:e}}e([u()],P.prototype,"hasPendingEdits",null),e([u()],P.prototype,"helpMessage",null),e([u()],P.prototype,"keyboardCancellationEnabled",null),e([u()],P.prototype,"reliesOnOwnerAdminPrivileges",null),e([u()],P.prototype,"shouldShowAttachments",null),e([u()],P.prototype,"shouldAllowAttachmentEditing",null),e([u()],P.prototype,"updating",null),P=G=e([h("esri.widgets.Editor.CreateFeaturesWorkflow")],P);const R=P;export{R as default};
