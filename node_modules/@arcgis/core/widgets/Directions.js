/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{_ as e}from"../chunks/tslib.es6.js";import"../intl.js";import{on as t,pausable as s}from"../core/events.js";import{assertIsSome as i}from"../core/maybe.js";import{watch as r,initial as o,when as n,on as a}from"../core/reactiveUtils.js";import{property as l}from"../core/accessorSupport/decorators/property.js";import{cast as c}from"../core/accessorSupport/decorators/cast.js";import"../core/arrayUtils.js";import"../core/has.js";import{subclass as d}from"../core/accessorSupport/decorators/subclass.js";import{defaultUnitPropertyMetadata as u}from"../properties/defaultUnit.js";import h from"../rest/support/Stop.js";import p from"../symbols/SimpleMarkerSymbol.js";import v from"./Search.js";import m from"./Widget.js";import _ from"./Directions/DirectionsViewModel.js";import{SaveLayer as g}from"./Directions/components/SaveLayer.js";import{formatDistance as S,formatDuration as y}from"./Directions/support/directionsUtils.js";import{DepartureTimeOption as w,CSS as M,getIconPath as f}from"./Directions/support/resources.js";import{isArcGISWorldGeocoder as b,meteredArcGISLocatorUrl as T}from"./Search/support/locatorUtils.js";import{loadCalciteComponents as C}from"./support/componentsUtils.js";import k from"./support/DatePicker.js";import{Heading as D,incrementHeadingLevel as I}from"./support/Heading.js";import P from"./support/TimePicker.js";import{accessibleHandler as R}from"./support/decorators/accessibleHandler.js";import{messageBundle as L}from"./support/decorators/messageBundle.js";import{tsx as B}from"./support/jsxFactory.js";import"./support/widgetUtils.js";import H from"sortablejs";import{formatNumber as A}from"../intl/number.js";import{formatDate as E,convertDateFormatToIntlOptions as j}from"../intl/date.js";const x={departureTime:!0,layerDetails:!0,printButton:!1,saveAsButton:!0,saveButton:!0,stops:!0,traveMode:!0};function O(e){const t=e.getTimezoneOffset(),s=t>0?"-":"+",i=60,r=Math.abs(Math.floor(t/i)),o=Math.abs(Math.floor(t)%i),n={minimumIntegerDigits:2};return`GMT${s}${A(r,n)}${A(o,n)}`}function U(e){return!!e.composedPath?.().find((e=>e.classList?.contains("esri-search__suggestions-list")))}const z="search-term",$="date-time-picker",F=100,N=500;let q=class extends m{constructor(e,t){super(e,t),this._activeStop=null,this._activeManeuver=null,this._autoStopRemovalDelay=F,this._autoStopRemovalTimeoutId=void 0,this._departureTimeOption=w.NOW,this._datePicker=new k,this._focusedManeuver=null,this._newPlaceholderStop=null,this._pointerDownUpHandle=null,this._pointerPressedSearchSuggestionStop=null,this._renderSavePopoverFunction=null,this._saveAsButtonNode=null,this._saveLayer=new g,this._sections=null,this._sortable=null,this._stopsToSearches=new Map,this._timePicker=new P,this._viewClickHandle=null,this.headingLevel=2,this.iconClass=M.widgetIcon,this.icon=null,this.messages=null,this.messagesCommon=null,this.messagesUnits=null,this.searchProperties=null,this.viewModel=new _,this.visibleElements={...x},this._setUpDragAndDropStops=e=>{this._sortable=H.create(e,{draggable:`.${M.validStopRow}`,ghostClass:M.stopRowGhost,handle:`.${M.stopHandle}`,onEnd:this._handleStopInputDragEnd})},this._handleDragHandlePointerDown=()=>this.viewModel.layer?.stops.forEach((e=>this._acquireSearch(e).activeMenu="none")),this._handleStopInputDragEnd=({oldIndex:e,newIndex:t,target:s})=>{if(e===t||null==t||null==e)return;const{children:i}=s,r=i[t],o=i[e],n=t-e<0;s.insertBefore(r,n?o.nextElementSibling:o);const{stops:a}=this.viewModel.layer;a.reorder(a.at(e),t);for(const l of a)l.sequence=null;this._getDirections()}}initialize(){this.addHandles([r((()=>this.viewModel.layer?.routeInfo),(()=>{this._activeManeuver=null,this._focusedManeuver=null,this._sections=this._getSections(),this.scheduleRender()}),o),n((()=>this.view),((e,s)=>{if(s&&(this._viewClickHandle=null,null!=s&&this.removeHandles(s)),e){const s=this._prepPointerDownUpClick(),i=this._prepViewClick();s.pause(),i.pause();const r=e.surface;this.addHandles([t(r,"mousedown",(()=>this._autoStopRemovalDelay=N)),t(r,"mouseup",(()=>this._autoStopRemovalDelay=F)),s,i],e),this._pointerDownUpHandle=s,this._viewClickHandle=i}}),o),n((()=>null==this.viewModel.serviceDescription),(()=>{try{this.viewModel.load()}catch{}}),o),r((()=>this._saveLayer.state),(()=>{this.scheduleRender()}))]),this.when((()=>{this.destroyed||this.visibleElements.saveAsButton&&(this._renderSavePopoverFunction=this._renderSavePopover.bind(this),this._projector.append(document.body,this._renderSavePopoverFunction))}))}loadDependencies(){return C({button:()=>import("@esri/calcite-components/dist/components/calcite-button.js"),link:()=>import("@esri/calcite-components/dist/components/calcite-link.js"),popover:()=>import("@esri/calcite-components/dist/components/calcite-popover.js")})}destroy(){this._datePicker.destroy(),this._timePicker.destroy();for(const e of this._stopsToSearches.values())e.destroy();this._sortable?.destroy(),null!=this._renderSavePopoverFunction&&this._projector.detach(this._renderSavePopoverFunction)}get apiKey(){return this.viewModel.apiKey}set apiKey(e){this.viewModel.apiKey=e}get goToOverride(){return this.viewModel.goToOverride}set goToOverride(e){this.viewModel.goToOverride=e}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}get lastRoute(){return this.viewModel.lastRoute}get layer(){return this.viewModel.layer}set layer(e){this.viewModel.layer=e}get maxStops(){return this.viewModel.maxStops}set maxStops(e){this.viewModel.maxStops=e}get unit(){return this.defaultUnit}set unit(e){this._overrideIfSome("unit",e)}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}castVisibleElements(e){return{...x,...e}}getDirections(){return this.viewModel.getDirections()}render(){return B("div",{class:this.classes(M.base,M.scroller)},this._renderPanelContent())}save(){return this.viewModel.save()}saveAs(e,t={}){return this.viewModel.saveAs(e,t)}zoomToRoute(){return this.viewModel.zoomToRoute()}_renderPanelContent(){const{layer:e,serviceDescription:t,state:s}=this.viewModel,i="initializing"===s,r="error"===s&&!t,o="unauthenticated"===s,n={[M.panelContentLoading]:i,[M.panelContentError]:r||!e,[M.panelContentSignIn]:o},a=i?"presentation":"group",l=e?o?this._renderSignIn():r?this._renderMessage(this._getErrorMessage()):i?this._renderLoader():this._renderReadyContent():this._renderMessage(this.messages.missingLayer);return B("div",{class:this.classes(M.panelContent,n),role:a},l)}_renderReadyContent(){return[this._renderStopsContainer(),this._renderTravelModeOptions(),this._renderDepartureTimeControls(),this._renderSaveContainer(),this._renderSectionSplitter(),this._renderDirectionsContainer()]}_renderSignIn(){return B("div",{key:"sign-in",class:M.signInContent},B(D,{class:M.contentTitle,level:this.headingLevel},this.messages.widgetLabel),this._renderPlaceholder(),B(D,{level:I(this.headingLevel)},this.messages.signInRequired),B("button",{class:this.classes(M.button,M.buttonSecondary,M.signInButton),tabIndex:0,onclick:this._handleSignInClick,bind:this,type:"button"},this.messagesCommon.auth.signIn))}_handleSignInClick(){this.viewModel.load().catch((()=>{}))}_renderTravelModeOptions(){if(!this.visibleElements.traveMode)return null;const{selectedTravelMode:e,travelModes:t}=this.viewModel;if(0===t.length)return null;const s=null!=e?e.name:this.messages.travelMode;return B("div",{"aria-disabled":this._saveLayer.opened.toString(),class:this.classes(M.travelMode,this._saveLayer.opened&&M.buttonDisabled),key:"esri-directions__travel-mode-controls",role:"group"},B("select",{"aria-label":s,bind:this,class:this.classes(M.travelModeSelect,M.select),key:"esri-directions__travel-mode-options",onchange:this._handleTravelModeChange,title:s},t.map(((t,s)=>B("option",{key:`esri-directions__travel-mode-${s}`,"data-mode":t,selected:e===t,value:`${s}`},t.name)))))}_handleTravelModeChange(e){const t=e.currentTarget;this.viewModel.selectedTravelMode=V(t.item(t.selectedIndex)),this._getDirections()}_renderStopsContainer(){return this.visibleElements.stops?B("div",{"aria-disabled":this._saveLayer.opened.toString(),class:this.classes(M.section,this._saveLayer.opened&&M.buttonDisabled),key:"esri-directions__stops-container",role:"group"},this._renderStops()):null}_renderDepartureTimeControls(){if(!this.visibleElements.departureTime)return null;const{messages:{departAt:e,departureTime:t,leaveNow:s,timeUnspecified:i}}=this;return B("div",{"aria-disabled":this._saveLayer.opened.toString(),class:this.classes(M.departureTime,this._saveLayer.opened&&M.buttonDisabled),key:"esri-directions__departure-time-controls",role:"group"},B("select",{"aria-label":t,bind:this,class:this.classes(M.departureTimeSelect,M.select),onchange:this._handleDepartureOptionChange,title:t},B("option",{value:w.NOW,selected:this._departureTimeOption===w.NOW},s),B("option",{value:w.DEPART_AT,selected:this._departureTimeOption===w.DEPART_AT},e),B("option",{value:w.UNSPECIFIED,selected:this._departureTimeOption===w.UNSPECIFIED},i)),this._departureTimeOption===w.DEPART_AT?this._renderTimeControls():null)}_renderStops(){const{stops:e}=this.viewModel.layer;let t=0;for(const r of this._stopsToSearches.keys())e.includes(r)||this._disposeSearch(r);for(const r of e){const e=this._acquireSearch(r);"none"!==e.activeMenu&&(t+=1),null!=r.name&&(e.searchTerm=r.name)}const s=e.toArray().map(((s,i)=>{const r=e.length,o=i>1&&null==s.geometry,n={[M.stopsIcon]:i>=0&&i<r-1,[M.lastStopIcon]:i===r-1},a={[M.lastStopIconContainer]:i===r-1},l={[M.validStopRow]:!o},c=e.at(i+1),d=c&&null!=c.geometry,u=i===r-1,h=i===r-2,p=2===r&&0===i||r>2&&!u&&!h||r>2&&h&&d||r>2&&u&&null==s.geometry,v=r<3,m=this._acquireSearch(s),{messages:_}=this,{removeStop:g,reverseStops:S,unlocated:y}=_,w=null!=s.geometry&&null!=s.name?s.name:y,f=A(i+1),b=`${_.stopLabel} ${f} (${w})`,T=`${this.id}__stop--${i}`,C=!!m.searchTerm&&!!m.selectedResult&&null!=s.geometry&&m.selectedResult.name===s.name,k={zIndex:"none"!==m.activeMenu?""+t--:""};return B("li",{"aria-label":b,afterCreate:this._handleStopFieldCreation,bind:this,class:this.classes(M.stopRow,l),id:T,key:i,"data-stop-index":i,styles:k},B("div",{class:M.stopHandle},B("span",{"aria-hidden":"true",class:this.classes(M.stopIcon,M.handleIcon,M.stopHandleIcon,M.interactiveStopIcon),onpointerdown:this._handleDragHandlePointerDown}),B("div",{bind:this,"aria-labelledby":T,class:this.classes(M.stopIconContainer,a),"data-stop-index":i,onclick:this._handleStopIconClick,onkeydown:this._handleStopIconClick,role:"button"},B("span",{class:this.classes(M.stopIcon,n),tabindex:C?"0":null}))),B("div",{class:M.stopInput},m.render()),B("div",{class:M.stopOptions,role:"group"},B("div",{"aria-label":g,class:M.removeStopButton,bind:this,"data-stop-index":i,hidden:v,onkeydown:this._handleRemoveStop,onclick:this._handleRemoveStop,role:"button",tabIndex:0,title:g},B("span",{"aria-hidden":"true",class:this.classes(M.stopIcon,M.removeStop,M.removeStopIcon,M.interactiveStopIcon)}),B("span",{class:M.screenReaderText},"removeStopTitle")),B("div",{"aria-label":S,class:M.reverseStops,bind:this,hidden:p,onkeydown:this._handleReverseStops,onclick:this._handleReverseStops,role:"button",tabIndex:0,title:S},B("span",{"aria-hidden":"true",class:this.classes(M.stopIcon,M.reverseStopIcon,M.interactiveStopIcon)}),B("span",{class:M.screenReaderText},"removeStopTitle"))))})),i=this._renderAddStop();return B("div",null,B("ol",{class:M.stops,role:"group",afterCreate:this._setUpDragAndDropStops},s),i)}_renderAddStop(){const e=this.viewModel.layer?.stops;if(!e)return null;const t=e.filter((({geometry:e})=>null!=e)),s=e.at(-1);return t.length>1&&t.length<this.maxStops&&null!=s&&null!=s.geometry?B("div",{class:M.toolbarSection},B("div",{class:M.toolbarButtons},B("calcite-button",{appearance:"outline",class:M.addStopButton,kind:"neutral",scale:"s",round:!0,iconStart:"plus",key:M.addStopButton,onclick:()=>{this._addNewPlaceholder()},label:this.messages.addStop,width:"full"},this.messages.addStop))):null}_handleStopIconClick(e){const t=W(e.currentTarget),s=null!=t?this.viewModel.layer?.stops.at(t):void 0;s?.geometry&&this._centerAtStop(s)}_handleClearRouteClick(){this.viewModel.reset()}_centerAtStop(e){this.viewModel.centerAt(e)}_handleStopFieldCreation(e){const t=this._newPlaceholderStop;if(!t)return;const s=W(e),i=null!=s?this.viewModel.layer?.stops.at(s):void 0;if(t===i){const e=this._acquireSearch(i);e.when((()=>{this.renderNow(),e.focus()}))}this._newPlaceholderStop=null}_handleStopInputBlur(e,t){if(this._saveLayer.opened)return;this.removeHandles(z);if(!!e.selectedResult&&null!=t.geometry&&null!=e.selectedResult?.feature.geometry&&t.geometry===e.selectedResult?.feature.geometry)return void this._pointerDownUpHandle?.pause();const s=null==t.geometry&&null==e.selectedResult?.feature.geometry,i=null!=t.geometry&&null!=e.selectedResult?.feature.geometry&&t.geometry!==e.selectedResult?.feature.geometry;if((s||i)&&"none"===e.activeMenu&&e.searchTerm)return e.search(),void this._pointerDownUpHandle?.pause();e.searchTerm||(this._viewClickHandle?.resume(),clearTimeout(this._autoStopRemovalTimeoutId),this._autoStopRemovalTimeoutId=setTimeout((()=>{this.destroyed||(this._viewClickHandle?.pause(),"searching"!==e.viewModel.state?this._pointerPressedSearchSuggestionStop||(null!=t.geometry&&(t.geometry=null,this._getDirections()),this.scheduleRender()):this._pointerDownUpHandle?.pause())}),this._autoStopRemovalDelay))}_handleStopInputFocus(e,t){this._pointerDownUpHandle?.resume();const{view:s}=this;if(this.hasHandles(z)||!s)return;const i=s.cursor;this.addHandles([{remove(){s.cursor=i}},r((()=>e.searchTerm),(t=>{e.destroyed||(s.cursor=t.length?i:"copy")}),o)],z),this._activeStop=t}_prepViewClick(){const{view:e}=this.viewModel;i(e),i(e.surface);const t=s(e,"click",this._handleViewClick.bind(this)),r=s(e.surface,"click",(()=>{clearTimeout(this._autoStopRemovalTimeoutId),r.pause()}));return{remove(){r.remove(),t.remove()},pause(){r.pause(),t.pause()},resume(){r.resume(),t.resume()}}}_prepPointerDownUpClick(){const e=s(document,"pointerdown",(e=>{this._pointerPressedSearchSuggestionStop=U(e)?this._activeStop:null})),t=s(document,"pointerup",(e=>{this._pointerDownUpHandle?.pause();const t=U(e),s=this._activeStop;t||s!==this._pointerPressedSearchSuggestionStop||this._removeStop(s),this.scheduleRender(),this._pointerPressedSearchSuggestionStop=t?s:null}));return{remove(){t.remove(),e.remove()},pause(){t.pause(),e.pause()},resume(){e.resume()}}}_handleViewClick(e){e.stopPropagation();const t=this._activeStop,s=t?this._stopsToSearches.get(t):null;t&&s&&!s.searchTerm&&(s.search(e.mapPoint).then((e=>{const i=e?.results[0].results;if(!i)return;const{feature:r,name:o}=i[0];t.geometry=r.geometry,t.name=o,s.searchTerm=o})),this.scheduleRender()),this._viewClickHandle?.pause(),clearTimeout(this._autoStopRemovalTimeoutId)}_addNewPlaceholder(){if(this._pointerDownUpHandle?.pause(),this._newPlaceholderStop)return;const e=new h({symbol:new p});this.viewModel.layer?.stops.add(e),this._newPlaceholderStop=e}_handleReverseStops(){this._reverseStops()}_reverseStops(){const e=this.viewModel.layer?.stops??[];e.reverse();for(const t of e)t.sequence=null;this._getDirections()}_handleRemoveStop(e){const{layer:t}=this.viewModel;if(!t)return;const s=W(e.currentTarget);if(null==s)return;const{stops:i,routeInfo:r}=t,o=i.at(s);this._removeStop(o),null==o.geometry&&null!=r||this._getDirections()}_removeStop(e){const{stops:t}=this.viewModel.layer;!e||t.length<=2||(this._disposeSearch(e),t.remove(e))}_handleDepartureOptionChange(e){const t=e.currentTarget,s=t.item(t.selectedIndex);s.value===w.NOW?(this._departureTimeOption=w.NOW,this.viewModel.departureTime=w.NOW,this.removeHandles($),this._getDirections()):s.value===w.DEPART_AT?(this._departureTimeOption=w.DEPART_AT,this.addHandles(r((()=>[this._datePicker.value,this._timePicker.value]),(()=>{this._updateDepartureTime(),this._getDirections()}),o),$)):(this._departureTimeOption=w.UNSPECIFIED,this.viewModel.departureTime=null,this._getDirections())}_updateDepartureTime(){const e=this._datePicker.value,t=this._timePicker.value;e&&t&&(this.viewModel.departureTime=new Date(e.getFullYear(),e.getMonth(),e.getDate(),t.getHours(),t.getMinutes()))}_renderTimeControls(){return B("div",{class:M.departureTimeControls,key:"esri-directions__time-controls",role:"group"},this._datePicker.render(),this._timePicker.render())}_renderSectionSplitter(){return B("div",{class:M.sectionSplitter})}_renderSaveContainer(){const{saveButton:e,saveAsButton:t,printButton:s,layerDetails:i}=this.visibleElements;return e||t||s||i?B("div",{class:M.saveSection,key:M.saveSection},this._renderSaveButtons(),this._renderRouteLayerDetailsLink()):null}_renderSaveButtons(){const{saveButton:e,saveAsButton:t,printButton:s}=this.visibleElements;return e||t||s?B("div",{class:M.saveButtons,key:M.saveButtons},this._renderSaveButton(),this._renderSaveAsButton(),this._renderPrintButton()):null}_renderSaveButton(){if(!this.visibleElements.saveButton)return null;const{portalItem:e,routeInfo:t}=this.viewModel.layer,s=e?.itemControl,i=null!=t&&("admin"===s||"update"===s);return B("calcite-button",{appearance:"outline",class:M.saveButton,disabled:!i,iconStart:"save",key:M.saveButton,onclick:()=>{this._handleSaveButtonClick()},label:this.messagesCommon.save,width:"full"},this.messagesCommon.save)}_renderSaveAsButton(){if(!this.visibleElements.saveAsButton)return null;const e=null==this.viewModel.layer.routeInfo;return B("div",{class:M.saveAsButtonPopover,key:M.saveAsButtonPopover},B("calcite-button",{afterCreate:e=>{this._saveAsButtonNode=e},appearance:"outline",class:M.saveAsButton,disabled:e,iconStart:"duplicate",key:M.saveAsButton,onclick:()=>this._handleSaveAsButtonClick(),label:this.messagesCommon.saveAs,width:"full"},this.messagesCommon.saveAs))}_renderSavePopover(){return B("calcite-popover",{label:this._saveLayer.label,open:this._saveLayer.opened,overlayPositioning:"fixed",referenceElement:this._saveAsButtonNode},this._saveLayer.render())}_handleSaveAsButtonClick(){this._saveLayer.opened?this._saveLayer.close():this._saveLayer.open(this.viewModel.layer)}_renderPrintButton(){return this.visibleElements.printButton?B("calcite-button",{appearance:"outline",class:M.printButton,iconStart:"print",key:M.printButton,label:this.messagesCommon.print}):null}_renderRouteLayerDetailsLink(){if(!this.visibleElements.layerDetails)return null;const{portalItem:e}=this.viewModel.layer;if(!e)return null;const{id:t,portal:{url:s}}=e,i=`${s}/home/item.html?id=${t}`;return B("calcite-link",{class:M.layerDetailsLink,href:i,key:M.layerDetailsLink,target:"_blank"},this.messages.viewLayerDetails)}_handleSaveButtonClick(){this.viewModel.layer.save()}_renderDirectionsContainer(){return B("div",{class:this.classes(M.directionsSection,M.section),key:"esri-directions__container"},this._renderDirectionsContainerContent())}_renderLoader(){return B("div",{class:M.loader,key:"loader"})}_renderWarningCard(){return B("div",{class:M.warningCard,role:"alert"},B("div",{class:M.warningHeader},B("span",{class:M.warningIcon,"aria-hidden":"true"}),B(D,{class:M.warningHeading,level:this.headingLevel},this.messagesCommon.warning)),B("div",{class:M.warningMessage},this._getErrorMessage()))}_renderDirectionsContainerContent(){const{layer:e,state:t}=this.viewModel,s="routing"===t;return"error"===t?this._renderWarningCard():s?this._renderLoader():null!=e.directionLines?B("div",{"aria-disabled":this._saveLayer.opened.toString(),class:this.classes(M.summary,this._saveLayer.opened&&M.buttonDisabled),key:"esri-directions__summary",role:"group"},this._renderCosts(),this._renderRouteActions(),this._renderManeuverSections()):B("div",{key:"esri-directions__placeholder",class:M.emptyContent},this._renderPlaceholder(),B(D,{class:M.message,level:this.headingLevel},this.messages.directionsPlaceholder))}_renderPlaceholder(){return B("svg",{class:M.emptyIllustration,xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 256 256"},B("path",{fill:"currentcolor",d:"M192 36c-15.477 0-24 6.034-24 16.99v45.822l24 24 24-24v-45.82C216 42.033 207.477 36 192 36zm20 61.155l-20 20-20-20V52.99c0-8.62 6.73-12.99 20-12.99s20 4.37 20 12.99zM192 52a12 12 0 1 0 12 12 12.013 12.013 0 0 0-12-12zm0 20a8 8 0 1 1 8-8 8.008 8.008 0 0 1-8 8zM92 140.99C92 130.035 83.477 124 68 124s-24 6.034-24 16.99v45.822l24 24 24-24zm-4 44.165l-20 20-20-20V140.99c0-8.62 6.73-12.99 20-12.99s20 4.37 20 12.99zM68 140a12 12 0 1 0 12 12 12.013 12.013 0 0 0-12-12zm0 20a8 8 0 1 1 8-8 8.008 8.008 0 0 1-8 8zm84-44h16v4h-16zm-24 80h4v12h-12v-4h8zm0-28h4v16h-4zm0-52h12v4h-8v8h-4zm0 24h4v16h-4zm-36 64h16v4H92z"}))}_renderMessage(e){return B(D,{class:M.messageHeading,level:this.headingLevel},e)}_renderRouteActions(){return B("div",{class:M.routeActions},B("button",{"aria-label":this.messages.clearRoute,class:this.classes(M.clearRouteButton,M.button,M.buttonTertiary),tabIndex:0,onclick:this._handleClearRouteClick,bind:this,type:"button"},this.messages.clearRoute))}_getSections(){const{layer:e}=this.viewModel;if(!e)return null;const{directionPoints:t,directionLines:s,stops:i}=e;if(null==t||null==s)return null;const r=[];let o=null;for(const n of t){const{objectId:e,stopId:t}=n;if(null!=t){const e=i.find((({objectId:e})=>e===t)),s=0===r.length;null!=o&&o.stop===e||(o={stop:e,directions:[],open:s},r.push(o));continue}if(null==o)continue;const a=s.find((({directionPointId:t})=>t===e));null!=a&&o.directions.push({directionPoint:n,directionLine:a})}return r}_renderManeuverSections(){return null==this._sections?null:B("div",{class:M.maneuvers,role:"group"},this._sections.map(((e,t)=>{const{open:s}=e;let i;e.directions.length>0&&s&&(i=B("ol",{class:M.maneuverList},e.directions.map((e=>this._renderManeuver(e)))));const r=this._sections.length>2,o=t===this._sections.length-1,n={[M.collapsibleSection]:r},a={[M.openIcon]:!s,[M.closeIcon]:s};let l;if(r&&!o){const t=s?this.messagesCommon.close:this.messagesCommon.open;l=B("header",{class:this.classes(M.maneuverSectionHeader,M.maneuverSectionToggle),key:M.maneuverSectionHeader},B("div",{"aria-expanded":s.toString(),"aria-label":t,bind:this,class:M.maneuverSectionHeaderButton,"data-maneuver-section":e,onkeydown:this._handleSectionToggle,onclick:this._handleSectionToggle,role:"button",tabIndex:0,title:t},B(D,{class:M.maneuverSectionTitle,level:this.headingLevel},e.stop.name),B("span",{"aria-hidden":"true",class:this.classes(a)})))}else l=B("header",{class:M.maneuverSectionHeader,key:M.maneuverSectionHeader},B(D,{class:M.maneuverSectionTitle,level:this.headingLevel},e.stop.name));return B("section",{class:this.classes(M.maneuverSection,n),key:t},l,i)})))}_handleSectionToggle(e){const t=G(e.currentTarget);t&&(t.open=!t.open)}_renderCosts(){const e=this._getCostSummary(),{directionPoints:t}=this.viewModel.layer;if(null==t||null==e)return null;const s=t.at(-1).arrivalTime,{distance:i,duration:r}=e,{eta:o,primaryCosts:n,secondaryCosts:a,zoomToRoute:l}=this.messages,c=j("short-time"),d=null!=s?`<strong>${E(s,c)}</strong> ${O(s)}`:"";return B("div",{"aria-label":l,bind:this,class:M.directionCosts,onkeydown:this._handleSummaryInteraction,onclick:this._handleSummaryInteraction,role:"button",tabIndex:0,title:l},B("div",{class:M.costsDetails,role:"group"},B("div",{class:M.primaryCosts,title:n},r),B("div",{class:M.verticalSplitter}),B("div",{class:M.secondaryCosts,title:a},i)),B("div",{innerHTML:d,title:o}))}_handleSummaryInteraction(){this._activeManeuver=null,this._focusedManeuver=null,this.viewModel.clearHighlights(),this.zoomToRoute()}_getErrorMessage(){switch(this.viewModel.lastError?.name){case"directions-view-model:unable-to-route":return this.messages.errors.unableToRoute;case"directions-view-model:service-metadata-unavailable":return this.messages.errors.unableToLoadServiceMetadata;default:return this.messages.errors.unknownError}}_normalizeSearchSources(e){this._overrideDefaultSources(e),this._applyLocatorSourceOverrides(e)}_overrideDefaultSources(e){e.viewModel.defaultSources.forEach((e=>{e.autoNavigate=!1}))}_applyLocatorSourceOverrides({allSources:e}){for(const t of e)"url"in t&&t.url&&(t.locationType??="street",b(t.url)&&this.apiKey&&null==t.apiKey&&(t.apiKey=this.apiKey,t.url=T))}_acquireSearch(e){const{view:t}=this.viewModel;if(this._stopsToSearches.has(e)){const s=this._stopsToSearches.get(e);return s.view=t,this._overrideDefaultSources(s),s}const s=new v({view:t,resultGraphicEnabled:!1,popupEnabled:!1,...this.searchProperties});return this._normalizeSearchSources(s),this.addHandles([a((()=>s.allSources),"change",(()=>this._normalizeSearchSources(s))),s.on("select-result",(()=>{e.geometry=s.selectedResult?.feature.geometry,e.name=s.selectedResult?.name,this._getDirections()})),s.on("search-focus",(()=>this._handleStopInputFocus(s,e))),s.on("search-blur",(()=>this._handleStopInputBlur(s,e))),s.on("search-clear",(()=>{e.geometry=null,e.name=null,this._activeStop=e,this.viewModel.layer?.removeResult()})),r((()=>s.searchTerm),(t=>{e.name=t}))],s),this._stopsToSearches.set(e,s),s}_disposeSearch(e){if(!e||!this._stopsToSearches.has(e))return;const t=this._stopsToSearches.get(e);this.removeHandles(t),t.destroy(),this._stopsToSearches.delete(e)}_renderManeuver(e){const{directionPoint:t,directionLine:s}=e,{distance:i,duration:r}=s,{messages:o,messagesUnits:n,unit:a}=this,l=S(n,i??0,a),c=y(r??0),d=l&&c?`${l}&nbsp;&middot;&nbsp;${c}`:`${l}${c}`,u=this._getFormattedManeuverText(t),{objectId:h,directionPointType:p}=t,v=f(p),m=`esri-directions__maneuver-${h}`,_=`esri-directions__intermediate-costs-${h}`,g={[M.maneuverActive]:this._activeManeuver===s};return B("li",{"aria-labelledby":`${m} ${_}`,bind:this,class:this.classes(M.maneuver,g),"data-maneuver":s,key:s,onclick:this._handleManeuverClick,onkeydown:this._handleManeuverClick,onfocus:this._handleManeuverFocus,onmouseover:this._handleManeuverMouseOver,onmouseout:this._handleManeuverMouseOut,onblur:this._handleManeuverBlur,tabIndex:0},null!=v&&B("img",{alt:"",class:M.maneuverIcon,src:v}),B("div",{class:M.maneuverCostsContainer},B("span",{id:m,innerHTML:u??""}),B("div",{class:M.maneuverCosts},B("div",{class:M.horizontalSplitter}),B("div",{"aria-hidden":"true",id:_,class:M.intermediateCost,innerHTML:d,title:o.intermediateCosts}))))}_handleManeuverClick(e){const t=Y(e.currentTarget);if(!t)return;if(this._activeManeuver===t)return this._activeManeuver=null,void this.zoomToRoute();this._activeManeuver=t;const{geometry:s}=t;this.viewModel.centerAt(s),this.viewModel.highlight(t)}_handleManeuverMouseOver(e){if(this._activeManeuver||this._focusedManeuver)return;const t=Y(e.currentTarget);t&&this.viewModel.highlight(t)}_handleManeuverMouseOut(){this._activeManeuver||this._focusedManeuver||this.viewModel.clearHighlights()}_handleManeuverBlur(){this._activeManeuver||(this._focusedManeuver=null,this.viewModel.clearHighlights())}_handleManeuverFocus(e){if(this._activeManeuver)return;const t=Y(e.currentTarget);t&&(this._focusedManeuver=t,this.viewModel.highlight(t))}_getFormattedManeuverText(e){const{displayText:t,name:s,intersectingName:i}=e;if(null==t)return"";let r=t;return null!=s&&r.includes(s)&&(r=r.replace(s,`<strong>${s}</strong>`)),null!=i&&r.includes(i)&&(r=r.replace(i,`<strong>${i}</strong>`)),r}_getCostSummary(){const{messagesUnits:e,unit:t,viewModel:s}=this,{routeInfo:i}=s.layer;if(null==i)return null;const r=i.totalDistance??0,o=i.totalDuration??0;return{distance:S(e,r,t),duration:y(o)}}async _getDirections(){const e=this.viewModel.layer?.stops.filter((({geometry:e})=>null!=e));if(e&&!(e.length<2))try{await this.viewModel.getDirections()}catch{}}get test(){return{acquireSearch:e=>this._acquireSearch(e)}}};e([l()],q.prototype,"apiKey",null),e([l(u)],q.prototype,"defaultUnit",void 0),e([l()],q.prototype,"goToOverride",null),e([l()],q.prototype,"headingLevel",void 0),e([l()],q.prototype,"iconClass",void 0),e([l()],q.prototype,"icon",void 0),e([l()],q.prototype,"label",null),e([l({readOnly:!0})],q.prototype,"lastRoute",null),e([l()],q.prototype,"layer",null),e([l()],q.prototype,"maxStops",null),e([l(),L("esri/widgets/Directions/t9n/Directions")],q.prototype,"messages",void 0),e([l(),L("esri/t9n/common")],q.prototype,"messagesCommon",void 0),e([l(),L("esri/core/t9n/Units")],q.prototype,"messagesUnits",void 0),e([l()],q.prototype,"searchProperties",void 0),e([l()],q.prototype,"unit",null),e([l()],q.prototype,"view",null),e([l({type:_})],q.prototype,"viewModel",void 0),e([l()],q.prototype,"visibleElements",void 0),e([c("visibleElements")],q.prototype,"castVisibleElements",null),e([R()],q.prototype,"_handleStopIconClick",null),e([R()],q.prototype,"_handleClearRouteClick",null),e([R()],q.prototype,"_handleReverseStops",null),e([R()],q.prototype,"_handleRemoveStop",null),e([R()],q.prototype,"_handleSectionToggle",null),e([R()],q.prototype,"_handleSummaryInteraction",null),e([R()],q.prototype,"_handleManeuverClick",null),q=e([d("esri.widgets.Directions")],q);const K=q;function V(e){return e?.["data-mode"]}function W(e){return e?.["data-stop-index"]}function G(e){return e?.["data-maneuver-section"]}function Y(e){return e?.["data-maneuver"]}export{K as default};
