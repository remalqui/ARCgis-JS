/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{_ as e}from"../../chunks/tslib.es6.js";import t from"../../core/Evented.js";import{clone as d}from"../../core/lang.js";import{createResolver as s}from"../../core/promiseUtils.js";import"../../core/Logger.js";import"../../core/accessorSupport/ensureType.js";import"../../core/Error.js";import"../../core/has.js";import{subclass as r}from"../../core/accessorSupport/decorators/subclass.js";const i=new t.EventEmitter;function l(e,t,d=!1){const r=s();return d=null==t||d,i.emit("apply-edits",{serviceUrl:e,layerId:t,mayReceiveServiceEdits:d,result:r.promise}),r}const a="esri.layers.mixins.EditBusLayer",o=Symbol(a);function n(e){return null!=e&&"object"==typeof e&&o in e}const c=t=>{var s;let l=class extends t{constructor(...e){super(...e),this[s]=!0,this.when().then((()=>{this.own([i.on("apply-edits",(e=>{const{serviceUrl:t,layerId:s,mayReceiveServiceEdits:r,result:i}=e,l=t===this.url,a=null!=s&&null!=this.layerId&&s===this.layerId;if(!l||!a&&!r)return;const o=i.then((e=>{if(a&&(e.addedFeatures.length||e.updatedFeatures.length||e.deletedFeatures.length||e.addedAttachments.length||e.updatedAttachments.length||e.deletedAttachments.length))return this.emit("edits",d(e)),e;const t=e.editedFeatures?.find((({layerId:e})=>e===this.layerId));if(t){const{adds:s,updates:r,deletes:i}=t.editedFeatures,l={edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:s?s.map((({attributes:e})=>({objectId:this.objectIdField&&e[this.objectIdField],globalId:this.globalIdField&&e[this.globalIdField]}))):[],deletedFeatures:i?i.map((({attributes:e})=>({objectId:this.objectIdField&&e[this.objectIdField],globalId:this.globalIdField&&e[this.globalIdField]}))):[],updatedFeatures:r?r.map((({current:{attributes:e}})=>({objectId:this.objectIdField&&e[this.objectIdField],globalId:this.globalIdField&&e[this.globalIdField]}))):[],editedFeatures:d(e.editedFeatures),exceededTransferLimit:!1};return this.emit("edits",l),l}return{edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:[],deletedFeatures:[],updatedFeatures:[],editedFeatures:d(e.editedFeatures),exceededTransferLimit:!1}}));this.emit("apply-edits",{result:o})}))])}),(()=>{}))}};return s=o,l=e([r(a)],l),l};export{c as EditBusLayer,l as emitApplyEditsEvent,n as isEditBusLayer};
