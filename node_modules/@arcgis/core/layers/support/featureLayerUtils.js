/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{id as t}from"../../kernel.js";import{symbolTypesRenderer as e}from"../../symbols.js";import r from"../../core/Error.js";import{JSONMap as n}from"../../core/jsonMap.js";import{parseWhereClause as o}from"../../core/sql.js";import{createTypeReader as s}from"../../core/accessorSupport/extensions/serializableProperty/reader.js";import{getOwningPortalUrl as a}from"./layerUtils.js";import i from"../../renderers/SimpleRenderer.js";import u from"../../renderers/UniqueValueRenderer.js";import c from"../../rest/support/AttachmentQuery.js";import p from"../../rest/support/Query.js";import l from"../../rest/support/RelationshipQuery.js";const d=new n({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch"});async function y(t,e,n,o){const s=await C(t);if(await f(t,e,o),!s.addAttachment)throw new r(o,"Layer source does not support addAttachment capability");return s.addAttachment(e,n)}function f(t,e,n){const{attributes:o}=e,{objectIdField:s}=t;return t.get("capabilities.data.supportsAttachment")?e?o?s&&o[s]?Promise.resolve():Promise.reject(new r(n,`feature is missing the identifying attribute ${s}`)):Promise.reject(new r(n,"'attributes' are required on a feature to query attachments")):Promise.reject(new r(n,"A feature is required to add/delete/update attachments")):Promise.reject(new r(n,"this layer doesn't support attachments"))}async function m(t,e,n,o,s){const a=await C(t);if(await f(t,e,s),!a.updateAttachment)throw new r(s,"Layer source does not support updateAttachment capability");return a.updateAttachment(e,n,o)}async function h(t,e,r){const{applyEdits:n}=await import("../graphics/editingSupport.js"),o=await t.load();return n(o,o.source,e,r)}async function w(t,e,r){const{uploadAssets:n}=await import("../graphics/editingSupport.js"),o=await t.load();return n(o,o.source,e,r)}async function b(t,e,n,o){const s=await C(t);if(await f(t,e,o),!s.deleteAttachments)throw new r(o,"Layer source does not support deleteAttachments capability");return s.deleteAttachments(e,n)}async function g(t,e,n){const o=(await t.load({signal:e?.signal})).source;if(!o.fetchRecomputedExtents)throw new r(n,"Layer source does not support fetchUpdates capability");return o.fetchRecomputedExtents(e)}async function j(t,e,n,o){e=c.from(e),await t.load();const s=t.source,a=t.capabilities;if(!a?.data?.supportsAttachment)throw new r(o,"this layer doesn't support attachments");const{attachmentTypes:i,objectIds:u,globalIds:p,num:l,size:d,start:y,where:f}=e;if(!a?.operations?.supportsQueryAttachments){if(i?.length>0||p?.length>0||d?.length>0||l||y||f)throw new r(o,"when 'capabilities.operations.supportsQueryAttachments' is false, only objectIds is supported",e)}if(!(u?.length||p?.length||f))throw new r(o,"'objectIds', 'globalIds', or 'where' are required to perform attachment query",e);if(!s.queryAttachments)throw new r(o,"Layer source does not support queryAttachments capability",e);return s.queryAttachments(e)}async function q(t,e,n,o){const s=await C(t);if(!s.queryObjectIds)throw new r(o,"Layer source does not support queryObjectIds capability");return s.queryObjectIds(p.from(e)??t.createQuery(),n)}async function F(t,e,n,o){const s=await C(t);if(!s.queryFeatureCount)throw new r(o,"Layer source does not support queryFeatureCount capability");return s.queryFeatureCount(p.from(e)??t.createQuery(),n)}async function I(t,e,n,o){const s=await C(t);if(!s.queryExtent)throw new r(o,"Layer source does not support queryExtent capability");return s.queryExtent(p.from(e)??t.createQuery(),n)}async function P(t,e,n,o){const s=await C(t);if(!s.queryRelatedFeatures)throw new r(o,"Layer source does not support queryRelatedFeatures capability");return s.queryRelatedFeatures(l.from(e),n)}async function A(t,e,n,o){const s=await C(t);if(!s.queryRelatedFeaturesCount)throw new r(o,"Layer source does not support queryRelatedFeaturesCount capability");return s.queryRelatedFeaturesCount(l.from(e),n)}async function O(t){const e=t.source;if(e?.refresh)try{const{dataChanged:r,updates:n}=await e.refresh();if(null!=n&&(t.sourceJSON={...t.sourceJSON,...n},t.read(n,{origin:"service",url:t.parsedUrl})),r)return!0}catch{}if(t.definitionExpression)try{return(await o(t.definitionExpression,t.fieldsIndex)).hasDateFunctions}catch{}return!1}function E(t){const e=new p,r=t.get("capabilities.data"),n=t.get("capabilities.query");e.historicMoment=t.historicMoment,e.gdbVersion=t.gdbVersion,e.returnGeometry=!0,n&&(e.compactGeometryEnabled=n.supportsCompactGeometry,e.defaultSpatialReferenceEnabled=n.supportsDefaultSpatialReference),r&&(r.supportsZ&&null!=t.returnZ&&(e.returnZ=t.returnZ),r.supportsM&&null!=t.returnM&&(e.returnM=t.returnM)),e.outFields=["*"];const{timeOffset:o,timeExtent:s}=t;return e.timeExtent=null!=o&&null!=s?s.offset(-o.value,o.unit):s||null,e.multipatchOption="multipatch"===t.geometryType?"xyFootprint":null,e}function S(t){const{globalIdField:e,fields:r}=t;if(e)return e;if(r)for(const n of r)if("esriFieldTypeGlobalID"===n.type)return n.name}function R(t){const{objectIdField:e,fields:r}=t;if(e)return e;if(r)for(const n of r)if("esriFieldTypeOID"===n.type)return n.name}function x(t){return t.currentVersion?t.currentVersion:t.hasOwnProperty("capabilities")||t.hasOwnProperty("drawingInfo")||t.hasOwnProperty("hasAttachments")||t.hasOwnProperty("htmlPopupType")||t.hasOwnProperty("relationships")||t.hasOwnProperty("timeInfo")||t.hasOwnProperty("typeIdField")||t.hasOwnProperty("types")?10:9.3}async function C(t){return(await t.load()).source}async function L(e,r){if(!t)return;if(t.findCredential(e))return;let n;try{const o=await a(e,r);o&&(n=await t.checkSignInStatus(`${o}/sharing`))}catch(o){}if(n)try{const n=null!=r?r.signal:null;await t.getCredential(e,{signal:n})}catch(o){}}async function M(t,e){const r=t.parsedUrl?.path;r&&G(t)&&await L(r,e)}function G(t){const e=t.editFieldsInfo;return!(!e?.creatorField&&!e?.editorField)||(t.userHasUpdateItemPrivileges?t.hasUpdateItemRestrictions:!!t.userHasFullEditingPrivileges&&t.hasFullEditingRestrictions)}function Q(t){return!t.sourceJSON?.isMultiServicesView&&(t.userHasUpdateItemPrivileges||t.editingEnabled)}const U=s({types:e});function v(t,e){if(t.defaultSymbol)return t.types&&t.types.length?new u({defaultSymbol:U(t.defaultSymbol,t,e),field:t.typeIdField,uniqueValueInfos:t.types.map((t=>({id:t.id,symbol:U(t.symbol,t,e)})))}):new i({symbol:U(t.defaultSymbol,t,e)})}export{y as addAttachment,h as applyEdits,Q as computeEffectiveEditingEnabled,v as createDefaultRenderer,E as createQuery,b as deleteAttachments,M as ensureLayerCredential,g as fetchRecomputedExtents,d as geometryTypeKebabDict,O as hasDataChanged,j as queryAttachments,I as queryExtent,F as queryFeatureCount,q as queryObjectIds,P as queryRelatedFeatures,A as queryRelatedFeaturesCount,S as readGlobalIdField,R as readObjectIdField,x as readVersion,m as updateAttachment,w as uploadAssets};
