/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import e from"../../request.js";import{throwIfAborted as r}from"../../core/promiseUtils.js";import{isProtocolRelative as t,isAbsolute as s,join as o,removeTrailingSlash as l,normalize as n,removeFile as i,getAppBaseUrl as u,addQueryParameters as c}from"../../core/urlUtils.js";import a from"../../views/2d/engine/vectorTiles/style/VectorTileSource.js";async function f(e,r){const t={source:null,sourceBase:null,sourceUrl:null,validatedSource:null,style:null,styleBase:null,styleUrl:null,sourceNameToSource:{},primarySourceName:"",spriteFormat:"png"},[s,o]="string"==typeof e?[e,null]:[null,e.jsonUrl];await y(t,"esri",e,o,r);return{layerDefinition:t.validatedSource,url:s,serviceUrl:t.sourceUrl,style:t.style,styleUrl:t.styleUrl,spriteUrl:t.style.sprite&&p(t.styleBase,t.style.sprite),spriteFormat:t.spriteFormat,glyphsUrl:t.style.glyphs&&p(t.styleBase,t.style.glyphs),sourceNameToSource:t.sourceNameToSource,primarySourceName:t.primarySourceName}}function p(...e){let r;for(const l of e)if(null!=l)if(t(l)){if(r){const e=r.split("://")[0];r=e+":"+l.trim()}}else r=s(l)?l:o(r,l);return r?l(r):void 0}async function y(t,s,o,l,i){let u,c,a;if(r(i),"string"==typeof o){const r=n(o);a=await e(r,{...i,responseType:"json",query:{f:"json",...i?.query}}),a.ssl&&(u&&(u=u.replace(/^http:/i,"https:")),c&&(c=c.replace(/^http:/i,"https:"))),u=r,c=r}else null!=o&&(a={data:o},u=o.jsonUrl||null,c=l);const f=a?.data;if(m(f))return t.styleUrl=u||null,S(t,f,c,i);if(d(f))return t.sourceUrl?h(t,f,c,!1,s,i):(t.sourceUrl=u||null,h(t,f,c,!0,s,i));throw new Error("You must specify the URL or the JSON for a service or for a style.")}function m(e){return!!e&&"sources"in e&&!!e.sources}function d(e){return!m(e)}async function S(e,r,t,s){const o=t?i(t):u();e.styleBase=o,e.style=r,r["sprite-format"]&&"webp"===r["sprite-format"].toLowerCase()&&(e.spriteFormat="webp");const l=[];if(r.sources&&r.sources.esri){const t=r.sources.esri;t.url?await y(e,"esri",p(o,t.url),void 0,s):l.push(y(e,"esri",t,o,s))}for(const n of Object.keys(r.sources))"esri"!==n&&"vector"===r.sources[n].type&&(r.sources[n].url?l.push(y(e,n,p(o,r.sources[n].url),void 0,s)):r.sources[n].tiles&&l.push(y(e,n,r.sources[n],o,s)));await Promise.all(l)}async function h(e,r,t,s,o,n){const i=t?l(t)+"/":u(),f=w(r),m=new a(o,c(i,n?.query??{}),f);if(!s&&e.primarySourceName in e.sourceNameToSource){const r=e.sourceNameToSource[e.primarySourceName];if(!r.isCompatibleWith(m))return;null!=m.fullExtent&&(null!=r.fullExtent?r.fullExtent.union(m.fullExtent):r.fullExtent=m.fullExtent.clone()),r.tileInfo&&m.tileInfo&&r.tileInfo.lods.length<m.tileInfo.lods.length&&(r.tileInfo=m.tileInfo)}if(s&&(e.sourceBase=i,e.source=r,e.validatedSource=f,e.primarySourceName=o),e.sourceNameToSource[o]=m,!e.style){if(null==r.defaultStyles)throw new Error;return"string"==typeof r.defaultStyles?y(e,"",p(i,r.defaultStyles,"root.json"),void 0,n):y(e,"",r.defaultStyles,p(i,"root.json"),n)}}function w(e){if(e.hasOwnProperty("tileInfo"))return e;const r={xmin:-20037507.067161843,ymin:-20037507.067161843,xmax:20037507.067161843,ymax:20037507.067161843,spatialReference:{wkid:102100}},t=512;let s=78271.51696400007,o=295828763.7957775;const l=[],n=e.hasOwnProperty("minzoom")?+e.minzoom:0,i=e.hasOwnProperty("maxzoom")?+e.maxzoom:22;for(let u=0;u<=i;u++)u>=n&&l.push({level:u,scale:o,resolution:s}),s/=2,o/=2;return{capabilities:"TilesOnly",initialExtent:r,fullExtent:r,minScale:0,maxScale:0,tiles:e.tiles,tileInfo:{rows:t,cols:t,dpi:96,format:"pbf",origin:{x:-20037508.342787,y:20037508.342787},lods:l,spatialReference:{wkid:102100}}}}export{f as loadMetadata};
