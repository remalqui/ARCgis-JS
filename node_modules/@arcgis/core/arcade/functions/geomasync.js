/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{version as n}from"../../kernel.js";import{cloneGeometry as t,convertSquareUnitsToCode as e,convertLinearUnitsToCode as r}from"../kernel.js";import{L as i,C as a,k as o,j as l,m as s,o as u,y as c,r as f,D as d,N as m,M as w,O as h,g as y,h as p,G as g}from"../../chunks/languageUtils.js";import{centroidPolyline as v,centroidMultiPoint as P,getMetersPerVerticalUnitForSR as I,segmentLength3d as A}from"./centroid.js";import F from"../../geometry/Extent.js";import R from"../../geometry/Geometry.js";import{disjoint as j,intersects as x,touches as N,crosses as b,within as O,contains as S,overlaps as D,equals as k,relate as M,intersect as C,union as Z,difference as J,symmetricDifference as L,clip as U,cut as z,planarArea as E,geodesicArea as T,planarLength as W,geodesicLength as q,distance as G,densify as V,geodesicDensify as B,generalize as H,buffer as K,geodesicBuffer as Q,offset as X,rotate as Y,simplify as $,isSimple as _,convexHull as nn,nearestCoordinate as tn,nearestVertex as en}from"../../geometry/geometryEngineAsync.js";import rn from"../../geometry/Multipoint.js";import an from"../../geometry/Point.js";import on from"../../geometry/Polygon.js";import ln from"../../geometry/Polyline.js";import{fromJSON as sn}from"../../geometry/support/jsonUtils.js";import{ArcadeExecutionError as un,ExecutionErrorCodes as cn}from"../executionError.js";import fn from"../Dictionary.js";import dn from"../ArcadePortal.js";import{getPortal as mn,lookupUser as wn}from"../portalUtils.js";import{getMetersPerUnitForSR as hn}from"../../core/unitUtils.js";import yn from"../../portal/Portal.js";function pn(t){return 0===n.indexOf("4.")?on.fromExtent(t):new on({spatialReference:t.spatialReference,rings:[[[t.xmin,t.ymin],[t.xmin,t.ymax],[t.xmax,t.ymax],[t.xmax,t.ymin],[t.xmin,t.ymin]]]})}function gn(n,t,e){if(a(n,2,2,t,e),n[0]instanceof R&&n[1]instanceof R);else if(n[0]instanceof R&&null===n[1]);else if(n[1]instanceof R&&null===n[0]);else if(null!==n[0]||null!==n[1])throw new un(t,cn.InvalidParameter,e)}async function vn(n,t){if("polygon"!==n.type&&"polyline"!==n.type&&"extent"!==n.type)return 0;let e=1;if(n.spatialReference.vcsWkid||n.spatialReference.latestVcsWkid){e=I(n.spatialReference)/hn(n.spatialReference)}let r=0;if("polyline"===n.type)for(const a of n.paths)for(let n=1;n<a.length;n++)r+=A(a[n],a[n-1],e);else if("polygon"===n.type)for(const a of n.rings){for(let n=1;n<a.length;n++)r+=A(a[n],a[n-1],e);(a[0][0]!==a[a.length-1][0]||a[0][1]!==a[a.length-1][1]||void 0!==a[0][2]&&a[0][2]!==a[a.length-1][2])&&(r+=A(a[0],a[a.length-1],e))}else"extent"===n.type&&(r+=2*A([n.xmin,n.ymin,0],[n.xmax,n.ymin,0],e),r+=2*A([n.xmin,n.ymin,0],[n.xmin,n.ymax,0],e),r*=2,r+=4*Math.abs(d(n.zmax,0)*e-d(n.zmin,0)*e));const i=new ln({hasZ:!1,hasM:!1,spatialReference:n.spatialReference,paths:[[0,0],[0,r]]});return W(i,t)}function Pn(n){"async"===n.mode&&(n.functions.disjoint=function(t,e){return n.standardFunctionAsync(t,e,((n,r,a)=>(gn(a=i(a),t,e),null===a[0]||null===a[1]||j(a[0],a[1]))))},n.functions.intersects=function(t,e){return n.standardFunctionAsync(t,e,((n,r,a)=>(gn(a=i(a),t,e),null!==a[0]&&null!==a[1]&&x(a[0],a[1]))))},n.functions.touches=function(t,e){return n.standardFunctionAsync(t,e,((n,r,a)=>(gn(a=i(a),t,e),null!==a[0]&&null!==a[1]&&N(a[0],a[1]))))},n.functions.crosses=function(t,e){return n.standardFunctionAsync(t,e,((n,r,a)=>(gn(a=i(a),t,e),null!==a[0]&&null!==a[1]&&b(a[0],a[1]))))},n.functions.within=function(t,e){return n.standardFunctionAsync(t,e,((n,r,a)=>(gn(a=i(a),t,e),null!==a[0]&&null!==a[1]&&O(a[0],a[1]))))},n.functions.contains=function(t,e){return n.standardFunctionAsync(t,e,((n,r,a)=>(gn(a=i(a),t,e),null!==a[0]&&null!==a[1]&&S(a[0],a[1]))))},n.functions.overlaps=function(t,e){return n.standardFunctionAsync(t,e,((n,r,a)=>(gn(a=i(a),t,e),null!==a[0]&&null!==a[1]&&D(a[0],a[1]))))},n.functions.equals=function(t,e){return n.standardFunctionAsync(t,e,((n,r,i)=>(a(i,2,2,t,e),i[0]===i[1]||(i[0]instanceof R&&i[1]instanceof R?k(i[0],i[1]):!(!o(i[0])||!o(i[1]))&&i[0].equals(i[1])))))},n.functions.relate=function(t,e){return n.standardFunctionAsync(t,e,((n,r,o)=>{if(o=i(o),a(o,3,3,t,e),o[0]instanceof R&&o[1]instanceof R)return M(o[0],o[1],l(o[2]));if(o[0]instanceof R&&null===o[1])return!1;if(o[1]instanceof R&&null===o[0])return!1;if(null===o[0]&&null===o[1])return!1;throw new un(t,cn.InvalidParameter,e)}))},n.functions.intersection=function(t,e){return n.standardFunctionAsync(t,e,((n,r,a)=>(gn(a=i(a),t,e),null===a[0]||null===a[1]?null:C(a[0],a[1]))))},n.functions.union=function(e,r){return n.standardFunctionAsync(e,r,((n,a,o)=>{const l=[];if(0===(o=i(o)).length)throw new un(e,cn.WrongNumberOfParameters,r);if(1===o.length)if(s(o[0])){const n=i(o[0]);for(let t=0;t<n.length;t++)if(null!==n[t]){if(!(n[t]instanceof R))throw new un(e,cn.InvalidParameter,r);l.push(n[t])}}else{if(!u(o[0])){if(o[0]instanceof R)return c(t(o[0]),e.spatialReference);if(null===o[0])return null;throw new un(e,cn.InvalidParameter,r)}{const n=i(o[0].toArray());for(let t=0;t<n.length;t++)if(null!==n[t]){if(!(n[t]instanceof R))throw new un(e,cn.InvalidParameter,r);l.push(n[t])}}}else for(let t=0;t<o.length;t++)if(null!==o[t]){if(!(o[t]instanceof R))throw new un(e,cn.InvalidParameter,r);l.push(o[t])}return 0===l.length?null:Z(l)}))},n.functions.difference=function(e,r){return n.standardFunctionAsync(e,r,((n,a,o)=>(gn(o=i(o),e,r),null!==o[0]&&null===o[1]?t(o[0]):null===o[0]?null:J(o[0],o[1]))))},n.functions.symmetricdifference=function(e,r){return n.standardFunctionAsync(e,r,((n,a,o)=>(gn(o=i(o),e,r),null===o[0]&&null===o[1]?null:null===o[0]?t(o[1]):null===o[1]?t(o[0]):L(o[0],o[1]))))},n.functions.clip=function(t,e){return n.standardFunctionAsync(t,e,((n,r,o)=>{if(o=i(o),a(o,2,2,t,e),!(o[1]instanceof F)&&null!==o[1])throw new un(t,cn.InvalidParameter,e);if(null===o[0])return null;if(!(o[0]instanceof R))throw new un(t,cn.InvalidParameter,e);return null===o[1]?null:U(o[0],o[1])}))},n.functions.cut=function(e,r){return n.standardFunctionAsync(e,r,((n,o,l)=>{if(l=i(l),a(l,2,2,e,r),!(l[1]instanceof ln)&&null!==l[1])throw new un(e,cn.InvalidParameter,r);if(null===l[0])return[];if(!(l[0]instanceof R))throw new un(e,cn.InvalidParameter,r);return null===l[1]?[t(l[0])]:z(l[0],l[1])}))},n.functions.area=function(t,r){return n.standardFunctionAsync(t,r,(async(n,o,l)=>{if(a(l,1,2,t,r),null===(l=i(l))[0])return 0;if(f(l[0])){const n=await l[0].sumArea(e(d(l[1],-1)),!1,t.abortSignal);if(t.abortSignal.aborted)throw new un(t,cn.Cancelled,r);return n}if(s(l[0])||u(l[0])){const n=m(l[0],t.spatialReference);return null===n?0:E(n,e(d(l[1],-1)))}if(!(l[0]instanceof R))throw new un(t,cn.InvalidParameter,r);return E(l[0],e(d(l[1],-1)))}))},n.functions.areageodetic=function(t,r){return n.standardFunctionAsync(t,r,(async(n,o,l)=>{if(a(l,1,2,t,r),null===(l=i(l))[0])return 0;if(f(l[0])){const n=await l[0].sumArea(e(d(l[1],-1)),!0,t.abortSignal);if(t.abortSignal.aborted)throw new un(t,cn.Cancelled,r);return n}if(s(l[0])||u(l[0])){const n=m(l[0],t.spatialReference);return null===n?0:T(n,e(d(l[1],-1)))}if(!(l[0]instanceof R))throw new un(t,cn.InvalidParameter,r);return T(l[0],e(d(l[1],-1)))}))},n.functions.length=function(t,e){return n.standardFunctionAsync(t,e,(async(n,o,l)=>{if(a(l,1,2,t,e),null===(l=i(l))[0])return 0;if(f(l[0])){const n=await l[0].sumLength(r(d(l[1],-1)),!1,t.abortSignal);if(t.abortSignal.aborted)throw new un(t,cn.Cancelled,e);return n}if(s(l[0])||u(l[0])){const n=w(l[0],t.spatialReference);return null===n?0:W(n,r(d(l[1],-1)))}if(!(l[0]instanceof R))throw new un(t,cn.InvalidParameter,e);return W(l[0],r(d(l[1],-1)))}))},n.functions.length3d=function(t,e){return n.standardFunctionAsync(t,e,((n,o,l)=>{if(a(l,1,2,t,e),null===(l=i(l))[0])return 0;if(s(l[0])||u(l[0])){const n=w(l[0],t.spatialReference);return null===n?0:!0===n.hasZ?vn(n,r(d(l[1],-1))):W(n,r(d(l[1],-1)))}if(!(l[0]instanceof R))throw new un(t,cn.InvalidParameter,e);return!0===l[0].hasZ?vn(l[0],r(d(l[1],-1))):W(l[0],r(d(l[1],-1)))}))},n.functions.lengthgeodetic=function(t,e){return n.standardFunctionAsync(t,e,(async(n,o,l)=>{if(a(l,1,2,t,e),null===(l=i(l))[0])return 0;if(f(l[0])){const n=await l[0].sumLength(r(d(l[1],-1)),!0,t.abortSignal);if(t.abortSignal.aborted)throw new un(t,cn.Cancelled,e);return n}if(s(l[0])||u(l[0])){const n=w(l[0],t.spatialReference);return null===n?0:q(n,r(d(l[1],-1)))}if(!(l[0]instanceof R))throw new un(t,cn.InvalidParameter,e);return q(l[0],r(d(l[1],-1)))}))},n.functions.distance=function(t,e){return n.standardFunctionAsync(t,e,((n,o,l)=>{l=i(l),a(l,2,3,t,e);let c=l[0];(s(l[0])||u(l[0]))&&(c=h(l[0],t.spatialReference));let f=l[1];if((s(l[1])||u(l[1]))&&(f=h(l[1],t.spatialReference)),!(c instanceof R))throw new un(t,cn.InvalidParameter,e);if(!(f instanceof R))throw new un(t,cn.InvalidParameter,e);return G(c,f,r(d(l[2],-1)))}))},n.functions.distancegeodetic=function(t,e){return n.standardFunctionAsync(t,e,((n,o,l)=>{l=i(l),a(l,2,3,t,e);const s=l[0],u=l[1];if(!(s instanceof an))throw new un(t,cn.InvalidParameter,e);if(!(u instanceof an))throw new un(t,cn.InvalidParameter,e);const c=new ln({paths:[],spatialReference:s.spatialReference});return c.addPath([s,u]),q(c,r(d(l[2],-1)))}))},n.functions.densify=function(t,e){return n.standardFunctionAsync(t,e,((n,o,l)=>{if(l=i(l),a(l,2,3,t,e),null===l[0])return null;if(!(l[0]instanceof R))throw new un(t,cn.InvalidParameter,e);const s=y(l[1]);if(isNaN(s))throw new un(t,cn.InvalidParameter,e);if(s<=0)throw new un(t,cn.InvalidParameter,e);return l[0]instanceof on||l[0]instanceof ln?V(l[0],s,r(d(l[2],-1))):l[0]instanceof F?V(pn(l[0]),s,r(d(l[2],-1))):l[0]}))},n.functions.densifygeodetic=function(t,e){return n.standardFunctionAsync(t,e,((n,o,l)=>{if(l=i(l),a(l,2,3,t,e),null===l[0])return null;if(!(l[0]instanceof R))throw new un(t,cn.InvalidParameter,e);const s=y(l[1]);if(isNaN(s))throw new un(t,cn.InvalidParameter,e);if(s<=0)throw new un(t,cn.InvalidParameter,e);return l[0]instanceof on||l[0]instanceof ln?B(l[0],s,r(d(l[2],-1))):l[0]instanceof F?B(pn(l[0]),s,r(d(l[2],-1))):l[0]}))},n.functions.generalize=function(t,e){return n.standardFunctionAsync(t,e,((n,o,l)=>{if(l=i(l),a(l,2,4,t,e),null===l[0])return null;if(!(l[0]instanceof R))throw new un(t,cn.InvalidParameter,e);const s=y(l[1]);if(isNaN(s))throw new un(t,cn.InvalidParameter,e);return H(l[0],s,p(d(l[2],!0)),r(d(l[3],-1)))}))},n.functions.buffer=function(e,o){return n.standardFunctionAsync(e,o,((n,l,s)=>{if(s=i(s),a(s,2,3,e,o),null===s[0])return null;if(!(s[0]instanceof R))throw new un(e,cn.InvalidParameter,o);const u=y(s[1]);if(isNaN(u))throw new un(e,cn.InvalidParameter,o);return 0===u?t(s[0]):K(s[0],u,r(d(s[2],-1)))}))},n.functions.buffergeodetic=function(e,o){return n.standardFunctionAsync(e,o,((n,l,s)=>{if(s=i(s),a(s,2,3,e,o),null===s[0])return null;if(!(s[0]instanceof R))throw new un(e,cn.InvalidParameter,o);const u=y(s[1]);if(isNaN(u))throw new un(e,cn.InvalidParameter,o);return 0===u?t(s[0]):Q(s[0],u,r(d(s[2],-1)))}))},n.functions.offset=function(t,e){return n.standardFunctionAsync(t,e,((n,o,s)=>{if(s=i(s),a(s,2,6,t,e),null===s[0])return null;if(!(s[0]instanceof on||s[0]instanceof ln))throw new un(t,cn.InvalidParameter,e);const u=y(s[1]);if(isNaN(u))throw new un(t,cn.InvalidParameter,e);const c=y(d(s[4],10));if(isNaN(c))throw new un(t,cn.InvalidParameter,e);const f=y(d(s[5],0));if(isNaN(f))throw new un(t,cn.InvalidParameter,e);return X(s[0],u,r(d(s[2],-1)),l(d(s[3],"round")).toLowerCase(),c,f)}))},n.functions.rotate=function(t,e){return n.standardFunctionAsync(t,e,((n,r,o)=>{o=i(o),a(o,2,3,t,e);let l=o[0];if(null===l)return null;if(!(l instanceof R))throw new un(t,cn.InvalidParameter,e);l instanceof F&&(l=on.fromExtent(l));const s=y(o[1]);if(isNaN(s))throw new un(t,cn.InvalidParameter,e);const u=d(o[2],null);if(null===u)return Y(l,s);if(u instanceof an)return Y(l,s,u);throw new un(t,cn.InvalidParameter,e)}))},n.functions.centroid=function(e,r){return n.standardFunctionAsync(e,r,((n,o,l)=>{if(l=i(l),a(l,1,1,e,r),null===l[0])return null;let f=l[0];if((s(l[0])||u(l[0]))&&(f=h(l[0],e.spatialReference)),null===f)return null;if(!(f instanceof R))throw new un(e,cn.InvalidParameter,r);return f instanceof an?c(t(l[0]),e.spatialReference):f instanceof on?f.centroid:f instanceof ln?v(f):f instanceof rn?P(f):f instanceof F?f.center:null}))},n.functions.multiparttosinglepart=function(e,r){return n.standardFunctionAsync(e,r,(async(n,o,l)=>{l=i(l),a(l,1,1,e,r);const s=[];if(null===l[0])return null;if(!(l[0]instanceof R))throw new un(e,cn.InvalidParameter,r);if(l[0]instanceof an)return[c(t(l[0]),e.spatialReference)];if(l[0]instanceof F)return[c(t(l[0]),e.spatialReference)];const u=await $(l[0]);if(u instanceof on){const n=[],t=[];for(let e=0;e<u.rings.length;e++)if(u.isClockwise(u.rings[e])){const t=sn({rings:[u.rings[e]],hasZ:!0===u.hasZ,hazM:!0===u.hasM,spatialReference:u.spatialReference.toJSON()});n.push(t)}else t.push({ring:u.rings[e],pt:u.getPoint(e,0)});for(let e=0;e<t.length;e++)for(let r=0;r<n.length;r++)if(n[r].contains(t[e].pt)){n[r].addRing(t[e].ring);break}return n}if(u instanceof ln){const n=[];for(let t=0;t<u.paths.length;t++){const e=sn({paths:[u.paths[t]],hasZ:!0===u.hasZ,hazM:!0===u.hasM,spatialReference:u.spatialReference.toJSON()});n.push(e)}return n}if(l[0]instanceof rn){const n=c(t(l[0]),e.spatialReference);for(let t=0;t<n.points.length;t++)s.push(n.getPoint(t));return s}return null}))},n.functions.issimple=function(t,e){return n.standardFunctionAsync(t,e,((n,r,o)=>{if(o=i(o),a(o,1,1,t,e),null===o[0])return!0;if(!(o[0]instanceof R))throw new un(t,cn.InvalidParameter,e);return _(o[0])}))},n.functions.simplify=function(t,e){return n.standardFunctionAsync(t,e,((n,r,o)=>{if(o=i(o),a(o,1,1,t,e),null===o[0])return null;if(!(o[0]instanceof R))throw new un(t,cn.InvalidParameter,e);return $(o[0])}))},n.functions.convexhull=function(t,e){return n.standardFunctionAsync(t,e,((n,r,o)=>{if(o=i(o),a(o,1,1,t,e),null===o[0])return null;if(!(o[0]instanceof R))throw new un(t,cn.InvalidParameter,e);return nn(o[0])}))},n.functions.getuser=function(t,e){return n.standardFunctionAsync(t,e,(async(n,r,i)=>{a(i,0,2,t,e);let o=d(i[1],""),s=!0===o;if(o=!0===o||!1===o?"":l(o),0===i.length||i[0]instanceof dn){let n=null;n=t.services&&t.services.portal?t.services.portal:yn.getDefault(),i.length>0&&(n=mn(i[0],n));const e=await wn(n,o,s);if(e){const n=JSON.parse(JSON.stringify(e));for(const t of["lastLogin","created","modified"])void 0!==n[t]&&null!==n[t]&&(n[t]=new Date(n[t]));return fn.convertObjectToArcadeDictionary(n,g(t))}return null}let u=null;if(f(i[0])&&(u=i[0]),u){if(s=!1,o)return null;await u.load();const n=await u.getOwningSystemUrl();if(!n){if(!o){const n=await u.getIdentityUser();return n?fn.convertObjectToArcadeDictionary({username:n},g(t)):null}return null}let e=null;e=t.services&&t.services.portal?t.services.portal:yn.getDefault(),e=mn(new dn(n),e);const r=await wn(e,o,s);if(r){const n=JSON.parse(JSON.stringify(r));for(const t of["lastLogin","created","modified"])void 0!==n[t]&&null!==n[t]&&(n[t]=new Date(n[t]));return fn.convertObjectToArcadeDictionary(n,g(t))}return null}throw new un(t,cn.InvalidParameter,e)}))}),n.functions.nearestcoordinate=function(t,e){return n.standardFunctionAsync(t,e,(async(n,r,o)=>{if(o=i(o),a(o,2,2,t,e),!(o[0]instanceof R||null===o[0]))throw new un(t,cn.InvalidParameter,e);if(!(o[1]instanceof an||null===o[1]))throw new un(t,cn.InvalidParameter,e);if(null===o[0]||null===o[1])return null;const l=await tn(o[0],o[1]);return null===l?null:fn.convertObjectToArcadeDictionary({coordinate:l.coordinate,distance:l.distance},g(t),!1,!0)}))},n.functions.nearestvertex=function(t,e){return n.standardFunctionAsync(t,e,(async(n,r,o)=>{if(o=i(o),a(o,2,2,t,e),!(o[0]instanceof R||null===o[0]))throw new un(t,cn.InvalidParameter,e);if(!(o[1]instanceof an||null===o[1]))throw new un(t,cn.InvalidParameter,e);if(null===o[0]||null===o[1])return null;const l=await en(o[0],o[1]);return null===l?null:fn.convertObjectToArcadeDictionary({coordinate:l.coordinate,distance:l.distance},g(t),!1,!0)}))}}export{Pn as registerFunctions};
