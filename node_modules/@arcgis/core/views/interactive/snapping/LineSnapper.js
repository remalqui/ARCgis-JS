/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{absoluteHeightElevationInfo as e}from"../../../support/elevationInfoUtils.js";import{SnappingAlgorithm as t}from"./SnappingAlgorithm.js";import{anyMapPointToSnappingPoint as s,asSnappingPoint as i}from"./SnappingPoint.js";import{editEdgeToSnappingEdge as r,squaredScreenDistance as o}from"./snappingUtils.js";import{LineSnappingCandidate as n}from"./candidates/LineSnappingCandidate.js";import{vectorToScreenPoint as d}from"../support/viewUtils.js";import{projectPointToLineLike as p}from"../../support/geometry3dUtils.js";import{LineType as a}from"../../support/geometry2dUtils.js";class h extends t{snapNewVertex(t,s){const i=s.editGeometryOperations.data.components[0],o=i.edges.length,n=[];if(o<1)return n;const{spatialReference:p}=s,a=d(t,p,e,this.view),{view:h}=this,l=i.edges[o-1];let g=l;do{if(this.edgeExceedsShortLineThreshold(g,s)){const e=r(g,h,s);this._processCandidateProposal(e.left,e.right,t,a,s,n)}g=g.leftVertex.leftEdge}while(g&&g!==l);return n}snapExistingVertex(t,i){const o=[],n=i.vertexHandle,p=n.component;if(p.edges.length<2)return o;const{view:a}=this,{spatialReference:h}=i,l=d(t,h,e,a),g=n.leftEdge,f=n.rightEdge;g&&f&&this.edgeExceedsShortLineThreshold(g,i)&&this.edgeExceedsShortLineThreshold(f,i)&&this._processCandidateProposal(s(g.leftVertex.pos,a,i),s(f.rightVertex.pos,a,i),t,l,i,o);const m=p.edges[0];let c=m;do{if(c!==n.leftEdge&&c!==n.rightEdge&&this.edgeExceedsShortLineThreshold(c,i)){const e=r(c,a,i);this._processCandidateProposal(e.left,e.right,t,l,i,o)}c=c.rightVertex.rightEdge}while(c&&c!==m);return o}_processCandidateProposal(t,s,r,h,l,g){const{spatialReference:f,pointer:m}=l,c=i(p(r,{start:t,end:s,type:a.LINE}));o(h,d(c,f,e,this.view))<this.squaredProximityThreshold(m)&&g.push(new n({lineStart:t,lineEnd:s,targetPoint:c,isDraped:"on-the-ground"===l.elevationInfo?.mode}))}}export{h as LineSnapper};
