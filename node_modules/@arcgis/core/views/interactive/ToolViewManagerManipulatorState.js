/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{find as t}from"../../core/iteratorUtils.js";import{someMap as e}from"../../core/MapUtils.js";import{clamp as o}from"../../core/mathUtils.js";import{applySome as r}from"../../core/maybe.js";import{createScreenPoint as i}from"../../core/screenUtils.js";import{areToolManipulatorsEditable as a}from"./interactiveToolUtils.js";import{createScreenPointFromEvent as n}from"../support/screenUtils.js";class s{constructor(){this._pointerLocations=new Map,this._hoveredManipulators=new Map,this._grabbedManipulators=new Map,this._draggedManipulators=new Map,this._stopDrag=!1,this._revertToNullActiveTool=!1,this._cursor=null}get cursor(){return this._cursor}hasFocusedManipulators(){return this._grabbedManipulators.size>0||this._draggedManipulators.size>0}handleInputEvent(t,e){const i=()=>t.stopPropagation();switch(t.type){case"pointer-move":l(t.pointerType)&&this._pointerLocations.set(t.pointerId,{x:t.x,y:t.y,pointerType:t.pointerType});break;case"drag":this._grabbedManipulators.size>0&&(this._stopDrag=!0),this._stopDrag&&(i(),"end"===t.action&&(this._stopDrag=!1));break;case"pointer-down":{if(!p(t))break;const o=n(t),r=this._intersect(o,t.pointerType,e.forEachTool);if(null==r)break;const a=r.manipulator,s=r.tool;null==a||null==s||!a.interactive||a.grabbable&&a.grabbableForEvent(t)||!a.grabbing||a.dragging||this._ungrabManipulatorBeforeDragging(a,t,e),null!=a&&null!=s&&a.interactive&&a.grabbable&&a.grabbableForEvent(t)&&!a.grabbing&&(this._grabbedManipulators.set(t.pointerId,{manipulator:a,tool:s,start:o,pointerType:t.pointerType}),1===this._grabbedManipulators.size&&null==e.activeTool&&(this._revertToNullActiveTool=!0,e.setActiveTool(r.tool)),a.grabbing=!0,a.events.emit("grab-changed",{action:"start",pointerType:t.pointerType,screenPoint:o}),i());break}case"pointer-up":this._draggedManipulators.has(t.pointerId)||this._handlePointerEnd(t,e);break;case"pointer-drag":{if(!p(t))break;const a=this._grabbedManipulators.get(t.pointerId),s=r(a,(({manipulator:t})=>t)),l=r(a,(({tool:t})=>t));if(null==s||null==l)break;const u=n(t);u.x=o(u.x,0,e.view.width),u.y=o(u.y,0,e.view.height);const c=a.start,h=this._draggedManipulators.get(t.pointerId);switch(t.action){case"start":case"update":"update"!==t.action&&1!==this._grabbedManipulators.size||(s.dragging=!0,h?s.events.emit("drag",{action:"update",start:c,screenPoint:u}):s.events.emit("drag",{action:"start",start:c,screenPoint:u,pointerType:t.pointerType}),this._draggedManipulators.set(t.pointerId,{tool:l,manipulator:s,start:c}));break;case"end":s.dragging=!1,h&&s.events.emit("drag",{action:"end",start:c,screenPoint:u}),this._draggedManipulators.delete(t.pointerId),this._handlePointerEnd(t,e)}i();break}case"immediate-click":{const o=n(t),r=this._intersect(o,t.pointerType,e.forEachTool);if(u(t)||e.forEachTool((t=>{if((null==r||r.tool!==t||t.automaticManipulatorSelection)&&t.manipulators){let e=!1;t.manipulators.forEach((({manipulator:t})=>{t.selected&&(t.selected=!1,e=!0)})),e&&t.onManipulatorSelectionChanged&&t.onManipulatorSelectionChanged()}})),null==r)break;const{manipulator:a,tool:s}=r;if(!a.interactive)break;a.selectable&&s.automaticManipulatorSelection&&(a.selected=!a.selected,s.onManipulatorSelectionChanged&&s.onManipulatorSelectionChanged());const l=t.native.shiftKey;a.events.emit("immediate-click",{screenPoint:o,button:t.button,pointerType:t.pointerType,shiftKey:l,stopPropagation:i});break}case"click":{const o=n(t),r=this._intersect(o,t.pointerType,e.forEachTool),a=null!=r?r.manipulator:null;if(null==a||!a.interactive)break;const s=t.native.shiftKey;a.events.emit(t.type,{screenPoint:o,button:t.button,pointerType:t.pointerType,shiftKey:s}),i();break}case"double-click":{const o=n(t),r=this._intersect(o,t.pointerType,e.forEachTool),a=null!=r?r.manipulator:null;if(null==a||!a.interactive)break;const s=t.native.shiftKey;a.events.emit("double-click",{screenPoint:o,button:t.button,pointerType:t.pointerType,shiftKey:s,stopPropagation:i});break}case"immediate-double-click":{const o=n(t),r=this._intersect(o,t.pointerType,e.forEachTool),a=null!=r?r.manipulator:null;if(null==a||!a.interactive)break;const s=t.native.shiftKey;a.events.emit("immediate-double-click",{screenPoint:o,button:t.button,pointerType:t.pointerType,shiftKey:s,stopPropagation:i});break}}this._onFocusChange(e.forEachTool)}_ungrabManipulatorBeforeDragging(t,e,o){t.grabbing=!1,t.events.emit("grab-changed",{action:"end",pointerType:e.pointerType,screenPoint:n(e)}),this._grabbedManipulators.forEach((({manipulator:e},o)=>{e===t&&this._grabbedManipulators.delete(o)})),this._afterManipulatorUngrab(o.setActiveTool)}_handlePointerEnd(t,e){const o=r(this._grabbedManipulators.get(t.pointerId),(({manipulator:t})=>t));null!=o&&o.grabbing&&(o.grabbing=!1,o.events.emit("grab-changed",{action:"end",pointerType:t.pointerType,screenPoint:n(t)}),this._grabbedManipulators.delete(t.pointerId),this._afterManipulatorUngrab(e.setActiveTool))}_cursorFromMap(t){let o=null;return e(t,(({manipulator:t})=>!(null==t||!t.interactive)&&(t.grabbing&&t.grabCursor?(o=t.grabCursor,!0):!!t.cursor&&(o=t.cursor,!0)))),o}_onFocusChange(t){this._updateCursor(),this._updateFocusedManipulatorTools(t)}_updateCursor(){this._grabbedManipulators.size>0?this._cursor=this._cursorFromMap(this._grabbedManipulators)||"grabbing":this._hoveredManipulators.size>0?this._cursor=this._cursorFromMap(this._hoveredManipulators)||"pointer":this._cursor=null}_updateFocusedManipulatorTools(e){const o=new Set,r=new Set;this._grabbedManipulators.forEach((({tool:t})=>{o.add(t)})),this._hoveredManipulators.forEach((({tool:t})=>{r.add(t)})),e((e=>{e.hasGrabbedManipulators=o.has(e),e.hasHoveredManipulators=r.has(e);const i=this._grabbedManipulators.values(),a=t(i,(({tool:t})=>t===e));e.firstGrabbedManipulator=null!=a?a.manipulator:null}))}clearPointers(t,{forEachTool:e,setActiveTool:o},r=!0,i){const a=(e,o)=>e===t&&(null==i||i===o);this._grabbedManipulators.forEach((({tool:t,manipulator:e,pointerType:o},r)=>{a(t,e)&&(this._grabbedManipulators.delete(r),e.grabbing=!1,e.events.emit("grab-changed",{action:"end",screenPoint:null,pointerType:o}))})),this._draggedManipulators.forEach((({tool:t,manipulator:e},o)=>{a(t,e)&&(this._draggedManipulators.delete(o),e.dragging=!1,e.events.emit("drag",{action:"cancel"}))})),r&&this._hoveredManipulators.forEach((({tool:t,manipulator:e},o)=>{a(t,e)&&(this._hoveredManipulators.delete(o),e.hovering=!1)})),this._afterManipulatorUngrab(o),this._onFocusChange(e)}_intersect(t,e,o){let r=null;return o((o=>{if(null==o.manipulators||!a(o))return!1;const i=o.manipulators.intersect(t,e);return null!=i&&(r={tool:o,manipulator:i},!0)})),r}updateHoveredStateFromKnownPointers(t){this._pointerLocations.forEach(((e,o)=>{this._updateHoveredStateForPointerAtScreenPosition(i(e.x,e.y),o,e.pointerType,t)}))}handleHoverEvent(t,e){"pointer-up"!==t.type&&"immediate-click"!==t.type&&"pointer-move"!==t.type||!l(t.pointerType)||this._updateHoveredStateForPointerAtScreenPosition(n(t),t.pointerId,t.pointerType,e)}_updateHoveredStateForPointerAtScreenPosition(t,e,o,i){let a=this._intersect(t,o,i);const n=r(this._hoveredManipulators.get(e),(({manipulator:t})=>t));null==a||a.manipulator.interactive||(a=null),null!=a&&n===a.manipulator||(null!=n&&(n.hovering=!1),null!=a?(a.manipulator.hovering=!0,this._hoveredManipulators.set(e,a)):this._hoveredManipulators.delete(e),this._onFocusChange(i))}_afterManipulatorUngrab(t){0===this._grabbedManipulators.size&&this._revertToNullActiveTool&&(t(null),this._revertToNullActiveTool=!1)}}function l(t){return"mouse"===t}function p(t){return"mouse"!==t.pointerType||0===t.button}function u(t){return!!t.native.shiftKey}export{s as ToolViewManagerManipulatorState};
