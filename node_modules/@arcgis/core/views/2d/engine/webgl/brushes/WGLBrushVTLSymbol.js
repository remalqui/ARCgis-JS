/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{c as e,f as t}from"../../../../../chunks/vec2f32.js";import{FADE_DURATION as i}from"../../vectorTiles/decluttering/config.js";import{RotationAlignment as a,SymbolPlacement as r,TranslateAnchor as n}from"../../vectorTiles/style/StyleDefinition.js";import{VTL_TEXTURE_BINDING_UNIT_SPRITES as s,VTL_TEXTURE_BINDING_UNIT_GLYPHS as o}from"../definitions.js";import{WGLDrawPhase as l}from"../enums.js";import{degToByte as f}from"../GeometryUtils.js";import{u32to4Xu8 as u}from"../number.js";import p from"./WGLBrush.js";import{TextureSamplingMode as c,CompareFunction as m,PrimitiveType as d,DataType as g}from"../../../../webgl/enums.js";const y=1/65536;class _ extends p{constructor(){super(...arguments),this._iconProgramOptions={id:!1,sdf:!1},this._sdfProgramOptions={id:!1},this._spritesTextureSize=e()}dispose(){}drawMany(e,t){const{drawPhase:i,styleLayerUID:a}=e,r=e.styleLayer;let n;i===l.HITTEST&&(n=u(a+1)),this._drawIcons(e,r,t,n),this._drawText(e,r,t,n)}_drawIcons(e,t,o,u){const{context:p,displayLevel:c,drawPhase:m,painter:d,spriteMosaic:g,state:y,styleLayerUID:_,requestRender:h,allowDelayedRender:M}=e,P=t.iconMaterial,T=d.vectorTilesMaterialManager;let U,E=!1;for(const i of o)if(i.layerData.has(_)&&(U=i.layerData.get(_),U.iconPerPageElementsMap.size>0)){E=!0;break}if(!E)return;const v=t.getPaintValue("icon-translate",c),x=t.getPaintValue("icon-translate-anchor",c);let D=t.getLayoutValue("icon-rotation-alignment",c);D===a.AUTO&&(D=t.getLayoutValue("symbol-placement",c)===r.POINT?a.VIEWPORT:a.MAP);const I=D===a.MAP,R=t.getLayoutValue("icon-keep-upright",c)&&I,S=U.isIconSDF,V=m===l.HITTEST,w=this._iconProgramOptions;w.id=V,w.sdf=S;const A=T.getMaterialProgram(p,P,w);if(M&&null!=h&&!A.compiled)return void h();p.useProgram(A),A.setUniformMatrix3fv("u_displayViewMat3",D===a.MAP?y.displayViewMat3:y.displayMat3),A.setUniformMatrix3fv("u_displayMat3",x===n.VIEWPORT?y.displayMat3:y.displayViewMat3),A.setUniform2fv("u_iconTranslation",v),A.setUniform1f("u_depth",t.z),A.setUniform1f("u_mapRotation",f(y.rotation)),A.setUniform1f("u_keepUpright",R?1:0),A.setUniform1f("u_level",10*c),A.setUniform1i("u_texture",s),A.setUniform1f("u_fadeDuration",i/1e3),V&&A.setUniform4fv("u_id",u);let L=-1;for(const i of o){if(!i.layerData.has(_))continue;if(i.key.level!==L&&(L=i.key.level,P.setDataUniforms(A,c,t,L,g)),U=i.layerData.get(_),0===U.iconPerPageElementsMap.size)continue;U.prepareForRendering(p),U.updateOpacityInfo();const a=U.iconVAO;if(null!=a){p.bindVAO(a),A.setUniformMatrix3fv("u_dvsMat3",i.transforms.dvs),A.setUniform1f("u_time",(performance.now()-U.lastOpacityUpdate)/1e3);for(const[t,a]of U.iconPerPageElementsMap)this._renderIconRange(e,A,a,t,i)}}}_renderIconRange(e,t,i,a,r){const{context:n,spriteMosaic:o}=e;this._spritesTextureSize[0]=o.getWidth(a)/4,this._spritesTextureSize[1]=o.getHeight(a)/4,t.setUniform2fv("u_mosaicSize",this._spritesTextureSize),o.bind(n,c.LINEAR,a,s),n.setStencilTestEnabled(!0),n.setStencilFunction(m.GREATER,255,255),n.setStencilWriteMask(0),n.drawElements(d.TRIANGLES,i[1],g.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*i[0]),r.triangleCount+=i[1]/3}_drawText(e,s,u,p){const{context:c,displayLevel:d,drawPhase:g,glyphMosaic:_,painter:h,pixelRatio:M,spriteMosaic:P,state:T,styleLayerUID:U,requestRender:E,allowDelayedRender:v}=e,x=s.textMaterial,D=h.vectorTilesMaterialManager;let I,R=!1;for(const t of u)if(t.layerData.has(U)&&(I=t.layerData.get(U),I.glyphPerPageElementsMap.size>0)){R=!0;break}if(!R)return;const S=s.getPaintProperty("text-opacity");if(S&&!S.isDataDriven&&0===S.getValue(d))return;const V=s.getPaintProperty("text-color"),w=!V||V.isDataDriven||V.getValue(d)[3]>0,A=s.getPaintProperty("text-halo-width"),L=s.getPaintProperty("text-halo-color"),O=(!A||A.isDataDriven||A.getValue(d)>0)&&(!L||L.isDataDriven||L.getValue(d)[3]>0);if(!w&&!O)return;const N=24/8;let z=s.getLayoutValue("text-rotation-alignment",d);z===a.AUTO&&(z=s.getLayoutValue("symbol-placement",d)===r.POINT?a.VIEWPORT:a.MAP);const k=z===a.MAP,b=s.getLayoutValue("text-keep-upright",d)&&k,G=g===l.HITTEST,j=.8*N/M;this._glyphTextureSize||(this._glyphTextureSize=t(_.width/4,_.height/4));const W=s.getPaintValue("text-translate",d),F=s.getPaintValue("text-translate-anchor",d),B=this._sdfProgramOptions;B.id=G;const H=D.getMaterialProgram(c,x,B);if(v&&null!=E&&!H.compiled)return void E();c.useProgram(H),H.setUniformMatrix3fv("u_displayViewMat3",z===a.MAP?T.displayViewMat3:T.displayMat3),H.setUniformMatrix3fv("u_displayMat3",F===n.VIEWPORT?T.displayMat3:T.displayViewMat3),H.setUniform2fv("u_textTranslation",W),H.setUniform1f("u_depth",s.z+y),H.setUniform2fv("u_mosaicSize",this._glyphTextureSize),H.setUniform1f("u_mapRotation",f(T.rotation)),H.setUniform1f("u_keepUpright",b?1:0),H.setUniform1f("u_level",10*d),H.setUniform1i("u_texture",o),H.setUniform1f("u_antialiasingWidth",j),H.setUniform1f("u_fadeDuration",i/1e3),G&&H.setUniform4fv("u_id",p);let C=-1;for(const t of u){if(!t.layerData.has(U))continue;if(t.key.level!==C&&(C=t.key.level,x.setDataUniforms(H,d,s,C,P)),I=t.layerData.get(U),0===I.glyphPerPageElementsMap.size)continue;I.prepareForRendering(c),I.updateOpacityInfo();const e=I.textVAO;if(null==e)continue;c.bindVAO(e),H.setUniformMatrix3fv("u_dvsMat3",t.transforms.dvs),c.setStencilTestEnabled(!0),c.setStencilFunction(m.GREATER,255,255),c.setStencilWriteMask(0);const i=(performance.now()-I.lastOpacityUpdate)/1e3;H.setUniform1f("u_time",i),I.glyphPerPageElementsMap.forEach(((e,i)=>{this._renderGlyphRange(c,e,i,_,H,O,w,t)}))}}_renderGlyphRange(e,t,i,a,r,n,s,l){a.bind(e,c.LINEAR,i,o),n&&(r.setUniform1f("u_halo",1),e.drawElements(d.TRIANGLES,t[1],g.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*t[0]),l.triangleCount+=t[1]/3),s&&(r.setUniform1f("u_halo",0),e.drawElements(d.TRIANGLES,t[1],g.UNSIGNED_INT,Uint32Array.BYTES_PER_ELEMENT*t[0]),l.triangleCount+=t[1]/3)}}export{_ as WGLBrushVTLSymbol};
