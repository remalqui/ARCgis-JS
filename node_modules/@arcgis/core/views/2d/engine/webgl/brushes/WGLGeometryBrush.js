/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{MIN_MAX_ZOOM_PRECISION_FACTOR as t,TEXTURE_BINDING_ATTRIBUTE_DATA_0 as e,TEXTURE_BINDING_ATTRIBUTE_DATA_1 as i,TEXTURE_BINDING_ATTRIBUTE_DATA_2 as s,TEXTURE_BINDING_ATTRIBUTE_DATA_3 as o,TEXTURE_BINDING_ATTRIBUTE_DATA_4 as a,TEXTURE_BINDING_ATTRIBUTE_DATA_5 as r}from"../definitions.js";import n from"./WGLBrush.js";import{MaterialKeyBase as u}from"../materialKey/MaterialKey.js";import{BlendFactor as m,CompareFunction as l}from"../../../../webgl/enums.js";class v extends n{constructor(){super(...arguments),this._computeDesc=new Map}prepareState({context:t},e){e&&e.includes("hittest")?t.setBlendFunctionSeparate(m.ONE,m.ONE,m.ONE,m.ONE):t.setBlendFunctionSeparate(m.ONE,m.ONE_MINUS_SRC_ALPHA,m.ONE,m.ONE_MINUS_SRC_ALPHA),t.setBlendingEnabled(!0),t.setColorMask(!0,!0,!0,!0),t.setStencilWriteMask(0),t.setStencilTestEnabled(!0)}draw(t,e,i){const s=this.getGeometryType();e.commit(t);const o=e.getGeometry(s);null!=o&&(t.timeline.begin(this.name),t.attributeView.bindTextures(t.context),t.context.setStencilFunction(l.EQUAL,e.stencilRef,255),o.forEachCommand((s=>{const o=u.load(s.materialKey).symbologyType;this.supportsSymbology(o)&&this.drawGeometry(t,e,s,i)})))}_setSharedUniforms(n,u,m){const{displayLevel:l,pixelRatio:v,state:f,passOptions:p}=u;null!=p&&"hittest"===p.type&&(n.setUniform2fv("u_hittestPos",p.position),n.setUniform1f("u_hittestDist",p.distance)),n.setUniform1f("u_pixelRatio",v),n.setUniformMatrix3fv("u_tileMat3",m.transforms.tileMat3),n.setUniformMatrix3fv("u_viewMat3",f.viewMat3),n.setUniformMatrix3fv("u_dvsMat3",m.transforms.dvs),n.setUniformMatrix3fv("u_displayViewMat3",f.displayViewMat3),n.setUniform1f("u_currentZoom",Math.round(l*t)),n.setUniform1i("u_attributeTextureSize",u.attributeView.size),n.setUniform1i("u_attributeData0",e),n.setUniform1i("u_attributeData1",i),n.setUniform1i("u_attributeData2",s),n.setUniform1i("u_attributeData3",o),n.setUniform1i("u_attributeData4",a),n.setUniform1i("u_attributeData5",r)}_setSizeVVUniforms(t,e,i,s){if(t.vvSizeMinMaxValue&&e.setUniform4fv("u_vvSizeMinMaxValue",i.vvSizeMinMaxValue),t.vvSizeScaleStops&&e.setUniform1f("u_vvSizeScaleStopsValue",i.vvSizeScaleStopsValue),t.vvSizeFieldStops){const t=i.getSizeVVFieldStops(s.key.level);null!=t&&(e.setUniform1fv("u_vvSizeFieldStopsValues",t.values),e.setUniform1fv("u_vvSizeFieldStopsSizes",t.sizes))}t.vvSizeUnitValue&&e.setUniform1f("u_vvSizeUnitValueWorldToPixelsRatio",i.vvSizeUnitValueToPixelsRatio)}_setColorAndOpacityVVUniforms(t,e,i){t.vvColor&&(e.setUniform1fv("u_vvColorValues",i.vvColorValues),e.setUniform4fv("u_vvColors",i.vvColors)),t.vvOpacity&&(e.setUniform1fv("u_vvOpacityValues",i.vvOpacityValues),e.setUniform1fv("u_vvOpacities",i.vvOpacities))}_setRotationVVUniforms(t,e,i){t.vvRotation&&e.setUniform1f("u_vvRotationType","geographic"===i.vvMaterialParameters.vvRotationType?0:1)}_getTriangleDesc(t,e,i=["a_pos"]){const s=e.bufferLayouts.geometry,o=i.map((t=>s.findIndex((e=>e.name===t)))),a=`${t}-${o.join("-")}`;let r=this._computeDesc.get(a);if(!r){const t=e.strides,i=e.strides.geometry,n=new Map(e.attributes),u=s.map((t=>({...t}))),m=Math.max(...e.attributes.values()),l={geometry:u};let v=0;for(const e of o){const t=s[e];l.geometry.push({count:t.count,name:t.name+"1",divisor:t.divisor,normalized:t.normalized,offset:i+t.offset,stride:i,type:t.type}),l.geometry.push({count:t.count,name:t.name+"2",divisor:t.divisor,normalized:t.normalized,offset:2*i+t.offset,stride:i,type:t.type}),n.set(t.name+"1",m+ ++v),n.set(t.name+"2",m+ ++v)}r={bufferLayouts:l,attributes:n,strides:t},this._computeDesc.set(a,r)}return r}}export{v as default};
