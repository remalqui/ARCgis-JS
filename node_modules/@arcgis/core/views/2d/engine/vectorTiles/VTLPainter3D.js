/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{disposeMaybe as e}from"../../../../core/maybe.js";import{vtlBrushes as t}from"../vtlBrushes.js";import r from"./shaders/VTLMaterialManager.js";import{Visibility as s,StyleLayerType as a}from"./style/StyleDefinition.js";import{CompareFunction as n,BlendFactor as i}from"../../../webgl/enums.js";const l=1e-6;class o{constructor(e,t){this.spriteMosaic=e,this.glyphMosaic=t,this._brushCache=new Map,this._vtlMaterialManager=new r}dispose(){this._brushCache&&(this._brushCache.forEach((e=>e.dispose())),this._brushCache=null),this._vtlMaterialManager=e(this._vtlMaterialManager),this.spriteMosaic.dispose(),this.glyphMosaic.dispose()}get vectorTilesMaterialManager(){return this._vtlMaterialManager}drawTile(e,t,r,s){const{context:a}=e,l=r.layers;r.backgroundBucketIds.length>0&&(e.renderPass="background",r.backgroundBucketIds.forEach((a=>{const n=r.getLayerById(a);null!=s&&s!==n.type||this._renderStyleLayer(n,e,t,!0)}))),a.setBlendingEnabled(!1),a.setDepthTestEnabled(!0),a.setDepthWriteEnabled(!0),a.setDepthFunction(n.LEQUAL),e.renderPass="opaque";for(let n=l.length-1;n>=0;n--){const r=l[n];null!=s&&s!==r.type||this._renderStyleLayer(r,e,t,!1)}a.setDepthWriteEnabled(!1),a.setBlendingEnabled(!0),a.setBlendFunctionSeparate(i.ONE,i.ONE_MINUS_SRC_ALPHA,i.ONE,i.ONE_MINUS_SRC_ALPHA),e.renderPass="translucent";for(let n=0;n<l.length;n++){const r=l[n];null!=s&&s!==r.type||this._renderStyleLayer(r,e,t,!1)}a.setDepthTestEnabled(!1),a.bindVAO()}_renderStyleLayer(e,t,r,n){if(!(n||e&&r.layerData.has(e.uid)))return;const i=e.getLayoutProperty("visibility");if(i&&i.getValue()===s.NONE)return;const{renderPass:o}=t;let h;switch(e.type){case a.BACKGROUND:if("background"!==o)return;h="vtlBackground";break;case a.FILL:if("opaque"!==o&&"translucent"!==t.renderPass)return;h="vtlFill";break;case a.LINE:if("translucent"!==o)return;h="vtlLine";break;case a.CIRCLE:if("translucent"!==o)return;h="vtlCircle";break;case a.SYMBOL:if("translucent"!==o)return;h="vtlSymbol"}const c=t.displayLevel;void 0!==e.minzoom&&e.minzoom>c+l||void 0!==e.maxzoom&&e.maxzoom<=c-l||(t.styleLayerUID=e.uid,t.styleLayer=e,this._drawWithBrush(t,r,h))}_drawWithBrush(e,r,s){if(!this._brushCache.has(s)){const e=t[s];this._brushCache.set(s,new e)}this._brushCache.get(s).drawMany(e,[r])}}export{o as default};
