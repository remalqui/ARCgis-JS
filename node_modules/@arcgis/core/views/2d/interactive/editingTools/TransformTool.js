/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{_ as t}from"../../../../chunks/tslib.es6.js";import"../../../../geometry.js";import e from"../../../../Graphic.js";import"../../../../symbols.js";import{getAccentColor as i,getContrastColor as s}from"../../../../core/analysisThemeUtils.js";import{destroyMaybe as o}from"../../../../core/maybe.js";import{watch as r}from"../../../../core/reactiveUtils.js";import{getMetersPerUnitForSR as a}from"../../../../core/unitUtils.js";import{property as n}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/accessorSupport/ensureType.js";import"../../../../core/arrayUtils.js";import"../../../../core/has.js";import{subclass as h}from"../../../../core/accessorSupport/decorators/subclass.js";import{c,e as p}from"../../../../chunks/vec2.js";import{a as l,U as _}from"../../../../chunks/vec2f64.js";import{g as m,l as d,n as y,a as u,h as g,b as f}from"../../../../chunks/vec3.js";import{c as v}from"../../../../chunks/vec3f64.js";import{project as G,initializeProjection as w}from"../../../../geometry/projection.js";import{a as R,c as b}from"../../../../chunks/boundedPlane.js";import{equals as k}from"../../../../geometry/support/spatialReferenceUtils.js";import j from"../../../../layers/GraphicsLayer.js";import{ViewingMode as P}from"../../../ViewingMode.js";import{DragManipulation as A}from"./manipulations/DragManipulation.js";import{RotateManipulation as C}from"./manipulations/RotateManipulation.js";import{ScaleManipulation as S}from"./manipulations/ScaleManipulation.js";import{PreserveAspectRatio as M,SnapRotation as T}from"./manipulations/utils.js";import{primaryKey as O}from"../../../input/keys.js";import{InteractiveToolBase as U}from"../../../interactive/InteractiveToolBase.js";import{EditGeometry as D}from"../../../interactive/editGeometry/EditGeometry.js";import{EditGeometryOperations as x}from"../../../interactive/editGeometry/EditGeometryOperations.js";import{AccumulationBehaviour as E}from"../../../interactive/editGeometry/interfaces.js";import{AccumulationType as L}from"../../../interactive/editGeometry/operations/UpdateVertices.js";import{calculateOrientedBounds as B}from"../../../interactive/editGeometry/support/editPlaneUtils.js";import{findFirstGraphicHit as H}from"../../../support/hitTestSelectUtils.js";import{createScreenPointFromEvent as V}from"../../../support/screenUtils.js";import I from"../../../../geometry/Polygon.js";import z from"../../../../geometry/Point.js";import K from"../../../../symbols/SimpleFillSymbol.js";import N from"../../../../symbols/SimpleMarkerSymbol.js";const W={up:"ArrowUp",down:"ArrowDown",left:"ArrowLeft",right:"ArrowRight",plus:"+",minus:"-",toggleOpacity:"t",shift:"Shift",primaryKey:O},q=80,F=10,J=30,Q=[[1,1],[1,-1],[-1,-1],[-1,1],[1,0],[0,-1],[-1,0],[0,1]],X=1,Y=10;let Z=class extends U{constructor(t){super(t),this._initialControlPoints=null,this._initialGeometry=null,this._graphic=null,this._planeCache=R(),this._displayPlaneCache=R(),this._mainAxisCache=l(),this._rotationHandleCache=v(),this._cornerA=v(),this._cornerB=v(),this._cornerC=v(),this._cornerD=v(),this._avgAB=v(),this._avgBC=v(),this._avgCD=v(),this._avgDA=v(),this._preserveAspectRatio=new M,this._snapRotation=new T,this._graphicsLayer=new j({internal:!0,listMode:"hide",visible:!1}),this._sharedUndoStack=[],this._sharedRedoStack=[],this._isOpacityToggled=!1,this._isModifierActive=!1,this._factor=1,this.preserveAspectRatio=null,this.snapRotation=null}initialize(){this._initialize()}destroy(){const{map:t}=this.view;this._dragManipulation.destroy(),this._rotateManipulation.destroy(),this._scaleManipulations.forEach((t=>t.destroy())),this._editGeometryOperations.destroy(),t.removeMany([this._graphicsLayer]),this._graphicsLayer.removeAll(),this._graphicsLayer=o(this._graphicsLayer),this._initialControlPoints=null,this._initialGeometry=null,this._graphic=null,this._preserveAspectRatio=null,this._snapRotation=null,this._planeCache=null,this._displayPlaneCache=null,this._rotationHandleCache=null,this._mainAxisCache=null,this._cornerA=null,this._cornerB=null,this._cornerC=null,this._cornerD=null,this._avgAB=null,this._avgBC=null,this._avgCD=null,this._avgDA=null,this._sharedUndoStack=null,this._sharedRedoStack=null}get _plane(){const t=this._graphic.geometry;if(null==t)return null;const e=this._editGeometryOperations.data,i=e.components[0].edges[0],s=c(this._mainAxisCache,i.leftVertex.pos,i.rightVertex.pos);p(s,s);let o=q*this.view.resolution;const r=this.view.spatialReference;return k(r,t.spatialReference)&&(o*=a(r)/a(t.spatialReference)),B(s,e,o,this._planeCache)}get _displayPlane(){const t=this._plane;if(!t)return null;const e=this._displayPlaneCache;b(t,e);const i=F*this.view.resolution;return m(e.basis1,e.basis1,1+i/d(e.basis1)),m(e.basis2,e.basis2,1+i/d(e.basis2)),e}get _backgroundGraphicGeometry(){const t=this._displayPlane;if(!t)return null;const e=this.view.spatialReference;return this._updateDisplayPlaneConrers(t),new I({spatialReference:e,rings:[[this._cornerA,this._cornerB,this._cornerC,this._cornerD,this._cornerA]]})}get _rotateGraphicGeometry(){const t=this._plane;if(!t)return null;const e=this._rotationHandleCache;return y(e,t.basis1),m(e,e,J*this.view.resolution),u(e,e,t.origin),u(e,e,t.basis1),new z({x:e[0],y:e[1],spatialReference:this.view.spatialReference})}get _scaleGraphicGeometries(){const t=this._displayPlane;if(!t)return[];const e=this.view.spatialReference;this._updateDisplayPlaneConrers(t);const{_cornerA:i,_cornerB:s,_cornerC:o,_cornerD:r}=this,a=g(this._avgAB,i,s,.5),n=g(this._avgBC,s,o,.5),h=g(this._avgCD,o,r,.5),c=g(this._avgDA,r,i,.5);return[new z({x:i[0],y:i[1],spatialReference:e}),new z({x:s[0],y:s[1],spatialReference:e}),new z({x:o[0],y:o[1],spatialReference:e}),new z({x:r[0],y:r[1],spatialReference:e}),new z({x:a[0],y:a[1],spatialReference:e}),new z({x:n[0],y:n[1],spatialReference:e}),new z({x:h[0],y:h[1],spatialReference:e}),new z({x:c[0],y:c[1],spatialReference:e})]}onActivate(){this.visible=!0}onDeactivate(){this.visible=!1}onShow(){this._graphicsLayer.visible=!0}onHide(){this._graphicsLayer.visible=!1}canUndo(){return this._editGeometryOperations.canUndo}canRedo(){return this._editGeometryOperations.canRedo}undo(){this._editGeometryOperations.undo(),this.updateGraphics()}redo(){this._editGeometryOperations.redo(),this.updateGraphics()}refresh(){const{view:t,target:e}=this,i="georeference"in e?e.georeference.coords:e.geometry,s=this._editGeometryOperations,o=s.data.components[0].vertices,r=D.fromGeometry(G(i,t.spatialReference),P.Local).components[0].vertices;o.forEach(((t,e)=>{s.setVertexPosition(t,r[e].pos)})),this.updateGraphics()}reset(){const{target:t}=this;if("georeference"in t){const e=t.georeference;"control-points"===e.type&&(e.controlPoints=this._initialControlPoints)}else t.geometry=this._initialGeometry;this.refresh(),this._sharedUndoStack.length=0,this._sharedRedoStack.length=0}updateGraphics(){const t=this._editGeometryOperations.data.geometry;if("georeference"in this.target){this.target.georeference.coords=t}this._graphic.geometry=t,this._backgroundGraphic.geometry=this._backgroundGraphicGeometry,this._rotateGraphic.geometry=this._rotateGraphicGeometry,this._scaleGraphicGeometries.forEach(((t,e)=>{this._scaleGraphics[e].geometry=t}))}setSharedUndoStack(t){this._sharedUndoStack=t}setSharedRedoStack(t){this._sharedRedoStack=t}async _initialize(){const{view:t,target:o}=this;if("georeference"in o){const t=o.georeference;this._graphic=new e({geometry:t.coords}),this._initialControlPoints="control-points"===t.type?t.controlPoints:null}else this._graphic=o,this._initialGeometry=o.geometry;t.map.addMany([this._graphicsLayer]),t.focus(),this.visible=!1,this.finishToolCreation(),await this._loadProjectionEngine(),this._editGeometryOperations=x.fromGeometry(G(this._graphic.geometry,t.spatialReference),P.Local),this._backgroundGraphic=new e({symbol:new K({color:"transparent",outline:{type:"simple-line",color:i(),width:2}}),geometry:this._backgroundGraphicGeometry}),this._rotateGraphic=new e({symbol:new N({color:s(),outline:{type:"simple-line",color:i(),width:1}}),geometry:this._rotateGraphicGeometry}),this._scaleGraphics=this._scaleGraphicGeometries.map((t=>new e({symbol:new N({size:6,style:"square",color:s(),outline:{type:"simple-line",color:i(),width:1}}),geometry:t}))),this._graphicsLayer.graphics.addMany([this._backgroundGraphic,this._rotateGraphic,...this._scaleGraphics]),this._dragManipulation=new A({tool:this,view:t,graphic:this._graphic}),this._rotateManipulation=new C({tool:this,view:t,graphic:this._rotateGraphic,snapRotation:this._snapRotation}),this._scaleManipulations=this._scaleGraphics.map(((e,i)=>new S({tool:this,view:t,graphic:e,direction:Q[i],preserveAspectRatio:this._preserveAspectRatio}))),this.addHandles([this._dragManipulation.createDragPipeline(this._getInfo.bind(this),this._updateGraphics.bind(this)),this._rotateManipulation.createDragPipeline(this._getInfo.bind(this),this._updateGraphics.bind(this)),...this._scaleManipulations.map((t=>t.createDragPipeline(this._getInfo.bind(this),this._updateGraphics.bind(this)))),r((()=>this.view.scale),(()=>this.active?this.updateGraphics():null)),t.on("click",(async e=>{if(null!=t.activeTool&&t.activeTool!==this)return;const i=V(e),s=[];t.map.allLayers.forEach((t=>{"vector-tile"!==t.type&&"imagery"!==t.type||s.push(t)}));const r=await this.view.hitTest(i,{exclude:s}),a=r.results;if(0===a.length)t.activeTool=null;else{const e=H(r.results),i="georeference"in o,s=a.map((t=>"media"===t.type?t.element:null)).filter(Boolean),n=[...this._graphicsLayer.graphics,i?null:o].filter(Boolean);i&&s.includes(o)||null!=e&&n.includes(e.graphic)?null==t.activeTool&&(t.activeTool=this):t.activeTool=null}}))]);const a=t=>{this.addHandles(t.events.on("grab-changed",(t=>{"georeference"in o&&("start"===t.action?o.opacity*=.5:"end"===t.action&&(o.opacity*=2))})))};this._dragManipulation.forEachManipulator(a),this._rotateManipulation.forEachManipulator(a),this._scaleManipulations.forEach((t=>t.forEachManipulator(a))),this.addHandles([t.on("key-down",(e=>{t.activeTool===this&&(e.key!==W.shift||e.repeat||(null==this.preserveAspectRatio&&(this._preserveAspectRatio.enabled=!this._preserveAspectRatio.enabled),null==this.snapRotation&&(this._snapRotation.enabled=!this._snapRotation.enabled),this._isModifierActive=!0,e.stopPropagation()),e.key!==W.toggleOpacity||e.repeat||("georeference"in o&&(o.opacity*=this._isOpacityToggled?2:.5,this._isOpacityToggled=!this._isOpacityToggled),e.stopPropagation()),e.key!==W.primaryKey||e.repeat||(this._factor=Y,e.stopPropagation()),this._isModifierActive&&(e.key===W.plus&&(this._scale(this._factor),e.stopPropagation()),e.key===W.minus&&(this._scale(-this._factor),e.stopPropagation()),e.key===W.up&&(this._move(0,this._factor),e.stopPropagation()),e.key===W.down&&(this._move(0,-this._factor),e.stopPropagation()),e.key===W.left&&(this._move(-this._factor,0),e.stopPropagation()),e.key===W.right&&(this._move(this._factor,0),e.stopPropagation())))})),t.on("key-up",(e=>{t.activeTool===this&&(e.key===W.shift&&(null==this.preserveAspectRatio&&(this._preserveAspectRatio.enabled=!this._preserveAspectRatio.enabled),null==this.snapRotation&&(this._snapRotation.enabled=!this._snapRotation.enabled),this._isModifierActive=!1,e.stopPropagation()),e.key===W.primaryKey&&(this._factor=X,e.stopPropagation()))}))])}async _loadProjectionEngine(){const t=this._graphic.geometry;return w(t.spatialReference,this.view.spatialReference)}_updateDisplayPlaneConrers(t){const{basis1:e,basis2:i,origin:s}=t,o=this._cornerA;u(o,s,e),u(o,o,i);const r=this._cornerB;u(r,s,e),f(r,r,i);const a=this._cornerC;f(a,s,e),f(a,a,i);const n=this._cornerD;f(n,s,e),u(n,n,i)}_getInfo(){return{editGeometryOperations:this._editGeometryOperations,plane:this._plane,displayPlane:this._displayPlane}}_updateGraphics(t,e){"start"===t.action&&(this._sharedUndoStack.push({tool:this,operation:e}),this._sharedRedoStack.length=0),this.updateGraphics()}_scale(t){const e=this._editGeometryOperations,i=[];for(const a of e.data.components)i.push(...a.vertices);const s=e.data.geometry.extent?.width,o=(s+t*this.view.resolution)/s,r=e.scaleVertices(i,this._plane.origin,_,o,o,E.NEW_STEP,L.REPLACE);this._sharedUndoStack.push({tool:this,operation:r}),this._sharedRedoStack.length=0,this.updateGraphics()}_move(t,e){const i=this._editGeometryOperations,s=[];for(const r of i.data.components)s.push(...r.vertices);const o=i.moveVertices(s,t*this.view.resolution,e*this.view.resolution,0,E.NEW_STEP);this._sharedUndoStack.push({tool:this,operation:o}),this._sharedRedoStack.length=0,this.updateGraphics()}};t([n()],Z.prototype,"_plane",null),t([n()],Z.prototype,"_backgroundGraphicGeometry",null),t([n()],Z.prototype,"_rotateGraphicGeometry",null),t([n()],Z.prototype,"_scaleGraphicGeometries",null),t([n()],Z.prototype,"preserveAspectRatio",void 0),t([n()],Z.prototype,"snapRotation",void 0),t([n({constructOnly:!0,nonNullable:!0})],Z.prototype,"target",void 0),t([n({constructOnly:!0})],Z.prototype,"view",void 0),Z=t([h("esri.views.2d.interactive.editingTools.TransformTool")],Z);export{W as KEYS,Z as TransformTool};
