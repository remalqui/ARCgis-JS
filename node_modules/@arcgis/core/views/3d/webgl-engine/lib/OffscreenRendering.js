/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import"../../../../core/has.js";import{RenderTargetHelper as e}from"./RenderTargetHelper.js";import{TransparencyPassType as t}from"./TransparencyPassType.js";import{AlphaMode as r}from"../shaders/CompositingTechniqueConfiguration.js";import{PixelType as i,SizedPixelFormat as o,TextureSamplingMode as s,ClearBufferBit as a}from"../../../webgl/enums.js";import{ensureAttachmentMaxSize as h}from"../../../webgl/FramebufferObject.js";class n{constructor(t,r){this._rctx=t,this._compositingHelper=r,this._mainColorTarget=0,this.width=4,this.height=4,this._background={type:"color",color:[0,0,0,1]},this._renderTargetHelper=new e(t);const a=this._renderTargetHelper;this._mainColorTargets=[a.registerColorTarget({name:"mainColorTarget0"}),a.registerColorTarget({name:"mainColorTarget1"})],this.frontFaceTarget=a.registerColorTarget({name:"frontFaceTarget"}),this.colorFloatTarget=a.registerColorTarget({name:"colorFloatTarget",dataType:i.HALF_FLOAT,internalFormat:o.RGBA16F,samplingMode:s.NEAREST}),this.alphaFloatTarget=a.registerColorTarget({name:"alphaFloatTarget",dataType:i.HALF_FLOAT,internalFormat:o.R16F,samplingMode:s.NEAREST}),this.mainDepth=a.registerDepthTarget({name:"mainDepth"}),this.linearDepth=a.registerColorTarget({name:"linearDepth",samplingMode:s.NEAREST}),this.terrainLinearDepth=a.registerColorTarget({name:"terrainLinearDepth"}),this.geometryLinearDepth=a.registerColorTarget({name:"geometryLinearDepth"}),this.normal=a.registerColorTarget({name:"normal"}),this.highlight=a.registerColorTarget({name:"highlight",internalFormat:o.RGBA4,dataType:i.UNSIGNED_SHORT_4_4_4_4}),this.hudVisibility=a.registerColorTarget({name:"hudVisibility",internalFormat:o.RGBA4,dataType:i.UNSIGNED_SHORT_4_4_4_4}),this.tmpColor=a.registerColorTarget({name:"tmpColor"}),this.tmpDepth=a.registerDepthTarget({name:"tmpDepth"}),this.hudColor=a.registerColorTarget({name:"hudColor"})}dispose(){this._renderTargetHelper.dispose()}set background(e){this._background=e}get background(){return this._background}get currentColorTarget(){return this._mainColorTargets[this._mainColorTarget]}get previousColorTarget(){return this._mainColorTargets[1-this._mainColorTarget]}get framebuffer(){return this.getFramebuffer(this.currentColorTarget,this.mainDepth)}getFramebuffer(e,t){return this._renderTargetHelper.getFramebuffer(this.width,this.height,e,t)}get colorTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.currentColorTarget)}get depthTexture(){return this._renderTargetHelper.getAllocatedDepthTexture(this.mainDepth)}get linearDepthTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.linearDepth)}get terrainLinearDepthTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.terrainLinearDepth)}get geometryLinearDepthTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.geometryLinearDepth)}get lastFrameColorTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.previousColorTarget)}get normalTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.normal)}get highlightTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.highlight)}get hudVisibilityTexture(){return this._getColorTexture(this.hudVisibility)}get tmpColorTexture(){return this._getColorTexture(this.tmpColor)}get hudColorTexture(){return this._getColorTexture(this.hudColor)}get mainColorTexture(){return this._getColorTexture(this.currentColorTarget)}setupRenderTarget(e){e?this._mainColorTarget=this._mainColorTarget?0:1:(this._mainColorTarget=0,this.disposeTarget(this._mainColorTargets[1]))}initializeFrame(e){const t=this._rctx;this.width=e.fullWidth,this.height=e.fullHeight,h(this,t.parameters.maxTextureSize),this.bindTarget(this.currentColorTarget,this.mainDepth),t.setClearStencil(0);const r=this._background.color;t.setClearColor(r[0]*r[3],r[1]*r[3],r[2]*r[3],r[3]),t.clearSafe(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT|a.STENCIL_BUFFER_BIT)}composite(e){null!=this.colorTexture&&this._compositingHelper.composite(e,this.colorTexture,r.None)}renderTmpAndCompositeToMain(e,t,r,i=!1){this.renderToTargets(e,this.tmpColor,i?this.tmpDepth:this.mainDepth,l),this._compositingHelper.composite(t,this._getColorTexture(this.tmpColor),r)}compositeAtmosphereToMain(e,t,r,i){this.bindTarget(this.currentColorTarget),this._compositingHelper.compositeAtmosphere(e,this._renderTargetHelper.getColorTexture(this.tmpColor,this.width,this.height),r,i,t),this.bindTarget(this.currentColorTarget,this.mainDepth)}renderHUDVisibility(e,t=!1){this.renderToTargets(e,this.hudVisibility,t?this.tmpDepth:this.mainDepth,g)}compositeTransparentTerrainOntoHUDVisibility(e){this.renderToTargets((()=>this._compositingHelper.compositeHUD(e,this._getColorTexture(this.tmpColor))),this.hudVisibility,this.tmpDepth)}renderOITPass(e,r,i){let o,s;switch(r){case t.Color:o=this.colorFloatTarget,s=[0,0,0,0];break;case t.Alpha:o=this.alphaFloatTarget,s=[1,1,1,1];break;case t.FrontFace:o=this.frontFaceTarget,s=[0,0,0,0];break;case t.NONE:case t.COUNT:return}i?this.renderToTargets(e,o,this.tmpDepth,s,!0,!0):this.renderToTargets(e,o,this.mainDepth,s,!1)}compositeTransparentTerrainOntoMain(e){this.bindFramebuffer(),this._compositingHelper.composite(e,this._getColorTexture(this.tmpColor),r.PremultipliedAlpha)}compositeOccludedOntoMain(e,t){this.bindFramebuffer(),this._compositingHelper.composite(e,this._getColorTexture(this.tmpColor),r.PremultipliedAlpha,t)}compositeTransparentOntoOpaque(e,t){t?(this.bindTarget(this.hudColor,this.tmpDepth),this._rctx.setClearColor(0,0,0,1e-13),this._rctx.clearSafe(a.COLOR_BUFFER_BIT)):this.bindFramebuffer(),this._compositingHelper.compositeOIT(e,this._getColorTexture(this.colorFloatTarget),this._getColorTexture(this.alphaFloatTarget),this._getColorTexture(this.frontFaceTarget))}bindFramebuffer(){this._rctx.bindFramebuffer(this.framebuffer)}renderDepthDetached(e){this.bindTarget(this.currentColorTarget),e(),this.bindTarget(this.currentColorTarget,this.mainDepth)}disposeTarget(e){this._renderTargetHelper.disposeTargetResource(e)}renderToFBO(e,t,r=!1,i=!1){const o=this._rctx;let s=0;if(t){const e=1e-13,r=Math.max(e,t[3]);o.setClearColor(t[0],t[1],t[2],r),s|=a.COLOR_BUFFER_BIT}r&&(s|=a.DEPTH_BUFFER_BIT),!1===i?i=0:(!0===i&&(i=255),s|=a.STENCIL_BUFFER_BIT),s&&o.clearSafe(s,i),e(),o.gl.flush(),this.bindTarget(this.currentColorTarget,this.mainDepth)}renderToTargets(e,t,r,i,o=!1,s=!1){const a=this.bindTarget(t,r);return this.renderToFBO(e,i,o,s),a}bindTarget(e,t){const r=this._renderTargetHelper.getFramebuffer(this.width,this.height,e,t);return this._rctx.bindFramebuffer(r),r}_getColorTexture(e){return this._renderTargetHelper.getColorTexture(e,this.width,this.height)}get gpuMemoryUsage(){let e=0;return this._renderTargetHelper&&(e+=this._renderTargetHelper.gpuMemoryUsage),e}}const l=[0,0,0,0],g=[0,1,0,1];export{n as OffscreenRendering};
