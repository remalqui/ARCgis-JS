/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../chunks/tslib.es6.js";import r from"../../../../core/Accessor.js";import t from"../../../../core/PooledArray.js";import{isPromiseLike as n,createAbortError as s}from"../../../../core/promiseUtils.js";import{property as o}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/accessorSupport/ensureType.js";import"../../../../core/arrayUtils.js";import"../../../../core/has.js";import{subclass as i}from"../../../../core/accessorSupport/decorators/subclass.js";import{union as l}from"./depthRange.js";import{RenderOccludedFlag as u}from"./Material.js";import{RenderSlot as a}from"./RenderSlot.js";let d=class extends r{constructor(e){super({}),this._context=e,this._renderPlugins=new t,this._slots=[];for(let r=0;r<a.MAX_SLOTS;++r)this._slots[r]=[]}normalizeCtorArgs(){return{}}add(e,r,t){const o=()=>{if(t?.aborted)throw r.uninitializeRenderContext(),s();this._renderPlugins.push(r);for(const t of e)this._slots[t].push(r);this._context.requestRender()},i=r.initializeRenderContext(this._context,t);if(n(i))return i.then(o);o(),this.notifyChange("_renderPlugins")}remove(e){if(null!=this._renderPlugins.removeUnordered(e)){for(let r=0;r<this._slots.length;++r)this._slots[r]=this._slots[r].filter((r=>r!==e));e.uninitializeRenderContext(),this._context.requestRender(),this.notifyChange("_renderPlugins")}}prepareRender(){this._renderPlugins.forAll((e=>{e.prepareRender&&e.prepareRender(this._context.renderContext)}))}updateAnimation(e){let r=!1;return this._renderPlugins.forAll((t=>{t.updateAnimation&&(r=t.updateAnimation(e)||r)})),r}prepareSlots(e){for(const r of e)this._context.renderContext.bindParameters.slot=r,this._slots[r].filter((e=>{e.canRender&&(p(e)&&e.prepareTechnique(this._context.renderContext),h(e)&&e.prepareTechniques(this._context.renderContext))}))}render(){const e=this._slots[this._context.renderContext.bindParameters.slot],r=new Array;e.filter((e=>{if(!e.canRender)return!1;if(p(e)){const t=e.prepareTechnique(this._context.renderContext);return null!=t&&(r.push(t),!0)}if(h(e)){const t=e.prepareTechniques(this._context.renderContext);return null!=t&&(r.push(t),!0)}return r.push(null),!0})).forEach(((e,t)=>e.render(this._context.renderContext,r[t])))}queryDepthRange(e){const r=c;return r.near=1/0,r.far=-1/0,this._renderPlugins.forAll((t=>{if(t.queryDepthRange){const n=t.queryDepthRange(e);n&&l(r,n,r)}})),r}get updating(){return this._renderPlugins.some((e=>e.running))}get needsTransparentPass(){return this._renderPlugins.some((e=>e.needsTransparentPass))}get needsHighlight(){return this._renderPlugins.some((e=>e.needsHighlight))}get needsLinearDepth(){return this._renderPlugins.some((e=>e.needsLinearDepth))}get needsLaserlineWithContrastControl(){const e=this._slots[a.LASERLINES_CONTRAST_CONTROL];return!!e&&e.length>0}get renderOccludedFlags(){return this._renderPlugins.reduce(((e,r)=>e|r.renderOccludedFlags),u.None)}};function p(e){return"prepareTechnique"in e}function h(e){return"prepareTechniques"in e}e([o()],d.prototype,"_renderPlugins",void 0),e([o({readOnly:!0})],d.prototype,"updating",null),d=e([i("esri.views.3d.webgl-engine.lib.RenderPluginManager")],d);const c={near:0,far:0};export{d as RenderPluginManager};
