/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../chunks/tslib.es6.js";import r from"../../../../core/Accessor.js";import{abortMaybe as s,disposeMaybe as t}from"../../../../core/maybe.js";import{throwIfAborted as i,isAborted as a}from"../../../../core/promiseUtils.js";import{property as o}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/accessorSupport/ensureType.js";import"../../../../core/arrayUtils.js";import"../../../../core/has.js";import{subclass as n}from"../../../../core/accessorSupport/decorators/subclass.js";import{requestImage as h}from"../../../../support/requestImageUtils.js";import{ShaderTechniqueConfiguration as l}from"../core/shaderTechnique/ShaderTechniqueConfiguration.js";import{BlendWeightsTechnique as u}from"./BlendWeightsTechnique.js";import{BlurTechnique as c}from"./BlurTechnique.js";import{EdgeDetectTechnique as d}from"./EdgeDetectTechnique.js";import{createScreenSizeTriangleVAO as m}from"./glUtil3D.js";import{SMAAPassParameters as _}from"../shaders/SMAAPassParameters.js";import{TextureSamplingMode as p,PixelFormat as b,SizedPixelFormat as T,TextureWrapMode as f,ClearBufferBit as g,PrimitiveType as x}from"../../../webgl/enums.js";import{FramebufferObject as q}from"../../../webgl/FramebufferObject.js";import{Texture as P}from"../../../webgl/Texture.js";import{TextureDescriptor as w}from"../../../webgl/TextureDescriptor.js";let A=class extends r{constructor(e,r){super({}),this._rctx=e,this._techniqueRep=r,this._passParameters=new _,this._isEnabled=!1}normalizeCtorArgs(){return{}}dispose(){this._abortController=s(this._abortController),this.disable()}_loadResources(e){if(null!=this._abortController)return!1;if(null!=this._passParameters.searchTexture)return!0;this._abortController=new AbortController;const r=this._abortController.signal;return import("./SmaaRenderPassData.js").then((e=>this._loadTextures(e,r))).then((()=>e())).finally((()=>this._abortController=null)),!1}_loadTextures(e,r){return i(r),Promise.all([this._loadTextureFromBase64(e.areaTexture,p.LINEAR,b.RGB),this._loadTextureFromBase64(e.searchTexure,p.NEAREST,b.LUMINANCE)]).then((([e,s])=>{a(r)?(e.dispose(),s.dispose(),i(r)):(this._passParameters.areaTexture=e,this._passParameters.searchTexture=s)}))}get updating(){return null!=this._abortController}enable(e){if(this._isEnabled)return!0;if(!this._edgeDetectTechnique||!this._blendWeightsTechnique||!this._blurTechnique){const e=new l;this._edgeDetectTechnique=this._techniqueRep.releaseAndAcquire(d,e,this._edgeDetectTechnique),this._blendWeightsTechnique=this._techniqueRep.releaseAndAcquire(u,e,this._blendWeightsTechnique),this._blurTechnique=this._techniqueRep.releaseAndAcquire(c,e,this._blurTechnique)}if(!this._loadResources(e))return!1;this._vao=m(this._rctx);const r=new w(4,4);r.pixelFormat=b.RG,r.internalFormat=T.RG8,r.wrapMode=f.CLAMP_TO_EDGE,this._passParameters.edges=new q(this._rctx,r);const s=new w(4,4);return s.pixelFormat=b.RGBA,s.wrapMode=f.CLAMP_TO_EDGE,this._passParameters.blend=new q(this._rctx,s),this._isEnabled=!0,!0}disable(){this._isEnabled&&(this._vao=t(this._vao),this._passParameters.areaTexture=t(this._passParameters.areaTexture),this._passParameters.searchTexture=t(this._passParameters.searchTexture),this._passParameters.blend=t(this._passParameters.blend),this._passParameters.edges=t(this._passParameters.edges),this._isEnabled=!1)}get _validPassParameters(){return this._isEnabled?this._passParameters:null}render(e){const r=this._validPassParameters;if(null==r)return;r.colorTexture=e;const s=this._rctx,t=s.getBoundFramebufferObject(),i=e.descriptor.width,a=e.descriptor.height;s.bindVAO(this._vao),s.setViewport(0,0,i,a),r.edges.resize(i,a),s.bindFramebuffer(r.edges),s.setClearColor(0,0,0,1),s.clear(g.COLOR_BUFFER_BIT),s.bindTechnique(this._edgeDetectTechnique,r,null),s.drawArrays(x.TRIANGLES,0,3),r.blend.resize(i,a),s.bindFramebuffer(r.blend),s.setClearColor(0,0,1,1),s.clear(g.COLOR_BUFFER_BIT),s.bindTechnique(this._blendWeightsTechnique,r,null),s.drawArrays(x.TRIANGLES,0,3),s.bindFramebuffer(t),s.setClearColor(0,1,0,1),s.clear(g.COLOR_BUFFER_BIT),s.bindTechnique(this._blurTechnique,r,null),s.drawArrays(x.TRIANGLES,0,3)}_loadTextureFromBase64(e,r,s){return h(e).then((e=>{const t=new w;return t.pixelFormat=s,t.wrapMode=f.CLAMP_TO_EDGE,t.width=e.width,t.height=e.height,t.samplingMode=r,new P(this._rctx,t,e)}))}};e([o()],A.prototype,"_abortController",void 0),e([o({readOnly:!0})],A.prototype,"updating",null),A=e([n("esri.views.3d.webgl-engine.lib.SmaaRenderPass")],A);export{A as SmaaRenderPass};
