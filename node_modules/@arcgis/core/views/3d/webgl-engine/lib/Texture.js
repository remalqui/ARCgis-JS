/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import"../../../../core/has.js";import t from"../../../../core/Error.js";import e from"../../../../core/Evented.js";import{disposeMaybe as r,removeMaybe as a}from"../../../../core/maybe.js";import{throwIfAborted as s,onAbort as i,createAbortError as o}from"../../../../core/promiseUtils.js";import{isArrayBuffer as n,isUint8Array as l}from"../../../../core/typedArrayUtil.js";import{isBlobProtocol as m,isDataProtocol as h}from"../../../../core/urlUtils.js";import{requestImage as p}from"../../../../support/requestImageUtils.js";import{loadImageAsync as d}from"../../../../support/requestUtils.js";import{TextureEncodingMimeType as _}from"./basicInterfaces.js";import{createTextureKTX2 as c,createTextureBasis as u,estimateMemoryKTX2 as g,estimateMemoryBasis as A}from"./BasisUtil.js";import{ContentObject as E}from"./ContentObject.js";import{ContentObjectType as T}from"./ContentObjectType.js";import{createDDSTexture as f}from"./DDSUtil.js";import{assert as D}from"./Util.js";import{TextureWrapMode as x,TextureSamplingMode as y,PixelFormat as F}from"../../../webgl/enums.js";import{Texture as I}from"../../../webgl/Texture.js";import{TextureDescriptor as U}from"../../../webgl/TextureDescriptor.js";class w extends E{constructor(t,r){super(),this._data=t,this.type=T.Texture,this._glTexture=null,this._loadingPromise=null,this._loadingController=null,this.events=new e,this.parameters=r||{},this.parameters.mipmap=!1!==this.parameters.mipmap,this.parameters.noUnpackFlip=this.parameters.noUnpackFlip||!1,this.parameters.preMultiplyAlpha=this.parameters.preMultiplyAlpha||!1,this.parameters.wrap=this.parameters.wrap||{s:x.REPEAT,t:x.REPEAT},this._startPreload(t)}_startPreload(t){null!=t&&(t instanceof HTMLVideoElement?this._startPreloadVideoElement(t):t instanceof HTMLImageElement&&this._startPreloadImageElement(t))}_startPreloadVideoElement(t){if(!(m(t.src)||"auto"===t.preload&&t.crossOrigin)){t.preload="auto",t.crossOrigin="anonymous";const e=!t.paused;if(t.src=t.src,e&&t.autoplay){const e=()=>{t.removeEventListener("canplay",e),t.play()};t.addEventListener("canplay",e)}}}_startPreloadImageElement(t){h(t.src)||m(t.src)||t.crossOrigin||(t.crossOrigin="anonymous",t.src=t.src)}dispose(){this._data=void 0}_createDescriptor(t){const e=new U;return e.wrapMode=this.parameters.wrap??x.REPEAT,e.flipped=!this.parameters.noUnpackFlip,e.samplingMode=this.parameters.mipmap?y.LINEAR_MIPMAP_LINEAR:y.LINEAR,e.hasMipmap=!!this.parameters.mipmap,e.preMultiplyAlpha=!!this.parameters.preMultiplyAlpha,e.maxAnisotropy=this.parameters.maxAnisotropy??(this.parameters.mipmap?t.parameters.maxMaxAnisotropy:1),e}get glTexture(){return this._glTexture}get memoryEstimate(){return this._glTexture?.gpuMemoryUsage||H(this._data,this.parameters)}load(t){if(null!=this._glTexture)return this._glTexture;if(this._loadingPromise)return this._loadingPromise;const e=this._data;return null==e?(this._glTexture=new I(t,this._createDescriptor(t),null),this._glTexture):"string"==typeof e?this._loadFromURL(t,e):e instanceof Image?this._loadFromImageElement(t,e):e instanceof HTMLVideoElement?this._loadFromVideoElement(t,e):e instanceof ImageData||e instanceof HTMLCanvasElement?this._loadFromImage(t,e):(n(e)||l(e))&&this.parameters.encoding===_.DDS_ENCODING?(this._data=void 0,this._loadFromDDSData(t,e)):(n(e)||l(e))&&this.parameters.encoding===_.KTX2_ENCODING?(this._data=void 0,this._loadFromKTX2(t,e)):(n(e)||l(e))&&this.parameters.encoding===_.BASIS_ENCODING?(this._data=void 0,this._loadFromBasis(t,e)):l(e)?this._loadFromPixelData(t,e):n(e)?this._loadFromPixelData(t,new Uint8Array(e)):null}get requiresFrameUpdates(){return this._data instanceof HTMLVideoElement}frameUpdate(t){return this._data instanceof HTMLVideoElement&&null!=this._glTexture?this._data.readyState<C.HAVE_CURRENT_DATA||t===this._data.currentTime?t:(this._glTexture.setData(this._data),this._glTexture.descriptor.hasMipmap&&this._glTexture.generateMipmap(),this.parameters.updateCallback&&this.parameters.updateCallback(),this._data.currentTime):t}_loadFromDDSData(t,e){return this._glTexture=f(t,this._createDescriptor(t),e),this._glTexture}_loadFromKTX2(t,e){return this._loadAsync((()=>c(t,this._createDescriptor(t),e).then((t=>(this._glTexture=t,t)))))}_loadFromBasis(t,e){return this._loadAsync((()=>u(t,this._createDescriptor(t),e).then((t=>(this._glTexture=t,t)))))}_loadFromPixelData(t,e){D(this.parameters.width>0&&this.parameters.height>0);const r=this._createDescriptor(t);return r.pixelFormat=1===this.parameters.components?F.LUMINANCE:3===this.parameters.components?F.RGB:F.RGBA,r.width=this.parameters.width??0,r.height=this.parameters.height??0,this._glTexture=new I(t,r,e),this._glTexture}_loadFromURL(t,e){return this._loadAsync((async r=>{const a=await p(e,{signal:r});return s(r),this._loadFromImage(t,a)}))}_loadFromImageElement(t,e){return e.complete?this._loadFromImage(t,e):this._loadAsync((async r=>{const a=await d(e,e.src,!1,r);return s(r),this._loadFromImage(t,a)}))}_loadFromVideoElement(t,e){return e.readyState>=C.HAVE_CURRENT_DATA?this._loadFromImage(t,e):this._loadFromVideoElementAsync(t,e)}_loadFromVideoElementAsync(e,r){return this._loadAsync((s=>new Promise(((n,l)=>{const m=()=>{r.removeEventListener("loadeddata",h),r.removeEventListener("error",p),a(d)},h=()=>{r.readyState>=C.HAVE_CURRENT_DATA&&(m(),n(this._loadFromImage(e,r)))},p=e=>{m(),l(e||new t("Failed to load video"))};r.addEventListener("loadeddata",h),r.addEventListener("error",p);const d=i(s,(()=>p(o())))}))))}_loadFromImage(t,e){const r=N(e);this.parameters.width=r.width,this.parameters.height=r.height;const a=this._createDescriptor(t);return a.pixelFormat=3===this.parameters.components?F.RGB:F.RGBA,a.width=r.width,a.height=r.height,this._glTexture=new I(t,a,e),this._glTexture}_loadAsync(t){const e=new AbortController;this._loadingController=e;const r=t(e.signal);this._loadingPromise=r;const a=()=>{this._loadingController===e&&(this._loadingController=null),this._loadingPromise===r&&(this._loadingPromise=null)};return r.then(a,a),r}unload(){if(this._glTexture=r(this._glTexture),null!=this._loadingController){const t=this._loadingController;this._loadingController=null,this._loadingPromise=null,t.abort()}this.events.emit("unloaded")}}function H(t,e){if(null==t)return 0;if(n(t)||l(t))return e.encoding===_.KTX2_ENCODING?g(t,!!e.mipmap):e.encoding===_.BASIS_ENCODING?A(t,!!e.mipmap):t.byteLength;const{width:r,height:a}=t instanceof Image||t instanceof ImageData||t instanceof HTMLCanvasElement||t instanceof HTMLVideoElement?N(t):e;return(e.mipmap?4/3:1)*r*a*(e.components||4)||0}function N(t){return t instanceof HTMLVideoElement?{width:t.videoWidth,height:t.videoHeight}:t}var C;!function(t){t[t.HAVE_NOTHING=0]="HAVE_NOTHING",t[t.HAVE_METADATA=1]="HAVE_METADATA",t[t.HAVE_CURRENT_DATA=2]="HAVE_CURRENT_DATA",t[t.HAVE_FUTURE_DATA=3]="HAVE_FUTURE_DATA",t[t.HAVE_ENOUGH_DATA=4]="HAVE_ENOUGH_DATA"}(C||(C={}));export{w as Texture};
