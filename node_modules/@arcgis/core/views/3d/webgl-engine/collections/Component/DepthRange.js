/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{nullifyNonNullableForDispose as t}from"../../../../../core/maybe.js";import n from"../../../../../core/PooledArray.js";import{c as o,d as e}from"../../../../../chunks/mat3.js";import{c as r}from"../../../../../chunks/mat3f64.js";import{c as a}from"../../../../../chunks/quat.js";import{a as s}from"../../../../../chunks/quatf64.js";import{e as f,w as c,q as l,s as u,h as i,c as h,t as m,a as p}from"../../../../../chunks/vec3.js";import{c as b}from"../../../../../chunks/vec3f64.js";import{signedDistance as j}from"../../../../../geometry/support/plane.js";import{projectedRadius as d,intersectPlane as g}from"../../../support/orientedBoundingBox.js";import{empty as k,within as w,union as z}from"../../lib/depthRange.js";function S(t,n){const o=k(),{eye:e,frustum:r,viewForward:a}=t;n.forAll((t=>{const n=null!=t.offsetObb?t.offsetObb:t.obb,s=f(c(G,n.center,e),a),l=d(n,a);if(w(o,s-l)&&w(o,s+l))return;const u=C(n,r);if(-1===u)return;if(0===u)return y.far=s+l,y.near=s-l,void z(o,y);const i=q.pushNew();i.near=s-l,i.far=s+l,i.mask=u,i.object=t}));for(let s=0;s<q.length;s++){const t=q.data[s];if(w(o,t.near)&&w(o,t.far))continue;y.far=t.far,y.near=1/0;const n=N(null!=t.object.offsetObb?t.object.offsetObb:t.object.obb,e,A,(n=>{let o=x;for(let e=0;e<R&&n.length>0;e++){if(0==(t.mask&1<<e))continue;B(r[e],n,o);const a=n;n=o,o=a}for(let t=0;t<n.length;t+=3){u(v,n.data[t],n.data[t+1],n.data[t+2]);const o=f(c(v,v,e),a);y.near=Math.min(y.near,o)}}));0===n&&(y.near=0),z(o,y)}return q.length=0,o}const q=new n({allocator:t=>t||{near:1/0,far:-1/0,mask:0,object:null},deallocator:n=>(n.object=t(n.object),n)}),y=k(),v=b(),O=b(),A=new n({deallocator:null}),x=new n({deallocator:null});function B(t,n,o){o.length=0;const e=n.length-3;F(v,n,e);const r=j(t,v);r<=0&&(o.push(v[0]),o.push(v[1]),o.push(v[2]));let a=0,s=r;for(;a<e;a+=3){F(O,n,a);const e=j(t,O);if(s*e<0){i(v,O,v,e/(e-s)),M(o,v)}e<=0&&M(o,O),s=e,h(v,O)}if(s*r<0){F(O,n,e);i(v,O,v,r/(r-s)),M(o,v)}}function F(t,n,o){return u(t,n.data[o],n.data[o+1],n.data[o+2])}function M(t,n){t.push(n[0]),t.push(n[1]),t.push(n[2])}function N(t,n,r,s){a(E,t.quaternion),c(G,n,t.center),l(G,G,E);const f=8*((G[0]<-t.halfSize[0]?-1:G[0]>t.halfSize[0]?1:0)+3*(G[1]<-t.halfSize[1]?-1:G[1]>t.halfSize[1]?1:0)+9*(G[2]<-t.halfSize[2]?-1:G[2]>t.halfSize[2]?1:0)+13),i=P[f];if(0===i)return i;o(D,t.quaternion),e(D,D,t.halfSize);const h=(n,o)=>{const e=P[f+o+1];return u(n,((1&e)<<1)-1,(2&e)-1,((4&e)>>1)-1),m(n,n,D),p(n,t.center,n)};return r.length=0,M(r,h(H,0)),M(r,h(I,1)),M(r,h(G,2)),M(r,h(J,3)),s(r),1===i?i:(r.length=0,M(r,H),M(r,J),M(r,h(G,4)),M(r,h(K,5)),s(r),2===i||(r.length=0,M(r,H),M(r,K),M(r,h(G,6)),M(r,I),s(r)),i)}const P=(()=>{const t=new Array(216);let n=0;const o=o=>{for(let e=0;e<o.length;e++)t[n+e]=o[e];n+=8};return o([3,0,6,2,3,1,5,4]),o([2,0,2,3,1,5,4,0]),o([3,1,0,2,3,7,5,4]),o([2,0,1,3,2,6,4,0]),o([1,0,1,3,2,0,0,0]),o([2,1,5,7,3,2,0,0]),o([3,2,0,1,3,7,6,4]),o([2,2,0,1,3,7,6,0]),o([3,3,0,1,5,7,6,2]),o([2,0,1,5,4,6,2,0]),o([1,0,1,5,4,0,0,0]),o([2,1,3,7,5,4,0,0]),o([1,0,2,6,4,0,0,0]),o([0,0,0,0,0,0,0,0]),o([1,1,3,7,5,0,0,0]),o([2,2,3,7,6,4,0,0]),o([1,2,3,7,6,0,0,0]),o([2,3,1,5,7,6,2,0]),o([3,4,0,1,5,7,6,2]),o([2,5,7,6,4,0,1,0]),o([3,5,0,1,3,7,6,4]),o([2,4,5,7,6,2,0,0]),o([1,4,5,7,6,0,0,0]),o([2,5,1,3,7,6,4,0]),o([3,6,0,2,3,7,5,4]),o([2,6,2,3,7,5,4,0]),o([3,7,6,2,3,1,5,4]),t})(),R=4;function C(t,n){let o=0;for(let e=0;e<R;e++){const r=g(t,n[e]);if(r>0)return-1;0===r&&(o|=1<<e)}return o}const D=r(),E=s(),G=b(),H=b(),I=b(),J=b(),K=b();export{S as computeDepthRange};
