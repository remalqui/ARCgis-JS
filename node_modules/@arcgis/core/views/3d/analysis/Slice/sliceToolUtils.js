/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import t from"../../../../Color.js";import"../../../../geometry.js";import e from"../../../../analysis/SlicePlane.js";import"../../../../core/has.js";import n from"../../../../core/Logger.js";import{rad2deg as o,deg2rad as i}from"../../../../core/mathUtils.js";import{castRenderScreenPointArray3 as r}from"../../../../core/screenUtils.js";import{o as s,b as a,k as c,m as l,r as u,i as d,w as m,F as p}from"../../../../chunks/mat4.js";import{c as g}from"../../../../chunks/mat4f64.js";import{r as f}from"../../../../chunks/quat.js";import{g as b,c as h,e as T,f as w,n as O,a as A,l as R,b as I,s as E,p as j,w as C}from"../../../../chunks/vec3.js";import{a as L,c as U,f as _}from"../../../../chunks/vec3f64.js";import{tryProjectWithZConversion as M}from"../../../../geometry/projection.js";import{Axis as P}from"../../../../geometry/support/Axis.js";import{r as v,f as N,i as V,a as y,n as S,u as G}from"../../../../chunks/boundedPlane.js";import{fromVectorsAndPoint as k,fromPositionAndNormal as H}from"../../../../geometry/support/plane.js";import{create as B}from"../../../../geometry/support/ray.js";import{angleAroundAxis as x}from"../../../../geometry/support/vector.js";import{sv3d as F,sm4d as X,sq4d as D}from"../../../../geometry/support/vectorStacks.js";import{settings as Y}from"./settings.js";import{VERTICAL_DOT_THRESHOLD as Z,SMALL_ANGLE_DOT_THRESHOLD as W,PLANE_MIN_BASIS_SCREEN_LEN2 as q,INITIAL_PLANE_HALF_SIZE_VIEW_PROPORTION as z,SHIFT_RESTART_OFFSET_DISTANCE as $,RESIZE_HANDLE_EDGE_PADDING_FRAC as J,SHIFT_RESTART_TIP_RADIUS as K,PLANE_OUTLINE_WIDTH as Q,RESIZE_HANDLE_CORNER_INPUT_RADIUS as tt,RESIZE_HANDLE_EDGE_INPUT_RADIUS as et,SHIFT_RESTART_TIP_LENGTH as nt,SHIFT_RESTART_ARROW_LENGTH as ot,SHIFT_RESTART_ARROW_OUTLINE_WIDTH as it,RESIZE_HANDLE_CORNER_WIDTH as rt,RESIZE_HANDLE_EDGE_WIDTH as st,DISPLAY_FOCUS_MULTIPLIER as at,SHIFT_RESTART_TUBE_RADIUS as ct,SHIFT_RESTART_TUBE_FOCUS_MULTIPLIER as lt,SHIFT_RESTART_TIP_FOCUS_MULTIPLIER as ut}from"./sliceToolConfig.js";import{applyProjectionAndElevationAlignment as dt}from"../support/projectionUtils.js";import{Manipulator3D as mt}from"../../interactive/Manipulator3D.js";import{calculateTranslateRotateFromBases as pt,createRotateManipulator as gt,worldScaledManipulatorSettings as ft}from"../../interactive/manipulatorUtils.js";import{RenderObject as bt}from"../../interactive/RenderObject.js";import{LineVisualElement as ht}from"../../interactive/visualElements/LineVisualElement.js";import{SlicePlaneVisualElement as Tt}from"../../interactive/visualElements/SlicePlaneVisualElement.js";import{RenderCoordsHelper as wt}from"../../support/RenderCoordsHelper.js";import{fromRender as Ot}from"../../support/geometryUtils/ray.js";import{CullFaceOptions as At}from"../../webgl-engine/lib/basicInterfaces.js";import{createPolylineGeometry as Rt,createConeGeometry as It,createPathExtrusionGeometry as Et}from"../../webgl-engine/lib/GeometryUtil.js";import{RenderOccludedFlag as jt}from"../../webgl-engine/lib/Material.js";import{ColorMaterial as Ct}from"../../webgl-engine/materials/ColorMaterial.js";import{NativeLineMaterial as Lt}from"../../webgl-engine/materials/NativeLineMaterial.js";import{RibbonLineMaterial as Ut}from"../../webgl-engine/materials/RibbonLineMaterial.js";import{ManipulatorStateCustomFlags as _t,ManipulatorStateFlags as Mt}from"../../../interactive/interfaces.js";import Pt from"../../../../geometry/Extent.js";function vt(t,e,n,o,i,r,s,a){return Nt(e,s.worldUpAtPosition(t,F.get()),i,r,a.basis1,a.basis2),b(a.basis1,a.basis1,n),b(a.basis2,a.basis2,o),h(a.origin,t),k(a.basis2,a.basis1,a.origin,a.plane),a}function Nt(t,e,n,o,i,r){const s=T(t,e),a=F.get(),c=F.get();switch(o===ge.HORIZONTAL_OR_VERTICAL?Math.abs(s)>Z?ge.HORIZONTAL:ge.VERTICAL:o){case ge.VERTICAL:{const o=Math.abs(s)<=W?t:n.viewUp;w(a,o,e),h(c,e);break}case ge.HORIZONTAL:w(a,n.viewUp,e),w(c,e,a);break;case ge.TILTED:{const o=Math.abs(s)<=W?e:n.viewUp;w(a,o,t),w(c,t,a);break}}const l=w(F.get(),a,c);T(l,n.viewForward)>0&&b(c,c,-1),O(i,a),O(r,c)}function Vt(t,e,n){const o=e.worldUpAtPosition(t.origin,F.get()),i=t.basis1,r=ae(t,o),s=Math.round(r/he)*he;return v(t,s-r,i,n)}function yt(t,e,n,o,i,r){const s=h(F.get(),i.origin);A(s,s,b(F.get(),i.basis1,t.direction[0]<0?1:-1)),A(s,s,b(F.get(),i.basis2,t.direction[1]<0?1:-1));const a=R(i.basis1),c=R(i.basis2),l=I(F.get(),n,s),u=I(F.get(),e,s);let d=0,m=0;if($t(t)){const e=zt(i),n=zt(r);d=a-.5*t.direction[0]*T(i.basis1,u)/a,m=c-.5*t.direction[1]*T(i.basis2,u)/c;const o=n/e;d*=o,m*=o}const p=d+.5*t.direction[0]*T(i.basis1,l)/a,g=m+.5*t.direction[1]*T(i.basis2,l)/c,f=b(F.get(),i.basis1,p/a),w=b(F.get(),i.basis2,g/c);(p<=0||Wt(r.origin,f,o)<=q)&&h(f,r.basis1),(g<=0||Wt(r.origin,w,o)<=q)&&h(w,r.basis2);const O=h(F.get(),s);return A(O,O,b(F.get(),f,t.direction[0]<0?-1:1)),A(O,O,b(F.get(),w,t.direction[1]<0?-1:1)),N(O,f,w,r)}function St(t,e){return z*Math.min(e.width,e.height)*e.computeRenderPixelSizeAt(t)}function Gt(t,e,n,o){const i=w(F.get(),e,n);return w(i,i,e),H(t,i,o)}function kt(t,e){return pt(t.basis1,t.basis2,t.origin,e)}function Ht(t,e,n,o){const i=e.worldUpAtPosition(t.origin,F.get()),r=F.get();switch(n){case pe.HEADING:h(r,i);break;case pe.TILT:h(r,t.basis1)}return H(t.origin,r,o)}function Bt(t,e,n,o){const i=Zt(n,Yt.NEGATIVE_X),a=X.get();s(a,e,i.edge*Math.PI/2);const c=O(F.get(),i.basis);let l=b(F.get(),c,i.direction*o.computeScreenPixelSizeAt(i.position)*$);A(l,l,i.position);const u=o.projectToRenderScreen(l,r(F.get())),d=xt(o,u);Ot(o,u,be),O(be.direction,be.direction);const m=F.get();!d&&V(n,be,m)&&(l=m),a[12]=0,a[13]=0,a[14]=0,t.modelTransform=a,t.renderLocation=L(l),d?t.state|=fe:t.state&=~fe}function xt(t,e){const[n,o,i,r]=t.viewport,s=Math.min(i,r)/16;let a=!0;return e[0]<n+s?(e[0]=n+s,a=!1):e[0]>n+i-s&&(e[0]=n+i-s,a=!1),e[1]<o+s?(e[1]=o+s,a=!1):e[1]>o+r-s&&(e[1]=o+r-s,a=!1),a}function Ft(t,e,n,o){const i=R(o.basis1),r=R(o.basis2),s=qt(o),u=zt(o),d=E(F.get(),0,0,0);A(d,b(F.get(),o.basis1,e.direction[0]),b(F.get(),o.basis2,e.direction[1])),A(d,o.origin,d);let m=0,p=1;if($t(e))1===e.direction[0]&&-1===e.direction[1]?m=he:1===e.direction[0]&&1===e.direction[1]?m=Math.PI:-1===e.direction[0]&&1===e.direction[1]&&(m=3*Math.PI/2),p=u;else{const t=0!==e.direction[0]?1:2;m=1===t?he:0,p=(1===t?r:i)-s}const g=a(X.get(),m);c(g,g,E(F.get(),p,p,p)),l(g,n,g),g[12]=0,g[13]=0,g[14]=0,t.modelTransform=g,t.renderLocation=d}function Xt(t,e,n,o){const i=o.worldUpAtPosition(n.origin,F.get()),r=Zt(n,Yt.POSITIVE_X),s=a(X.get(),r.edge*Math.PI/2);u(s,s,-ae(n,i)),l(s,e,s),s[12]=0,s[13]=0,s[14]=0,t.modelTransform=s,t.renderLocation=r.position}function Dt(t,e,n){const o=Zt(n,Yt.POSITIVE_Y),i=a(X.get(),o.edge*Math.PI/2);u(i,i,he),l(i,e,i),i[12]=0,i[13]=0,i[14]=0,t.modelTransform=i,t.renderLocation=o.position}var Yt;function Zt(t,e){switch(e){case Yt.POSITIVE_X:return{basis:t.basis1,direction:1,position:A(F.get(),t.origin,t.basis1),edge:e};case Yt.POSITIVE_Y:return{basis:t.basis2,direction:1,position:A(F.get(),t.origin,t.basis2),edge:e};case Yt.NEGATIVE_X:return{basis:t.basis1,direction:-1,position:I(F.get(),t.origin,t.basis1),edge:e};case Yt.NEGATIVE_Y:return{basis:t.basis2,direction:-1,position:I(F.get(),t.origin,t.basis2),edge:e}}}function Wt(t,e,n){const o=n.projectToRenderScreen(A(F.get(),t,e),r(F.get())),i=n.projectToRenderScreen(I(F.get(),t,e),r(F.get()));return j(I(o,o,i))}function qt(t){const e=R(t.basis1),n=R(t.basis2);return J*Math.min(e,n)}function zt(t){return qt(t)}function $t(t){return 0!==t.direction[0]&&0!==t.direction[1]}function Jt(e,n){const o=n.offsetMode===Oe.CENTER_ON_CALLOUT?$:0,i=[_(o,0,-ot/2),_(o,0,ot/2)],r=ie(i,!0),s=(t,e)=>ne(i,t,e,n),a=s(0,!1),c=s(it,!0),l=new Lt({color:t.toUnitRGBA(n.calloutColor),renderOccluded:jt.OccludeAndTransparent}),u=Rt(l,[[o,0,0],[o-$,0,0]]),d=Rt(l,[[o,0,0],[o-$,0,0]]);return new mt({view:e,renderObjects:[...a.normal.map((t=>new bt(t,Mt.Unfocused|me))),...c.normal.map((t=>new bt(t,Mt.Unfocused|me))),new bt(u,Mt.Unfocused|me|fe),...a.focused.map((t=>new bt(t,Mt.Focused|me))),...c.focused.map((t=>new bt(t,Mt.Focused|me))),new bt(d,Mt.Focused|me|fe)],autoScaleRenderObjects:!1,collisionType:{type:"line",paths:[r]},collisionPriority:1,radius:K,state:me})}function Kt(e,n){const o=gt(e,{calloutColor:t.toUnitRGBA(Y.callouts.color),customStateMask:me,texture:n});return o.state=me,o}function Qt(e){const n=[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0],[-1,-1,0]];return new ht({view:e,attached:!1,color:t.toUnitRGBA(Y.plane.outlineColor),width:Q,renderOccluded:jt.OccludeAndTransparent,geometry:[n]})}function te(e){return new Tt({view:e,attached:!1,backgroundColor:t.toUnitRGBA(Y.plane.color),gridColor:t.toUnitRGBA(Y.plane.gridColor),gridWidth:4,renderOccluded:jt.OccludeAndTransparent})}function ee(e,n,o){const i=$t(n),r=i?[_(1,0,0),_(0,0,0),_(0,1,0)]:[_(1,0,0),_(-1,0,0)],s=t.toUnitRGBA(o.color),a=t=>new Ut({color:s,width:t,renderOccluded:jt.OccludeAndTransparent}),c=()=>new Lt({color:s,renderOccluded:jt.OccludeAndTransparent}),l=i?rt:st,u=l*at,d=st,m=t=>t>1?a(t):c(),p=[new bt(Rt(m(l),r),Mt.Unfocused|Te),new bt(Rt(m(u),r),Mt.Focused|Te),new bt(Rt(m(d),r),we)],g=new mt({view:e,renderObjects:p,collisionType:{type:"line",paths:[r]},radius:i?tt:et,...ft});return g.state=Te,g}function ne(e,n,o,i){const r=t.blendColors(i.color,i.outlineColor,.4),s=t.blendColors(i.color,i.outlineColor,.14),a=new Ct({color:t.toUnitRGBA(i.color),cullFace:At.Back,renderOccluded:jt.Opaque}),u=new Ct({color:t.toUnitRGBA(r),cullFace:At.Back,renderOccluded:jt.Opaque}),h=new Ct({color:t.toUnitRGBA(s),cullFace:At.Back,renderOccluded:jt.Opaque}),T=new Ct({color:t.toUnitRGBA(i.outlineColor),transparent:!0,writeDepth:!1,cullFace:At.Front,renderOccluded:jt.Transparent}),w=t=>{const i=e.slice(0),r=I(F.get(),i[0],i[1]);O(r,r);const s=I(F.get(),i[i.length-1],i[i.length-2]);if(O(s,s),n>0){const t=b(U(),s,-n);i[i.length-1]=A(t,t,i[i.length-1]);const e=b(U(),r,-n);i[0]=A(e,e,i[0])}const w=t?ut:1,R=nt*w,j=K*w,C=d(X.get());if(n>0){const t=R/4,e=E(F.get(),0,t,0),o=1+n/t;m(C,C,e),c(C,C,E(F.get(),o,o,o)),m(C,C,b(e,e,-1/o))}const L=d(g()),M=_(0,1,0),P=p(g(),f(D.get(),M,s));P[12]=i[i.length-1][0],P[13]=i[i.length-1][1],P[14]=i[i.length-1][2],l(P,P,C);const v=oe(ct*(t?lt:1)+n,i,o?T:h);v.transformation=L;const N=[v],V=It(o?T:a,R,j,24,!1,!1,!0);V.transformation=P,N.push(V);const y=It(o?T:u,R,j,24,!1,!0,!1);y.transformation=P,N.push(y);const S=p(g(),f(D.get(),M,r));return S[12]=i[0][0],S[13]=i[0][1],S[14]=i[0][2],l(S,S,C),N.push(V.instantiate({transformation:S})),N.push(y.instantiate({transformation:S})),N};return{normal:w(!1),focused:w(!0)}}function oe(t,e,n){const o=[],i=12;for(let r=0;r<i;r++){const e=r/i*2*Math.PI;o.push([Math.cos(e)*t,Math.sin(e)*t])}return Et(n,o,e,[],[],!1)}function ie(t,e){const n=I(U(),t[t.length-1],t[t.length-2]);if(O(n,n),b(n,n,nt),A(n,n,t[t.length-1]),e){const e=I(U(),t[0],t[1]);return O(e,e),b(e,e,nt),A(e,e,t[0]),[e,...t,n]}return[...t,n]}function re(t,n,i,r=new e){if(null==t)return null;const{renderCoordsHelper:s}=n,a=s.fromRenderCoords(t.origin,n.spatialReference);if(null==a)return null;const c=M(a,i);if(null==c)return null;r.position=c;const l=2*R(t.basis1),u=2*R(t.basis2),d=wt.renderUnitScaleFactor(n.spatialReference,i);r.width=l*d,r.height=u*d;const m=s.worldUpAtPosition(t.origin,F.get());return r.tilt=o(ae(t,m)),r.heading=s.headingAtPosition(t.origin,t.basis1)-90,r}function se(t,e,n){if(null==t)return null;const o=t.origin,i=F.get(),r=F.get(),s=F.get(),a=F.get();let c,l,u,d,m,p;A(i,o,t.basis1),A(i,i,t.basis2),A(r,o,t.basis1),C(r,r,t.basis2),C(s,o,t.basis1),C(s,s,t.basis2),C(a,o,t.basis1),A(a,a,t.basis2);for(const g of[i,r,s,a]){const t=e.fromRenderCoords(g,g,n);if(null==t)return null;c=null==c?t[0]:Math.min(c,t[0]),l=null==l?t[0]:Math.max(l,t[0]),u=null==u?t[1]:Math.min(u,t[1]),d=null==d?t[1]:Math.max(d,t[1]),m=null==m?t[2]:Math.min(m,t[2]),p=null==p?t[2]:Math.max(p,t[2])}return new Pt({xmin:c,xmax:l,ymin:u,ymax:d,zmin:m,zmax:p,spatialReference:n})}function ae(t,e){return x(e,t.basis2,t.basis1)+he}function ce(t,e,o,r,s,a,c=y()){return a.toRenderCoords(t,c.origin)?(a.worldBasisAtPosition(c.origin,P.X,c.basis1),a.worldBasisAtPosition(c.origin,P.Y,c.basis2),k(c.basis2,c.basis1,c.origin,c.plane),v(c,-i(e),S(c),c),v(c,i(o),c.basis1,c),b(c.basis1,c.basis1,r/2),b(c.basis2,c.basis2,s/2),G(c),c):(n.getLogger("esri.views.3d.analysis.Slice.sliceToolUtils").error(`Failed to project slice plane position, projection from ${t.spatialReference.wkid} is not supported`),null)}function le(t,e){if(null==t||null==t.position)return null;const n=dt(t.position,e.spatialReference,e.elevationProvider);if(null==n)return null;const o=wt.renderUnitScaleFactor(t.position.spatialReference,e.spatialReference),i=t.width*o,r=t.height*o;return{position:n,heading:t.heading,tilt:t.tilt,renderWidth:i,renderHeight:r}}function ue(t,e,n,o=y()){const i=le(t,e);return null==i?null:de(i,e,n,o)}function de(t,e,n,o=y()){if(null==t)return null;const i=ce(t.position,t.heading,t.tilt,t.renderWidth,t.renderHeight,e.renderCoordsHelper,o);return n.tiltEnabled||null==i||Vt(i,e.renderCoordsHelper,i),i}!function(t){t[t.POSITIVE_X=0]="POSITIVE_X",t[t.POSITIVE_Y=1]="POSITIVE_Y",t[t.NEGATIVE_X=2]="NEGATIVE_X",t[t.NEGATIVE_Y=3]="NEGATIVE_Y"}(Yt||(Yt={}));const me=_t.Custom1;var pe,ge;!function(t){t[t.HEADING=1]="HEADING",t[t.TILT=2]="TILT"}(pe||(pe={})),function(t){t[t.HORIZONTAL_OR_VERTICAL=0]="HORIZONTAL_OR_VERTICAL",t[t.HORIZONTAL=1]="HORIZONTAL",t[t.VERTICAL=2]="VERTICAL",t[t.TILTED=3]="TILTED"}(ge||(ge={}));const fe=_t.Custom2,be=B(),he=Math.PI/2,Te=_t.Custom1,we=_t.Custom2;var Oe;function Ae(t){return null!=("building-scene-3d"===t.type?t:null)}!function(t){t[t.CENTER_ON_CALLOUT=0]="CENTER_ON_CALLOUT",t[t.CENTER_ON_ARROW=1]="CENTER_ON_ARROW"}(Oe||(Oe={}));export{me as DidPointerMoveRecentlyFlag,fe as IsShiftEdgeOnScreenFlag,Oe as OffsetMode,pe as RotationAxis,ge as SliceOrientation,ie as addArrowTips,kt as calculateBoundedPlaneTranslateRotate,zt as calculateDiagonalResizeHandleScale,St as calculatePlaneHalfSize,qt as calculateResizeHandlePadding,Wt as calculateScreenSpaceBasisLength2,te as createGridVisualElement,Qt as createOutlineVisualElement,vt as createPlane,ee as createResizeManipulator,Kt as createRotateManipulator,Ht as createRotatePlane,Jt as createShiftManipulator,Gt as createShiftPlane,Vt as forceHorizontalOrVertical,$t as isDiagonalResizeHandle,Ae as isIBuildingSceneLayerView3D,Nt as normalToBases,se as planeToExtent,re as planeToShape,le as projectAndElevationAlignShape,de as projectedShapeToPlane,Te as resizeNormal,we as resizeOutlineOnly,yt as resizePlane,ue as shapeToPlane,Ft as updateResizeHandle,Xt as updateRotateHeadingHandle,Dt as updateRotateTiltHandle,Bt as updateShiftRestartHandle};
