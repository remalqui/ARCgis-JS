/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{_ as i}from"../../../chunks/tslib.es6.js";import s from"../../../core/Accessor.js";import o from"../../../core/Collection.js";import t from"../../../core/Logger.js";import{abortMaybe as e,destroyMaybe as n}from"../../../core/maybe.js";import{on as r}from"../../../core/reactiveUtils.js";import{property as a}from"../../../core/accessorSupport/decorators/property.js";import"../../../core/accessorSupport/ensureType.js";import"../../../core/arrayUtils.js";import"../../../core/has.js";import{subclass as l}from"../../../core/accessorSupport/decorators/subclass.js";import{AnalysisView3D as m}from"./AnalysisView3D.js";import{DimensionController as p}from"./Dimension/DimensionController.js";import{DimensionTool as d}from"./Dimension/DimensionTool.js";import{DimensionVisualization as c}from"./Dimension/DimensionVisualization.js";import{LengthDimensionComputation as u}from"./Dimension/LengthDimensionComputation.js";import{applyProjectionAndElevationAlignment as h,logFailedGeometryProjectionError as y}from"./support/projectionUtils.js";import{connectAnalysisViewToTool as _,removeAnalysisViewTool as D,activateAnalysisViewTool as f}from"../../analysis/analysisViewUtils.js";import j from"../../analysis/DimensionAnalysisView.js";let v=class extends(j(m(s))){constructor(i){super(i),this.type="dimension-view-3d",this.tool=null,this.computations=new o,this.selectedDimension=null,this._dimensionsToComputations=new Map,this._placementTask=null,this._projectAndAlignPoint=null}initialize(){this._projectAndAlignPoint=i=>{if(null==i)return null;const{spatialReference:s,elevationProvider:o}=this.view,e=h(i,s,o);return null==e&&y(this.analysis,i.spatialReference,t.getLogger(this)),e},this.addHandles([_(this,d),r((()=>this.analysis.dimensions),"after-add",(i=>this._onDimensionAdd(i.item)),{onListenerAdd:i=>{for(const s of i)this._onDimensionAdd(s)},onListenerRemove:()=>{this._onDimensionsClear()}}),r((()=>this.analysis.dimensions),"after-remove",(i=>this._onDimensionRemove(i.item)))]),this._analysisVisualization=new c({analysisViewData:this,view:this.view}),this._analysisController=new p({analysisViewData:this,view:this.view})}destroy(){this._placementTask=e(this._placementTask),this._analysisVisualization=n(this._analysisVisualization),D(this)}get updating(){return this._analysisVisualization?.loadingMessages??!1}get results(){return this.analysis.dimensions.map((i=>this._dimensionsToComputations.get(i).result))}get selectedComputation(){const{selectedDimension:i}=this;return null==i?null:this._dimensionsToComputations.get(i)}get testInfo(){return{visualization:this._analysisVisualization,controller:this._analysisController}}async createLengthDimensions(i){return this.selectedDimension=null,this._placementTask=e(this._placementTask),this._placementTask=f(this,i),this._placementTask.promise}_onDimensionAdd(i){const{computations:s,_dimensionsToComputations:o}=this;if(o.has(i))return;const t=new u({dimension:i,projectAndAlignPoint:this._projectAndAlignPoint});s.add(t),o.set(i,t)}_onDimensionRemove(i){const{computations:s,_dimensionsToComputations:o}=this,t=s.findIndex((s=>s.dimension===i)),e=s.at(t);e.dimension===this.selectedDimension&&(this.selectedDimension=null),s.removeAt(t),o.delete(i),n(e)}_onDimensionsClear(){this.computations.drain((i=>i.destroy())),this._dimensionsToComputations.clear()}};i([a({readOnly:!0})],v.prototype,"type",void 0),i([a()],v.prototype,"tool",void 0),i([a()],v.prototype,"updating",null),i([a({readOnly:!0})],v.prototype,"results",null),i([a({readOnly:!0})],v.prototype,"computations",void 0),i([a()],v.prototype,"selectedDimension",void 0),i([a()],v.prototype,"selectedComputation",null),i([a()],v.prototype,"_analysisVisualization",void 0),i([a()],v.prototype,"_analysisController",void 0),i([a()],v.prototype,"_dimensionsToComputations",void 0),i([a()],v.prototype,"_placementTask",void 0),v=i([l("esri.views.3d.analysis.DimensionAnalysisView3D")],v);const g=v;export{g as default};
