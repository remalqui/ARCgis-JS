/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{_ as t}from"../../../../chunks/tslib.es6.js";import e from"../../../../Color.js";import"../../../../geometry.js";import{LengthDimensionMeasureType as i}from"../../../../analysis/dimensionUtils.js";import n from"../../../../analysis/LengthDimension.js";import{HandleOwner as a}from"../../../../core/HandleOwner.js";import o from"../../../../core/Handles.js";import{equals as s}from"../../../../core/lang.js";import{destroyMaybe as r,applySome as p}from"../../../../core/maybe.js";import{memoize as l}from"../../../../core/memoize.js";import{ignoreAbortErrors as u}from"../../../../core/promiseUtils.js";import{watch as d,sync as c,syncAndInitial as m,initial as h,when as g}from"../../../../core/reactiveUtils.js";import{property as f}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/accessorSupport/ensureType.js";import{subclass as _}from"../../../../core/accessorSupport/decorators/subclass.js";import{c as M}from"../../../../chunks/vec3f64.js";import{clonePoint as y}from"../../../../layers/graphics/hydratedFeatures.js";import{reapplyConstraint as v,LengthDimensionConstraint as C,applyConstraint as S,computeConstraint as b,constraintDependencies as w}from"./lengthDimensionConstraintUtils.js";import{LengthDimensionManipulators as P,createPointManipulator as O,pointManipulatorHandles as D,createOffsetManipulator as j,offsetManipulatorHandles as H,createOrientationManipulator as T,headingManipulatorHandles as G,rotationManipulatorHandles as I,createMeasureTypeManipulator as z,measureTypeManipulatorHandles as x,updateOffsetManipulatorTransform as V,updateHeadingManipulatorTransform as U,updateRotationManipulatorTransform as R,updateMeasureTypeManipulatorTransform as A,unfocusedOffsetWidth as k,focusedOffsetWidth as E,updateOrientationManipulator as F}from"./lengthDimensionManipulatorUtils.js";import{isValidComputation as L,arePointsVerticallyAligned as q,computeGeometryFromDimension as B,computationToGeometryDependencies as N}from"./lengthDimensionUtils.js";import{settings as J}from"./settings.js";import{getRotateHeadingTexture as K}from"../Slice/images/Factory.js";import{SnappingVisualizer3D as Q}from"../../interactive/SnappingVisualizer3D.js";import{LineVisualElement as W}from"../../interactive/visualElements/LineVisualElement.js";import{VerticesVisualElement as X}from"../../interactive/visualElements/VerticesVisualElement.js";import{RenderOccludedFlag as Y}from"../../webgl-engine/lib/Material.js";import{ImageMaterial as Z}from"../../webgl-engine/materials/ImageMaterial.js";import{createStipplePatternSimple as $}from"../../webgl-engine/materials/lineStippleUtils.js";import{RibbonLineMaterial as tt}from"../../webgl-engine/materials/RibbonLineMaterial.js";import{createCoordinateHelper as et}from"../../../interactive/coordinateHelper.js";import{EditGeometry as it}from"../../../interactive/editGeometry/EditGeometry.js";import{EditGeometryOperations as nt}from"../../../interactive/editGeometry/EditGeometryOperations.js";import{acquire as at}from"../../../interactive/snapping/SceneSnappingManagerPool.js";import{SnappingContext as ot}from"../../../interactive/snapping/SnappingContext.js";import{createSnapDragEventPipelineStep as st}from"../../../interactive/snapping/SnappingDragPipelineStep.js";import{SnappingOperation as rt}from"../../../interactive/snapping/SnappingOperation.js";import{setupSnappingToggleHandles as pt}from"../../../interactive/snapping/snappingUtils.js";import lt from"../../../../geometry/Point.js";let ut=class extends a{constructor(t){super(t),this._stagedDimension=null,this._computationManipulators=new Map,this._computationHandles=new o,this._getSnappingContext=l((t=>new ot({elevationInfo:{mode:"absolute-height",offset:0},pointer:t,editGeometryOperations:new nt(new it("point",et(!0,!1,this.view.spatialReference))),visualizer:new Q})));const{view:i}=t;this._snappingManagerResult=at(i),this.addHandles(this._snappingManagerResult),this._unfocusedOffsetManipulatorMaterial=dt(),this._focusedOffsetManipulatorMaterial=dt(),this._thinOffsetManipulatorMaterial=dt(),this._thinOffsetManipulatorMaterial.setParameters({stipplePattern:$(2)}),this._constraintSnappingIndicator=new W({view:i,attached:!0,width:1,color:e.toUnitRGBA(J.constraint.color),renderOccluded:Y.OccludeAndTransparent,stipplePattern:$(5)});const n=e.toUnitRGBA(J.disabledPointIndicator.color);this._stagedStartIndicator=new X({view:i,attached:!1,elevationInfo:{mode:"absolute-height",offset:0},spatialReference:t.view.renderCoordsHelper.spatialReference,color:n,size:2*J.disabledPointIndicator.radius,outlineSize:0,renderOccluded:Y.OccludeAndTransparent})}initialize(){this._snappingOperation=new rt({view:this.view});const{color:t,contrastColor:e}=J.orientationManipulator,i=!this.view._stage?.renderView.renderingContext.driverTest.svgPremultipliesAlpha.result;this._orientationManipulatorTexture=K(this.view.toolViewManager.textures,{accentColor:t,contrastColor:e,preMultiplyAlpha:i}),this._orientationManipulatorMaterial=new Z({transparent:!0,writeDepth:!1,textureId:this._orientationManipulatorTexture.texture.id,renderOccluded:Y.Opaque});const{computations:n}=this.analysisViewData;for(const a of n)this._addComputation(a);this.addHandles([n.on("after-add",(t=>this._addComputation(t.item))),n.on("after-remove",(t=>this._removeComputation(t.item)))]),this.addHandles([d((()=>({stagedPoint:this._snappingOperation.stagedPoint,stagedComputation:this._stagedComputation})),(({stagedPoint:t,stagedComputation:e})=>{if(null==e||null==t)return;const i=y(t,new lt);this._applyPointUpdate(e,{endPoint:i})}),c),d((()=>({stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator})),((t,e)=>{const{stagedDimension:i,selectedComputation:n,firstGrabbedManipulator:a}=t;if(i===e?.stagedDimension&&a===e?.firstGrabbedManipulator){for(const o of[n,e?.selectedComputation])if(null!=o){const e=this._computationManipulators.get(o);this._updateManipulators(o,e,t)}}else for(const[o,s]of this._computationManipulators)this._updateManipulators(o,s,t)}),m),d((()=>this.analysis.style.lineSize),(t=>{this._updateManipulatorStyle(t)}),h),d((()=>this.view.state.camera),(()=>{null!=this._stagedComputation&&this._updateStagedDimensionOffset(this._stagedComputation)})),d((()=>p(this._stagedComputation,(t=>{const e=t.elevationAlignedStartPoint,i=M();return null!=e&&this.view.renderCoordsHelper.toRenderCoords(e,i)?i:null}))),(t=>{null!=t?(this._stagedStartIndicator.vertices=[t],this._stagedStartIndicator.attached=!0):this._stagedStartIndicator.attached=!1}))]),this.addHandles(this._constraintHandles),this.addHandles(this._snappingIndicatorHandles),pt(this,(()=>{const t=this._activeComputation,e=this._stagedComputation;if(null==t||null!=e){const t=this.view.inputManager.latestPointerType??"mouse",e=this._getSnappingContext(t);this.updatingHandles.addPromise(u(this._snappingOperation.resnap(this._snappingManager,e)))}if(null!=t){const{start:e,end:i}=this._computationManipulators.get(t);if(e.grabbing||i.grabbing){const i=e.grabbing?"start":"end",n=this._computeConstraint(t);v(t,i,{constraint:n,view:this.view})}}}))}destroy(){this._snappingOperation=r(this._snappingOperation),this._computationHandles.destroy(),this._constraintSnappingIndicator.destroy(),this._stagedStartIndicator.destroy(),this._orientationManipulatorMaterial.dispose(),this._orientationManipulatorTexture.release()}get updating(){return this.updatingHandles.updating||this._snappingManager.updating}get firstGrabbedManipulator(){return this.parentTool.firstGrabbedManipulator}get hasGrabbedManipulators(){return this.parentTool.hasGrabbedManipulators}get snappingOptions(){return this._snappingManager.options}get _snappingManager(){return this._snappingManagerResult.snappingManager}get _activeComputation(){if(null!=this._stagedComputation)return this._stagedComputation;const{selectedComputation:t}=this.analysisViewData;return this.hasGrabbedManipulators&&null!=t?t:null}get _stagedComputation(){const t=this._stagedDimension,e=this.analysisViewData.computations.at(-1);return null==t||null==e||e.dimension!==t?null:e}get _constraintHandles(){return[g((()=>this.analysisViewData.selectedComputation),(t=>{t.previousConstraint=this._computeConstraint(t)}),{...m,equals:s}),d((()=>{const t=this._activeComputation;if(null==t)return null;const{measureType:e,orientation:i}=t.dimension;return{measureType:e,orientation:i,computation:t}}),((t,e)=>{if(null!=t&&null==e){const{measureType:e,orientation:n,computation:a}=t;switch(a.previousConstraint){case C.Horizontal:a.preConstraintProperties={measureType:i.Horizontal,orientation:0};break;case C.Vertical:a.preConstraintProperties={measureType:i.Vertical,orientation:0};break;case C.Direct:a.preConstraintProperties={measureType:i.Direct,orientation:n};break;default:a.preConstraintProperties={measureType:e,orientation:n}}}null==t&&null!=e&&(e.computation.preConstraintProperties=null)}),c)]}get _snappingIndicatorHandles(){const t="snapping-indicator-event-handles";return[d((()=>({stagedComputation:this._stagedComputation,activeComputation:this._activeComputation})),(({stagedComputation:e,activeComputation:i})=>{const n=this._constraintSnappingIndicator;if(this.removeHandles(t),null!=i)if(i===e)n.attached=!0;else{const{start:e,end:a}=this._computationManipulators.get(i),o=()=>{n.attached=e.grabbing||a.grabbing};o(),this.addHandles([e.events.on("grab-changed",o),a.events.on("grab-changed",o)],t)}else n.attached=!1})),d((()=>{const t=this._activeComputation;return null!=t?{geometry:t.geometry,constraint:t.previousConstraint}:{}}),(({geometry:t,constraint:e})=>{const i=this._constraintSnappingIndicator;null!=t&&null!=e&&e!==C.Direct?(i.visible=!0,i.setGeometryFromSegment(t.directSegment)):i.visible=!1}))]}removeStaged(){return null!=this._stagedDimension&&(this.analysis.dimensions.remove(this._stagedDimension),this._stagedDimension=null,!0)}onDeactivate(){this.removeStaged(),this._resetSnappingState()}onClick(t){const{_stagedDimension:e}=this;if(null==e){const e=this._onUnstagedClick(t);return this.analysis.dimensions.add(e),null}return this._onStagedClick(t),e}onPointerMove({mapPoint:t,pointerType:e}){if("touch"===e)return;const i=this._getSnappingContext(e);this.updatingHandles.addPromise(u(this._snappingOperation.snap({point:t},this._snappingManager,i)))}onManipulatorSelectionChanged(){if(null!=this.analysisViewData.selectedComputation){this._computationManipulators.get(this.analysisViewData.selectedComputation).offset.selected||(this.analysisViewData.selectedDimension=null)}}_onUnstagedClick({mapPoint:t,pointerType:e}){let a=t;if("mouse"===e){const i=this._getSnappingContext(e);a=this._snappingManager.update({point:t,context:i})}const o=new n({startPoint:y(a,new lt),endPoint:null,measureType:i.Horizontal});return this._stagedDimension=o,this._resetSnappingState(),o}_onStagedClick({mapPoint:t,pointerType:e}){const i=this._stagedComputation;if(null==i)return;let n=t;if("mouse"===e){const i=this._getSnappingContext(e);n=this._snappingManager.update({point:t,context:i})}const a=y(n,new lt);this._applyPointUpdate(i,{endPoint:a}),this._stagedDimension=null,this._resetSnappingState()}_resetSnappingState(){this._snappingManager.doneSnapping(),this._snappingOperation.abort(),this._snappingOperation.stagedPoint=null}_addComputation(t){if(this._computationManipulators.has(t))return;const e=this._setupPointManipulator(t,{isStart:!0}),n=this._setupPointManipulator(t,{isStart:!1}),a=this._setupOffsetManipulator(t),o=this._setupHeadingManipulator(t),s=this._setupRotationManipulator(t),r=this._setupMeasureTypeManipulator(t,i.Direct),p=this._setupMeasureTypeManipulator(t,i.Horizontal),l=this._setupMeasureTypeManipulator(t,i.Vertical),u=new P({start:e,end:n,offset:a,heading:o,rotation:s,direct:r,horizontal:p,vertical:l});this._setupComputationToManipulatorsSync(t,u),this._computationManipulators.set(t,u),this.manipulators.addMany(u.values())}_removeComputation(t){const e=this._computationManipulators.get(t);if(null!=e){this._computationHandles.remove(t),this._computationManipulators.delete(t);for(const t of e.values())this.manipulators.remove(t)}}_setupComputationToManipulatorsSync(t,e){this._computationHandles.add([d((()=>t.geometry),(()=>this._updateManipulators(t,e)),{...m,equals:s})],t)}_setupPointManipulator(t,e){const{view:i}=this,{dimension:n}=t,a=O(i,{metadata:n}),o=D(a,{isStart:e.isStart,createSnappingPipelineStep:t=>st({snappingContext:this._getSnappingContext(t),snappingManager:this._snappingManager,updatingHandles:this.updatingHandles}),dimension:n,onUpdate:e=>this._applyPointUpdate(t,e),view:i});return this._computationHandles.add(o,t),a}_setupOffsetManipulator(t){const{view:e}=this,i=j(e,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,metadata:t.dimension}),n=H(i,{computation:t,view:e});return this._computationHandles.add(n,t),i}_setupHeadingManipulator(t){const{view:e}=this,i=T(e,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:t.dimension}),n=G(i,{computation:t,view:e});return this._computationHandles.add(n,t),i}_setupRotationManipulator(t){const{view:e}=this,i=T(e,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:t.dimension}),n=I(i,{computation:t,view:e});return this._computationHandles.add(n,t),i}_setupMeasureTypeManipulator(t,e){const{view:i}=this,n=z(i,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,thinOffsetManipulatorMaterial:this._thinOffsetManipulatorMaterial,metadata:t.dimension}),a=x(n,{computation:t,manipulatorMeasureType:e,view:i});return this._computationHandles.add(a,t),n}_updateManipulators(t,e,n={stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator}){const{stagedDimension:a,selectedComputation:o,firstGrabbedManipulator:s}=n,{start:r,end:p,offset:l,heading:u,rotation:d}=e,c=o===t,m=L(t),{dimension:h}=t;for(const i of e.values()){const t=m&&null==a&&(null==s||i===s);i===l?(i.available=t,i.selected=c):i.available=t&&c}if(!m)return;null!=this._computeConstraint(t)?e.forEachMeasureTypeManipulator((t=>t.available=!1)):e.manipulatorForMeasureType(h.measureType).available=!1;for(const _ of[u,d])h.measureType===i.Direct&&0!==h.offset||(_.available=!1);q(t)?d.available=!1:u.available=!1;const{geometry:g}=t;r.renderLocation=g.directSegment.startRenderSpace,p.renderLocation=g.directSegment.endRenderSpace;const{renderCoordsHelper:f}=this.view;V(l,g,f),u.available&&U(u,t,f),d.available&&R(d,t,f),e.forEachMeasureTypeManipulator(((e,i)=>{e.available&&A(e,t,i,f)}))}_updateManipulatorStyle(t){const e=k(t),i=E(t),n={lineSizePt:t,material:this._orientationManipulatorMaterial};for(const{offset:a,heading:o,rotation:s}of this._computationManipulators.values())a.radius=i/2,F(o,n),F(s,n);this._unfocusedOffsetManipulatorMaterial.setParameters({width:e}),this._focusedOffsetManipulatorMaterial.setParameters({width:i})}_applyPointUpdate(t,e){const{view:i}=this,n=N(t);"startPoint"in e&&(n.elevationAlignedStartPoint=e.startPoint),"endPoint"in e&&(n.elevationAlignedEndPoint=e.endPoint);const a=B(n,i.renderCoordsHelper);if(null==a)return;const o=this._computeConstraint({...n,geometry:a});S(t,e,{...n,constraint:o,unconstrainedGeometry:a,view:i}),t===this._stagedComputation&&this._updateStagedDimensionOffset(t)}_updateStagedDimensionOffset(t){if(null==t.geometry)return;t.geometry.directSegment.eval(.5,ct);const e=this.view.state.camera.computeRenderPixelSizeAt(ct);t.dimension.offset=J.initialOffsetPx*e}_computeConstraint(t){return b(w(t,this._snappingManager.options),this.view)}get testInfo(){const t=t=>this.analysisViewData.computations.find((e=>e.dimension===t));return{disableManipulatorPartialOcclusion:()=>{this._stagedStartIndicator.renderOccluded=Y.Occlude,this.manipulators.forEach((({manipulator:t})=>{for(const{geometry:e}of t.renderObjects)e.material.setParameters({renderOccluded:Y.Occlude})}))},getManipulatorsForDimension:e=>this._computationManipulators.get(t(e)),getComputationForDimension:e=>t(e),getConstraintForDimension:e=>{const i=t(e);return null!=i?this._computeConstraint(i):null},stagedDimension:this._stagedDimension,stagedStartIndicator:this._stagedStartIndicator,constraintSnappingIndicator:this._constraintSnappingIndicator,snappingManager:this._snappingManager}}};function dt(){const{color:t}=J.offsetManipulator;return new tt({color:e.toUnitRGBA(t),width:1,renderOccluded:Y.OccludeAndTransparent,writeDepth:!1,hasPolygonOffset:!0})}t([f({constructOnly:!0})],ut.prototype,"analysis",void 0),t([f({constructOnly:!0})],ut.prototype,"analysisViewData",void 0),t([f({constructOnly:!0})],ut.prototype,"manipulators",void 0),t([f({constructOnly:!0})],ut.prototype,"parentTool",void 0),t([f({constructOnly:!0,nonNullable:!0})],ut.prototype,"view",void 0),t([f({readOnly:!0})],ut.prototype,"updating",null),t([f()],ut.prototype,"firstGrabbedManipulator",null),t([f()],ut.prototype,"hasGrabbedManipulators",null),t([f()],ut.prototype,"snappingOptions",null),t([f()],ut.prototype,"_stagedDimension",void 0),t([f()],ut.prototype,"_activeComputation",null),t([f()],ut.prototype,"_stagedComputation",null),ut=t([_("esri.views.3d.analysis.Dimension.LengthDimensionSubTool")],ut);const ct=M();export{ut as LengthDimensionSubTool};
