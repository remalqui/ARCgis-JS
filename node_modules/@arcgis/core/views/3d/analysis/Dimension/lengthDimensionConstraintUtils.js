/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import"../../../../geometry.js";import{LengthDimensionMeasureType as e}from"../../../../analysis/dimensionUtils.js";import"../../../../core/has.js";import{k as t,g as n,e as i,b as o,p as r}from"../../../../chunks/vec3.js";import{sv3d as a}from"../../../../geometry/support/vectorStacks.js";import{automaticHeadingFromCamera as s}from"./lengthDimensionManipulatorUtils.js";import{isGeodesicDimension as l,directUp as d,directStartToEnd as c}from"./lengthDimensionUtils.js";import{settings as m}from"./settings.js";import u from"../../../../geometry/Point.js";var P;function p(e,t){return{enabled:t.effectiveFeatureEnabled,elevationAlignedStartPoint:e.elevationAlignedStartPoint,elevationAlignedEndPoint:e.elevationAlignedEndPoint,geometry:e.geometry}}function g(e,s){if(l(e))return P.Direct;if(!e.enabled)return null;const{geometry:u}=e;if(null==u||t(u.directSegment.startRenderSpace,u.directSegment.endRenderSpace))return null;const{constraintThresholdPx:p}=m,{camera:g}=s.state,f=d(a.get(),u,s.renderCoordsHelper),v=c(a.get(),u),y=n(a.get(),f,i(v,f)),S=o(a.get(),v,y),A=r(S),R=r(y),{startRenderSpace:z,endRenderSpace:j}=u.directSegment,x=Math.max(g.computeRenderPixelSizeAt(z)*p,g.computeRenderPixelSizeAt(j)*p)**2;return A<x?P.Vertical:R<x?P.Horizontal:null}function f(e,t,{constraint:n,view:i}){const{unconstrainedGeometry:o}=e;if(null==o)return;const{renderCoordsHelper:r,spatialReference:a}=i,{startRenderSpace:s,endRenderSpace:l}=o.directSegment,d=r.fromRenderCoords(s,new u,a),c=r.fromRenderCoords(l,new u,a);let m;m="start"===t?{startPoint:d}:{endPoint:c},v(e,m,{constraint:n,elevationAlignedStartPoint:e.elevationAlignedStartPoint,elevationAlignedEndPoint:e.elevationAlignedEndPoint,unconstrainedGeometry:o,view:i})}function v(t,n,i){const{constraint:o,elevationAlignedStartPoint:r,elevationAlignedEndPoint:a,unconstrainedGeometry:l,view:d}=i,{dimension:c,previousConstraint:m,preConstraintProperties:u}=t;if(null==r||null==a)return;const p=()=>{"startPoint"in n?c.startPoint=n.startPoint:"endPoint"in n&&(c.endPoint=n.endPoint)};if(null==o)p(),null!=m&&null!=u&&(c.measureType=u.measureType,c.orientation=u.orientation);else switch(c.measureType=e.Direct,o){case P.Horizontal:if(o!==m&&(c.orientation=0),"startPoint"in n){const e=n.startPoint;null!=e&&(e.z=a.z),c.startPoint=e}else if("endPoint"in n){const e=n.endPoint;null!=e&&(e.z=r.z),c.endPoint=e}break;case P.Vertical:if(o!==m&&(c.orientation=s(l,d)),"startPoint"in n){const e=n.startPoint;null!=e&&(e.x=a.x,e.y=a.y),c.startPoint=e}else if("endPoint"in n){const e=n.endPoint;null!=e&&(e.x=r.x,e.y=r.y),c.endPoint=e}break;case P.Direct:o!==m&&null!=u&&(c.orientation=u.orientation),p()}t.previousConstraint=o,t.unconstrainedGeometry=l}!function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical",e[e.Direct=2]="Direct"}(P||(P={}));export{P as LengthDimensionConstraint,v as applyConstraint,g as computeConstraint,p as constraintDependencies,f as reapplyConstraint};
