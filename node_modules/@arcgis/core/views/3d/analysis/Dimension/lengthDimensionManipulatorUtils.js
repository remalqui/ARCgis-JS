/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import e from"../../../../Color.js";import"../../../../geometry.js";import{lengthDimensionMeasureType as t,LengthDimensionMeasureType as n}from"../../../../analysis/dimensionUtils.js";import{cyclicalDegrees as r}from"../../../../core/Cyclical.js";import{rad2deg as o}from"../../../../core/mathUtils.js";import{pt2px as i}from"../../../../core/screenUtils.js";import{i as a,k as s}from"../../../../chunks/mat4.js";import{c}from"../../../../chunks/mat4f64.js";import{g as m,c as d,b as l,f as u,e as f,k as p,l as g,s as h,w as v}from"../../../../chunks/vec3.js";import{c as y,Z as S,f as j}from"../../../../chunks/vec3f64.js";import{fromPositionAndNormal as x,create as M,signedDistance as w,normal as H}from"../../../../geometry/support/plane.js";import{sv3d as P}from"../../../../geometry/support/vectorStacks.js";import{clonePoint as C}from"../../../../layers/graphics/hydratedFeatures.js";import{isValidComputation as T,computeGeometryFromDimension as b,computationToGeometryDependencies as k,headingFromGeometry as R,computeOffsetForPoint as U,computeSegmentForMeasureType as z,computeOffsetAxis as O,directUp as D,directStartToEnd as F,dimensionStartToEnd as E}from"./lengthDimensionUtils.js";import{settings as L}from"./settings.js";import{Manipulator3D as A}from"../../interactive/Manipulator3D.js";import{createSphereManipulator as G,worldScaledManipulatorSettings as B,createRotateManipulator as I,updateRotateManipulator as W,calculateInputRotationTransform as N,calculateTranslateRotateFromBases as V}from"../../interactive/manipulatorUtils.js";import{RenderObject as Z}from"../../interactive/RenderObject.js";import{screenToMap3D as q,screenToRenderPlane as J,hideManipulatorWhileDragging as K}from"../../interactive/editingTools/dragEventPipeline3D.js";import{EuclideanSegment as Q}from"../../interactive/visualElements/support/Segment.js";import{MARKER_SIZE_PER_LINE_WIDTH as X}from"../../support/engineContent/marker.js";import{createPolylineGeometry as Y}from"../../webgl-engine/lib/GeometryUtil.js";import{createManipulatorDragEventPipeline as $,resetProperties as _,EventPipeline as ee}from"../../../interactive/dragEventPipeline.js";import{ManipulatorStateCustomFlags as te,ManipulatorStateFlags as ne}from"../../../interactive/interfaces.js";import re from"../../../../geometry/Point.js";class oe{constructor(e){this.start=e.start,this.end=e.end,this.offset=e.offset,this.heading=e.heading,this.rotation=e.rotation,this.direct=e.direct,this.horizontal=e.horizontal,this.vertical=e.vertical}manipulatorName(e){return Object.keys(this).find((t=>this.hasOwnProperty(t)&&e===this[t]))}values(){return[this.start,this.end,this.offset,this.heading,this.rotation,this.direct,this.horizontal,this.vertical]}forEachMeasureTypeManipulator(e){for(const n of t)e(this.manipulatorForMeasureType(n),n)}manipulatorForMeasureType(e){switch(e){case n.Direct:return this.direct;case n.Horizontal:return this.horizontal;case n.Vertical:return this.vertical}}}function ie(t,n){const r=G(t,e.toUnitRGBA(L.pointManipulators.color),Fe);return r.available=!1,r.grabCursor="crosshair",r.radius=L.pointManipulators.radius,r.metadata=n.metadata,r.collisionPriority=1,r}function ae(e,t){const n=[j(-.5,0,0),j(.5,0,0)],{lengthFraction:r}=L.offsetManipulator,o=Y(t.unfocusedMaterial,n.map((e=>m(y(),e,r)))),i=o.instantiate({material:t.focusedMaterial});return new A({view:e,renderObjects:[new Z(o,ne.Unfocused|ne.Selected|Fe),new Z(i,ne.Focused|Fe)],collisionType:{type:"line",paths:[n]},radius:De(t.lineSizePt)/2,metadata:t.metadata,available:!1,...B})}function se(t,{lineSizePt:n,material:r}){const{calloutOffsetPx:o,calloutWidth:a,discScale:s,focusMultiplier:c,color:m}=L.orientationManipulator;return{calloutLength:.25*X*L.markers.lineSizeFraction*i(n)+o,calloutColor:e.toUnitRGBA(m),calloutWidth:a,customStateMask:Fe,discScale:s,focusMultiplier:c,material:r,metadata:t}}function ce(e,t){return I(e,se(t.metadata,t))}function me(e,t){W(e,se(e.metadata,t))}function de(e,t){const n=[j(-.5,0,0),j(.5,0,0)],{lengthFraction:r}=L.offsetManipulator,o=Y(t.thinOffsetManipulatorMaterial,n),i=Y(t.unfocusedMaterial,n.map((e=>m(y(),e,r)))),a=i.instantiate({material:t.focusedMaterial});return new A({view:e,renderObjects:[new Z(i,ne.Unfocused|Fe),new Z(a,ne.Focused|Fe),new Z(o,Fe)],collisionType:{type:"line",paths:[n]},radius:De(t.lineSizePt)/2,available:!1,metadata:t.metadata,...B})}function le(e,{isStart:t,createSnappingPipelineStep:n,dimension:r,onUpdate:o,view:i}){const a=t?"startPoint":"endPoint",s=$(e,((e,t,s,c)=>{const m=K(e),{snappingStep:d,cancelSnapping:l}=n(c);s=s.next(m).next(_(r,[a,"measureType","orientation"])).next(l),t.next(m).next(q(i)).next(...d).next((e=>{const t=C(e.mapEnd,new re);o("startPoint"===a?{startPoint:t}:{endPoint:t})}))}));return[s]}function ue(e,{computation:t,view:n}){return[$(e,((e,r,o)=>{if(!T(t)||!e.selected)return;const{geometry:i,dimension:a}=t,s=K(e);r.next(s).next(Se(n,a,i.dimensionSegment,i.primaryOffsetAxis)),o.next(s).next(_(a,["offset"]))}))]}function fe(e,{computation:t,view:n}){return[$(e,((e,r,o)=>{he({cancel:o,computation:t,settingHeading:!0,steps:r,view:n})}))]}function pe(e,{computation:t,view:n}){return[$(e,((e,r,o)=>{he({cancel:o,computation:t,settingHeading:!1,steps:r,view:n})})),e.events.on("immediate-click",(e=>{ge(e,t,n)}))]}function ge(e,t,n){const{dimension:o,geometry:i}=t;if(90===o.orientation||270===o.orientation)return o.orientation=0,void e.stopPropagation();if(null==i)return;const{renderCoordsHelper:a}=n,s=b({...k(t),orientation:90},a),c=b({...k(t),orientation:270},a);if(null==s||null==c)return;const m=R(s,a),d=R(c,a),l=je(i,n),u=r.shortestSignedDiff(l,m),f=r.shortestSignedDiff(l,d);o.orientation=Math.abs(u)<Math.abs(f)?90:270,e.stopPropagation()}function he(e){const{cancel:t,computation:n,settingHeading:r,steps:i,view:a}=e;if(!T(n))return;const{renderCoordsHelper:s}=a,{dimension:c,geometry:m}=n,l=y(),u=be(y(),m,m.directSegment,s),f=ke(P.get(),{forHeading:r,geometry:m,renderCoordsHelper:s}),p=x(u,f,M()),g=r?c.orientation??R(m,a.renderCoordsHelper):c.orientation??0;i.next(J(a,p)).next((e=>{"start"===e.action&&d(l,e.renderStart);const t=H(p),n=N(l,e.renderEnd,u,t);let i=g-o(n);r||(i=ve(i)),c.orientation=i})),t.next(_(c,["orientation"]))}function ve(e){const t=r.normalize(e)%90;return t<L.orientationSnapThresholdDegrees?e-t:90-t<L.orientationSnapThresholdDegrees?e+(90-t):e}function ye(e,{computation:t,manipulatorMeasureType:r,view:o}){let i=n.Direct,a=0,s=0;return[e.events.on("grab-changed",(n=>{if("start"!==n.action||!T(t))return;const{dimension:c,geometry:m}=t;i=c.measureType,a=c.offset,s=c.orientation;const l=d(P.get(),e.renderLocation);c.measureType=r,c.offset=U(l,r,m,o.renderCoordsHelper),c.orientation=0})),$(e,((e,n,c)=>{if(!T(t))return;const{geometry:m,dimension:d}=t,{renderCoordsHelper:l}=o,u=z(Ge,r,t,l),f=O(P.get(),{measureType:r,directSegment:m.directSegment,renderCoordsHelper:l}),p=K(e);n.next(p).next(Se(o,d,u,f)),c.next(p).next((e=>(d.measureType=i,d.offset=a,d.orientation=s,e)))}))]}function Se(e,t,n,r){const o=l(P.get(),n.endRenderSpace,n.startRenderSpace);u(o,o,r);const i=x(n.startRenderSpace,o,M()),a=x(n.startRenderSpace,r,M()),s=t.offset;let c,m=0;const d=new ee;return d.next(J(e,i)).next((n=>{"start"===n.action&&(m=w(a,n.renderStart));const r=(w(a,n.renderEnd)-m)*e.renderCoordsHelper.unitInMeters;t.offset=s+r,c=n})),e=>(d.execute(e),c)}function je(e,t){const{directSegment:n}=e,{renderCoordsHelper:r}=t,o=D(P.get(),e,r),i=F(P.get(),e),a=u(P.get(),i,o),{viewForward:s}=t.state.camera;f(a,s)>0&&m(a,a,-1);const c=n.eval(.5,P.get());return r.headingAtPosition(c,a)}function xe(e,t,n){const{dimensionSegment:r,primaryOffsetAxis:o}=t,i=E(Ee,t),c=p(i,S)?a(Ae):V(i,o,S,Ae),m=Math.max(g(i),L.offsetManipulator.minLengthMeters/n.unitInMeters);s(c,c,h(Ee,m,m,m)),e.modelTransform=c,e.renderLocation=r.eval(.5,Ee)}function Me(e,t,n){He(e,t,n,{forHeading:!0})}function we(e,t,n){He(e,t,n,{forHeading:!1})}function He(e,t,n,{forHeading:r}){const{dimension:o,geometry:i}=t,{primaryOffsetAxis:a}=i,s=m(Pe,a,o.offset>=0?1:-1),c=ke(Ce,{forHeading:r,geometry:i,renderCoordsHelper:n});u(c,c,s);const d=V(s,c,S,Ae);e.modelTransform=d,e.renderLocation=be(Ee,i,i.dimensionSegment,n)}const Pe=y(),Ce=y();function Te(e,t,n,r){const{geometry:o}=t,i=z(Ge,n,t,r),a=O(Ee,{measureType:n,directSegment:o.directSegment,renderCoordsHelper:r}),c=v(Le,i.endRenderSpace,i.startRenderSpace),m=V(c,a,S,Ae),d=g(c);s(m,m,h(Le,d,d,d)),e.modelTransform=m,e.renderLocation=i.eval(.5,Le)}function be(e,t,n,r){const{startRenderSpace:o,endRenderSpace:i}=n,a=Re(t,r)?o:i;return d(e,a)}function ke(e,{forHeading:t,geometry:n,renderCoordsHelper:r}){return t?D(e,n,r):E(e,n,{invert:!0})}function Re(e,t){const n=F(Ue,e),r=D(ze,e,t);return f(n,r)>0}const Ue=y(),ze=y();function Oe(e){return i(e)+L.offsetManipulator.linePaddingPx}function De(e){return i(e)+L.offsetManipulator.focusedLinePaddingPx}const Fe=te.Custom1,Ee=y(),Le=y(),Ae=c(),Ge=new Q;export{Fe as DidPointerMoveRecentlyFlag,oe as LengthDimensionManipulators,je as automaticHeadingFromCamera,de as createMeasureTypeManipulator,ae as createOffsetManipulator,ce as createOrientationManipulator,ie as createPointManipulator,De as focusedOffsetWidth,fe as headingManipulatorHandles,ye as measureTypeManipulatorHandles,ue as offsetManipulatorHandles,le as pointManipulatorHandles,pe as rotationManipulatorHandles,ve as snapOrientationToNearestRightAngle,Oe as unfocusedOffsetWidth,Me as updateHeadingManipulatorTransform,Te as updateMeasureTypeManipulatorTransform,xe as updateOffsetManipulatorTransform,me as updateOrientationManipulator,we as updateRotationManipulatorTransform};
