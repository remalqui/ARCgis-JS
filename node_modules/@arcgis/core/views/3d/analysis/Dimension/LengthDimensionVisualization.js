/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import e from"../../../../core/Handles.js";import{equals as t}from"../../../../core/lang.js";import{destroyMaybe as s}from"../../../../core/maybe.js";import{formatDecimal as i}from"../../../../core/quantityFormatUtils.js";import{watch as n,initial as l}from"../../../../core/reactiveUtils.js";import{pt2px as a}from"../../../../core/screenUtils.js";import{c as m}from"../../../../chunks/vec3f64.js";import{computeSpanningSegment as o,OffsetSegmentLocation as r,maxScreenLengthSquaredFromGeometry as f,offsetSegment as d}from"./lengthDimensionUtils.js";import{settings as c}from"./settings.js";import{LabelVisualElement as h}from"../../interactive/visualElements/LabelVisualElement.js";import{LineVisualElement as u}from"../../interactive/visualElements/LineVisualElement.js";import{MarkerVisualElement as S}from"../../interactive/visualElements/MarkerVisualElement.js";import{EuclideanSegment as g}from"../../interactive/visualElements/support/Segment.js";class v{set visible(e){for(const t of this._visualElements.values())t.attached=e}constructor(s){this.destroyed=!1,this._handles=new e,this._messages=null,this._labelSegment=new g;const{analysis:i,computation:m,view:o,messages:r}=s;this.analysis=i,this.computation=m,this.view=o,this._messages=r;const f=s.visible,d={view:o,attached:f},{fontSize:c,textColor:v,textBackgroundColor:p}=i.style;this._visualElements=new y({marker:new S(d,s.markerMaterial),dimension:new u(d,s.dimensionLineMaterial),startOffset:new u(d,s.offsetLineMaterial),endOffset:new u(d,s.offsetLineMaterial),dimensionSmall:new u(d,s.smallDimensionLineMaterial),startOffsetSmall:new u(d,s.smallOffsetLineMaterial),endOffsetSmall:new u(d,s.smallOffsetLineMaterial),label:new h({view:o,attached:f,distance:0,geometry:{type:"segment",sampleLocation:"center",segment:this._labelSegment,callout:!1},fontSize:a(c),textColor:v.clone(),backgroundColor:p.clone()})}),this._handles.add([n((()=>m.geometry),(e=>{this.updateCameraDependentElements(o.state.camera,e,i.style),null!=m.geometry&&this._updateLines(m.geometry)}),{...l,equals:t}),n((()=>m.length),(e=>this._updateLabelContent(e)),l)])}destroy(){this.destroyed=!0,this._handles=s(this._handles);for(const e of this._visualElements.values())e.destroy()}get testInfo(){return{dimensionVisualElement:this._visualElements.dimension,label:this._visualElements.label}}_updateLines(e){const t=o(b,r.Start,e.directSegment,e.dimensionSegment),s=o(O,r.End,e.directSegment,e.dimensionSegment),i=this._visualElements;i.marker.setGeometryFromSegment(e.dimensionSegment,e.primaryOffsetAxis),i.dimension.setGeometryFromSegment(e.dimensionSegment),i.startOffset.setGeometryFromSegment(t),i.endOffset.setGeometryFromSegment(s),i.dimensionSmall.setGeometryFromSegment(e.dimensionSegment),i.startOffsetSmall.setGeometryFromSegment(t),i.endOffsetSmall.setGeometryFromSegment(s)}updateCameraDependentElements(e,t,s){const i=this._visualElements;if(null==t){for(const e of i.values())e.visible=!1;return}const n=e.computeScreenPixelSizeAt(t.dimensionSegment.eval(.5,_)),l=f(t,n),m=l<(a(s.lineSize)*c.smallScreenLengthLineSizeFactor)**2,o=!m;i.marker.visible=o,i.dimension.visible=o,i.startOffset.visible=o,i.endOffset.visible=o,i.dimensionSmall.visible=m,i.startOffsetSmall.visible=m,i.endOffsetSmall.visible=m;const r=a(s.fontSize)*c.labels.minScreenLengthFontSizeFactor,{label:h}=i;if(h.visible=l>=r**2,!h.visible)return;const{dimensionSegment:u,primaryOffsetAxis:S}=t,{offset:g}=this.computation.dimension,v=(Math.sign(g)>=0?1:-1)*p(s)*n;d(this._labelSegment,u,S,v),h.updateLabelPosition()}updateLabelStyle(e){const{label:t}=this._visualElements;t.fontSize=a(e.fontSize),t.textColor=e.textColor,t.backgroundColor=e.textBackgroundColor}updateUnitsMessages(e){this._messages=e;const{length:t}=this.computation;this._updateLabelContent(t)}_updateLabelContent(e){const{label:t}=this._visualElements;null!=e&&null!=this._messages?t.text=i(this._messages,e,e.unit):t.text=""}}function p(e){return 1.5*a(e.fontSize)+c.labels.marginPx+a(e.lineSize/2)}const b=new g,O=new g,_=m();class y{constructor(e){this.marker=e.marker,this.dimension=e.dimension,this.startOffset=e.startOffset,this.endOffset=e.endOffset,this.dimensionSmall=e.dimensionSmall,this.startOffsetSmall=e.startOffsetSmall,this.endOffsetSmall=e.endOffsetSmall,this.label=e.label}values(){return[this.marker,this.dimension,this.startOffset,this.endOffset,this.dimensionSmall,this.startOffsetSmall,this.endOffsetSmall,this.label]}}export{y as LengthDimensionVisualElements,v as LengthDimensionVisualization};
