/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../chunks/tslib.es6.js";import i from"../../../../Color.js";import"../../../../intl.js";import s from"../../../../core/Accessor.js";import{makeHandle as t}from"../../../../core/handleUtils.js";import{watch as a,syncAndInitial as r,when as n,sync as o}from"../../../../core/reactiveUtils.js";import{pt2px as l}from"../../../../core/screenUtils.js";import{property as m}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/accessorSupport/ensureType.js";import"../../../../core/arrayUtils.js";import"../../../../core/has.js";import{subclass as d}from"../../../../core/accessorSupport/decorators/subclass.js";import{Z as c}from"../../../../chunks/vec4f64.js";import{LengthDimensionVisualization as h}from"./LengthDimensionVisualization.js";import{settings as p}from"./settings.js";import{RenderOccludedFlag as u}from"../../webgl-engine/lib/Material.js";import{LineMarkerMaterial as f}from"../../webgl-engine/materials/LineMarkerMaterial.js";import{createStipplePatternSimple as _}from"../../webgl-engine/materials/lineStippleUtils.js";import{RibbonLineMaterial as g}from"../../webgl-engine/materials/RibbonLineMaterial.js";import{LineMarkerAnchor as M}from"../../webgl-engine/shaders/LineMarkerTechniqueConfiguration.js";import{onLocaleChange as y}from"../../../../intl/locale.js";import{fetchMessageBundle as w}from"../../../../intl/messages.js";let v=class extends s{get analysis(){return this.analysisViewData.analysis}get visible(){return this.analysisViewData.visible}constructor(e){super(e),this.loadingMessages=!1,this._messages=null,this._dimensionVisualizations=new Map,this._markerMaterial=new f({width:1,anchor:M.Tip,color:c,placement:"begin-end",worldSpace:!0,hideOnShortSegments:!0,hasTip:!0,renderOccluded:u.OccludeAndTransparent,markerPrimitive:"triangle"}),this._dimensionLineMaterial=new g({width:1,color:c,renderOccluded:u.OccludeAndTransparent,markerParameters:this._markerMaterial.parameters}),this._offsetLineMaterial=new g({width:1,color:c,renderOccluded:u.OccludeAndTransparent,stipplePattern:_(5),stippleScaleWithLineWidth:!0}),this._smallDimensionLineMaterial=new g({width:1,color:c,renderOccluded:u.OccludeAndTransparent}),this._smallOffsetLineMaterial=new g({width:1,color:c,renderOccluded:u.OccludeAndTransparent,stipplePattern:_(5),stippleScaleWithLineWidth:!0})}initialize(){for(const i of this._lineMaterials())this.view._stage.add(i),this.addHandles(t((()=>{this.view._stage?.remove(i),i.dispose()})));const{computations:e}=this.analysisViewData;for(const i of e)this._addComputation(i);this.addHandles([e.on("change",(({added:e,removed:i})=>{for(const s of i)this._removeComputation(s);for(const s of e)this._addComputation(s)})),a((()=>i.toUnitRGBA(this.analysis.style.color)),(e=>{for(const i of this._lineMaterials())i.setParameters({color:e})}),r),a((()=>this.analysis.style.lineSize),(e=>{const i=l(e);this._markerMaterial.setParameters({width:i*p.markers.lineSizeFraction}),this._dimensionLineMaterial.setParameters({width:i,markerParameters:this._markerMaterial.parameters});const s=Math.max(i*p.offsetLine.lineSizeFraction,1);this._offsetLineMaterial.setParameters({width:s})}),r),a((()=>({camera:this.view.state.camera,style:L(this.analysis)})),(({camera:e,style:i})=>{for(const[s,t]of this._dimensionVisualizations)t.updateCameraDependentElements(e,s.geometry,i),t.updateLabelStyle(i)})),a((()=>this.visible),(e=>{for(const i of this._dimensionVisualizations.values())i.visible=e}))]),this.addHandles([y((()=>this._updateMessageBundle())),n((()=>!this.loadingMessages),(()=>{for(const e of this._dimensionVisualizations.values())e.updateUnitsMessages(this._messages)}),o)]),this._updateMessageBundle()}destroy(){this._dimensionVisualizations.forEach((e=>{e.destroy()})),this._dimensionVisualizations.clear()}get testInfo(){return{visualizations:Array.from(this._dimensionVisualizations.values()),disablePartialOcclusion:()=>{for(const e of this._lineMaterials())e.setParameters({renderOccluded:u.Occlude})}}}_addComputation(e){this._dimensionVisualizations.has(e)||this._dimensionVisualizations.set(e,new h({analysis:this.analysis,computation:e,view:this.view,visible:this.visible,markerMaterial:this._markerMaterial,dimensionLineMaterial:this._dimensionLineMaterial,offsetLineMaterial:this._offsetLineMaterial,smallDimensionLineMaterial:this._smallDimensionLineMaterial,smallOffsetLineMaterial:this._smallOffsetLineMaterial,messages:this._messages}))}_removeComputation(e){const i=this._dimensionVisualizations.get(e);null!=i&&(i.destroy(),this._dimensionVisualizations.delete(e))}_lineMaterials(){return[this._markerMaterial,this._dimensionLineMaterial,this._offsetLineMaterial,this._smallDimensionLineMaterial,this._smallOffsetLineMaterial]}async _updateMessageBundle(){this.loadingMessages=!0;try{this._messages=await w("esri/core/t9n/Units")}finally{this.loadingMessages=!1}}};function L(e){const{fontSize:i,lineSize:s,textColor:t,textBackgroundColor:a}=e.style;return{fontSize:i,lineSize:s,textBackgroundColor:a.clone(),textColor:t.clone()}}e([m({constructOnly:!0})],v.prototype,"analysisViewData",void 0),e([m({constructOnly:!0,nonNullable:!0})],v.prototype,"view",void 0),e([m()],v.prototype,"analysis",null),e([m()],v.prototype,"visible",null),e([m()],v.prototype,"loadingMessages",void 0),v=e([d("esri.views.3d.analysis.Dimension.DimensionVisualization")],v);export{v as DimensionVisualization};
