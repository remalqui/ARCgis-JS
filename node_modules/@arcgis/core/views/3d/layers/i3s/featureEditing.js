/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{clone as t}from"../../../../core/lang.js";import{attributeLookup as e}from"../support/attributeUtils.js";const n={setAttribute(){},setGeometry(t){},rollback(){},commit(){}};var o;function r(e,r){const s=r.attributes[e.objectIdField],l=e.sessions.get(s);if(l)return l;const u=t(r.attributes),i=new Set;if(null==s)return n;const a=e.i3sOverrides.createInteractiveEditSession(s),c=new Map,d=(t,e)=>{const n=c.get(t);if(null==n){const n=e.indexOf(s);return c.set(t,n),n}return n};let f=o.EDITING;const b={setAttribute(t,n){if(f!==o.EDITING)return;const s=e.fieldsIndex.get(t);if(!s)return;const l=e.attributeStorageInfo.findIndex((t=>t.name===s.name));if(l<0)return;a.setAttribute(l,n);const u=e.attributeStorageInfo[l];let c=!1;i.add(t),e.forEachNode(((t,o)=>{const s=d(t,o);if(-1===s)return;const l=e.getAttributeData(t.index);if(l){const o=l[u.name];o&&(o[s]=n,e.setAttributeData(t.index,l,r),c=!0)}})),c&&e.clearMemCache()},setGeometry(t){f===o.EDITING&&a.setGeometry(t)},rollback(){if(f===o.EDITING){for(const t of i)this.setAttribute(t,u[t]);a.rollback(),f=o.ROLLED_BACK,e.sessions.delete(s)}},commit(){f===o.EDITING&&(a.commit(),f=o.COMMITTED,e.sessions.delete(s))}};return e.sessions.set(s,b),b}function s(t,n){const o=t.fieldsIndex,r=t.objectIdField,s=t.globalIdField;if(null==s)return;const l=new Map,u=f(n.addedFeatures),i=n.edits.addFeatures,a=b(n.updatedFeatures),c=n.edits.updateFeatures,I=d(o,r,s,n.edits?.deleteFeatures),g=b(n.deletedFeatures,I),m=n.edits.deleteFeatures;if(null!=i&&i.length>0)for(const d of i){const t=e(o,d.attributes,s),n=u.get(t);null!=d.geometry&&"mesh"===d.geometry.type&&null!=n&&l.set(n,d.geometry)}if(null!=c&&c.length>0)for(const d of c){const t=e(o,d.attributes,r);null!=d.geometry&&"mesh"===d.geometry.type&&a.has(t)&&l.set(t,d.geometry)}if(null!=m&&m.length>0)for(const d of m){let t=null;t="attributes"in d?e(o,d.attributes,r):d.objectId,null!=t&&g.has(t)&&l.set(t,null)}for(const[e,d]of l)t.i3sOverrides.updateGeometry(e,d)}function l(t,e){const n=i(t,e),o=u(t,e);if(0===n.size&&0===o.size)return;const r=new Map;for(let u=0;u<t.attributeStorageInfo.length;u++)r.set(t.attributeStorageInfo[u].name,u);let s=!1;n.forEach(((e,n)=>{const o=t.getAttributeData(n);let l=!1;e.forEach(((e,n)=>{const u=null!=o?o[n]:null,i=r.get(n);for(const{featureIndex:o,value:r,featureId:a}of e)u&&(u[o]=r,l=!0,s=!0),t.i3sOverrides.updateAttributeValue(a,i,r)})),l&&t.setAttributeData(n,o,null)})),s&&t.clearMemCache();const{fieldsIndex:l,i3sOverrides:a,objectIdField:c,globalIdField:d}=t,f=a.layer.associatedLayer?.infoFor3D,b=new Set(f?[...Object.values(f.assetMapFieldRoles),...Object.values(f.transformFieldRoles)]:[]);for(const[u,i]of o){a.featureAdded(u);const{attributes:t}=i;for(const e in t){if(e!==c&&e!==d&&b.has(e))continue;const n=l.normalizeFieldName(e),o=null!=n?r.get(n):null;if(null==o)continue;const s=t[e];a.updateAttributeValue(u,o,s)}}}function u(t,{edits:n,addedFeatures:o}){const r=new Map,s=n.addAssetFeatures,{fieldsIndex:l,globalIdField:u}=t;if(!s||0===s.length||null==u)return r;const i=f(o);for(const a of s){const t=e(l,a.attributes,u),n=i.get(t);null!=a.geometry&&"mesh"===a.geometry.type&&null!=n&&r.set(n,a)}return r}function i(t,n){const o=n.edits.updateFeatures;if(!o||0===o.length)return new g;const r=b(n.updatedFeatures),s=new g,l=new Map;for(let e=0;e<t.attributeStorageInfo.length;e++)l.set(t.attributeStorageInfo[e].name,e);const u=t.fieldsIndex,i=t.objectIdField,c=o.filter((t=>{const n=e(u,t.attributes,i);return r.has(n)}));return t.forEachNode(((n,o)=>{const r=new Set(o);for(const l of c){const c=e(u,l.attributes,i);if(!r.has(c))continue;const d=o.indexOf(c);for(const e in l.attributes){const o=t.fieldsIndex.normalizeFieldName(e),r=a(s,n.index,o),u=l.attributes[e];r.push({featureIndex:d,featureId:c,value:u})}}})),s}function a(t,e,n){const o=c(t,e),r=null!=n&&o.get(n);if(r)return r;const s=new Array;return o.set(n,s),s}function c(t,e){const n=t.get(e);if(n)return n;const o=new I;return t.set(e,o),o}function d(t,n,o,r){const s=new Map;if(!r)return s;for(const l of r){let r=null,u=null;"attributes"in l?(r=e(t,l.attributes,n),u=e(t,l.attributes,o)):(r=l.objectId,u=l.globalId),null!=u&&null!=r&&s.set(u,r)}return s}function f(t){const e=new Map;if(!t)return e;for(const n of t)null!=n.globalId&&null!=n.objectId&&null==n.error&&e.set(n.globalId,n.objectId);return e}function b(t,e=null){const n=new Set;if(!t)return n;for(const o of t)if(null==o.error)if(null!=o.objectId&&-1!==o.objectId)n.add(o.objectId);else if(null!=o.globalId&&null!=e){const t=e.get(o.globalId);null!=t&&n.add(t)}return n}!function(t){t[t.EDITING=0]="EDITING",t[t.ROLLED_BACK=1]="ROLLED_BACK",t[t.COMMITTED=2]="COMMITTED"}(o||(o={}));const I=Map,g=Map;export{r as createInteractiveEditSession,l as processAttributeEdits,s as processGeometryEdits};
