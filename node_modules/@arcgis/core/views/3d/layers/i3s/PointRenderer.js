/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{disposeMaybe as e}from"../../../../core/maybe.js";import t from"../../../../core/PooledArray.js";import{b as s,l as i,g as r,o as n,e as o,p as a}from"../../../../chunks/vec3.js";import{c as h}from"../../../../chunks/vec3f64.js";import{s as l}from"../../../../chunks/vec4.js";import{create as c,offset as u,contains as d,containsPoint as p,set as m,POSITIVE_INFINITY as g,equals as _}from"../../../../geometry/support/aaBoundingBox.js";import{create as f}from"../../../../geometry/support/plane.js";import{fromPoints as P}from"../../../../geometry/support/ray.js";import{PclTarget as b}from"./Intersector.js";import{PointHighlights as S}from"./PointHighlights.js";import{minimumDistancePlane as x,maximumDistancePlane as z,intersectLine as R,toAaBoundingBox as q}from"../../support/orientedBoundingBox.js";import{ShaderOutput as w}from"../../webgl-engine/core/shaderLibrary/ShaderOutput.js";import{Default3D as y}from"../../webgl-engine/lib/DefaultVertexAttributeLocations.js";import{newIntersectorResult as A}from"../../webgl-engine/lib/Intersector.js";import{IntersectorType as j,StoreResults as I}from"../../webgl-engine/lib/IntersectorInterfaces.js";import{VertexArrayObject as F}from"../../webgl-engine/lib/VertexArrayObject.js";import{VertexAttribute as v}from"../../webgl-engine/lib/VertexAttribute.js";import{P as C,a as E,g as H}from"../../../../chunks/PointRenderer.glsl.js";import{PointRendererTechnique as N}from"../../webgl-engine/shaders/PointRendererTechnique.js";import{PointRendererTechniqueConfiguration as O}from"../../webgl-engine/shaders/PointRendererTechniqueConfiguration.js";import{BufferObject as L}from"../../../webgl/BufferObject.js";import{DataType as T,PrimitiveType as B,Usage as D}from"../../../webgl/enums.js";import{VertexElementDescriptor as M}from"../../../webgl/VertexElementDescriptor.js";const V={positions:[new M(v.POSITION,3,T.FLOAT,0,12)],colors:[new M(v.COLOR,3,T.UNSIGNED_BYTE,0,3,!0)]};class W{get needsHighlight(){return this._highlights.hasHighlights}constructor(e){this._params=e,this.type=j.PCL,this.isGround=!1,this._passParameters=new C,this._highlights=new S({forEachNode:e=>this.forEachNode(e),addHighlight:(e,t,s)=>this._addHighlight(e,t,s),removeHighlight:(e,t)=>this._removeHighlight(e,t)}),this.canRender=!0,this.layerUid="",this._slicePlaneEnabled=!1,this._techniqueConfig=new O,this._nodes=new t}initializeRenderContext(e){this._context=e,this._techniqueRepository=this._context.techniqueRepository,e.requestRender()}uninitializeRenderContext(){}intersect(e,t,m,g){const _=h(),S=h(),w=h(),y=h(),j=f(),F=e.camera.perScreenPixelRatio/2,v=e.camera.near;s(S,g,m);const C=1/i(S);r(S,S,C),n(w,S),l(j,S[0],S[1],S[2],-o(S,m));const E=new Z,H=new Z,N=new Array,O=c(),L=c(this._passParameters.clipBox);u(L,-m[0],-m[1],-m[2],L),this._nodes.forAll((i=>{const r=i.splatSize*this._passParameters.scaleFactor;let n=x(i.obb,j),h=z(i.obb,j);n-=Y(r,n+v,this._passParameters,F,i.isLeaf),h-=Y(r,h+v,this._passParameters,F,i.isLeaf);const l=h<0,c=null!=E.dist&&null!=H.dist&&E.dist<n*C&&H.dist>h*C;if(l||c)return;const f=G(r,h+v,this._passParameters,F,i.isLeaf);if(!R(i.obb,m,S,f))return;const P=f*f;q(i.obb,O),u(O,-m[0],-m[1],-m[2],O);const b=!d(L,O);s(y,i.origin,m);const A=i.coordinates.length/3;for(let s=0;s<A;s++){if(_[0]=y[0]+i.coordinates[3*s],_[1]=y[1]+i.coordinates[3*s+1],_[2]=y[2]+i.coordinates[3*s+2],b&&!p(L,_))continue;const n=o(_,S),h=a(_)-n*n;if(h>P)continue;let l=n+v;const c=Y(r,l,this._passParameters,F,i.isLeaf);if(n-c<0)continue;l-=c;const u=G(r,l,this._passParameters,F,i.isLeaf);if(h>u*u)continue;const d=(n-c)*C,f=e=>(e.point=J(i,s,e.point),e.dist=d,e.normal=w,e.node=i,e.pointId=s,e.layerUid=this.layerUid,e);if((null==E.dist||d<E.dist)&&(null==t||t(m,g,d))&&f(E),e.options.store!==I.MIN&&(null==H.dist||d>H.dist)&&(null==t||t(m,g,d))&&f(H),e.options.store===I.ALL&&(null==t||t(m,g,d))){const e=new Z;N.push(f(e))}}}));const T=e=>{const{layerUid:t,node:s,pointId:i}=e;return new b(e.point,t,i,(()=>this._params.createGraphic(s,i,e.point)))},B=(e,t)=>{const s=T(t);e.set(this.type,s,t.dist,t.normal)};if($(E)){const t=e.results.min;(null==t.dist||E.dist<t.dist)&&B(t,E)}if($(H)&&e.options.store!==I.MIN){const t=e.results.max;(null==t.dist||H.dist>t.dist)&&B(t,H)}if(e.options.store===I.ALL){const t=P(m,g);for(const s of N){const i=A(t);B(i,s),e.results.all.push(i)}}}prepareTechnique(e){return 0===this._nodes.length||e.output!==w.Color&&e.output!==w.Depth&&e.output!==w.Highlight?null:(this._nodes.forAll((t=>{null==t.vao&&this._initNode(e,t)})),this._techniqueConfig.drawScreenSize=this._passParameters.drawScreenSpace,this._techniqueConfig.useFixedSizes=this._passParameters.useFixedSizes,this._techniqueConfig.hasSlicePlane=this._slicePlaneEnabled,this._techniqueConfig.hasOccludees=e.bindParameters.hasOccludees,this._techniqueConfig.clippingEnabled=this._clippingEnabled,this._techniqueConfig.output=e.output===w.Depth?w.Depth:e.output===w.Highlight?w.Highlight:w.Color,this._techniqueRepository.releaseAndAcquire(N,this._techniqueConfig,this._technique))}render(e,t){const s=e.rctx,i=s.bindTechnique(t,this._passParameters,e.bindParameters),r=e.output===w.Highlight;this._nodes.forAll((t=>{0===t.coordinates.length||r&&!t.highlights||(i.bindDraw(t,e.bindParameters,this._passParameters),s.bindVAO(t.vao),r?this._renderHighlightFragments(s,t):s.drawArrays(B.POINTS,0,t.coordinates.length/3))}))}_renderHighlightFragments(e,t){const s=t.highlights;if(null==s)return;let i=s[0].component,r=i+1;for(let o=1;o<s.length;o++){const t=s[o].component;if(t!==r){const s=r-i;s>0&&e.drawArrays(B.POINTS,i,s),i=t}r=t+1}const n=r-i;n>0&&e.drawArrays(B.POINTS,i,n)}set useFixedSizes(e){this._passParameters.useFixedSizes!==e&&(this._passParameters.useFixedSizes=e,this._requestRender())}get useFixedSizes(){return this._passParameters.useFixedSizes}set scaleFactor(e){this._passParameters.scaleFactor!==e&&(this._passParameters.scaleFactor=e,this._requestRender())}get scaleFactor(){return this._passParameters.scaleFactor}set minSizePx(e){this._passParameters.minSizePx!==e&&(this._passParameters.minSizePx=e,this._requestRender())}get minSizePx(){return this._passParameters.minSizePx}set useRealWorldSymbolSizes(e){this._passParameters.useRealWorldSymbolSizes!==e&&(this._passParameters.useRealWorldSymbolSizes=e,this._requestRender())}get useRealWorldSymbolSizes(){return this._passParameters.useRealWorldSymbolSizes}set size(e){this._passParameters.size!==e&&(this._passParameters.size=e,this._requestRender())}get size(){return this._passParameters.size}set sizePx(e){this._passParameters.sizePx!==e&&(this._passParameters.sizePx=e,this._requestRender())}get sizePx(){return this._passParameters.sizePx}set clippingBox(e){m(this._passParameters.clipBox,e||g)}get _clippingEnabled(){return!_(this._passParameters.clipBox,g,((e,t)=>e===t))}get slicePlaneEnabled(){return this._slicePlaneEnabled}set slicePlaneEnabled(e){this._slicePlaneEnabled!==e&&(this._slicePlaneEnabled=e,this._requestRender())}addNode(e){this._nodes.push(e),this._highlights.nodeAdded(e),this._requestRender()}removeNode(t){let s=null;return this._nodes.filterInPlace((i=>i.id!==t||(s=i,i.vao=e(i.vao),this._highlights.nodeRemoved(i),!1))),this._requestRender(),s}forEachNode(e){this._nodes.forAll(e)}removeAll(){this._nodes.forAll((t=>t.vao=e(t.vao))),this._highlights.removeAll(),this._nodes.clear(),this._requestRender()}highlight(e){return this._highlights.add(e)}_addHighlight(e,t,s){e.highlights=Q(e.highlights,t,s),this._requestRender()}_removeHighlight(e,t){e.highlights=X(e.highlights,t),this._requestRender()}_initNode(e,t){const s=e.rctx;t.vao=new F(s,y,V,{positions:L.createVertex(s,D.STATIC_DRAW,t.coordinates),colors:L.createVertex(s,D.STATIC_DRAW,t.rgb)})}_requestRender(){this._context&&this._context.requestRender()}}class U extends E{constructor(e,t,s,i,r,n,o,a,h=null,l=null){super(s,r,t),this.id=e,this.obb=i,this.coordinates=n,this.rgb=o,this.attributes=a,this.pointIdFilterMap=h,this.highlights=l}}function k(e){return e.hasOwnProperty("splatSize")}function G(e,t,s,i,r){if(s.drawScreenSpace)return s.fixedSize*t*i;const n=H(r)*t*i;return s.useFixedSizes?Math.min(s.fixedSize/2,n):s.screenMinSize>0?Math.min(Math.max(s.screenMinSize*t*i,e/2),n):Math.min(e/2,n)}function Y(e,t,s,i,r){return s.drawScreenSpace?0:G(e,t,s,i,r)}function J(e,t,s){return null==s&&(s=h()),s[0]=e.origin[0]+e.coordinates[3*t],s[1]=e.origin[1]+e.coordinates[3*t+1],s[2]=e.origin[2]+e.coordinates[3*t+2],s}function K(e){return null!=e.component?e.component:-1}function Q(e,t,s){null==e&&(e=[]);const i={component:t,id:s};e.push(i);const r=K(i);let n=e.length-1;for(;n>0&&r<K(e[n-1]);)[e[n-1],e[n]]=[e[n],e[n-1]],--n;return e}function X(e,t){if(null==e)return e;const s=e.filter((e=>e.id!==t));return 0===s.length?null:s}class Z{constructor(){this.node=null,this.pointId=null,this.point=null,this.dist=null,this.normal=null,this.layerUid=""}}function $(e){return null!=e.dist&&null!=e.point&&null!=e.pointId&&null!=e.node}export{W as PointRenderer,U as PointRendererNode,k as isInstanceOfNode};
