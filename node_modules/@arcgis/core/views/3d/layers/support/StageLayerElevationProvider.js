/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{_ as e}from"../../../../chunks/tslib.es6.js";import t from"../../../../core/Accessor.js";import o from"../../../../core/Evented.js";import r from"../../../../core/Handles.js";import s from"../../../../core/Logger.js";import{getMetersPerVerticalUnitForSR as n}from"../../../../core/unitUtils.js";import{property as i}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/accessorSupport/ensureType.js";import"../../../../core/arrayUtils.js";import"../../../../core/has.js";import{subclass as a}from"../../../../core/accessorSupport/decorators/subclass.js";import{c as l}from"../../../../chunks/vec3.js";import{c}from"../../../../chunks/vec3f64.js";import{empty as d,toRect as p,expandWithVec3 as m}from"../../../../geometry/support/aaBoundingBox.js";import{empty as h}from"../../../../geometry/support/aaBoundingRect.js";import{getMetersPerUnit as u}from"../../../../symbols/support/unitConversionUtils.js";import{newIntersector as f}from"../../webgl-engine/lib/Intersector.js";import{StoreResults as _}from"../../webgl-engine/lib/IntersectorInterfaces.js";const j=1;let y=class extends(o.EventedMixin(t)){get spatialReference(){return this.view?.spatialReference}constructor(e){super(e),this._elevationOffset=0,this._layerHandes=new r}initialize(){this._renderCoordsHelper=this.view.renderCoordsHelper,this._intersectLayers=[this.stageLayer],this._intersector=f(this.view.state.viewingMode),this._intersector.options.store=_.MIN;const e=this._computeLayerExtent(this.spatialReference,this.stageLayer);this._zmin=e[2],this._zmax=e[5];const t=this.stageLayer.events;this._layerHandes.add([t.on("layerObjectAdded",(e=>this._objectChanged(e.object))),t.on("layerObjectRemoved",(e=>this._objectChanged(e.object))),t.on("objectGeometryAdded",(e=>this._objectChanged(e.object))),t.on("objectGeometryRemoved",(e=>this._objectChanged(e.object))),t.on("objectGeometryUpdated",(e=>this._objectChanged(e.object))),t.on("objectTransformation",(e=>this._objectChanged(e)))])}dispose(){this._layerHandes.destroy()}elevationInfoChanged(){const e=null!=this.layer?this.layer.elevationInfo:null;if(null!=e&&"on-the-ground"!==e.mode){const t=n(this.layer.spatialReference),o=u(e.unit??"meters");this._elevationOffset=(e.offset??0)*o/t}else this._elevationOffset=0}getElevation(e,t,o,r){if(x[0]=e,x[1]=t,x[2]=o,!this._renderCoordsHelper.toRenderCoords(x,r,x))return s.getLogger(this).error("could not project point for elevation alignment"),null;const n=this._elevationOffset,i=this._zmin+n,a=this._zmax+n;this._renderCoordsHelper.setAltitude(C,a,x),this._renderCoordsHelper.setAltitude(E,i,x);const l=e=>!!e.lastValidElevationBB;return this._intersector.reset(C,E,null),this._intersector.intersect(this._intersectLayers,null,j,null,l),this._intersector.results.min.getIntersectionPoint(x)?this._renderCoordsHelper.getAltitude(x):null}_objectChanged(e){const t=this.spatialReference;if(!e.lastValidElevationBB||!t)return;d(g);const o=e.lastValidElevationBB;o.isEmpty()||this._expandExtent(t,o.min,o.max,g);const{min:r,max:s}=e.boundingVolumeWorldSpace;this._expandExtent(t,r,s,g),p(g,v),this._zmin=Math.min(this._zmin,g[2]),this._zmax=Math.max(this._zmax,g[5]),b.extent=v,b.spatialReference=t,this.emit("elevation-change",b),l(o.min,r),l(o.max,s)}_computeLayerExtent(e,t){return d(g),null!=e&&t.objects.forAll((t=>this._expandExtent(e,t.boundingVolumeWorldSpace.min,t.boundingVolumeWorldSpace.max,g))),g}_expandExtent(e,t,o,r){for(let s=0;s<8;++s)x[0]=1&s?t[0]:o[0],x[1]=2&s?t[1]:o[1],x[2]=4&s?t[2]:o[2],this._renderCoordsHelper.fromRenderCoords(x,x,e),m(r,x);return r}};e([i({constructOnly:!0})],y.prototype,"layer",void 0),e([i({constructOnly:!0})],y.prototype,"stageLayer",void 0),e([i({constructOnly:!0})],y.prototype,"view",void 0),e([i()],y.prototype,"spatialReference",null),y=e([a("esri.views.3d.layers.support.StageLayerElevationProvider")],y);const g=d(),v=h(),b={spatialReference:null,extent:v,context:"scene"},x=c(),C=c(),E=c();export{y as StageLayerElevationProvider};
