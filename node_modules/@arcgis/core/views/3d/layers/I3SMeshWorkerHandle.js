/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import s from"../../../core/Logger.js";import{unwrapOrThrow as e}from"../../../core/maybe.js";import o from"../../../core/PooledArray.js";import{WorkerHandle as t}from"../../../core/workers/WorkerHandle.js";import{canProjectWithoutEngine as r,projectVectorToVector as p}from"../../../geometry/projection.js";import{ModificationType as h}from"../../../libs/i3s/enums.js";class i extends t{constructor(s){super("SceneLayerWorker","process",{process:s=>[s.geometryBuffer],project:s=>[s.positions.buffer],transformNormals:s=>[s.normals.buffer]},s,{hasInitialize:!0})}setModifications(s,e,o,t){const r={context:s,modifications:a(e,o,t),isGeodetic:t.isGeographic};this.broadcast(r,"setModifications")}setLegacySchema(s,e){const o=JSON.stringify(e);this.broadcast({context:s,jsonSchema:o},"setLegacySchema")}destroyContext(s){return this.broadcast(s,"destroyContext")}project(s,e){return this.invokeMethod("project",s,e)}transformNormals(s,e){return this.invokeMethod("transformNormals",s,e)}}const n=new o({deallocator:null}),u=[0,0,0];function a(o,t,i){n.clear();let a=1/0,c=1/0,f=-1/0,m=-1/0,l=!1;for(const g of t){const o="clip"===g.type?h.Inside:"mask"===g.type?h.Outside:h.Replace,t=e(g.geometry,"modification.geometry");let d=s=>s;if(t.spatialReference){if(!r(t.spatialReference,i)){s.getLogger("esri.views.3d.layers.I3SMeshWorkerHandle").warn("Can't project modification polygon into layer spatial reference, ignoring modification");continue}d=s=>(p(s,t.spatialReference,u,i),u)}else t.hasZ||(u[2]=0,d=s=>(u[0]=s[0],u[1]=s[1],u));l=l||o===h.Outside,n.push(o),n.push(t.rings.length);for(const s of t.rings){n.push(s.length);for(const e of s){const s=d(e);n.push(s[0]),n.push(s[1]),n.push(s[2]),a=Math.min(a,s[0]),c=Math.min(c,s[1]),f=Math.max(f,s[0]),m=Math.max(m,s[1])}}}if(null!=o)if(l){const s=1e-4;n.push(h.Inside),n.push(2),n.push(4),n.push(a-s),n.push(c-s),n.push(0),n.push(f+s),n.push(c-s),n.push(0),n.push(f+s),n.push(m+s),n.push(0),n.push(a-s),n.push(m+s),n.push(0),n.push(4),n.push(o[0]),n.push(o[1]),n.push(0),n.push(o[2]),n.push(o[1]),n.push(0),n.push(o[2]),n.push(o[3]),n.push(0),n.push(o[0]),n.push(o[3]),n.push(0)}else n.push(h.Outside),n.push(1),n.push(4),n.push(o[0]),n.push(o[1]),n.push(0),n.push(o[2]),n.push(o[1]),n.push(0),n.push(o[2]),n.push(o[3]),n.push(0),n.push(o[0]),n.push(o[3]),n.push(0);n.push(h.Finished);const d=new Float64Array(n.length);for(let s=0;s<n.length;++s)d[s]=n.at(s);return d}export{i as I3SMeshWorkerHandle,a as toWasmModification};
