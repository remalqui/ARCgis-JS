/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import"../../../../core/has.js";import t from"../../../../core/Logger.js";import{B as e,m as r,c as a,f as s,a as o}from"../../../../chunks/mat4.js";import{I as i,c as n}from"../../../../chunks/mat4f64.js";import{g as m}from"../../../../chunks/vec3.js";import{c as f}from"../../../../chunks/vec3f64.js";import{perObjectElevationAligner as l}from"./ElevationAligners.js";import{evaluateElevationInfoAtPoint as c}from"./elevationAlignmentUtils.js";import{setContextFeature as h}from"./featureExpressionInfoUtils.js";import{Graphics3DObject3DGraphicLayer as g}from"./Graphics3DObject3DGraphicLayer.js";t.getLogger("esri.views.3d.layers.graphics.Graphics3DMeshObject3DGraphicLayer");class d extends g{constructor(){super(...arguments),this._originalGeometries=[],this._fastTransformUpdatesEnabled=!1}get fastTransformUpdatesEnabled(){return this._fastTransformUpdatesEnabled}enableFastTransformUpdates(t,r){if(this._fastTransformUpdatesEnabled)return;this._fastTransformUpdatesEnabled=!0;const{stageObject:a}=this,s=a.geometries.slice();a.removeAllGeometries();const o=e(p,a.transformation),i=r.getOrigin(o);for(const e of s){const r=t(e.material),s=e.instantiate({material:r});s.localOrigin=i,a.addGeometry(s)}this._originalGeometries=s}disableFastTransformUpdates(t){if(!this._fastTransformUpdatesEnabled)return;this._fastTransformUpdatesEnabled=!1;const{stageObject:e}=this,r=e.geometries.map((e=>t(e.material)));e.removeAllGeometries();for(let a=0;a<this._originalGeometries.length;a++){const t=this._originalGeometries[a],s=r[a];s.setParameters({modelTransformation:null}),s===t.material?e.addGeometry(t):e.addGeometry(t.instantiate({material:s}))}this._originalGeometries.length=0}updateFastLocalOrigin(t,r,a){if(!this._fastTransformUpdatesEnabled)return;const{stageObject:s}=this;if(0===s.geometries.length)return;const o=s.geometries[0].localOrigin,n=e(p,t),m=a.getOrigin(n);if(m===o)return;const f=r?.localMatrix??i;s.clearShaderTransformation(),s.transformation=t,s.geometries.forEach((t=>{t.transformation=f,t.localOrigin=m}))}updateTransform(t,e,a){const{stageObject:s}=this,o=e?.localMatrix??i;if(!this._fastTransformUpdatesEnabled)return s.clearShaderTransformation(),s.transformation=t,s.geometries.forEach((t=>{t.transformation=o})),void this.resetEdgeObject(a);const n=s.transformation,m=s.geometries[0].transformation,f=t,l=o,c=r(T,n,m),h=r(b,f,l);s.shaderTransformation=f,this._setFastMaterialTransformation({matA:c,matB:h});const g=()=>l;for(const r of s.geometries)r.shaderTransformer=g;this.resetEdgeObject(a)}alignWithElevation(t,e,s,o){if(!this._fastTransformUpdatesEnabled)return void super.alignWithElevation(t,e,s,o);null!=s&&h(this.elevationContext.featureExpressionInfoContext,s);const i=(r,a)=>c(r,t,this.elevationContext,e,a),{stageObject:n}=this;if(!n.geometries[0].material.parameters.modelTransformation)return;const m=n.transformation,f=n.geometries[0].transformation,g=r(T,m,f),d=a(u,n.shaderTransformation);this.alignedSampledElevation=l(this,this.elevationContext,t.spatialReference,i,e,d),n.shaderTransformation=d;const p=n.geometries[0].shaderTransformation,j=r(b,d,p);this._setFastMaterialTransformation({matA:g,matB:j}),this.resetEdgeObject(o)}_setFastMaterialTransformation({matA:t,matB:e}){const{stageObject:a}=this;if(0===a.geometries.length)return;const i=a.geometries[0].localOrigin,n=s(O,m(p,i.vec3,-1)),f=r(j,n,t),l=r(E,n,e),c=o(j,f),h=r(E,l,c);for(const r of a.geometries)r.material.setParameters({modelTransformation:h})}}const p=f(),T=n(),b=n(),u=n(),j=n(),E=n(),O=n();export{d as Graphics3DMeshObject3DGraphicLayer};
