/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{c as e,m as t,a as s}from"../../../../chunks/vec3.js";import{c as i}from"../../../../chunks/vec3f64.js";import{setMin as a,setMax as n,create as r,isPoint as o,empty as c,center as l,offset as h}from"../../../../geometry/support/aaBoundingBox.js";import{g}from"../../../../chunks/sphere.js";import{evaluateElevationInfoAtPoint as d}from"./elevationAlignmentUtils.js";import{setContextFeature as u}from"./featureExpressionInfoUtils.js";import{demResolutionForBoundingBox as b}from"./graphicUtils.js";import{Object3DState as O}from"../../webgl-engine/lib/basicInterfaces.js";import{Transparency as j}from"../../webgl-engine/lib/edgeRendering/interfaces.js";class m{constructor(e,t,s){this.baseMaterial=e,this.edgeMaterials=t,this.properties=s}}class p{get isElevationSource(){return!!this.stageObject.lastValidElevationBB}constructor(e,t,s,i,a,n,r,o=null){this.graphics3DSymbolLayer=e,this.stageObject=t,this._uniqueGeometries=s,this._uniqueMaterials=i,this._sharedResource=a,this.elevationAligner=n,this.elevationContext=r,this._edgeState=o,this.type="object3d",this._stageLayer=null,this._visible=!1,this._addedToStage=!1,this.alignedSampledElevation=0,this.needsElevationUpdates=!1,this.useObjectOriginAsAttachmentOrigin=!1}initialize(e){this._stageLayer=e;const t=e.stage;t.addMany(this._uniqueMaterials),t.addMany(this._uniqueGeometries),t.add(this.stageObject)}destroy(){if(!this._stageLayer)return;const e=this._stageLayer.stage;e.removeMany(this._uniqueMaterials),e.removeMany(this._uniqueGeometries),e.remove(this.stageObject),this._addedToStage&&(this._stageLayer.remove(this.stageObject),this._addedToStage=!1);const t=e.renderer.ensureEdgeView();t.hasObject(this.stageObject)&&t.removeObject(this.stageObject),this.stageObject.dispose(),null!=this._sharedResource&&this._sharedResource.release(),this._visible=!1,this._stageLayer=null}layerOpacityChanged(e,t){if(null==this._edgeState)return;const s=v(this._edgeState.baseMaterial);let i=!1;for(const a of this._edgeState.edgeMaterials)a.objectTransparency!==s&&(a.objectTransparency=s,i=!0);i&&this.resetEdgeObject(t);this._stageLayer.stage.renderer.ensureEdgeView().updateAllComponentOpacities(this.stageObject,[e])}slicePlaneEnabledChanged(e,t){if(null==this._edgeState)return;this._stageLayer.stage.renderer.ensureEdgeView().updateAllComponentMaterials(this.stageObject,this._edgeState.edgeMaterials,{hasSlicePlane:e},!t),this._edgeState.properties.hasSlicePlane=e}setVisibility(e){if(null!=this._stageLayer&&this._visible!==e&&(this._visible=e,this.stageObject.visible=e,this._visible&&!this._addedToStage&&(this._stageLayer.add(this.stageObject),this._addedToStage=!0),this._edgeState)){const t=this._stageLayer.stage.renderer.ensureEdgeView();t.hasObject(this.stageObject)?t.updateObjectVisibility(this.stageObject,e):e&&this._addOrUpdateEdgeObject(t,!1)}}get visible(){return this._visible}alignWithElevation(e,t,s,i){if(null==this.elevationAligner)return;null!=s&&u(this.elevationContext.featureExpressionInfoContext,s);const a=(s,i)=>d(s,e,this.elevationContext,t,i);this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,e.spatialReference,a,t),this.resetEdgeObject(i)}alignWithAbsoluteElevation(e,t,s){const i=(t,s)=>{s.sampledElevation=e,s.verticalDistanceToGround=0,s.z=e};this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,null,i,t),this.resetEdgeObject(s)}getCenterObjectSpace(t=i()){return e(t,g(this.stageObject.boundingVolumeObjectSpace.bounds))}getBoundingBoxObjectSpace(e=r()){const t=this.stageObject.boundingVolumeObjectSpace;return a(e,t.min),n(e,t.max),e}computeAttachmentOrigin(e){if(this.useObjectOriginAsAttachmentOrigin){const t=this.stageObject.shaderTransformation;e.render.origin[0]+=t[12],e.render.origin[1]+=t[13],e.render.origin[2]+=t[14],e.render.num++}else for(const i of this.stageObject.geometries)i.computeAttachmentOrigin(S)&&(t(S,S,this.stageObject.shaderTransformation),s(e.render.origin,e.render.origin,S),e.render.num++)}async getProjectedBoundingBox(e,s,i,a,n){const r=this.getBoundingBoxObjectSpace(n),g=y,d=o(r)?1:g.length;for(let o=0;o<d;o++){const e=g[o];f[0]=r[e[0]],f[1]=r[e[1]],f[2]=r[e[2]],t(f,f,this.stageObject.transformation),_[3*o]=f[0],_[3*o+1]=f[1],_[3*o+2]=f[2]}if(!e(_,0,d))return null;c(r);let u=null;this.calculateRelativeScreenBounds&&(u=this.calculateRelativeScreenBounds());for(let t=0;t<3*d;t+=3){for(let e=0;e<3;e++)r[e]=Math.min(r[e],_[t+e]),r[e+3]=Math.max(r[e+3],_[t+e]);u&&i.push({location:_.slice(t,t+3),screenSpaceBoundingRect:u})}if(s&&s.service&&"absolute-height"!==this.elevationContext.mode){l(r,S);const e="relative-to-scene"===this.elevationContext.mode?"scene":"ground";let t=0;if(s.useViewElevation)t=s.service.getElevation(S[0],S[1],e)??0;else try{const i=b(r,s.service.spatialReference,s);t=await s.service.queryElevation(S[0],S[1],a,i,e)??0}catch(O){}h(r,0,0,-this.alignedSampledElevation+t)}return r}addObjectState(e,t){e===O.Highlight&&t.addObject(this.stageObject,this.stageObject.highlight()),e===O.MaskOccludee&&t.addObject(this.stageObject,this.stageObject.maskOccludee())}removeObjectState(e){e.removeObject(this.stageObject)}resetEdgeObject(e){if(null==this._edgeState)return;const t=this._stageLayer.stage.renderer.ensureEdgeView();this._visible?this._addOrUpdateEdgeObject(t,e):t.removeObject(this.stageObject)}_addOrUpdateEdgeObject(e,t){const s=this._edgeState;if(null==s)return;const i=v(s.baseMaterial);for(const a of s.edgeMaterials)a.objectTransparency=i;e.addOrUpdateObject3D(this.stageObject,s.edgeMaterials,s.properties,!t).then((()=>this._stageLayer?.sync()))}}function v(e){return e.isVisible()?e.parameters.transparent?j.TRANSPARENT:j.OPAQUE:j.INVISIBLE}const _=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],f=i(),S=i(),y=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];export{p as Graphics3DObject3DGraphicLayer,m as Object3DEdgeState};
