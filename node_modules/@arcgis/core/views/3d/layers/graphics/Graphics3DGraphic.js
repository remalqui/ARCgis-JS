/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{EmptyArray as e}from"../../../../core/arrayUtils.js";import{forEach as t}from"../../../../core/asyncUtils.js";import{estimateAttributesObjectSize as i}from"../../../../core/byteSizeEstimations.js";import r from"../../../../core/ObjectPool.js";import{a as s}from"../../../../chunks/vec2.js";import{a}from"../../../../chunks/vec2f64.js";import{g as o}from"../../../../chunks/vec3.js";import{c as n}from"../../../../chunks/vec3f64.js";import l from"../../../../geometry/Polygon.js";import{projectBoundingRect as h}from"../../../../geometry/projection.js";import{set as c,ZERO as y,empty as p,expandWithAABB as u,allFinite as m,toRect as d}from"../../../../geometry/support/aaBoundingBox.js";import{create as b,allFinite as f}from"../../../../geometry/support/aaBoundingRect.js";import{equals as g}from"../../../../geometry/support/spatialReferenceUtils.js";import{computeAABR as L,numVertices as _}from"../../../../layers/graphics/dehydratedFeatures.js";import{convertFromGeometry as E}from"../../../../layers/graphics/featureConversionUtils.js";import{VisibilityFlag as G,VisibilityGroup as j}from"./enums.js";import{createFeature as v}from"./featureExpressionInfoUtils.js";const x=new r(Array,(e=>c(e,y)),null,10,5),A=b();class S{get labelLayers(){return this._labelLayers||e}get extent(){return this._extent}get isElevationSource(){return this.layers.some((e=>e?.isElevationSource))}constructor(e,t,i,r,s){this.graphic=e,this.graphics3DSymbol=t,this.layers=i,this._visibleFlags=G.ALL_LABEL,this.deconflictionPriority=0,++t.referenced,this._featureExpressionFeature=s?v(s,e,r):null}initialize(e){this._layer=e,this._forEachSymbolLayerGraphic((t=>{t.initialize(e),t.setVisibility(this.isVisible())}))}destroy(){this._forEachSymbolLayerGraphic((e=>e.destroy())),this._calloutLayer=null,--this.graphics3DSymbol.referenced,this.graphics3DSymbol=null}get destroyed(){return null==this.layers}clearLabelGraphics(){this._forEachLabelGraphic((e=>e.destroy())),this._labelLayers=null}addLabelGraphic(e,t){this._labelLayers||(this._labelLayers=new Array),this._labelLayers.push(e),e.initialize(t),e.setVisibility(this.isVisible(j.LABEL))}setCalloutGraphic(e){this._calloutLayer=e,this._layer&&(e.initialize(this._layer),e.setVisibility(this.isVisible()))}get calloutLayer(){return this._calloutLayer}get isDraped(){let e=!1;return this._forEachSymbolLayerGraphic((t=>{"draped"===t.type&&(e=!0)})),e}isVisible(e=j.GRAPHIC,t){const i=t?this._visibleFlags|t|j.LABEL*t:this._visibleFlags;return e===j.GRAPHIC?(i&G.ALL_GRAPHIC)===G.ALL_GRAPHIC:(i&G.ALL_LABEL)===G.ALL_LABEL}setVisibilityFlag(e,t,i){const r=this.isVisible(e);i?this._visibleFlags|=e*t:this._visibleFlags&=~(e*t);const s=this.isVisible(e);if(r===s)return!1;if(e===j.LABEL)this._forEachLabelGraphic((e=>e.setVisibility(s)));else{this._forEachSymbolLayerGraphic((e=>e.setVisibility(s)));const e=this.isVisible(j.LABEL);this._forEachLabelGraphic((t=>t.setVisibility(e)))}return!0}getVisibilityFlag(e,t){return 0!=(this._visibleFlags&e*t)}computeExtent(e){if(!this._extent){const t=this.graphic.geometry;if(null==t)return!1;this._extent=b(),L(t,this._extent);const i=t.spatialReference;if(!g(i,e)&&!h(this._extent,i,this._extent,e))return this._extent=null,!1}return!0}getAsOptimizedGeometry(e,t){return this._optimizedGeometry||(this._optimizedGeometry=this._convertGraphicToOptimizedGeometry(this.graphic,e,t)),this._optimizedGeometry}_convertGraphicToOptimizedGeometry(e,t,i){let r=e.geometry;return"mesh"!==r.type&&"extent"!==r.type||(r=l.fromExtent("mesh"===r.type?r.extent:r)),E(r,t,i)}get usedMemory(){let e=i(this.graphic.attributes);return this._forEachSymbolLayerGraphic((t=>{const i=t.graphics3DSymbolLayer.complexity;if(null==i)return;const r="draped"===t.type?i.memory.draped:i.memory;e+=r.bytesPerFeature,r.bytesPerCoordinate&&(e+=_(this.graphic.geometry)*r.bytesPerCoordinate)})),e}computeAttachmentOrigin(){const e={render:{origin:n(),num:0},draped:{origin:a(),num:0}};for(const t of this.layers)null!=t&&t.computeAttachmentOrigin(e);return e.render.num>1&&o(e.render.origin,e.render.origin,1/e.render.num),e.draped.num>1&&s(e.draped.origin,e.draped.origin,1/e.draped.num),e}async getProjectedBoundingBox(e,i,r,s,a){return a||(a={boundingBox:null,requiresDrapedElevation:!1,screenSpaceObjects:[]}),a.boundingBox?p(a.boundingBox):a.boundingBox=p(),a.requiresDrapedElevation=!1,await t(this.layers,(async t=>{if(null==t)return;const o="draped"===t.type?i:e,n=x.acquire(),l=await t.getProjectedBoundingBox(o,r,a.screenSpaceObjects,s,n);isFinite(l[2])&&isFinite(l[5])||(a.requiresDrapedElevation=!0),l&&u(a.boundingBox,n),x.release(n)})),m(a.boundingBox)||f(d(a.boundingBox,A))?a:null}needsElevationUpdates(){for(const e of this.layers)if(null!=e&&("object3d"===e.type||"lod-instance"===e.type)&&e.needsElevationUpdates)return!0;return this._labelLayers?.some((e=>e?.needsElevationUpdates??!1))??!1}alignWithElevation(e,t,i){this._forEachRenderedGraphic((r=>{"object3d"!==r.type&&"lod-instance"!==r.type||r.alignWithElevation(e,t,this._featureExpressionFeature,i)}))}alignWithAbsoluteElevation(e,t,i){this._forEachRenderedGraphic((r=>{"object3d"===r.type&&r.alignWithAbsoluteElevation(e,t,i)}))}addObjectStateSet(e,t){this._forEachSymbolLayerGraphic((i=>i.addObjectState(e,t)))}removeObjectState(e){this._forEachSymbolLayerGraphic((t=>t.removeObjectState(e)))}_forEachGraphicList(e,t){e?.forEach((e=>e&&t(e)))}_forEachSymbolLayerGraphic(e){this._forEachGraphicList(this.layers,e),this._calloutLayer&&e(this._calloutLayer)}_forEachLabelGraphic(e){this._forEachGraphicList(this._labelLayers,e)}_forEachRenderedGraphic(e){this._forEachSymbolLayerGraphic(e),this._forEachLabelGraphic(e)}get test(){const e=this;return{addLabelLayer:t=>{e._labelLayers||(e._labelLayers=new Array),e._labelLayers.push(t)}}}}export{S as default};
