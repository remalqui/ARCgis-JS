/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import"../../../../geometry.js";import{remove as e}from"../../../../core/arrayUtils.js";import{createResolver as t,onAbort as r,createAbortError as s}from"../../../../core/promiseUtils.js";import{TaskPriority as i,noBudget as n}from"../../../support/Scheduler.js";import o from"../../../../geometry/Multipoint.js";class a{constructor(e,t){this.spatialReference=e,this._view=t}getElevation(e,t,r){return this._view.elevationProvider.getElevation(e,t,0,this.spatialReference,r)}async queryElevation(e,t,r,s,i){return this._view.elevationProvider.queryElevation(e,t,0,this.spatialReference,i,r,s)}}class l{constructor(e,t,r,s){this.spatialReference=t,this._getElevationQueryProvider=r,this._queries=new Array,this._queryOptions={...s,ignoreInvisibleLayers:!0},this._frameTask=e.registerTask(i.ELEVATION_QUERY,this)}destroy(){this._frameTask.remove()}queryElevation(i,n,o,a=0){const l=t(),u={x:i,y:n,minDemResolution:a,result:l,signal:o};return this._queries.push(u),r(o,(()=>{e(this._queries,u),l.reject(s())})),l.promise}get running(){return this._queries.length>0}runTask(e){const t=this._queries;this._queries=[];const i=this._getElevationQueryProvider();if(!i)return t.forEach((e=>e.result.reject())),void e.madeProgress();const n=t.map((e=>[e.x,e.y])),a=t.reduce(((e,t)=>Math.min(e,t.minDemResolution)),1/0),l=new o({points:n,spatialReference:this.spatialReference}),u=t.length>1&&t.some((e=>!!e.signal))?new AbortController:null,h=null!=u?u.signal:t[0].signal;if(null!=u){let e=0;t.forEach((i=>r(i.signal,(()=>{e++,i.result.reject(s()),e===t.length&&u.abort()}))))}const c={...this._queryOptions,minDemResolution:a,signal:h};i.queryElevation(l,c).then((e=>{t.forEach(((t,r)=>{null!=t.signal&&t.signal.aborted?t.result.reject(s()):t.result.resolve(e.geometry.points[r][2])}))})).catch((e=>{t.forEach((t=>t.result.reject(e)))})),e.madeProgress()}get test(){const e=this;return{update:()=>e._queries.length>0&&e.runTask(n)}}}export{l as ElevationQuery,a as ViewElevationProvider};
