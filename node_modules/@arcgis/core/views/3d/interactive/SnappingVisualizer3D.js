/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import e from"../../../Color.js";import{getAccentColor as n}from"../../../core/analysisThemeUtils.js";import"../../../core/has.js";import{destroyHandle as i}from"../../../core/handleUtils.js";import{h as t}from"../../../chunks/vec3.js";import{c as r}from"../../../chunks/vec3f64.js";import{projectVectorToVector as o}from"../../../geometry/projection.js";import{onTheGroundElevationInfo as l,absoluteHeightElevationInfo as a}from"../../../support/elevationInfoUtils.js";import{ExtendedLineVisualElement as s,ExtensionType as p}from"./visualElements/ExtendedLineVisualElement.js";import{ParallelLineVisualElement as c}from"./visualElements/ParallelLineVisualElement.js";import{PointVisualElement as d}from"./visualElements/PointVisualElement.js";import{RightAngleQuadVisualElement as u}from"./visualElements/RightAngleQuadVisualElement.js";import{DrapedRenderGroup as m}from"../layers/interfaces.js";import{RenderOccludedFlag as g}from"../webgl-engine/lib/Material.js";import{defaults as f}from"../../interactive/snapping/Settings.js";import{SnappingDomain as v}from"../../interactive/snapping/SnappingDomain.js";import{snappingPointToDehydratedPoint as h,createSnappingPoint as E}from"../../interactive/snapping/SnappingPoint.js";import{LineSegmentHintType as S}from"../../interactive/snapping/snappingUtils.js";import{SnappingVisualizer as C}from"../../interactive/snapping/SnappingVisualizer.js";import{LineSnappingHint as j}from"../../interactive/snapping/hints/LineSnappingHint.js";import{vectorToRender as w}from"../../interactive/support/viewUtils.js";class O extends C{sortUniqueHints(e){return e.sort(((e,n)=>(n instanceof j?n.length:0)-(e instanceof j?e.length:0)))}visualizeIntersectionPoint(e,n){const{spatialReference:t,view:r}=n,o=R();return i(new d({view:r,primitive:"circle",geometry:h(e.intersectionPoint,t),elevationInfo:e.isDraped?l:a,size:20,outlineSize:2,color:o.intersectionPointColor,outlineColor:o.intersectionPointOutlineColor,pixelSnappingEnabled:!1}))}visualizePoint(e,n){const{view:t,spatialReference:r}=n,o=R(),l=A(e.point,e.domain,n);return i(new d({view:t,primitive:"circle",geometry:h(l,r),elevationInfo:H(e,n),size:20,outlineSize:2,color:o.pointColor,outlineColor:o.pointOutlineColor,pixelSnappingEnabled:!1}))}visualizeLine(e,n){const{view:t,spatialReference:r}=n,o=R(),l=A(e.lineStart,e.domain,n),a=A(e.lineEnd,e.domain,n);return i(this._createLineSegmentHint(e.type,l,a,r,H(e,n),t,o,e.isDraped,e.fadeLeft,e.fadeRight))}visualizeParallelSign(e,n){const{view:r,spatialReference:o}=n,l=R(),{isDraped:a}=e,s=H(e,n),p=A(e.lineStart,e.domain,n),d=A(e.lineEnd,e.domain,n),u=z(p,o,s,r,a),v=z(d,o,s,r,a),h=t(v,u,v,.5),E=new c({view:r,attached:!1,offset:f.parallelLineHintOffset,length:f.parallelLineHintLength,width:f.parallelLineHintWidth,color:l.parallelSignColor,location:h,renderOccluded:a?g.OccludeAndTransparent:g.Opaque,isDraped:a,renderGroup:m.SnappingHint});return E.setDirectionFromPoints(u,h),E.attached=!0,i(E)}visualizeRightAngleQuad(e,n){const{view:t,spatialReference:r}=n,o=R(),l=H(e,n),{isDraped:a}=e,s=A(e.previousVertex,e.domain,n),p=A(e.centerVertex,e.domain,n),c=A(e.nextVertex,e.domain,n),d=z(s,r,l,t,a),v=z(p,r,l,t,a),h=z(c,r,l,t,a);return i(new u({view:t,attached:!0,color:a?o.rightAngleColorDraped:o.rightAngleColor,renderOccluded:a?g.OccludeAndTransparent:g.Transparent,outlineRenderOccluded:a?g.OccludeAndTransparent:g.Opaque,outlineColor:o.rightAngleOutlineColor,outlineSize:f.rightAngleHintOutlineSize,size:f.rightAngleHintSize,isDraped:a,geometry:{previous:d,center:v,next:h},renderGroup:m.SnappingHint}))}_createLineSegmentHint(e,n,i,t,r,o,l,a=!1,c=!0,d=!0){const u=z(n,t,r,o,a),v=z(i,t,r,o,a),h=new s({view:o,extensionType:p.FADED,start:u,end:v,isDraped:a,color:l.lineColor,renderOccluded:a?g.OccludeAndTransparent:g.Opaque,renderGroup:m.SnappingHint});switch(e){case S.TARGET:h.width=f.lineHintWidthTarget,h.fadedExtensions={start:0,end:f.lineHintFadedExtensions};break;case S.REFERENCE_EXTENSION:h.width=f.lineHintWidthReference,h.fadedExtensions={start:0,end:0};break;case S.REFERENCE:h.width=f.lineHintWidthReference,h.fadedExtensions={start:c?f.lineHintFadedExtensions:0,end:d?f.lineHintFadedExtensions:0}}return h.attached=!0,h}}function R(i){const t=e.toUnitRGBA(n()),r=[0,0,0,0];return{intersectionPointColor:r,intersectionPointOutlineColor:t,pointColor:r,pointOutlineColor:t,lineColor:t,lineOutlineColor:void 0,parallelSignColor:t,rightAngleColor:t,rightAngleColorDraped:e.toUnitRGBA(n(.5)),rightAngleOutlineColor:t}}function A(e,n,i){const t=x(n,i);return null==t?e:E(e[0],e[1],t)}function H(e,n){return null!=x(e.domain,n)?n.selfSnappingZ.elevationInfo:e.isDraped?l:a}function x(e,{selfSnappingZ:n}){return e===v.SELF&&null!=n?n.value:null}function z(e,n,i,t,l,a=r()){if(l){const i=t.basemapTerrain.overlayManager.renderer.spatialReference;o(e,n,a,i)}else w(e,n,i,t,a);return a}export{O as SnappingVisualizer3D};
