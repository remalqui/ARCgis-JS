/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{handlesGroup as e,destroyHandle as t,refHandle as n}from"../../../../core/handleUtils.js";import{deg2rad as a}from"../../../../core/mathUtils.js";import{watch as i}from"../../../../core/reactiveUtils.js";import{s as r,a as o,g as l}from"../../../../chunks/vec3.js";import{c as s}from"../../../../chunks/vec3f64.js";import{getGraphicEffectiveElevationInfo as p}from"../../../../support/elevationInfoUtils.js";import{Manipulator3D as c}from"../Manipulator3D.js";import{GrabbingState as m}from"./GrabbingState.js";import{ManipulatorState as h}from"./ManipulatorState.js";import{ManipulatorType as d}from"./ManipulatorType.js";import{getSettings as u}from"./settings.js";import{ExtendedLineVisualElement as g}from"../visualElements/ExtendedLineVisualElement.js";import{LaserlineVisualElement as f}from"../visualElements/LaserlineVisualElement.js";import{OutlineVisualElement as y}from"../visualElements/OutlineVisualElement.js";import{GraphicState as v}from"../../layers/graphics/GraphicState.js";import{RenderOccludedFlag as E}from"../../webgl-engine/lib/Material.js";function w(t){const{view:n,graphic:a}=t,i=new v({graphic:a}),r=b(t,i),o=[r,j(t,r.visualElement,i),n.maskOccludee(a),n.trackGraphicState(i)];return{visualElement:r.visualElement,remove:()=>e(o).remove()}}function b(n,a){const{view:r,graphic:o}=n,l=new y({view:r,geometry:G(o)?o.geometry:null,elevationInfo:p(o),attached:!1}),s=u(r).visualElements.lineGraphics;s.shadowStyle.apply(l);const c=()=>{l.attached=a.displaying};s.outline.apply(l);const m=[i((()=>a.displaying),c),i((()=>a.isDraped),(e=>{l.isDraped=e})),a.on("changed",(()=>l.geometry=G(o)?o.geometry:null)),t(l)];return c(),{visualElement:l,remove:()=>e(m).remove()}}function j(r,o,l){const{graphic:s,view:c}=r,d=[],y=p(s),v="on-the-ground"===y.mode||!y.offset&&"absolute-height"!==y.mode,w=new h,b=u(c).visualElements,j=new g({view:c,extensionType:b.zVerticalLine.extensionType,innerWidth:1,attached:!1,writeDepthEnabled:!1,renderOccluded:E.OccludeAndTransparent});b.pointGraphics.shadowStyle.apply(j);const L=a(b.heightPlaneAngleCutoff),T=new f({view:c,attached:!1,angleCutoff:L});b.heightPlane.apply(T);let A=1,D=1;const C=()=>{if(w.update(r),!l.displaying||v&&(l.isDraped||!G(s)||!s.geometry.hasZ))return o.laserlineEnabled=!1,j.attached=!1,void(T.attached=!1);o.laserlineEnabled=!0;const e=w.grabbingState&m.XY?b.laserlineAlphaMultiplier:1;e!==A&&(A=e,b.lineGraphics.shadowStyle.apply(o,e),b.pointGraphics.shadowStyle.apply(j,e));const t=w.grabbingState&m.Z?b.laserlineAlphaMultiplier:1;t!==D&&(D=t,b.heightPlane.apply(T,t)),S(j,w),M(r,o,T,w)};b.zVerticalLine.apply(j),d.push(l.on("changed",C),i((()=>l.displaying),C),o.events.on("attachment-origin-changed",C),t(j),t(T));const O=[],V=()=>{e(O).remove(),O.length=0,r.forEachManipulator((e=>O.push(e.events.on("grab-changed",C)))),r.forEachManipulator((e=>O.push(e.events.on("select-changed",C)))),C()};return V(),d.push(r.onManipulatorsChanged(V),n((()=>e(O)))),e(d)}function S(e,t){const n=1===t.numSelected?t.firstSelected:t.numSelected>1&&null!=t.firstGrabbedXY?t.firstGrabbedXY:null;null!=n?(e.setStartEndFromWorldDownAtLocation(n.renderLocation),e.attached=!0):e.attached=!1}function M(e,t,n,a){if(a.numSelected>0){r(L,0,0,0);let t=0;e.forEachManipulator(((e,n)=>{n===d.TRANSLATE_XY&&e.selected&&e instanceof c&&(o(L,L,e.renderLocation),t++)})),t>0?(n.heightManifoldTarget=l(L,L,1/t),n.attached=!0):n.attached=!1}else{const a=t.attachmentOrigin;null!=a&&e.view.renderCoordsHelper.toRenderCoords(a,L)?(n.heightManifoldTarget=L,n.attached=!0):n.attached=!1}}function G(e){return null!=e.geometry&&("polygon"===e.geometry.type||"polyline"===e.geometry.type)}const L=s();export{w as createVisualElements};
