/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{cyclicalPI as t}from"../../../../../core/Cyclical.js";import e from"../../../../../core/Evented.js";import a from"../../../../../core/Handles.js";import{clamp as i,rad2deg as o}from"../../../../../core/mathUtils.js";import{destroyMaybe as s}from"../../../../../core/maybe.js";import{createAngle as n,createLength as r}from"../../../../../core/quantityUtils.js";import{when as l,initial as c,watch as h}from"../../../../../core/reactiveUtils.js";import{addFrameTask as p}from"../../../../../core/scheduling.js";import{createScreenPointArray as d}from"../../../../../core/screenUtils.js";import{d as u,E as g,m,k as _,e as f}from"../../../../../chunks/mat4.js";import{c as D}from"../../../../../chunks/mat4f64.js";import{s as S,b as M,l as v,d as y,f as w,a as b}from"../../../../../chunks/vec3.js";import{a as T,f as R}from"../../../../../chunks/vec3f64.js";import{fromPositionAndNormal as j,create as O,normal as I}from"../../../../../geometry/support/plane.js";import{wrap as k,distance2 as A}from"../../../../../geometry/support/ray.js";import{sv3d as F,sm4d as P}from"../../../../../geometry/support/vectorStacks.js";import{getGraphicEffectiveElevationInfo as C}from"../../../../../support/elevationInfoUtils.js";import{Manipulator3D as E}from"../../Manipulator3D.js";import{calculateInputRotationTransform as U}from"../../manipulatorUtils.js";import{RenderObject as L}from"../../RenderObject.js";import{screenToRenderPlane as z}from"../dragEventPipeline3D.js";import{ManipulatorType as x}from"../ManipulatorType.js";import{getSettings as N}from"../settings.js";import{RING_INDICATOR_DELAY_MS as H,ROTATE_INDICATOR_DIRECTION_BUFFER as V,SCALE_INDICATOR_DIRECTION_BUFFER as q,ROTATE_INDICATOR_ARROW_PLACEMENT_PERCENTAGE as B,RING_THICKNESS as G,DRAG_THRESHOLD_PX as J,RING_RADIUS as K,INNER_INDICATOR_RADIUS as Q,OUTER_INDICATOR_RADIUS as W,RING_HEIGHT as X,ROTATE_INDICATOR_ARROW_TIP_RADIUS as Y,ROTATE_INDICATOR_ARROW_TIP_LENGTH as Z,SCALE_INDICATOR_OFFSET1 as $,SCALE_INDICATOR_OFFSET2 as tt,INDICATOR_THICKNESS as et,GEOMETRY_SEGMENTS as at,ROTATE_INDICATOR_ARC_LENGTH as it,RING_RESET_ANIMATION_SPEED_FACTOR as ot,SCALE_INDICATOR_ARC_LENGTH as st}from"../manipulations/config.js";import{CullFaceOptions as nt}from"../../../webgl-engine/lib/basicInterfaces.js";import{createExtrudedTriangle as rt,transformInPlace as lt,createPathExtrusionGeometry as ct}from"../../../webgl-engine/lib/GeometryUtil.js";import{RenderOccludedFlag as ht}from"../../../webgl-engine/lib/Material.js";import{ColorMaterial as pt}from"../../../webgl-engine/materials/ColorMaterial.js";import{createManipulatorDragEventPipeline as dt}from"../../../../interactive/dragEventPipeline.js";import{ManipulatorStateCustomFlags as ut,ManipulatorStateFlags as gt}from"../../../../interactive/interfaces.js";import{Tooltip as mt}from"../../../../interactive/tooltip/Tooltip.js";import{TransformRotateTooltipInfo as _t,TransformScaleTooltipInfo as ft,TransformAbsoluteTooltipInfo as Dt}from"../../../../interactive/tooltip/TransformTooltipInfos.js";import{unitRGBAFromColor as St}from"../../../../support/colorUtils.js";var Mt,vt;!function(t){t.ScaleIn=ut.Custom2,t.ScaleOut=ut.Custom3,t.RotateLeft=ut.Custom4,t.RotateRight=ut.Custom5,t.Unlocked=ut.Custom7,t.DelayedFocused=ut.Custom8,t.TouchInput=ut.Custom12}(Mt||(Mt={}));class yt{get angle(){return this._adapter.angle}get scale(){return this._adapter.scale}set location(t){this._ringManipulator.location=t}set elevationAlignedLocation(t){this._ringManipulator.elevationAlignedLocation=t}get grabbing(){return this._ringManipulator.grabbing}set interactive(t){this._ringManipulator.interactive=t}constructor({adapter:t,tooltipOptions:i,mode:o,tool:s}){this._mode=null,this._handles=new a,this._scaleRotateDragData=null,this._activeAnimation=null,this._ringIndicatorDelayMs=H,this.events=new e,this.getFocused=()=>this._ringManipulator.focused,this.getScale=()=>"scale"===this._scaleRotateDragData?.mode?this._adapter.scale:1,this.tool=s,this._mode=o,this._adapter=t,this._tooltipOptions=i,this._tooltip=new mt({view:s.view}),this._createManipulator(),this._updateDragState(),this._updateManipulatorTransform(),this._handles.add(l((()=>!this._tooltipOptions.enabled),(()=>this._tooltip.clear()),c))}destroy(){this._activeAnimation?.frameTask.remove(),this._activeAnimation=null,this._handles=s(this._handles),this.tool.manipulators.remove(this._ringManipulator),this._ringManipulator=null,this._tooltip=s(this._tooltip)}startAnimation(t){this.cancelActiveAnimation(),t.start();const e=p({update:({deltaTime:e})=>{t.update(e)&&this.cancelActiveAnimation()}});this._activeAnimation={...t,frameTask:e}}cancelActiveAnimation(){this._activeAnimation?.frameTask.remove(),this._activeAnimation=s(this._activeAnimation)}forEachManipulator(t){t(this._ringManipulator,x.SCALE_ROTATE)}_createManipulator(){const e=this._createRingManipulator();this._ringManipulator=e,this.tool.manipulators.add(e);const a=this.tool.graphicState.graphic,s=dt(e,((e,s,n)=>{this._scaleRotateDragData=null;const r=this._adapter.startInteraction(),l={mode:"none",origin:T(e.renderLocation),initialAngle:this._adapter.angle,angle:0,angleDir:0,scaleDir:0};this._scaleRotateDragData=l,this._updateDragState();const c=F.get();this.tool.view.renderCoordsHelper.worldUpAtPosition(e.renderLocation,c),s.next(z(this.tool.view,j(e.renderLocation,c,O()))).next((e=>{const s=I(e.plane),n=U(e.renderStart,e.renderEnd,l.origin,s),c=t.shortestSignedDiff(l.angle,n);l.angleDir=i(l.angleDir+c,-V,V),l.angle=n;const h=wt(l,e),p=h-this._adapter.scale;if(l.scaleDir=i(l.scaleDir+p,-q,q),this._onScaleChanged(),"none"===l.mode){const t=this._mode||bt(e,e.plane,l.origin,this.tool.view.state.camera);if(null!=t){switch(t){case"rotate":this.tool.emit("graphic-rotate-start",{graphic:a,angle:0}),this.tool.emit("record-undo",{record:this._adapter.createUndoRecord()});break;case"scale":this.tool.emit("graphic-scale-start",{graphic:a,xScale:1,yScale:1}),this.tool.emit("record-undo",{record:this._adapter.createUndoRecord()})}l.mode=t}}switch(l.mode){case"rotate":r.state.angle=l.initialAngle+n;break;case"scale":r.state.scale=h,this._onScaleChanged()}switch(this._updateDragState(),this._updateManipulatorTransform(),e.action){case"start":case"update":switch(l.mode){case"rotate":this.tool.emit("graphic-rotate",{graphic:a,angle:o(l.angle)});break;case"scale":this.tool.emit("graphic-scale",{graphic:a,xScale:h,yScale:h})}break;case"end":switch(l.mode){case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:a,angle:o(l.angle)});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:a,xScale:h,yScale:h})}}return"end"===e.action&&(this.startAnimation(Rt(this,(()=>this._onScaleChanged()))),this._scaleRotateDragData=null,this._updateDragState(),r.done()),e})).next(this._updateTooltipPipelineStep(l)),n.next((()=>{if(r.cancel(),null!=this._scaleRotateDragData){switch(this._scaleRotateDragData.mode){case"none":break;case"rotate":this.tool.emit("graphic-rotate-stop",{graphic:a,angle:0});break;case"scale":this.tool.emit("graphic-scale-stop",{graphic:a,xScale:1,yScale:1})}this.startAnimation(Rt(this,(()=>this._onScaleChanged()))),this._scaleRotateDragData=null,this._updateDragState()}this._updateFocusTooltip()}))}));this._handles.add([s,e.events.on("focus-changed",(t=>{"focus"===t.action?this.startAnimation(jt(this,(()=>this._updateDelayedFocusedState()),{delayMs:this._ringIndicatorDelayMs})):this._updateDelayedFocusedState()})),e.events.on("immediate-click",(t=>{t.stopPropagation()})),h((()=>this.tool.graphicState?.displaying),(t=>this._ringManipulator.available=t),c)])}_updateTooltipPipelineStep(t){return e=>{const a=this._tooltipOptions;if(!a.enabled)return e;if("end"===e.action)return this._updateFocusTooltip(),e;const i=this._tooltip,o=this._tooltipOptions.visualVariables;switch(t.mode){case"scale":{const{size:t,scale:e}=this._adapter,s=o?.size;i.info=new ft({tooltipOptions:a,scale:{value:e},size:null!=t?r(t,"meters"):void 0,sizePrecision:Ot(s?.valueType),sizeUnit:s?.unit});break}case"rotate":{const{orientationClockwise:t,relativeAngleClockwise:e}=this._adapter,s=o?.rotation,r=Ot(s?.valueType);i.info=new _t({tooltipOptions:a,rotation:null!=e?n(e,"radians","geographic"):void 0,rotationPrecision:r,rotationType:s?.rotationType??"geographic",orientation:null!=t?n(t,"radians","geographic"):void 0,orientationPrecision:r})}}return e}}_updateFocusTooltip(){if(!this._tooltipOptions.enabled)return;if(this.getFocused()){const t=this._tooltipOptions.visualVariables,e=t?.rotation,a=t?.size,i=this._mode,{size:o,orientationClockwise:s}=this._adapter,l=null!=s&&(null==i||"rotate"===i),c=null!=o&&(null==i||"scale"===i);this._tooltip.info=new Dt({tooltipOptions:this._tooltipOptions,orientation:l?n(s,"radians","geographic"):void 0,orientationPrecision:Ot(e?.valueType),rotationType:e?.rotationType??"geographic",size:c?r(o,"meters"):void 0,sizeUnit:a?.unit,sizePrecision:Ot(a?.valueType)})}else this._tooltip.clear()}_onScaleChanged(){this.events.emit("scale-changed"),this._updateManipulatorTransform()}_updateDelayedFocusedState(){this._ringManipulator.updateStateEnabled(Mt.DelayedFocused,this.getFocused()),this._updateFocusTooltip()}_updateDragState(){if(this._ringManipulator.updateStateEnabled(Mt.Unlocked,!(null!=this._scaleRotateDragData&&"none"!==this._scaleRotateDragData?.mode)),null!=this._scaleRotateDragData)switch(this._scaleRotateDragData.mode){case"rotate":this._ringManipulator.updateStateEnabled(Mt.ScaleIn|Mt.ScaleOut,!1),this._ringManipulator.updateStateEnabled(Mt.RotateLeft,this._scaleRotateDragData.angleDir<0),this._ringManipulator.updateStateEnabled(Mt.RotateRight,this._scaleRotateDragData.angleDir>=0);break;case"scale":this._ringManipulator.updateStateEnabled(Mt.RotateLeft|Mt.RotateRight,!1),this._ringManipulator.updateStateEnabled(Mt.ScaleIn,this._scaleRotateDragData.scaleDir<0),this._ringManipulator.updateStateEnabled(Mt.ScaleOut,this._scaleRotateDragData.scaleDir>=0)}else this._ringManipulator.updateStateEnabled(Mt.ScaleIn|Mt.ScaleOut|Mt.RotateLeft|Mt.RotateRight,!1)}_updateManipulatorTransform(){const t=u(P.get(),this._adapter.angle,R(0,0,1));if(null==t)return;const e=this.getScale(),a=g(P.get(),S(F.get(),e,e,e));this._ringManipulator.modelTransform=m(P.get(),a,t)}_createRingManipulator(){const t=(t,e,a)=>{const i=[],o=Math.ceil(at*(e-t)/(2*Math.PI));for(let s=0;s<o+1;s++){const n=t+s*(e-t)/o;i.push(R(a*Math.cos(n),a*Math.sin(n),0))}return i},e=e=>t(0,2*Math.PI,e),a=t=>[[-t/2,0],[t/2,0],[t/2,X/2],[-t/2,X/2]],i=this._createMaterial(1),o=(t,e,o=i)=>ct(o,a(e),t,[],[],!1),s=e(K),n=o(s,G),r={left:new Array,right:new Array},l=[];for(let R=0;R<2;R++){const e=R*Math.PI-Math.PI/4,a=Math.PI/2-it,s=e+a,n=e+Math.PI/2-a,c=t(s,n,Q),h=o(c,et);l.push(c),l.push(t(s,n,W-G/2)),r.left.push(h),r.right.push(h.instantiate());for(let t=0;t<2;t++){const e=0===t,a=D();if(e){_(a,a,[1,-1,1]),f(a,a,-s,[0,0,1]);const t=Math.round(B*(c.length-1));a[12]=c[t][0],a[13]=c[t][1],a[14]=c[t][2]}else{f(a,a,n,[0,0,1]);const t=Math.round((1-B)*(c.length-1));a[12]=c[t][0],a[13]=c[t][1],a[14]=c[t][2]}const o=rt(i,Z,0,Y,X);lt(o,a),(e?r.left:r.right).push(o)}}const c=[];for(let _=0;_<2;_++){const e=_*Math.PI-Math.PI/4,a=Math.PI/2-st,i=e+a,s=e+Math.PI/2-a,n=t(i,s,W);c.push(o(n,et))}const h=this._createMaterial(.66),p=this._createMaterial(.5),d=this._createMaterial(.33),u=e(K+$),g=e(K+tt),m=o(u,et,h),S=o(g,et,d),M=e(K-$),v=e(K-tt),y=o(M,et,h),w=o(v,et,d);let b=[new L(n,Mt.DelayedFocused),new L(n.instantiate({material:p}),gt.None)];this._mode&&"scale"!==this._mode||(b=b.concat([...c.map((t=>new L(t,Mt.DelayedFocused|Mt.Unlocked))),new L(m,Mt.DelayedFocused|Mt.ScaleIn),new L(S,Mt.DelayedFocused|Mt.ScaleIn),new L(y,Mt.DelayedFocused|Mt.ScaleOut),new L(w,Mt.DelayedFocused|Mt.ScaleOut)])),this._mode&&"rotate"!==this._mode||(b=b.concat([...r.right.map((t=>new L(t.instantiate(),Mt.DelayedFocused|Mt.Unlocked))),...r.left.map((t=>new L(t,Mt.DelayedFocused|Mt.RotateLeft))),...r.right.map((t=>new L(t,Mt.DelayedFocused|Mt.RotateRight)))]));const T=[s,...l];return new E({view:this.tool.view,renderObjects:b,autoScaleRenderObjects:!1,worldOriented:!0,radius:G,focusMultiplier:1,touchMultiplier:1.5,elevationInfo:C(this.tool.graphicState.graphic),collisionType:{type:"ribbon",paths:T,direction:R(0,0,1)}})}_createMaterial(t){const e=N(this.tool.view).colors.accent.clone();return e.a=t,new pt({color:St(e),transparent:1!==t,cullFace:nt.Back,renderOccluded:ht.Transparent})}get test(){return{ringManipulator:this._ringManipulator,setRingIndicatorDelayMs:t=>this._ringIndicatorDelayMs=t,tooltip:this._tooltip}}}function wt(t,e){const a=M(F.get(),e.renderStart,t.origin),i=M(F.get(),e.renderEnd,t.origin),o=v(a),s=v(i);return 0===o?0:s/o}function bt(t,e,a,i){const{renderStart:o,renderEnd:s}=t,n=Tt(o,i,F.get()),r=Tt(s,i,F.get());if(y(n,r)<J*J)return null;const l=M(F.get(),o,a),c=w(F.get(),l,I(e)),h=o,p=b(F.get(),h,c),d=Tt(a,i,F.get()),u=n,g=Tt(p,i,F.get()),m=M(F.get(),g,u),_=M(F.get(),n,d),f=k(u,m),D=k(d,_);return A(f,r)<A(D,r)?"rotate":"scale"}function Tt(t,e,a){return e.projectToScreen(t,It),S(a,It[0],It[1],0)}function Rt(t,e){let a=null,i=1;const o=()=>i;return{start:()=>{i=t.getScale(),a=t.getScale,t.getScale=o,e()},update:t=>(i+=((i+1)/2-i)*Math.min(t*ot,1),e(),Math.abs(i-1)<.01?vt.STOP:vt.CONTINUE),destroy:()=>{a&&(t.getScale=a),e()}}}function jt(t,e,a){let i=0,o=null;const s=()=>!1;return{start:()=>{o=t.getFocused,t.getFocused=s,i=0,e()},update:t=>(i+=t,!o?.()||i>=a.delayMs?vt.STOP:vt.CONTINUE),destroy:()=>{o&&(t.getFocused=o),e()}}}function Ot(t){switch(t){case"integer":case"long":return 0;default:return null}}!function(t){t[t.CONTINUE=0]="CONTINUE",t[t.STOP=1]="STOP"}(vt||(vt={}));const It=d();export{yt as GraphicScaleRotateTransform};
