/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{_ as t}from"../../../../../chunks/tslib.es6.js";import e from"../../../../../core/Accessor.js";import{HandleOwner as o}from"../../../../../core/HandleOwner.js";import{deg2rad as r,rad2deg as i}from"../../../../../core/mathUtils.js";import{when as n,sync as s}from"../../../../../core/reactiveUtils.js";import{property as a}from"../../../../../core/accessorSupport/decorators/property.js";import"../../../../../core/accessorSupport/ensureType.js";import"../../../../../core/arrayUtils.js";import"../../../../../core/has.js";import{subclass as l}from"../../../../../core/accessorSupport/decorators/subclass.js";import{g as c}from"../../../../../chunks/vec3.js";import{create as p,axis as g,angle as h,composeAxes as u,compose as m}from"../../../../../geometry/support/axisAngleDegrees.js";import d from"../../../../../geometry/support/MeshTransform.js";import{ViewingMode as y}from"../../../../ViewingMode.js";import{createGraphicGeometryUndoRecord as v}from"./undoRecords.js";let f=class extends o{constructor(t){super(t),this._interactionState=null}initialize(){this.addHandles([n((()=>{const t=this._interactionState;return t&&t.angle!==t.previousAngle?{interactionState:t,angle:t.state.angle}:null}),(({interactionState:t})=>{this._updateMeshRotation(t)}),s),n((()=>{const t=this._interactionState;return t&&t.scale!==t.previousScale?{interactionState:t,scale:t.state.scale}:null}),(({interactionState:t})=>{this._updateMeshSize(t)}),s)])}get initialAngle(){return this._interactionState?.initialAngle??0}get angle(){const t=this.geometry.transform;if(null==t)return this._interactionState?.angle??0;const e=g(t.rotation)[2];return Math.abs(e)>.999999?r(h(t.rotation))*Math.sign(e):0}get angleClockwise(){return-this.angle}get relativeAngle(){return this.angle-this.initialAngle}get relativeAngleClockwise(){return-this.relativeAngle}get scale(){return this._interactionState?.scale??1}startInteraction(){const t=new S({angle:this.angle});this._interactionState=t;const e=()=>{this._interactionState=null};return{state:t,done:e,cancel:()=>{t.cancel(),e()}}}createUndoRecord(){return v(this.graphic)}_updateMeshRotation(t){const{angle:e,previousAngle:o}=t;t.previousAngle=e;const{geometry:r}=this,{vertexSpace:n}=r,s=i(e-o);if(n.isGeoreferenced){const t=!n.isRelative&&this.viewingMode===y.Global,e=this.geometry.anchor;this.geometry.rotate(0,0,s,{origin:e,geographic:t}),this.graphic.notifyGeometryChanged()}else{r.transform??=new d;const{transform:t}=r,e=u(0,0,s,A);t.rotation=m(t.rotation,e,t.rotation),this.graphic.notifyMeshTransformChanged()}}_updateMeshSize(t){const{scale:e,previousScale:o}=t;t.previousScale=e;const{geometry:r}=this,{vertexSpace:i}=r,n=e/o;if(i.isGeoreferenced){const t=!i.isRelative&&this.viewingMode===y.Global,e=this.geometry.anchor;this.geometry.scale(n,{origin:e,geographic:t}),this.graphic.notifyGeometryChanged()}else{r.transform??=new d;const{transform:t}=r;t.scale=c(t.scale,t.scale,n),this.graphic.notifyMeshTransformChanged()}}};t([a({constructOnly:!0})],f.prototype,"graphic",void 0),t([a({constructOnly:!0})],f.prototype,"geometry",void 0),t([a({constructOnly:!0})],f.prototype,"viewingMode",void 0),t([a()],f.prototype,"initialAngle",null),t([a()],f.prototype,"angle",null),t([a()],f.prototype,"angleClockwise",null),t([a()],f.prototype,"relativeAngle",null),t([a()],f.prototype,"relativeAngleClockwise",null),t([a()],f.prototype,"scale",null),t([a()],f.prototype,"_interactionState",void 0),f=t([l("esri.views.3d.interactive.editingTools.transformGraphic.ScaleRotateMeshAdapter")],f);let S=class extends e{get state(){const{angle:t,scale:e}=this;return{angle:t,scale:e}}constructor(t){super(t),this.angle=0,this.initialAngle=0,this.previousAngle=0,this.previousScale=1,this.scale=1,this.initialAngle=t.angle,this.previousAngle=t.angle}cancel(){this.angle=this.initialAngle,this.scale=1}};t([a()],S.prototype,"angle",void 0),t([a()],S.prototype,"initialAngle",void 0),t([a()],S.prototype,"previousAngle",void 0),t([a()],S.prototype,"previousScale",void 0),t([a()],S.prototype,"scale",void 0),t([a()],S.prototype,"state",null),S=t([l("InteractionState")],S);const A=p();export{f as ScaleRotateMeshAdapter};
