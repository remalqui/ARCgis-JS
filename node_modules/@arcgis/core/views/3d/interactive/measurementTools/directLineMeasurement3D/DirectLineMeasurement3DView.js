/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{_ as i}from"../../../../../chunks/tslib.es6.js";import t from"../../../../../Color.js";import e from"../../../../../core/Accessor.js";import{getAccentColor as s,getContrastColor as n,getOpacity as a}from"../../../../../core/analysisThemeUtils.js";import o from"../../../../../core/Handles.js";import{destroyMaybe as r,applySome as l}from"../../../../../core/maybe.js";import{watch as h,initial as d}from"../../../../../core/reactiveUtils.js";import{property as p}from"../../../../../core/accessorSupport/decorators/property.js";import"../../../../../core/accessorSupport/ensureType.js";import"../../../../../core/arrayUtils.js";import"../../../../../core/has.js";import{subclass as c}from"../../../../../core/accessorSupport/decorators/subclass.js";import{c as u}from"../../../../../chunks/vec3f64.js";import{fromPoints as g}from"../../../../../geometry/support/lineSegment.js";import{MeasurementMode as _}from"../../../analysis/interfaces.js";import{ViewMode as m}from"../../../analysis/DirectLineMeasurement/interfaces.js";import{Manipulator3D as y}from"../../Manipulator3D.js";import{createSphereManipulator as v}from"../../manipulatorUtils.js";import{LaserlineVisualElement as b}from"../../visualElements/LaserlineVisualElement.js";var w;!function(i){i.Manipulators="manipulators",i.AnalysisViewDestroyed="analysis-view-destroyed",i.AnalysisView="analysis-view"}(w||(w={}));let P=class extends e{constructor(i){super(i),this._params={laserLineGlowColor:t.toUnitRGB(s(.75)),laserLineGlowWidth:8,laserLineGlowFalloff:8,laserLineInnerColor:t.toUnitRGB(n(.75)),laserLineInnerWidth:.75,laserLineGlobalAlpha:a(.75),handleColor:t.toUnitRGBA(s(.5)),handleRadius:5},this.cursorPoint=null,this._visible=!1,this._laserLine=null,this.laserLineEnabled=!0,this._handles=new o,this._lastDraggedHandle=null}initialize(){this._laserLine=new b({view:this.view,attached:!0}),this._updateVisibility(this._visible),this._connectToAnalysisView()}destroy(){this._handles=r(this._handles),this._laserLine=r(this._laserLine)}get visible(){return this._visible}set visible(i){i?this.show():this.hide()}get testData(){const i=this._laserLine.testData,t=this.analysisViewData.testData;return{labels:t?.labels,stripeLength:t?.stripeLength,laserLineRenderer:{heightManifoldEnabled:null!=i&&i.heightManifoldEnabled,heightManifoldTarget:null!=i?i.heightManifoldTarget:null,pointDistanceEnabled:null!=i&&i.pointDistanceEnabled,pointDistanceOrigin:null!=i?i.pointDistanceOrigin:null,pointDistanceTarget:null!=i?i.pointDistanceTarget:null,lineVerticalPlaneEnabled:null!=i&&i.lineVerticalPlaneEnabled}}}get _cursorPosition(){const i=u();return l(this.cursorPoint,(t=>this.view.renderCoordsHelper.toRenderCoords(t,i))),i}get _startPosition(){const i=u();return l(this.analysis.startPoint,(t=>this.view.renderCoordsHelper.toRenderCoords(t,i))),i}get _endPosition(){const i=u();return l(this.analysis.endPoint,(t=>this.view.renderCoordsHelper.toRenderCoords(t,i))),i}get _laserLineParams(){const i=this._focusPosition,{active:t,lineState:e}=this.toolState,s=this.analysisViewData,n=this.laserLineEnabled&&!!i&&"measured"!==e&&t;if(!n||!this.visible||null==s||s.destroyed)return{heightManifoldTarget:null,pointDistanceLine:null,lineVerticalPlaneSegment:null};const a=s.actualVisualizedMeasurement,o="local"!==this.view.viewingMode&&n&&!!this.analysis.startPoint&&"geodesic"===a,r=n&&s.viewMode===m.Triangle;return{heightManifoldTarget:"euclidean"===a?i:null,pointDistanceLine:o?this._pointDistanceLine:null,lineVerticalPlaneSegment:r?g(this._startPosition,this._endPosition):null}}get _focusPosition(){const{lineState:i}=this.toolState,t=this.analysisViewData,e=null!=t&&!t.destroyed&&t.measurementMode===_.Euclidean&&t.viewMode===m.Direct;switch(i){case"drawing":return e?this._startPosition:this.analysis.endPoint?this._endPosition:this._startPosition;case"editing":return e?"start"===this._lastDraggedHandle?this._endPosition:this._startPosition:"start"===this._lastDraggedHandle?this._startPosition:this._endPosition;default:return null!=this.cursorPoint?this._cursorPosition:null}}get _pointDistanceLine(){return{origin:"drawing"===this.toolState.lineState||"end"===this._lastDraggedHandle?this._startPosition:this._endPosition,target:this._focusPosition}}createManipulators(){const i=()=>{const i=v(this.view,this._params.handleColor);return i.available=!1,i.radius=this._params.handleRadius,i},t=i(),e=i(),s=new y({view:this.view});s.available=!1,s.interactive=!1,null!=this.analysis.startPoint&&(t.location=this.analysis.startPoint,t.available=!0),null!=this.analysis.endPoint&&(e.location=this.analysis.endPoint,e.available=!0);const n=()=>{let i=this._lastDraggedHandle;t.grabbing&&!e.grabbing&&(i="start"),e.grabbing&&!t.grabbing&&(i="end"),t.grabbing||e.grabbing||(i=null),this._lastDraggedHandle=i},a=t.events.on("grab-changed",n),o=e.events.on("grab-changed",n);return this._handles.add([a,o],w.Manipulators),{start:t,end:e,cursor:s}}show(){this.destroyed||this._visible||this._updateVisibility(!0)}hide(){!this.destroyed&&this._visible&&this._updateVisibility(!1)}_connectToAnalysisView(){this._handles.remove(w.AnalysisView),this._handles.add([h((()=>l(this.analysisViewData,(i=>i.destroyed))),(i=>{i&&this._handles.remove(w.AnalysisView)}),d),h((()=>["measured"===this.toolState.lineState,this.analysisViewData]),(([i,t])=>{null==t||t.destroyed||(t.allowVisualElementsOrientationChange=!i)}),d),h((()=>this._laserLineParams),(i=>{const t=this._laserLine;t.heightManifoldTarget=i.heightManifoldTarget,t.pointDistanceLine=i.pointDistanceLine,t.lineVerticalPlaneSegment=i.lineVerticalPlaneSegment}),d)],w.AnalysisView)}_updateVisibility(i){this.initialized&&(this._visible=i,i?this._laserLine.style={innerColor:this._params.laserLineInnerColor,innerWidth:this._params.laserLineInnerWidth,glowColor:this._params.laserLineGlowColor,glowWidth:this._params.laserLineGlowWidth,glowFalloff:this._params.laserLineGlowFalloff,globalAlpha:this._params.laserLineGlobalAlpha}:this.view.cursor=null,this._laserLine.visible=i)}};i([p({constructOnly:!0})],P.prototype,"view",void 0),i([p()],P.prototype,"_params",void 0),i([p({constructOnly:!0})],P.prototype,"analysis",void 0),i([p({constructOnly:!0})],P.prototype,"analysisViewData",void 0),i([p()],P.prototype,"cursorPoint",void 0),i([p()],P.prototype,"toolState",void 0),i([p()],P.prototype,"visible",null),i([p()],P.prototype,"testData",null),i([p()],P.prototype,"_visible",void 0),i([p()],P.prototype,"_laserLine",void 0),i([p({constructOnly:!0})],P.prototype,"laserLineEnabled",void 0),i([p()],P.prototype,"_cursorPosition",null),i([p()],P.prototype,"_startPosition",null),i([p()],P.prototype,"_endPosition",null),i([p()],P.prototype,"_lastDraggedHandle",void 0),i([p()],P.prototype,"_laserLineParams",null),i([p()],P.prototype,"_focusPosition",null),i([p()],P.prototype,"_pointDistanceLine",null),P=i([c("esri.views.3d.interactive.measurementTools.directLineMeasurement3D.DirectLineMeasurement3DView")],P);export{P as DirectLineMeasurement3DView};
