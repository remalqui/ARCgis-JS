/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import e from"../../../Graphic.js";import{NATIVE_ARRAY_MAX_SIZE as r}from"../../../core/typedArrayUtil.js";import{WorkerHandle as s}from"../../../core/workers/WorkerHandle.js";import t from"../../../geometry/SpatialReference.js";import o from"../../../layers/support/Field.js";class a{constructor(e){this._controller=e,this._handle=new i((r=>e.schedule(r)))}destroy(){this._handle.destroy()}invoke(r,s){return r.buffer&&0!==r.buffer.byteLength?(r.options.sourceSpatialReference&&r.options.sourceSpatialReference instanceof t&&(r.options={...r.options,sourceSpatialReference:r.options.sourceSpatialReference.toJSON()}),this._handle.invoke(r,s).then((r=>{let s=0,a=0;const i=async l=>{if(r.spatialReference=t.fromJSON(r.spatialReference),r.fields)for(;s<r.fields.length;)if(r.fields[s]=o.fromJSON(r.fields[s]),s++,l.madeProgress())return this._controller.reschedule((e=>i(e)));const c=r.spatialReference;for(;a<r.features.length;){const s=r.features[a];if(++a,s.uid=e.generateUID(),null!=s.geometry&&(s.geometry.spatialReference=c,n(s.geometry),l.madeProgress()))return this._controller.reschedule((e=>i(e)))}return r};return this._controller.schedule((e=>i(e)))}))):Promise.resolve(null)}}function n(e){switch(e.type){case"polyline":e.paths.reduce(((e,r)=>e+r.length),0)<r&&(e.paths=e.hasZ||e.hasM?e.paths.map((e=>e.map((e=>[e[0],e[1],e[2]])))):e.paths.map((e=>e.map((e=>[e[0],e[1]])))));break;case"polygon":e.rings.reduce(((e,r)=>e+r.length),0)<r&&(e.rings=e.hasZ||e.hasM?e.rings.map((e=>e.map((e=>[e[0],e[1],e[2]])))):e.rings.map((e=>e.map((e=>[e[0],e[1]])))))}}class i extends s{constructor(e){super("PBFDecoderWorker","_parseFeatureQuery",{_parseFeatureQuery:e=>[e.buffer]},e)}}export{a as PBFDecoder};
