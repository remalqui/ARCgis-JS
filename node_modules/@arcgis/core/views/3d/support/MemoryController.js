/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{_ as t}from"../../../chunks/tslib.es6.js";import e from"../../../core/Accessor.js";import i from"../../../core/Logger.js";import{MemCacheStorage as s,MemCache as a}from"../../../core/MemCache.js";import{property as r}from"../../../core/accessorSupport/decorators/property.js";import"../../../core/accessorSupport/ensureType.js";import"../../../core/arrayUtils.js";import"../../../core/has.js";import{subclass as o}from"../../../core/accessorSupport/decorators/subclass.js";import{isMemoryManagedView as h}from"./MemoryManagedView.js";function y(t){return new _({view:t})}const u=1,l=1,m=.75,n=.6,d=1.3;let _=class extends e{constructor(t){super(t),this._quality=1,this._usedMemory=0,this._updating=!1,this.minQuality=.1,this._stableQuality=0,this._downscaleMemoryUsed=0,this._canFastRecover=!1,this._memoryPredicted=0,this._cacheStorage=new s,this._warnMemoryUsage=null,this._numQualityChanges=0,this._maxMemory=750,this._additionalCacheMemory=0}destroy(){this._cacheStorage.destroy()}set maxMemory(t){null==t||t<=0||(this._stableQuality=0,this._canFastRecover=!1,this._maxMemory<t&&this._updateQuality(u),this._maxMemory=t)}get maxMemory(){return this._maxMemory}set additionalCacheMemory(t){null!=t&&(this._additionalCacheMemory=t)}get additionalCacheMemory(){return this._additionalCacheMemory}get memoryFactor(){return this._quality}get updating(){return this._updating}get usedMemory(){return this._usedMemory}newCache(t,e){return new a(t,this._cacheStorage,e)}resetStableQuality(){this._stableQuality=0}disableMemCache(){this.additionalCacheMemory=-4096}update(){if(this._updateMemory(),this._memoryPredicted<=0&&!this._updating)return;let t=this._layersUpdating();if(this._memoryPredicted<n&&this._canFastRecover)this._downscaleMemoryUsed=0,this._stableQuality=0,this._canFastRecover=!1,this._updateQuality(u);else if(t)(this._memoryPredicted>1.1*l||this._usedMemory>l)&&(this._stableQuality>0?(this._downscaleMemoryUsed=0,this._updateQuality(this._stableQuality)):this._quality>this.minQuality&&this._downscaleMemoryUsed<this._usedMemory&&(this._updateQuality(this._quality/d),this._downscaleMemoryUsed=this._usedMemory,this._canFastRecover=!1));else if(this._downscaleMemoryUsed=0,this._usedMemory>l)this._stableQuality=0,this._canFastRecover=!1,t=this._updateQuality(this._quality/d),this._downscaleMemoryUsed=this._memoryPredicted;else if(this._stableQuality!==this._quality)if(this._usedMemory<m&&this._quality<u){this._stableQuality=this._quality;const e=.05;t=this._updateQuality(this._quality+e)}else this._quality<1&&(this._canFastRecover=!0);this._updating=t}_updateQuality(t){return(t=Math.min(Math.max(t,this.minQuality),u))!==this._quality&&(this._quality=t,++this._numQualityChanges,!0)}_layersUpdating(){return this.view.allLayerViews.some((t=>!!t.updating))}_updateMemory(){if(!this.view)return;let t=0;this.view.basemapTerrain&&(t+=this.view.basemapTerrain.usedMemory);const e=this.view?._stage&&this.view._stage.renderView&&this.view._stage.renderer?.edgeView;null!=e&&(t+=e.usedMemory);let s=0;this.view.allLayerViews&&this.view.allLayerViews.forEach((e=>{if(h(e)){const i=e.ignoresMemoryFactor?this._quality:1;t+=e.usedMemory*i,s+=e.unloadedMemory*i}}));const a=null==this._warnMemoryUsage||Math.round(10*t)!==Math.round(10*this._warnMemoryUsage),r=1048576*this.maxMemory;if(t>r&&a){this._warnMemoryUsage=t;const e=t=>(t/1048576).toLocaleString(void 0,{maximumFractionDigits:1})+" MB",a=Math.round(100*this._quality);i.getLogger(this).warn(`Memory Limit exceeded! Limit: ${e(r)} Current: ${e(t)} Projected: ${e(t+s)} Quality: ${a}%`)}this._usedMemory=t/r,this._memoryPredicted=(t+s)/r;const o=r-t;this._cacheStorage.maxSize=Math.max(0,o+1048576*this.additionalCacheMemory)}get test(){const t=this;return{cacheStorage:this._cacheStorage,resetQualityChanges:()=>{const e=t._numQualityChanges;return t._numQualityChanges=0,e}}}};t([r({constructOnly:!0})],_.prototype,"view",void 0),t([r()],_.prototype,"maxMemory",null),t([r()],_.prototype,"additionalCacheMemory",null),t([r()],_.prototype,"memoryFactor",null),t([r()],_.prototype,"updating",null),t([r()],_.prototype,"usedMemory",null),t([r()],_.prototype,"_quality",void 0),t([r()],_.prototype,"_usedMemory",void 0),t([r()],_.prototype,"_updating",void 0),t([r()],_.prototype,"_stableQuality",void 0),t([r()],_.prototype,"_maxMemory",void 0),t([r()],_.prototype,"_additionalCacheMemory",void 0),_=t([o("esri.views.3d.support.MemoryController")],_);export{y as newMemoryController};
