/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{unwrapOrThrow as e}from"../../core/maybe.js";import{hasRunningElapsedTimer as t}from"./capabilities/DisjointTimerQuery.js";function i(e){const i=e.capabilities.disjointTimerQuery;return null==i?null:i.timestampBits()>0?new r(i):t?null:new s(i)}class s{constructor(e){this._timer=e,this._timer.disjoint(),this._query=this._timer.createQuery(),this._timer.beginTimeElapsed(this._query)}stop(e,t=50){this._timer.endTimeElapsed(),this._checkQueryResult(e,t)}abort(){this._deleteQuery()}_deleteQuery(){this._query&&(this._timer.deleteQuery(this._query),this._query=null)}_checkQueryResult(t,i){if(this._timer.disjoint())return this._deleteQuery(),void t(null);const s=e(this._query);if(!this._timer.resultAvailable(s))return void setTimeout((()=>this._checkQueryResult(t,i)),i);const r=this._timer.getResult(s);this._deleteQuery(),t(r/1e6)}}class r{constructor(e){this._timer=e,this._timer.disjoint(),this._start=this._timer.createQuery(),this._end=this._timer.createQuery(),this._timer.createTimestamp(this._start)}abort(){this._deleteQueries()}stop(t,i=50){this._timer.createTimestamp(e(this._end)),this._checkQueryResult(t,i)}_deleteQueries(){this._start&&(this._timer.deleteQuery(this._start),this._start=null),this._end&&(this._timer.deleteQuery(this._end),this._end=null)}_checkQueryResult(t,i){if(this._timer.disjoint())return this._deleteQueries(),void t(null);if(!(this._end&&this._timer.resultAvailable(this._end)))return void setTimeout((()=>this._checkQueryResult(t,i)),i);const s=this._timer.getResult(e(this._start)),r=this._timer.getResult(e(this._end));this._deleteQueries(),t((r-s)/1e6)}}export{i as startMeasurement};
