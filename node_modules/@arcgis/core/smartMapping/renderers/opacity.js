/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import i from"../../core/Error.js";import e from"../../renderers/support/AuthoringInfo.js";import a from"../../renderers/support/AuthoringInfoVisualVariable.js";import r from"../../renderers/visualVariables/OpacityVariable.js";import{verifyBasicFieldValidity as s,createStopValues as l,getDefaultDataRange as n}from"./support/utils.js";import o from"../statistics/summaryStatistics.js";import{verifyBinningParams as t}from"../support/binningUtils.js";import{getFieldsList as p}from"../support/utils.js";import{binningCapableLayerTypes as u,featureCapableLayerTypes as m,createLayerAdapter as d,getLayerTypeLabels as f}from"../support/adapters/support/layerUtils.js";const v="date";async function c(e){if(!(e&&e.layer&&(e.field||e.valueExpression||e.sqlExpression)))throw new i("opacity-visual-variable:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(e.valueExpression&&!e.view)throw new i("opacity-visual-variable:missing-parameters","View is required when 'valueExpression' is specified");e.forBinning&&t(e,"opacity-visual-variable");const a={...e,layer:e.layer},r=e.forBinning?u:m,l=d(a.layer,r,e.forBinning);if(!l)throw new i("opacity-visual-variable:invalid-parameters","'layer' must be one of these types: "+f(r).join(", "));a.layer=l;const n=null!=a.signal?{signal:a.signal}:null;await l.load(n);const o=await p({field:a.field,normalizationField:a.normalizationField,valueExpression:a.valueExpression}),v=s(l,o,"opacity-visual-variable:invalid-parameters");if(v)throw v;return a}function y(i,s){const o=s.layer,t=s.field,p=t&&!("function"==typeof t)?o.getField(t):null,u=p?.type===v,m=l(i),d=n(i,u,!0),f=d||[m[0],m[4]],c=new r({field:t,valueExpression:s.valueExpression,valueExpressionTitle:s.valueExpressionTitle,normalizationField:s.normalizationField,stops:[{value:f[0],opacity:.3},{value:f[1],opacity:1}],legendOptions:s.legendOptions}),y=new a({type:"opacity",minSliderValue:null!=s.minValue?s.minValue:i.min,maxSliderValue:null!=s.maxValue?s.maxValue:i.max}),x=new e({visualVariables:[y]});return Promise.resolve({visualVariable:c,statistics:i,defaultValuesUsed:!!d,authoringInfo:x})}async function x(i){const e=await c(i);let a=null;return a=e.statistics?e.statistics:await o({layer:e.layer,field:e.field,valueExpression:e.valueExpression,sqlExpression:e.sqlExpression,sqlWhere:e.sqlWhere,normalizationType:e.normalizationField?"field":void 0,normalizationField:e.normalizationField,minValue:e.minValue,maxValue:e.maxValue,view:e.view,signal:e.signal}),y(a,e)}export{x as createVisualVariable};
