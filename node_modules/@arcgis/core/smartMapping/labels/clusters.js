/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import e from"../../core/Error.js";import{fetchMessageBundle as t}from"../../intl/messages.js";import r from"../heuristics/clusterMinSize.js";import{createNumericLabelExpression as s,createLabelClass as n}from"./support/utils.js";import{getStatisticInfos as i,getClusterField as a,clusterCountField as o,getClusterFieldHash as l,getPredominantTypeExpression as u}from"../support/clusterUtils.js";import{isClusterCompatibleRenderer as c}from"../../views/2d/layers/support/clusterUtils.js";async function p(t){const{layer:r,renderer:s,view:n}=t;await Promise.all([r.load(),n.when()]);const i=s||r.renderer;if(!c(i))throw new e("clusters-label-schemes:invalid-parameters","'renderer' is not valid");return{layer:r,renderer:i,view:n}}function f(e,t,r){const s="unique-value"===e.type?e.uniqueValueInfos??[]:[];return u(s,t,r)}async function m(e){const{renderer:t,view:i,statInfo:u}=e,c=u?.statisticType,p=u?a(u.attributeInfo,c):o,m="type"===c?f(t,p,e.noneValueLabel):s(p),w=n(m);return{name:u?`clusters-${c}-${l(p,c)}`:"clusters-count",labelingInfo:[w],clusterMinSize:await r(w.symbol,i),fieldName:p}}function w(e){const t=new Map;for(const r of e)"size"===r.attributeInfo.vvType?t.set(r.statisticHash,r):t.has(r.statisticHash)||t.set(r.statisticHash,r);return[...t.values()]}async function d(e){const[{renderer:r,layer:s,view:n},a]=await Promise.all([p(e),t("esri/smartMapping/t9n/smartMapping")]);if(!r)return null;let o=null;const l=[],u=w(i(s,r,!1));for(const t of u){const e=await m({renderer:r,view:n,statInfo:t,noneValueLabel:a.clusters.predominantNoneValue});"size"===t.attributeInfo.vvType?o=e:l.push(e)}const c=await m({renderer:r,view:n});return o?l.unshift(c):o=c,{primaryScheme:o,secondarySchemes:l}}export{d as getLabelSchemes};
