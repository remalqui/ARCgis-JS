/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{_ as t}from"../../../../chunks/tslib.es6.js";import r from"../../../../core/Error.js";import{property as e}from"../../../../core/accessorSupport/decorators/property.js";import"../../../../core/accessorSupport/ensureType.js";import"../../../../core/arrayUtils.js";import"../../../../core/has.js";import{subclass as s}from"../../../../core/accessorSupport/decorators/subclass.js";import a from"../../../../geometry/Extent.js";import{estimateStatisticsHistograms as o}from"../../../../layers/support/rasterFunctions/stretchUtils.js";import i from"./RasterLayerAdapter.js";let n=class extends i{async generateRasterInfo(t){const{layer:r}=this,e=t?.rasterFunction;if("imagery-tile"===r.type&&e)try{return r.generateRasterInfo(e,{signal:t?.signal})}catch{return r.rasterInfo}return this.rasterInfo}async estimateStatisticsHistograms(t){if(null!==this._statsCache)return this._statsCache;const{raster:e}=this.layer,{extent:s,width:a,height:i}=this._getSamplePixelBlockDescriptor(e.rasterInfo),{pixelBlock:n}=await e.fetchPixels(s,a,i,t);if(null==n)throw new r("raster-layer-adapter","Unable to estimate histograms");return this._statsCache=o(n),this._statsCache}supportsMultidirectionalHillshade(){return!0}load(t){return this.addResolvingPromise(this.layer.load(t).then((()=>this.rasterInfo=this.layer.raster.rasterInfo))),Promise.resolve(this)}_getSamplePixelBlockDescriptor(t,r=1e3){const{pyramidScalingFactor:e,maximumPyramidLevel:s}=t.storageInfo;let{extent:o,width:i,height:n,pixelSize:l}=t,m=Math.ceil(Math.log(Math.max(i,n)/r)/Math.log(e))-1,h=0,c=0;if(m<=s){const t=e**m;i=Math.floor(i/t),n=Math.floor(n/t)}else m=0,i=Math.min(i,r),n=Math.min(n,r),h=Math.max(Math.floor(i/2-500),0),c=Math.max(Math.floor(n/2-500),0),o=new a({xmin:o.xmin+h*l.x,xmax:Math.min(o.xmax,o.xmin+h*l.x*r),ymin:o.ymin+c*l.y,ymax:Math.min(o.ymax,o.ymin+c*l.y*r)});return{extent:o,width:i,height:n,origin:{x:h,y:c}}}};t([e()],n.prototype,"layer",void 0),n=t([s("esri.smartMapping.support.adapters.ImageryTileLayerAdapter")],n);const l=n;export{l as default};
