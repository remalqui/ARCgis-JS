/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{addNearFar as e,addLinearDepth as r}from"../views/3d/webgl-engine/core/shaderLibrary/ForwardLinearDepth.glsl.js";import{ShaderOutput as o}from"../views/3d/webgl-engine/core/shaderLibrary/ShaderOutput.js";import{SliceDraw as i}from"../views/3d/webgl-engine/core/shaderLibrary/Slice.glsl.js";import{Transform as t}from"../views/3d/webgl-engine/core/shaderLibrary/Transform.glsl.js";import{ObjectAndLayerIdColor as l}from"../views/3d/webgl-engine/core/shaderLibrary/attributes/ObjectAndLayerIdColor.glsl.js";import{VertexColor as s}from"../views/3d/webgl-engine/core/shaderLibrary/attributes/VertexColor.glsl.js";import{OutputDepth as a}from"../views/3d/webgl-engine/core/shaderLibrary/output/OutputDepth.glsl.js";import{OutputHighlight as d}from"../views/3d/webgl-engine/core/shaderLibrary/output/OutputHighlight.glsl.js";import{multipassTerrainTest as n}from"../views/3d/webgl-engine/core/shaderLibrary/shading/MultipassTerrainTest.glsl.js";import{VisualVariables as p}from"../views/3d/webgl-engine/core/shaderLibrary/shading/VisualVariables.glsl.js";import{symbolAlphaCutoff as g}from"../views/3d/webgl-engine/core/shaderLibrary/util/AlphaCutoff.js";import{ColorConversion as u}from"../views/3d/webgl-engine/core/shaderLibrary/util/ColorConversion.glsl.js";import{addProjViewLocalOrigin as c}from"../views/3d/webgl-engine/core/shaderLibrary/util/View.glsl.js";import{Float4PassUniform as v}from"../views/3d/webgl-engine/core/shaderModules/Float4PassUniform.js";import{glsl as b}from"../views/3d/webgl-engine/core/shaderModules/interfaces.js";import{ShaderBuilder as h}from"../views/3d/webgl-engine/core/shaderModules/ShaderBuilder.js";import{TransparencyPassType as m}from"../views/3d/webgl-engine/lib/TransparencyPassType.js";import{VertexAttribute as f}from"../views/3d/webgl-engine/lib/VertexAttribute.js";function w(w){const C=new h,{vertex:j,fragment:y,attributes:L,varyings:O}=C;c(j,w),C.include(t,w),C.include(s,w),C.include(p,w),C.include(l,w),L.add(f.POSITION,"vec3"),w.vvColor&&L.add(f.COLORFEATUREATTRIBUTE,"float"),O.add("vColor","vec4"),O.add("vpos","vec3");const T=w.hasMultipassTerrain&&(w.output===o.Color||w.output===o.Alpha);T&&O.add("depth","float"),j.uniforms.add(new v("eColor",(e=>e.color)));const A=w.output===o.Depth;A&&(C.include(a,w),e(C),r(C)),j.code.add(b`
    void main(void) {
      vpos = position;
      forwardNormalizedVertexColor();
      forwardObjectAndLayerIdColor();

      ${w.hasVertexColors?"vColor *= eColor;":w.vvColor?"vColor = eColor * interpolateVVColor(colorFeatureAttribute);":"vColor = eColor;"}
      ${T?"depth = (view * vec4(vpos, 1.0)).z;":""}
      gl_Position = ${A?b`transformPositionWithDepth(proj, view, vpos, nearFar, linearDepth);`:b`transformPosition(proj, view, vpos);`}
    }
  `),C.include(i,w),T&&C.include(n,w),y.include(u);const $=w.output===o.Highlight;return $&&C.include(d,w),y.code.add(b`
  void main() {
    discardBySlice(vpos);
    ${T?"terrainDepthTest(gl_FragCoord, depth);":""}
    vec4 fColor = vColor;

    ${w.output===o.ObjectAndLayerIdColor?b`fColor.a = 1.0;`:""}

    if (fColor.a < ${b.float(g)}) {
      discard;
    }

    ${w.output===o.Alpha?b`fragColor = vec4(fColor.a);`:""}

    ${w.output===o.Color?b`fragColor = highlightSlice(fColor, vpos); ${w.transparencyPassType===m.Color?"fragColor = premultiplyAlpha(fragColor);":""}`:""}
    ${$?b`outputHighlight();`:""};
    ${w.output===o.Depth?b`outputDepth(linearDepth);`:""};
    ${w.output===o.ObjectAndLayerIdColor?b`outputObjectAndLayerIdColor();`:""}
  }
  `),C}const C=Object.freeze(Object.defineProperty({__proto__:null,build:w},Symbol.toStringTag,{value:"Module"}));export{C,w as b};
