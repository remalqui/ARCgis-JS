/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{getAssetUrl as e}from"../../assets.js";import{toHSV as t,toRGB as s}from"../../core/colorUtils.js";import"../../core/has.js";import a from"../../core/Error.js";import l from"../../core/Logger.js";import{unwrapOrThrow as r}from"../../core/maybe.js";import{eachAlways as n}from"../../core/promiseUtils.js";import{pt2px as o}from"../../core/screenUtils.js";import{defaultThematicColor as i,getPatternUrlWithColor as c,dekebabifyLineStyle as p}from"./gfxUtils.js";import{defaultPrimitive as u}from"./IconSymbol3DLayerResource.js";import{defaultPrimitive as h}from"./ObjectSymbol3DLayerResource.js";import{SymbolSizeDefaults as m,adjustColorComponentBrightness as f,getPathSymbolShapes as y,shapes as b,getExtrudeSymbolShapes as d,getTetrahedronShapes as k,getDiamondShapes as v,getCylinderShapes as g,getCubeShapes as w,getInvertedConeShapes as x,getConeShapes as M,getWaterSymbolShapes as L}from"./previewUtils.js";import{tintImageWithColor as j,renderSymbol as z}from"./renderUtils.js";import{isVolumetricSymbol as S,getIconHref as U}from"./utils.js";import{resolveWebStyleSymbol as P}from"./webStyleSymbolUtils.js";const D=m.size,O=m.maxSize,C=m.maxOutlineSize,R=m.lineWidth,E=m.tallSymbolWidth;function I(e){const t=e.outline,s=null!=e.material?e.material.color:null,a=null!=s?s.toHex():null;if(null==t||"pattern"in t&&null!=t.pattern&&"style"===t.pattern.type&&"none"===t.pattern.style)return"fill"===e.type&&"#ffffff"===a?{color:"#bdc3c7",width:.75}:null;const l=o(t.size)||0;return{color:"rgba("+(null!=t.color?t.color.toRgba():"255,255,255,1")+")",width:Math.min(l,C),style:"pattern"in t&&null!=t.pattern&&"style"===t.pattern.type?p(t.pattern.style):null,join:"butt",cap:"patternCap"in t?t.patternCap:"butt"}}async function Z(t,s){if(t.thumbnail?.url)return t.thumbnail.url;if("icon"===s.type){const e=s?.resource?.href;if(e)return U(s)}const a=e("esri/images/Legend/legend3dsymboldefault.png");if(t.styleOrigin&&(t.styleOrigin.styleName||t.styleOrigin.styleUrl)){const e=await P(t.styleOrigin,{portal:t.styleOrigin.portal},"webRef").catch((()=>null));if(e&&"thumbnail"in e&&e.thumbnail?.url)return e.thumbnail.url}return a}function q(e,a=1){const l=e.a,r=t(e),n=r.h,o=r.s/a,i=100-(100-r.v)/a,{r:c,g:p,b:u}=s({h:n,s:o,v:i});return[c,p,u,l]}function H(e){return"water"===e.type?null==e.color?null:e.color:null==e.material||null==e.material.color?null:e.material.color}function N(e,t=0){const s=H(e);if(!s){if("fill"===e.type)return null;const s=i.r,a=f(s,t);return[a,a,a,100]}const a=s.toRgba();for(let l=0;l<3;l++)a[l]=f(a[l],t);return a}async function T(t,s){const a=t.style;if("none"===a)return null;return{type:"pattern",x:0,y:0,src:await c(e(`esri/symbols/patterns/${a}.png`),s.toCss(!0)),width:5,height:5}}function W(e){return e.outline?I(e):{color:"rgba(0, 0, 0, 1)",width:1.5}}function $(e,t){const s=H(e);if(!s)return null;let a="rgba(";return a+=f(s.r,t)+",",a+=f(s.g,t)+",",a+=f(s.b,t)+",",a+s.a+");"}function A(e,t){const s=$(e,t);if(!s)return{};if("pattern"in e&&null!=e.pattern&&"style"===e.pattern.type&&"none"===e.pattern.style)return null;return{color:s,width:Math.min(e.size?o(e.size):.75,C),style:"pattern"in e&&null!=e.pattern&&"style"===e.pattern.type?p(e.pattern.style):null,cap:"cap"in e?e.cap:null,join:"join"in e?"miter"===e.join?o(2):e.join:null}}function B(e,t,s){const a=null!=s?.75*s:0;return{type:"linear",x1:a?.25*a:0,y1:a?.5*a:0,x2:a||4,y2:a?.5*a:4,colors:[{color:e,offset:0},{color:t,offset:1}]}}function F(e){const t=e.depth,s=e.height,a=e.width;return 0!==a&&0!==t&&0!==s&&a===t&&null!=a&&null!=s&&a<s}function G(e,t,s){const a=[];if(!e)return a;switch(e.type){case"icon":{const s=0,l=0,r=t,n=t;switch(e.resource&&e.resource.primitive||u){case"circle":a.push({shape:{type:"circle",cx:0,cy:0,r:.5*t},fill:N(e,0),stroke:I(e)});break;case"square":a.push({shape:{type:"path",path:[{command:"M",values:[s,n]},{command:"L",values:[s,l]},{command:"L",values:[r,l]},{command:"L",values:[r,n]},{command:"Z",values:[]}]},fill:N(e,0),stroke:I(e)});break;case"triangle":a.push({shape:{type:"path",path:[{command:"M",values:[s,n]},{command:"L",values:[.5*r,l]},{command:"L",values:[r,n]},{command:"Z",values:[]}]},fill:N(e,0),stroke:I(e)});break;case"cross":a.push({shape:{type:"path",path:[{command:"M",values:[.5*r,l]},{command:"L",values:[.5*r,n]},{command:"M",values:[s,.5*n]},{command:"L",values:[r,.5*n]}]},stroke:W(e)});break;case"x":a.push({shape:{type:"path",path:[{command:"M",values:[s,l]},{command:"L",values:[r,n]},{command:"M",values:[r,l]},{command:"L",values:[s,n]}]},stroke:W(e)});break;case"kite":a.push({shape:{type:"path",path:[{command:"M",values:[s,.5*n]},{command:"L",values:[.5*r,l]},{command:"L",values:[r,.5*n]},{command:"L",values:[.5*r,n]},{command:"Z",values:[]}]},fill:N(e,0),stroke:I(e)})}break}case"object":switch(e.resource&&e.resource.primitive||h){case"cone":{const l=B(N(e,0),N(e,-.6),s?E:t),r=M(t,s);a.push({shape:r[0],fill:l}),a.push({shape:r[1],fill:l});break}case"inverted-cone":{const s=N(e,0),l=B(s,N(e,-.6),t),r=x(t);a.push({shape:r[0],fill:l}),a.push({shape:r[1],fill:s});break}case"cube":{const l=w(t,s);a.push({shape:l[0],fill:N(e,0)}),a.push({shape:l[1],fill:N(e,-.3)}),a.push({shape:l[2],fill:N(e,-.5)});break}case"cylinder":{const l=B(N(e,0),N(e,-.6),s?E:t),r=g(t,s);a.push({shape:r[0],fill:l}),a.push({shape:r[1],fill:l}),a.push({shape:r[2],fill:N(e,0)});break}case"diamond":{const s=v(t);a.push({shape:s[0],fill:N(e,-.3)}),a.push({shape:s[1],fill:N(e,0)}),a.push({shape:s[2],fill:N(e,-.3)}),a.push({shape:s[3],fill:N(e,-.7)});break}case"sphere":{const s=B(N(e,0),N(e,-.6));s.x1=0,s.y1=0,s.x2=.25*t,s.y2=.25*t,a.push({shape:{type:"circle",cx:0,cy:0,r:.5*t},fill:s});break}case"tetrahedron":{const s=k(t);a.push({shape:s[0],fill:N(e,-.3)}),a.push({shape:s[1],fill:N(e,0)}),a.push({shape:s[2],fill:N(e,-.6)});break}}break}return a}function J(e){const t="number"==typeof e?.size?e?.size:null;return t?o(t):null}function K(e){return"icon"===e.type?"multiply":"tint"}function Q(e,t){const s=J(t),a=t?.maxSize?o(t.maxSize):null,r=t?.disableUpsampling??!1,i=e.symbolLayers,c=[];let p=0,u=0;const h=i.at(-1);let m;return h&&"icon"===h.type&&(m=h.size&&o(h.size)),i.forEach((l=>{if("icon"!==l.type&&"object"!==l.type)return;const n="icon"===l.type?l.size&&o(l.size):0,i=s||n?Math.ceil(Math.min(s||n,a||O)):D;if(l&&l.resource&&l.resource.href){const t=Z(e,l).then((e=>{const t=l.get("material.color"),s=K(l);return j(e,i,t,s,r)})).then((e=>{const t=e.width,s=e.height;return p=Math.max(p,t),u=Math.max(u,s),[{shape:{type:"image",x:0,y:0,width:t,height:s,src:e.url},fill:null,stroke:null}]}));c.push(t)}else{let e=i;"icon"===l.type&&m&&s&&(e=i*(n/m));const a="tall"===t?.symbolConfig||t?.symbolConfig?.isTall||"object"===l.type&&F(l);p=Math.max(p,a?E:e),u=Math.max(u,e),c.push(Promise.resolve(G(l,e,a)))}})),n(c).then((e=>{const s=[];return e.forEach((e=>{e.value?s.push(e.value):e.error&&l.getLogger("esri.symbols.support.previewSymbol3D").warn("error while building swatchInfo!",e.error)})),z(s,[p,u],{node:t&&t.node,scale:!1,opacity:t&&t.opacity,ariaLabel:t?.ariaLabel})}))}function V(e,t){const s=e.symbolLayers,a=[],l=S(e),r=J(t),n=(t&&t.maxSize?o(t.maxSize):null)||C;let i,c=0,p=0;return s.forEach(((e,t)=>{if(!e)return;if("line"!==e.type&&"path"!==e.type)return;const s=[];switch(e.type){case"line":{const a=A(e,0);if(null==a)break;const l=a&&a.width||0;0===t&&(i=l);const o=Math.min(r||l,n),u=0===t?o:r?o*(l/i):o,h=u>R/2?2*u:R;p=Math.max(p,u),c=Math.max(c,h),a.width=u,s.push({shape:{type:"path",path:[{command:"M",values:[0,.5*p]},{command:"L",values:[c,.5*p]}]},stroke:a});break}case"path":{const t=Math.min(r||D,n),a=N(e,0),l=N(e,-.2),o=$(e,-.4),i=o?{color:o,width:1}:{};if("quad"===e.profile){const t=e.width,r=e.height,n=y(t&&r?t/r:1,0===r,0===t),o={...i,join:"bevel"};s.push({shape:n[0],fill:l,stroke:o}),s.push({shape:n[1],fill:l,stroke:o}),s.push({shape:n[2],fill:a,stroke:o})}else s.push({shape:b.pathSymbol3DLayer[0],fill:l,stroke:i}),s.push({shape:b.pathSymbol3DLayer[1],fill:a,stroke:i});p=Math.max(p,t),c=p}}a.push(s)})),Promise.resolve(z(a,[c,p],{node:t&&t.node,scale:l,opacity:t&&t.opacity,ariaLabel:t?.ariaLabel}))}async function X(e,t){const s="mesh-3d"===e.type,a=e.symbolLayers,l=J(t),n=t&&t.maxSize?o(t.maxSize):null,i=l||D,c=[];let p=0,u=0,h=!1;for(let o=0;o<a.length;o++){const e=a.at(o),t=[];if(s&&"fill"!==e.type)continue;const l=b.fill[0];switch(e.type){case"fill":{const a=I(e),r=Math.min(i,n||O);p=Math.max(p,r),u=Math.max(u,r),h=!0;let o=N(e,0);const c="pattern"in e?e.pattern:null,m=H(e);!s&&null!=c&&"style"===c.type&&"solid"!==c.style&&m&&(o=await T(c,m)),t.push({shape:l,fill:o,stroke:a});break}case"line":{const s=A(e,0);if(null==s)break;const a={stroke:s,shape:l};p=Math.max(p,D),u=Math.max(u,D),t.push(a);break}case"extrude":{const s={join:"round",width:1,...A(e,-.4)},a=N(e,0),l=N(e,-.2),r=Math.min(i,n||O),o=d(r);s.width=1,t.push({shape:o[0],fill:l,stroke:s}),t.push({shape:o[1],fill:l,stroke:s}),t.push({shape:o[2],fill:a,stroke:s});const c=D,h=.7*D+.5*r;p=Math.max(p,c),u=Math.max(u,h);break}case"water":{const s=r(H(e)),a=q(s),l=q(s,2),o=q(s,3),c=L();h=!0,t.push({shape:c[0],fill:a}),t.push({shape:c[1],fill:l}),t.push({shape:c[2],fill:o});const m=Math.min(i,n||O);p=Math.max(p,m),u=Math.max(u,m);break}}c.push(t)}return z(c,[p,u],{node:t&&t.node,scale:h,opacity:t&&t.opacity,ariaLabel:t?.ariaLabel})}function Y(e,t){if(0===e.symbolLayers.length)return Promise.reject(new a("symbolPreview: renderPreviewHTML3D","No symbolLayers in the symbol."));switch(e.type){case"point-3d":return Q(e,t);case"line-3d":return V(e,t);case"polygon-3d":case"mesh-3d":return X(e,t)}return Promise.reject(new a("symbolPreview: swatchInfo3D","symbol not supported."))}export{T as getPatternDescriptor,J as getSizeFromOptions,N as getSymbolLayerFill,Y as previewSymbol3D};
