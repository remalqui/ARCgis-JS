/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{isSymbol3D as t}from"../../symbols.js";import{isDevEnvironment as e,adjustStaticAGOUrl as r}from"../../core/devEnvironmentUtils.js";import l from"../../core/Error.js";import{unwrapOrThrow as o}from"../../core/maybe.js";import{urlToObject as n,removeFile as s}from"../../core/urlUtils.js";import m from"../../portal/Portal.js";import{f as i}from"../../chunks/persistableUrlUtils.js";import{fromJSON as a}from"./jsonUtils.js";import u from"./StyleOrigin.js";import{fetchStyle as p,requestJSON as f,makeCIMSymbolRef as y,Style2DUrlTemplate as c,symbolUrlFromStyleItem as b}from"./styleUtils.js";import{Thumbnail as g}from"./Thumbnail.js";function j(t,e,r,n){const s=t.name;return null==s?Promise.reject(new l("symbolstyleutils:style-symbol-reference-name-missing","Missing name in style symbol reference")):t.styleName&&"Esri2DPointSymbolsStyle"===t.styleName?U(s,e,n):p(t,e,n).then((t=>d(o(t),s,e,r,b,n)))}function h(t,e){return e.items.find((e=>e.name===t))}function d(o,p,c,b,j,d){const U=c&&null!=c.portal?c.portal:m.getDefault(),N={portal:U,url:n(o.baseUrl),origin:"portal-item"},w=h(p,o.data);if(!w){const t=`The symbol name '${p}' could not be found`;return Promise.reject(new l("symbolstyleutils:symbol-name-not-found",t,{symbolName:p}))}let S=i(j(w,b),N),D=w.thumbnail?.href??null;const O=w.thumbnail&&w.thumbnail.imageData;e()&&(S=r(S)??"",D=r(D));const P={portal:U,url:n(s(S)),origin:"portal-item"};return f(S,d).then((e=>{const r="cimRef"===b?y(e.data):e.data,l=a(r,P);if(l&&t(l)){if(D){const t=i(D,N);l.thumbnail=new g({url:t})}else O&&(l.thumbnail=new g({url:`data:image/png;base64,${O}`}));o.styleUrl?l.styleOrigin=new u({portal:c.portal,styleUrl:o.styleUrl,name:p}):o.styleName&&(l.styleOrigin=new u({portal:c.portal,styleName:o.styleName,name:p}))}return l}))}function U(t,e,r){const l=c.replaceAll(/\{SymbolName\}/gi,t),o=null!=e.portal?e.portal:m.getDefault();return f(l,r).then((t=>{const e=y(t.data);return a(e,{portal:o,url:n(s(l)),origin:"portal-item"})}))}export{d as fetchSymbolFromStyle,h as getStyleItemFromStyle,j as resolveWebStyleSymbol};
