/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{result as r}from"../../core/asyncUtils.js";import e from"../../core/Error.js";import{eachAlways as o,throwIfAborted as t}from"../../core/promiseUtils.js";import{generateUUID as s}from"../../core/uuid.js";import{getSiblingOfSameTypeI as c}from"../../portal/support/resourceUtils.js";async function p(r,p,u){if(!p||!p.resources)return;const h=p.portalItem===r.portalItem?new Set(r.paths):new Set;r.paths.length=0,r.portalItem=p.portalItem;const i=new Set(p.resources.toKeep.map((r=>r.resource.path))),m=new Set,f=[];i.forEach((e=>{h.delete(e),r.paths.push(e)}));for(const e of p.resources.toUpdate)if(h.delete(e.resource.path),i.has(e.resource.path)||m.has(e.resource.path)){const{resource:o,content:t,finish:p,error:n}=e,h=c(o,s());r.paths.push(h.path),f.push(a({resource:h,content:t,compress:e.compress,finish:p,error:n},u))}else r.paths.push(e.resource.path),f.push(n(e,u)),m.add(e.resource.path);for(const e of p.resources.toAdd)f.push(a(e,u)),r.paths.push(e.resource.path);if(h.forEach((r=>{if(p.portalItem){const e=p.portalItem.resourceFromPath(r);f.push(e.portalItem.removeResource(e).catch((()=>{})))}})),0===f.length)return;const l=await o(f);t(u);const d=l.filter((r=>"error"in r)).map((r=>r.error));if(d.length>0)throw new e("save:resources","Failed to save one or more resources",{errors:d})}async function a(e,o){const t={...null!=o?o:{},compress:e.compress},s=await r(e.resource.portalItem.addResource(e.resource,e.content,t));if(!0!==s.ok)throw e.error?.(s.error),s.error;e.finish?.(e.resource)}async function n(e,o){const t=await r(e.resource.update(e.content,o));if(!0!==t.ok)throw e.error?.(t.error),t.error;e.finish?.(e.resource)}export{p as saveResources};
