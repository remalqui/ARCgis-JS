/*
All material copyright ESRI, All Rights Reserved, unless otherwise specified.
See https://js.arcgis.com/4.27/esri/copyright.txt for details.
*/
import{getMetersPerCartesianUnitForSR as n,convertUnit as t}from"../../../core/unitUtils.js";import{c as e}from"../../../chunks/mat3f64.js";import{j as r,m as o,a as i,k as a}from"../../../chunks/mat4.js";import{I as s,c as l}from"../../../chunks/mat4f64.js";import{k as c}from"../../../chunks/vec3.js";import{Z as u,f}from"../../../chunks/vec3f64.js";import{b as p}from"../../../chunks/mat3.js";import{projectBuffer as m,canProjectWithoutEngine as g,computeTranslationToOriginAndRotation as h}from"../../projection.js";import{getSphericalPCPF as j}from"../../spatialReferenceEllipsoidUtils.js";import{newDoubleArray as y,copyInto as R}from"../DoubleArray.js";import w from"../MeshGeoreferencedRelativeVertexSpace.js";import A from"../MeshGeoreferencedVertexSpace.js";import x from"../MeshLocalVertexSpace.js";import v from"../MeshTransform.js";import{t as F,a as k}from"../../../chunks/vec32.js";import{isGeographicMesh as S}from"./geographicUtils.js";import{transformNormal as M,transformTangent as d,projectFromPCPF as b,projectNormalFromPCPF as z,projectTangentFromPCPF as G,projectToPCPF as P,projectNormalToPCPF as U,projectTangentToPCPF as V}from"./projection.js";function O(n,t,e){return S(t.spatialReference,e)?Z(n,t,e):L(n,t,e)}function T(n,t,e,r){const{position:o,normal:i,tangent:a}=n;if(!t.isRelative)return{position:o,normal:i,tangent:a};const l=e?.localMatrix??s;return O({position:F(new Float64Array(o.length),o,l),normal:null!=i?M(i,new Float32Array(i.length),l):null,tangent:null!=a?d(a,new Float32Array(a.length),l):null},t.getOriginPoint(r),{geographic:!t.isGeoreferenced})}function q(n,t,e){if(e?.useTransform){const{position:r,normal:o,tangent:i}=n,{x:a,y:s,z:l}=t,c=f(a,s,l??0);return{vertexAttributes:{position:r,normal:o,tangent:i},vertexSpace:e.geographic??1?new x({origin:c}):new w({origin:c}),transform:new v}}return{vertexAttributes:O(n,t,e),vertexSpace:new A,transform:null}}function D(n,t,e){return S(t.spatialReference,e)?K(n,t,e):J(n,t,e)}function E(n,t,e,r,o){if(!t.isRelative)return D(n,r,o);const{spatialReference:i}=r,a=T(n,t,e,i);return r.equals(t.getOriginPoint(i))?J(a,r,o):D(a,r,o)}function I({positions:n,transform:t,vertexSpace:e,inSpatialReference:i,outSpatialReference:a,outPositions:l,local:f}){const p=e.isRelative?e.origin:u,w=e.isRelative?t?.localMatrix??s:s;if(e.isGeoreferenced){const t=l??y(n.length);if(r(w,s)?R(t,n):F(t,n,w),!c(p,u)){const[n,e,r]=p;for(let o=0;o<t.length;o+=3)t[o]+=n,t[o+1]+=e,t[o+2]+=r}return m(t,i,0,t,a,0,t.length/3),t}const A=j(i),x=!f&&g(i,A)?A:i;h(i,p,$,x),o($,$,w);const v=l??y(n.length);return F(v,n,$),m(v,x,0,v,a,0,v.length/3),v}function L(n,t,e){const r=new Float64Array(n.position.length),o=n.position,i=t.x,a=t.y,s=t.z??0,l=Y(e?e.unit:null,t.spatialReference);for(let c=0;c<o.length;c+=3)r[c]=o[c]*l+i,r[c+1]=o[c+1]*l+a,r[c+2]=o[c+2]*l+s;return{position:r,normal:n.normal,tangent:n.tangent}}function Z(n,t,e){const r=t.spatialReference,o=N(t,e,$),i=new Float64Array(n.position.length),a=B(n.position,o,r,i),s=p(nn,o);return{position:a,normal:C(a,i,n.normal,s,r),tangent:H(a,i,n.tangent,s,r)}}function B(n,t,e,r){F(r,n,t);const o=new Float64Array(n.length);return b(r,o,e)}function C(n,t,e,r,o){if(null==e)return null;const i=new Float32Array(e.length);return k(i,e,r),z(i,n,t,o,i),i}function H(n,t,e,r,o){if(null==e)return null;const i=new Float32Array(e.length);k(i,e,r,4);for(let a=3;a<i.length;a+=4)i[a]=e[a];return G(i,n,t,o,i),i}function J(n,t,e){const r=new Float64Array(n.position.length),o=n.position,i=t.x,a=t.y,s=t.z??0,l=Y(e?e.unit:null,t.spatialReference);for(let c=0;c<o.length;c+=3)r[c]=(o[c]-i)/l,r[c+1]=(o[c+1]-a)/l,r[c+2]=(o[c+2]-s)/l;return{position:r,normal:n.normal,tangent:n.tangent}}function K(n,t,e){const r=t.spatialReference;N(t,e,$);const o=i(_,$),a=new Float64Array(n.position.length),s=Q(n.position,r,o,a),l=p(nn,o);return{position:s,normal:W(n.normal,n.position,a,r,l),tangent:X(n.tangent,n.position,a,r,l)}}function N(n,t,e){h(n.spatialReference,[n.x,n.y,n.z??0],e,j(n.spatialReference));const r=Y(t?t.unit:null,n.spatialReference);return a(e,e,[r,r,r]),e}function Q(n,t,e,r){const o=P(n,t,r),i=new Float64Array(o.length);return F(i,o,e),i}function W(n,t,e,r,o){if(null==n)return null;const i=U(n,t,e,r,new Float32Array(n.length));return k(i,i,o),i}function X(n,t,e,r,o){if(null==n)return null;const i=V(n,t,e,r,new Float32Array(n.length));return k(i,i,o,4),i}function Y(e,r){if(null==e)return 1;const o=n(r);return 1/t(o,"meters",e)}const $=l(),_=l(),nn=e();export{O as georeference,T as georeferenceApplyTransform,q as georeferenceByTransform,I as project,D as ungeoreference,E as ungeoreferenceByTransform};
